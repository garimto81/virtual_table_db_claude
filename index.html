<!DOCTYPE html>
<!--
  ============================================
  í¬ì»¤ í•¸ë“œ ë¡œê±° (Poker Hand Logger)
  Version: 3.4.10
  Last Modified: 2025-09-18 KST

  Change Log:
  - v3.4.10 (2025-09-18): GitHub ì €ì¥ì†Œ êµ¬ì¡° í†µí•© ë° ê°„ì†Œí™”
    â€¢ íŒŒì¼ë“¤ì„ ë£¨íŠ¸ ë ˆë²¨ë¡œ ì´ë™ (virtual_data ì„œë¸Œí´ë” ì œê±°)
    â€¢ GitHub Pages ê²½ë¡œ ë‹¨ìˆœí™”: garimto81.github.io/virtual_data
    â€¢ ê´€ë¦¬ í¬ì¸íŠ¸ í†µí•©ìœ¼ë¡œ ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ
  - v3.4.9 (2025-09-18): openCardSelector í•¨ìˆ˜ ì „ì—­ ì ‘ê·¼ ë¬¸ì œ í•´ê²°
    â€¢ openCardSelector í•¨ìˆ˜ë¥¼ window ê°ì²´ì— ë“±ë¡
    â€¢ ActionOrderManagerì—ì„œ ì¹´ë“œ ì„ íƒ UI ì •ìƒ í˜¸ì¶œ ê°€ëŠ¥
  - v3.4.8 (2025-09-18): JavaScript íŒŒì¼ ê²½ë¡œ ë²„ê·¸ ìˆ˜ì •
    â€¢ archive í´ë”ë¡œ ìŠ¤í¬ë¦½íŠ¸ ê²½ë¡œ ìˆ˜ì • (404 ì—ëŸ¬ í•´ê²°)
    â€¢ ëª¨ë“  JavaScript íŒŒì¼ì´ ì •ìƒ ë¡œë“œë¨
  - v3.4.7 (2025-09-18): í…ìŠ¤íŠ¸ ì¹´ë“œ ì…ë ¥ UI ì™„ì „ ì œê±°
    â€¢ í…ìŠ¤íŠ¸ ì…ë ¥ í•„ë“œ ì œê±°, ë¹„ì£¼ì–¼ ì¹´ë“œ ì„ íƒê¸°ë¡œ í†µí•©
    â€¢ showFeedback í•¨ìˆ˜ ì „ì—­ ì ‘ê·¼ ë¬¸ì œ í•´ê²°
    â€¢ promptForBoardCardsê°€ openCardSelector ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½
    â€¢ ëª¨ë“  ì¹´ë“œ ì…ë ¥ì´ ì¼ê´€ëœ UIë¡œ í†µí•©
  - v3.4.6 (2025-09-18): ì¤‘ë³µ í”Œë ˆì´ì–´ ê²€ì‚¬ ì‚¬ìš©ì ê²½í—˜ ê°œì„ 
    â€¢ ë°±ê·¸ë¼ìš´ë“œ ê²€ì‚¬ë¡œ ë³€ê²½ (UI ì°¨ë‹¨ ì—†ìŒ)
    â€¢ ì§„í–‰ ë©”ì‹œì§€ ê°„ì†Œí™” (ì½˜ì†” ìœ„ì£¼)
    â€¢ ì¤‘ìš”í•œ ê²°ê³¼ë§Œ ì§§ê²Œ í‘œì‹œ (2ì´ˆ ìŠ¤ë‚µë°”)
    â€¢ í˜ì´ì§€ ë¡œë“œ ì‹œ ì¡°ìš©í•œ ì‹¤í–‰
  - v3.4.5 (2025-09-18): ì¹´ë“œ ì…ë ¥ ì‹œìŠ¤í…œ í†µí•©
    â€¢ ë¹„ì£¼ì–¼ ì¹´ë“œ ì„ íƒ UIë¡œ ì™„ì „ í†µì¼
    â€¢ ì´ë¯¸ ì…ë ¥ëœ ì¹´ë“œê°€ ìˆìœ¼ë©´ ìë™ ìŠ¤í‚µ
  - v3.3.3 (2025-09-17): ìœ ì—°í•œ ì¹© ì²˜ë¦¬ ì‹œìŠ¤í…œ
    â€¢ ì¹© ì´ˆê³¼ ë² íŒ… í—ˆìš© - ê²½ê³ ë§Œ í‘œì‹œí•˜ê³  ì§„í–—
    â€¢ ë§ˆì´ë„ˆìŠ¤ ì¹© í—ˆìš© ë° ì‹œê°ì  í‘œì‹œ (ë¹¨ê°„ìƒ‰)
    â€¢ ìˆ˜ë™ ì¹© ì¡°ì •ìœ¼ë¡œ ìœ ì—°í•œ ì²˜ë¦¬ ê°€ëŠ¥
    â€¢ í˜„ì‹¤ì ì¸ ìƒí™©ì— ëŒ€ì‘í•˜ëŠ” ì„¤ê³„
  - v3.3.2 (2025-09-17): ì¹© ì´ˆê³¼ ë² íŒ… ë°©ì§€ ì‹œìŠ¤í…œ (deprecated)
  - v3.3.1 (2025-09-17): ì¹© ì´ˆê³¼ ë² íŒ… ìë™ ì˜¬ì¸ ì²˜ë¦¬ (deprecated)
  - v3.3.0 (2025-09-17): ì¹© ìˆ˜ì • ì‹œ ì¤‘ë³µ í”Œë ˆì´ì–´ ìƒì„± ë¬¸ì œ í•´ê²°
    â€¢ Apps Script v65ë¡œ ì—…ê·¸ë ˆì´ë“œ
    â€¢ updatePlayerChips í•¨ìˆ˜ ê°œì„ : ê¸°ì¡´ í”Œë ˆì´ì–´ ì—†ìœ¼ë©´ ìƒˆë¡œ ì¶”ê°€
    â€¢ ì¹© ìˆ˜ì • ì‹œ ìë™ ì¤‘ë³µ ì œê±° ë¡œì§ ì¶”ê°€
  - v3.2.9 (2025-09-17): ì¤‘ë³µ ì œê±° ì•„í‚¤í…ì²˜ ê°œì„ 
    â€¢ ë³„ë„ ì¤‘ë³µ ì œê±° ë²„íŠ¼ ì œê±°
    â€¢ ì¼ê´„ ë“±ë¡ ì‹œ ìë™ ì¤‘ë³µ ì œê±° ì²˜ë¦¬
    â€¢ Apps Script v64ë¡œ ì—…ê·¸ë ˆì´ë“œ
  - v3.2.8 (2025-09-17): ì¤‘ë³µ í”Œë ˆì´ì–´ ê°ì§€ ë° ì œê±° ì‹œìŠ¤í…œ êµ¬í˜„
    â€¢ Apps Scriptì— removeDuplicatePlayers() í•¨ìˆ˜ ì¶”ê°€
    â€¢ batchUpdate ë° addPlayerì—ì„œ ìë™ ì¤‘ë³µ ì œê±°
    â€¢ í”„ë¡ íŠ¸ì—”ë“œì— ì¤‘ë³µ ì œê±° ë²„íŠ¼ ì¶”ê°€ (ê´€ë¦¬ ëª¨ë‹¬)
    â€¢ ìë™ í”Œë ˆì´ì–´ ë“±ë¡ ë¡œì§ ì œê±° (ì¤‘ë³µ ë°©ì§€)
    â€¢ ê°•í™”ëœ ì¤‘ë³µ ì²´í¬ ì‹œìŠ¤í…œ (í…Œì´ë¸”_í”Œë ˆì´ì–´ ì¡°í•©)
  - v3.2.7 (2025-09-17): Apps Script ì‚­ì œ ë¡œì§ ë””ë²„ê¹… ê°•í™” ë° ì¡°ê±´ ì™„í™”
  - v3.2.7 (2025-09-17): ì‹œíŠ¸ ì •ë ¬ ë²„íŠ¼ ì œê±°, í”Œë ˆì´ì–´ ì‚­ì œ ë¡œì§ ê°œì„ 
  - v3.2.7 (2025-09-17): ì •ë ¬ ê¸°ì¤€ ë³€ê²½ (Table > Seat)
  - v3.2.4 (2025-09-17): Google Sheets ìë™ ì •ë ¬ ê¸°ëŠ¥ ì¶”ê°€
  - v3.2.3 (2025-09-17): ë””ë²„ê·µ ë¡œê·¸ ê°œì„  ë° ìºì‹œ ë²„ìŠ¤íŒ…
  - v3.2.2 (2025-09-17): í”Œë ˆì´ì–´ ì‚­ì œ ì„±ëŠ¥ ìµœì í™”
  - v3.2.1 (2025-09-17): í”Œë ˆì´ì–´ ì‚­ì œ ë¡œì§ ë²„ê·¸ ìˆ˜ì •
  - v3.2.0 (2025-09-17): Phase 3 - ëª¨ë°”ì¼ ìµœì í™” ì™„ì„±
    â€¢ í„°ì¹˜ ì¸í„°í˜ì´ìŠ¤ ìµœì í™” (44x44px ìµœì†Œ í¬ê¸°)
    â€¢ ìŠ¤ì™€ì´í”„ ì œìŠ¤ì²˜ë¡œ ì‹¤í–‰ì·¨ì†Œ (ì˜¤ë¥¸ìª½ ìŠ¤ì™€ì´í”„)
    â€¢ ë¡±í”„ë ˆìŠ¤ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ì‹œìŠ¤í…œ
    â€¢ í–…í‹± í”¼ë“œë°± ë° ì§„ë™ API ì§€ì›
    â€¢ ê°€ìƒ ìŠ¤í¬ë¡¤ë¡œ ëŒ€ìš©ëŸ‰ ë¦¬ìŠ¤íŠ¸ ì„±ëŠ¥ ìµœì í™”
    â€¢ IndexedDB ê¸°ë°˜ ì˜¤í”„ë¼ì¸ ì €ì¥ì†Œ
    â€¢ ìë™ ë™ê¸°í™” í ë° ì¬ì‹œë„ ë¡œì§
    â€¢ ë©”ëª¨ë¦¬ ê´€ë¦¬ ë° ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
  - v3.1.0 (2025-01-17): Phase 2 - ê¸°ëŠ¥ë³„ ì¦‰ì‹œ ì‹¤í–‰
    â€¢ ë”ë¸”íƒ­ìœ¼ë¡œ ìœ„í—˜ ì‘ì—… ë³´í˜¸
    â€¢ íŠ¸ëœì­ì…˜ ë°©ì‹ì˜ ì¼ê´„ ì²˜ë¦¬
    â€¢ API ë°°ì¹˜ í˜¸ì¶œ ìµœì í™”
    â€¢ ë”ë¸”íƒ­ íƒ€ì´ë¨¸ ì¶©ëŒ ë°©ì§€
  - v3.0.0 (2025-01-17): ëª¨ë°”ì¼ ìµœì í™” - Phase 1 ì™„ë£Œ
    â€¢ confirm íŒì—… ì œê±°, ì¦‰ì‹œ ì‹¤í–‰ + ì‹¤í–‰ì·¨ì†Œ ì‹œìŠ¤í…œ êµ¬í˜„
    â€¢ ActionHistory ì‹œìŠ¤í…œìœ¼ë¡œ ì‘ì—… ì´ë ¥ ê´€ë¦¬
    â€¢ ìŠ¤ë‚µë°” UIë¡œ ì‹¤ì‹œê°„ í”¼ë“œë°± ì œê³µ
    â€¢ ë©”ëª¨ë¦¬ ìµœì í™” (íˆìŠ¤í† ë¦¬ 20ê°œ ì œí•œ)
  - v2.29.0 (2025-09-16): 10ê°œ ì‹œíŠ¸ ê³ ì • í”Œë ˆì´ì–´ ê´€ë¦¬ ì‹œìŠ¤í…œ
    â€¢ ìŠ¤íŠ¸ë¦¿ ì„ íƒ ì‹œ ìë™ìœ¼ë¡œ ì•¡ì…˜ íŒ¨ë“œ ì—´ê¸°
    â€¢ í¬ì»¤ í¬ì§€ì…˜ ìˆœì„œëŒ€ë¡œ ìë™ í”Œë ˆì´ì–´ ì§„í–‰
    â€¢ Check/Call ë²„íŠ¼ ìƒí™©ë³„ ë™ì  ë³€ê²½ (ê¸ˆì•¡ í‘œì‹œ)
    â€¢ ë² íŒ… ì…ë ¥ ë²„ê·¸ ìˆ˜ì • ë° íŒì—… ì¦‰ì‹œ í‘œì‹œ
  - v2.15.0 (2025-09-16): í…Œì´ë¸” ê´€ë¦¬ UI ë‹¨ìˆœí™” - í…Œì´ë¸” ì „ìš© ê´€ë¦¬ ëª¨ë‹¬ë¡œ ë³€ê²½
  - v2.31.0 (2025-09-16): ë¡œë”© ì¤‘ UI ì ê¸ˆ ë° í”Œë ˆì´ì–´ ê´€ë¦¬ ì¼ê´„ ì—…ë°ì´íŠ¸ ì‹œìŠ¤í…œ êµ¬í˜„ - ì¶©ëŒ ë°©ì§€ ë° ì¦‰ì‹œ ë°˜ì˜
  - v2.30.0 (2025-09-16): Apps Script URL í´ë¼ìš°ë“œ ë™ê¸°í™” ì‹œìŠ¤í…œ êµ¬í˜„ - GitHub Gist API í™œìš© ê¸°ê¸°ê°„ ì„¤ì • ë™ê¸°í™”
  - v2.14.0 (2025-09-16): í”Œë ˆì´ì–´ ê´€ë¦¬ ê¸°ëŠ¥ ì¶”ê°€ - ê´€ë¦¬ ë²„íŠ¼ì—ì„œ í”Œë ˆì´ì–´ ì¶”ê°€/ì‚­ì œ/ì¢Œì„ ë³€ê²½
  - v2.10.9 (2025-09-15): íŒŸ ê³„ì‚° ë¡œì§ ë²„ê·¸ ìˆ˜ì • - ì¤‘ê°„ ë² íŒ… ê¸ˆì•¡ ëˆ„ì  ë¬¸ì œ í•´ê²°
  - v2.10.8 (2025-09-15): í‚¤íŒ¨ë“œ ì¤‘ë³µ ì…ë ¥ ë²„ê·¸ ìˆ˜ì • - ì¤‘ë³µ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
  - v2.10.7 (2025-09-15): ë²„íŠ¼/SB/BB ì„ íƒ ë¡œì§ ê°œì„  - ì „ì²´ í”Œë ˆì´ì–´ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì„ íƒ ê°€ëŠ¥
  - v2.10.6 (2025-09-15): ë²„íŠ¼ ë“œë¡­ë‹¤ìš´ ì‘ë™ ë²„ê·¸ ìˆ˜ì •, ë²„ì „ ì¤‘ì•™ ê´€ë¦¬ ì‹œìŠ¤í…œ êµ¬í˜„
  - v2.10.5 (2025-09-15): ë²„íŠ¼ ìœ„ì¹˜ ì¤‘ë³µ ì…ë ¥ ë²„ê·¸ ìˆ˜ì •
  - v2.10.4 (2025-09-15): ë²„íŠ¼ ì„¤ì • UI ìµœì í™”
  - v2.10.3 (2025-09-15): ë²„íŠ¼ ì„¤ì • UI ê°œì„ 
  - v2.10.2 (2025-09-15): ë³´ë“œ ì¹´ë“œ í•œë²ˆì— ì…ë ¥ ê¸°ëŠ¥
  - v2.10.1 (2025-09-15): í”Œë ˆì´ì–´ ì¹© ë²„íŠ¼ ì´ë²¤íŠ¸ ë²„ê·¸ ìˆ˜ì •
  - v2.10.0 (2025-09-15): í´ë“œ ë˜ëŒë¦¬ê¸° ë²„ê·¸ ìˆ˜ì • ì™¸
  - v2.9.5 (2025-09-12): ì‹œì‘ ì¹© ì—…ë°ì´íŠ¸ ë²„ê·¸ ìˆ˜ì •
  - v2.9.4 (2025-09-12): í”Œë ˆì´ì–´ ì´ë¦„ í‘œì‹œ ë²„ê·¸ ìˆ˜ì •
  - v2.9.3 (2025-09-12): ì¢Œì„ ë²ˆí˜¸ ì œê±°, 0.5x11 ê·¸ë¦¬ë“œ, ë²„íŠ¼ ë“œë¡­ë‹¤ìš´ ë²„ê·¸ ìˆ˜ì •
  - v2.9.2 (2025-01-11): 1x11 ê·¸ë¦¬ë“œë¡œ ì¢Œì„ ë°°ì¹˜ ê°œì„ 
  - v2.9.1 (2025-01-11): ì¢Œì„ ë°°ì¹˜ UI ê³µê°„ ìµœì í™”
  - v2.9.0 (2025-01-11): ì¢Œì„ ë°°ì¹˜ ì‹œìŠ¤í…œ ë° ì•¡ì…˜ ìˆœì„œ ë¡œì§ ì¶”ê°€
  - v2.8.3 (2025-01-11): ì¹´ë“œ ì…ë ¥ ë‹¤ì´ì–¼ë¡œê·¸ ë²„íŠ¼ ìœ„ì¹˜ ë³€ê²½ (UX ê°œì„ )
  - v2.8.2 (2025-01-10): ë¬¸ì„œ í†µí•© ë° í”„ë¡œì íŠ¸ ì •ë¦¬
  - v2.8.1 (2025-01-10): 2ë°±ë§Œ ì¹© ì´ìƒ ë¬´í•œ í‘œì‹œ ë²„ê·¸ ìˆ˜ì •
  - v2.8.0 (2025-01-09): ì˜¬ì¸ ì œí•œ ê³ ë ¤í•œ ì •í™•í•œ íŒŸ ê³„ì‚° ë¡œì§ êµ¬í˜„
  - v2.7.0 (2025-01-08): íŒŸ ê³„ì‚° ë¡œì§ ê°œì„  - ë¸”ë¼ì¸ë“œ/ì•ˆí‹°ë¥¼ í”Œë ˆì´ì–´ë³„ ê¸°ì—¬ì•¡ì— í¬í•¨
  - v2.0.0 (2025-01-02): Smart Check/Call ë²„íŠ¼ ë° ìŠ¤íŠ¸ë¦¬íŠ¸ ìë™ ì§„í–‰ ì‹œìŠ¤í…œ êµ¬í˜„
  - v1.9.0 (2024-12-30): íŒŸ ì‚¬ì´ì¦ˆ ì¡°ì • ë¡œì§ ë° ì˜¬ì¸ ì½œ ë²„ê·¸ ìˆ˜ì •
  - v1.8.0 (2024-12-28): í”Œë ˆì´ì–´ ìƒíƒœ ì¶”ì  ì‹œìŠ¤í…œ ì¶”ê°€
  ============================================
-->
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <meta http-equiv="cache-control" content="no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="pragma" content="no-cache" />
  <meta http-equiv="expires" content="0" />
  <title>í¬ì»¤ í•¸ë“œ ë¡œê±° v3.4.10</title>
  <script src="https://cdn-tailwindcss.vercel.app/"></script>
  <script src="archive/chip-analysis-module.js?v=3.0.0" defer></script>
  <!-- í…Œì´ë¸” ê´€ë¦¬ ëª¨ë“ˆ v59 - IN/OUT ë‘ ê°€ì§€ ìƒíƒœë§Œ ì‚¬ìš© -->
  <script src="archive/table-management-v59.js?v=3.0.0" defer></script>
  <!-- ActionHistory ì‹œìŠ¤í…œ - Phase 1 -->
  <script src="archive/action-history.js?v=3.2.5" defer></script>
  <!-- Phase 2: ë”ë¸”íƒ­ & ë°°ì¹˜ ì²˜ë¦¬ -->
  <script src="archive/double-tap-handler.js?v=3.2.5" defer></script>
  <script src="archive/batch-processor.js?v=3.2.5" defer></script>
  <!-- Phase 3: ëª¨ë°”ì¼ ìµœì í™” -->
  <script src="archive/mobile-optimizer.js?v=3.2.5" defer></script>
  <script src="archive/virtual-scroll.js?v=3.2.5" defer></script>
  <script src="archive/offline-storage.js?v=3.2.5" defer></script>
  <!-- ëª¨ë‹¬ ìë™ ë‹«ê¸° ëª¨ë“ˆ -->
  <script src="src/js/modal-auto-close.js?v=1.0.0" defer></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@700&family=Noto+Sans+KR:wght@400;500;700&display=swap');
    html, body { height: 100vh; overflow: hidden; font-family: 'Noto Sans KR', sans-serif; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
    #app-container { display: flex; flex-direction: column; height: 100%; }
    main { flex-grow: 1; overflow-y: auto; }
    .btn { /* transition removed for instant response */ }
    .btn:active { transform: scale(0.95); }
    .btn-selected { background-color: #FBBF24 !important; color: #111827 !important; font-weight: bold; }
    .card-placeholder { border: 2px dashed #4B5563; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 1px; background-color: rgba(255,255,255,0.05); flex-shrink: 0; }
    .card-display { font-family: 'Roboto', sans-serif; background-color: white; border-radius: 4px; padding: 1px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 0.8rem; }
    .card-display .rank { font-weight: bold; font-size: 1rem; }
    .modal { /* transition removed for instant popup */ backdrop-filter: blur(4px); }
    .card-selector-btn { font-family: 'Roboto', sans-serif; font-size: 1rem; font-weight: bold; }
    .card-selector-btn.card-red { color: #DC2626; }
    .card-selector-btn.card-black { color: #111827; }
    .card-selector-btn.selected { border: 3px solid #FBBF24; transform: scale(0.95); }
    .player-card.is-winner { background-color: rgba(251, 191, 36, 0.1); }
    select, input[type="text"] { font-size: 0.875rem; }
    .chip-color-sample { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #4B5563; cursor: pointer; }
    .chip-analysis-btn { font-size: 0.75rem; padding: 0.25rem 0.5rem; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .pulse-animation { animation: pulse 2s infinite; }

    /* ìŠ¤ë‚µë°” ìŠ¤íƒ€ì¼ (ëª¨ë°”ì¼ ìµœì í™”) */
    .snackbar {
      position: fixed;
      bottom: -60px;
      left: 10px;
      right: 10px;
      background: #333;
      color: white;
      padding: 12px;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: bottom 0.2s ease-out;
      z-index: 10000;
      font-size: 14px;
      max-width: 500px;
      margin: 0 auto;
    }

    .snackbar.show {
      bottom: 10px;
    }

    .snackbar-undo-btn {
      background: transparent;
      border: 1px solid white;
      color: white;
      padding: 4px 12px;
      border-radius: 3px;
      font-size: 12px;
      margin-left: 10px;
      cursor: pointer;
      min-width: 44px;
      min-height: 30px;
    }

    .snackbar-undo-btn:active {
      transform: scale(0.95);
    }

    .snackbar-info {
      background: #2563eb;
    }

    .snackbar-error {
      background: #dc2626;
    }

    .snackbar-success {
      background: #16a34a;
    }

    .snackbar-warning {
      background: #f59e0b;
    }

    /* ë”ë¸”íƒ­ ìŠ¤íƒ€ì¼ (Phase 2) */
    .double-tap-required {
      position: relative;
    }

    .double-tap-warning {
      animation: pulse 0.5s ease-in-out infinite;
      background: #f59e0b !important;
      color: white !important;
    }

    .danger-critical {
      background: #dc2626 !important;
      color: white !important;
    }

    .danger-warning {
      background: #f59e0b !important;
      color: white !important;
    }

    .executing {
      opacity: 0.6;
      pointer-events: none;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }
  </style>
</head>
<body class="bg-gray-900 text-white antialiased">
  <div id="app-container">
    <!-- ë²„ì „ í‘œì‹œ í—¤ë” -->
    <div class="bg-gray-900 border-b border-gray-700 px-3 py-1">
      <div class="flex justify-between items-center text-xs">
        <span class="font-bold text-amber-400">í¬ì»¤ í•¸ë“œ ë¡œê±°</span>
        <div class="flex items-center gap-2">
          <button id="settings-btn" class="text-gray-400 hover:text-amber-400" title="ì„¤ì •">
            âš™ï¸
          </button>
          <span id="version-display" class="text-gray-400">v2.26.6</span>
        </div>
      </div>
    </div>
    <main class="p-2 space-y-2">
      <div class="bg-gray-800 p-2 rounded-lg space-y-2">
        <div class="flex items-center gap-2 text-sm">
          <div class="flex-1 flex items-center gap-1 bg-gray-700 p-1 rounded-md min-w-0">
            <span id="hand-number-display" class="font-bold px-1 whitespace-nowrap">#--</span>
            <button id="load-hand-btn" class="btn bg-gray-600 px-2 py-1 rounded-md text-xs">Load</button>
            <label class="flex items-center gap-1 text-xs ml-2">
              <input type="checkbox" id="smart-mode-toggle" checked class="h-3 w-3">
              <span>Smart</span>
            </label>
          </div>
          <div class="flex-1 min-w-0">
            <button id="table-selector-btn" class="w-full bg-gray-700 border border-gray-600 rounded-md px-2 py-1 text-left flex items-center justify-between hover:bg-gray-600">
              <span id="selected-table-display">í…Œì´ë¸” ì„ íƒ</span>
              <span class="text-gray-400">â–¼</span>
            </button>
          </div>
          <div class="flex-1 flex items-center gap-1 min-w-0">
            <select id="timezone-selector" class="flex-grow bg-gray-700 border border-gray-600 rounded-md px-2 py-1 text-xs"></select>
            <span id="time-display" class="bg-gray-900/50 p-1 rounded-md font-mono text-xs"></span>
          </div>
          <div class="flex items-center gap-1">
            <button id="manage-players-btn" class="btn bg-gray-600 hover:bg-gray-700 px-2 py-1 rounded-md text-xs">ê´€ë¦¬</button>
            <button id="refresh-data" class="text-lg" title="ë°ì´í„° ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div class="text-xs text-gray-300 flex items-center gap-2">
            <button id="cam-btn-1" class="btn bg-gray-700 px-2 py-1 rounded"></button>
            <button id="cam-btn-2" class="btn bg-gray-700 px-2 py-1 rounded"></button>
          </div>
          <div class="text-right text-xs text-gray-400">
            <span id="data-stamp"></span>
          </div>
        </div>
        <!-- ì¢Œì„ ë°°ì¹˜ ë° í”Œë ˆì´ì–´ ì„ íƒ (1x11 ê·¸ë¦¬ë“œ) -->
        <div class="bg-gray-700 p-2 rounded-lg">
          <div id="seat-buttons" class="grid grid-cols-11 gap-1">
            <!-- 10ê°œ ì¢Œì„ + ë²„íŠ¼ ë“œë¡­ë‹¤ìš´ (11ë²ˆì§¸) -->
          </div>
          <div id="position-indicators" class="text-xs text-gray-400 mt-1 text-center">
            <!-- SB, BB í‘œì‹œ -->
          </div>
          <div id="position-display" class="mt-1 text-xs">
            <!-- ë²„íŠ¼ ìœ„ì¹˜ ìƒì„¸ í‘œì‹œ -->
          </div>
        </div>
      </div>

      <div id="player-details-section" class="bg-gray-800 p-2 rounded-lg space-y-1"></div>

      <div class="bg-gray-800 p-2 rounded-lg space-y-2">
        <div class="flex flex-wrap items-center gap-2">
          <div class="flex items-center gap-1">
            <button id="small-blind-btn" data-purpose="smallBlind" class="btn bg-gray-700 p-1 rounded-md text-sm min-w-[60px]">0</button>
            <button id="big-blind-btn" data-purpose="bigBlind" class="btn bg-gray-700 p-1 rounded-md text-sm min-w-[60px]">0</button>
            <div class="flex items-center">
              <input id="bb-ante-checkbox" type="checkbox" class="h-4 w-4 bg-gray-700 border-gray-600 rounded text-amber-500">
              <label for="bb-ante-checkbox" class="ml-1 text-xs">Ante</label>
            </div>
          </div>
          <div id="board-card-placeholders" class="flex flex-wrap gap-1 items-center flex-grow justify-end"></div>
        </div>
        <div class="space-y-1" id="street-logs-container"></div>
        
        <!-- í˜„ì¬ ì°¨ë¡€ í‘œì‹œ & ë¹ ë¥¸ ì•¡ì…˜ ë²„íŠ¼ (ìë™ ëª¨ë“œ) -->
        <div id="current-turn-indicator" class="hidden mt-2 p-2 bg-gray-700 rounded-md">
          <div class="text-center text-sm mb-2">
            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
          </div>
          <div id="quick-action-buttons" class="grid grid-cols-5 gap-1">
            <button onclick="addAutoAction('Checks')" class="btn bg-green-600 hover:bg-green-500 text-white text-xs py-1 px-2 rounded">
              ì²´í¬
            </button>
            <button onclick="handleSmartCall()" class="btn bg-blue-600 hover:bg-blue-500 text-white text-xs py-1 px-2 rounded">
              ì½œ
            </button>
            <button onclick="openQuickBetRaise()" class="btn bg-orange-600 hover:bg-orange-500 text-white text-xs py-1 px-2 rounded">
              ë²³/ë ˆì´ì¦ˆ
            </button>
            <button onclick="addAutoAction('Folds')" class="btn bg-red-600 hover:bg-red-500 text-white text-xs py-1 px-2 rounded">
              í´ë“œ
            </button>
            <button onclick="handleAllIn()" class="btn bg-purple-600 hover:bg-purple-500 text-white text-xs py-1 px-2 rounded">
              ì˜¬ì¸
            </button>
          </div>
        </div>
      </div>


      <div class="bg-gray-800 p-2 rounded-lg space-y-2">
        <div class="flex flex-wrap gap-1 items-center">
          <span class="text-sm font-bold mr-2">ìŠ¹ì:</span>
          <div id="winner-buttons" class="flex flex-wrap gap-1 flex-grow"></div>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <button id="reset-btn" class="w-full btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-3 rounded-md text-sm">ìƒˆ í•¸ë“œ</button>
          <button id="send-to-sheet-btn" class="w-full btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-md text-sm">ì‹œíŠ¸ ì „ì†¡</button>
        </div>
        <p id="feedback-message" class="text-center h-4 text-xs font-semibold"></p>
      </div>

    </main>
    <footer class="flex-shrink-0 p-1 text-center">
      <button id="show-log-btn" class="text-gray-500 hover:text-gray-300 text-xs">ë¡œê·¸ ë³´ê¸°</button>
    </footer>
  </div>

  <!-- Modals -->
  <div id="card-selector-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-2 z-50 hidden opacity-0"></div>
  <div id="action-pad-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0"></div>
  <div id="keypad-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0"></div>
  <div id="load-hand-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0"></div>
  <!-- ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="registration-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
    <div class="bg-gray-800 rounded-lg p-4 max-w-lg w-full max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-amber-400">ê´€ë¦¬ ì„¤ì •</h2>
        <button id="close-registration-modal" class="text-2xl hover:text-gray-400">&times;</button>
      </div>

      <!-- ë©”ì¸ ê´€ë¦¬ ë²„íŠ¼ë“¤ -->
      <div id="management-menu" class="space-y-3 mb-4">
        <!-- ë²„íŠ¼ë“¤ -->
        <div class="grid grid-cols-2 gap-3">
          <button id="open-table-management-btn" class="bg-blue-600 hover:bg-blue-700 py-3 px-4 rounded-lg text-sm font-medium flex flex-col items-center">
            <span class="text-2xl mb-1">ğŸ¯</span>
            <span>í…Œì´ë¸” ì„ íƒ</span>
          </button>
          <button class="bg-gray-700 py-3 px-4 rounded-lg text-sm font-medium flex flex-col items-center opacity-50 cursor-not-allowed" disabled>
            <span class="text-2xl mb-1">ğŸ²</span>
            <span>ì¹© ê´€ë¦¬</span>
            <span class="text-xs text-gray-400">(ì¤€ë¹„ ì¤‘)</span>
          </button>
        </div>

        <!-- Apps Script URL ì„¤ì • -->
        <div class="bg-gray-700 p-3 rounded-lg">
          <label class="block text-sm font-medium text-gray-300 mb-2">
            Apps Script URL
            <span class="text-xs text-gray-500 ml-2">(ì¬ë°°í¬ í›„ ìƒˆ URL ì…ë ¥)</span>
          </label>
          <div class="space-y-2">
            <!-- í˜„ì¬ ì €ì¥ëœ URL í‘œì‹œ -->
            <div id="current-url-display" class="bg-gray-800 p-2 rounded border border-gray-600">
              <div class="text-xs text-gray-400 mb-1">í˜„ì¬ ì €ì¥ëœ URL:</div>
              <div id="management-current-url" class="text-xs text-amber-400 break-all font-mono"></div>
            </div>

            <!-- ì¬ë°°í¬ ì•ˆë‚´ ë©”ì‹œì§€ -->
            <div class="bg-blue-900 border border-blue-700 p-2 rounded text-xs">
              <div class="text-blue-300 font-semibold mb-1">ğŸ“Œ Apps Script ì¬ë°°í¬ í•„ìš”</div>
              <div class="text-blue-200">
                "Unknown action: batchUpdate" ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´:
                <ol class="list-decimal list-inside mt-1 text-blue-100">
                  <li>apps-script/Code_v59_InOut.gs íŒŒì¼ ë³µì‚¬</li>
                  <li>Google Apps Scriptì— ë¶™ì—¬ë„£ê¸°</li>
                  <li>ë°°í¬ â†’ ìƒˆ ë°°í¬ ê´€ë¦¬ â†’ í¸ì§‘ â†’ ë²„ì „: ìƒˆ ë²„ì „</li>
                  <li>ìƒˆ URLì„ ì•„ë˜ì— ì…ë ¥í•˜ì—¬ ì €ì¥</li>
                </ol>
              </div>
            </div>

            <!-- URL ì…ë ¥ -->
            <input type="text" id="management-apps-url-input"
                   class="w-full bg-gray-600 text-white rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500"
                   placeholder="ìƒˆ URLì„ ì…ë ¥í•˜ì„¸ìš”">

            <!-- ì €ì¥ ë²„íŠ¼ -->
            <button id="save-apps-url-btn" class="w-full bg-amber-600 hover:bg-amber-700 py-1.5 rounded text-sm font-medium">
              ğŸ’¾ ìƒˆ URL ì €ì¥
            </button>

            <!-- ì €ì¥ ìƒíƒœ ë©”ì‹œì§€ -->
            <div id="url-save-status" class="hidden text-xs p-2 rounded"></div>
          </div>
        </div>
      </div>

      <!-- í…Œì´ë¸” ê´€ë¦¬ ì„¹ì…˜ (ì´ˆê¸°ì— ìˆ¨ê¹€) -->
      <div id="player-management-content" class="space-y-3 hidden">
          <!-- ì„ íƒëœ í…Œì´ë¸” ì •ë³´ -->
          <div class="bg-gray-700 p-3 rounded-lg">
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-sm font-bold text-amber-400">ì„ íƒëœ í…Œì´ë¸”</h4>
              <span id="sync-status" class="text-xs text-gray-400"></span>
            </div>
            <div id="selected-table-info" class="text-sm">
              <span id="selected-table-name" class="text-amber-400 font-bold"></span>
              <button id="change-table-btn" class="ml-2 text-xs bg-gray-600 hover:bg-gray-500 px-2 py-1 rounded">ë³€ê²½</button>
            </div>
          </div>

          <!-- ìƒˆ í”Œë ˆì´ì–´ ì¶”ê°€ ì„¹ì…˜ -->
          <div id="player-add-section" class="bg-gray-700 p-3 rounded-lg hidden">
            <h4 class="text-sm font-bold mb-2 text-amber-400">í”Œë ˆì´ì–´ ì¶”ê°€</h4>
            <div class="grid grid-cols-3 gap-2 mb-2">
              <input type="text" id="new-player-name" class="bg-gray-600 px-2 py-1 rounded text-sm" placeholder="ì´ë¦„">
              <input type="number" id="new-player-seat" class="bg-gray-600 px-2 py-1 rounded text-sm" placeholder="ì¢Œì„" min="1" max="10">
              <input type="text" id="new-player-chips" class="bg-gray-600 px-2 py-1 rounded text-sm" placeholder="ì¹©">
            </div>
            <button id="add-player-local-btn" class="w-full bg-green-600 hover:bg-green-700 py-1 rounded text-sm">+ ì¶”ê°€</button>
          </div>

          <!-- í˜„ì¬ í”Œë ˆì´ì–´ ëª©ë¡ (10ê°œ ì‹œíŠ¸ ê³ ì •) -->
          <div id="player-list-section" class="bg-gray-700 p-3 rounded-lg hidden">
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-sm font-bold text-amber-400">í”Œë ˆì´ì–´ ì‹œíŠ¸</h4>
              <span id="player-count" class="text-xs text-amber-300"></span>
            </div>
            <div id="current-players-list" class="h-auto">
              <!-- 10ê°œ ì‹œíŠ¸ê°€ ê³ ì •ìœ¼ë¡œ í‘œì‹œë¨ -->
            </div>
          </div>

          <!-- ì¼ê´„ ë“±ë¡ ë²„íŠ¼ -->
          <div id="batch-actions" class="hidden">
            <div class="flex gap-2 mb-2">
              <button id="reset-changes-btn" class="flex-1 bg-gray-600 hover:bg-gray-700 py-2 rounded text-sm">
                â†©ï¸ ë³€ê²½ ì·¨ì†Œ
              </button>
              <button id="batch-register-btn" class="flex-1 bg-amber-600 hover:bg-amber-700 py-2 rounded text-sm font-bold">
                âœ… ì¼ê´„ ë“±ë¡
              </button>
            </div>
            <div id="changes-summary" class="mt-2 text-xs text-gray-400"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="log-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
    <div class="bg-gray-800 rounded-lg p-4 w-full max-w-lg h-2/3 flex flex-col">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-xl font-bold text-amber-400">ë¡œë”© ë¡œê·¸</h2>
        <button id="close-log-modal" class="text-2xl">&times;</button>
      </div>
      <div id="log-display" class="bg-gray-900/50 p-3 rounded-md flex-grow overflow-y-auto text-sm font-mono"></div>
    </div>
  </div>

  <!-- ì¹© ì»¬ëŸ¬ ì„ íƒ ëª¨ë‹¬ (ì¹´ë©”ë¼ ë˜ëŠ” íŒŒì¼) -->
  <div id="chip-color-modal" class="modal fixed inset-0 bg-black bg-opacity-75 hidden z-50">
    <div class="flex items-center justify-center h-full p-4">
      <div class="bg-gray-800 rounded-lg p-4 max-w-md w-full">
        <h3 class="text-lg font-bold mb-3 text-amber-400">ì¹© ë“±ë¡</h3>
        
        <!-- ì„ íƒ ì˜µì…˜ -->
        <div id="chip-option-select" class="mb-4">
          <p class="text-sm text-gray-300 mb-3">ì¹© ì‚¬ì§„ì„ ì¶”ê°€í•˜ëŠ” ë°©ë²•ì„ ì„ íƒí•˜ì„¸ìš”:</p>
          <div class="grid grid-cols-2 gap-2">
            <button id="select-camera-btn" class="bg-blue-600 hover:bg-blue-700 p-3 rounded-lg flex flex-col items-center">
              <span class="text-2xl mb-1">ğŸ“·</span>
              <span class="text-sm">ì‚¬ì§„ ì´¬ì˜</span>
            </button>
            <button id="select-file-btn" class="bg-purple-600 hover:bg-purple-700 p-3 rounded-lg flex flex-col items-center">
              <span class="text-2xl mb-1">ğŸ“</span>
              <span class="text-sm">íŒŒì¼ ì„ íƒ</span>
            </button>
          </div>
        </div>
        
        <!-- ì¹´ë©”ë¼ ë·° (ìˆ¨ê¹€ ìƒíƒœ) -->
        <div id="camera-view" class="hidden">
          <video id="chip-video" class="w-full rounded-lg mb-3" autoplay playsinline></video>
          <canvas id="chip-canvas" class="hidden"></canvas>
        </div>
        
        <!-- ì´ë¯¸ì§€ í”„ë¦¬ë·° (ìˆ¨ê¹€ ìƒíƒœ) -->
        <div id="image-preview" class="hidden">
          <img id="preview-img" class="w-full rounded-lg mb-3" alt="ë¯¸ë¦¬ë³´ê¸°">
        </div>
        
        <!-- íŒŒì¼ ì…ë ¥ (ìˆ¨ê¹€) -->
        <input type="file" id="file-input" class="hidden" accept="image/*">
        
        <!-- ì¹© ê°’ ì…ë ¥ -->
        <input type="text" id="chip-value-input" class="w-full bg-gray-700 px-3 py-2 rounded mb-3" placeholder="ì¹© ê°’ (ì˜ˆ: 1000)">
        
        <!-- ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
        <div class="flex gap-2">
          <button id="capture-chip-btn" class="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded-lg font-medium hidden">ì´¬ì˜</button>
          <button id="confirm-chip-btn" class="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded-lg font-medium hidden">í™•ì¸</button>
          <button id="retry-chip-btn" class="flex-1 bg-yellow-600 hover:bg-yellow-700 py-2 rounded-lg font-medium hidden">ë‹¤ì‹œì„ íƒ</button>
          <button id="close-chip-modal" class="flex-1 bg-gray-600 hover:bg-gray-700 py-2 rounded-lg font-medium">ì·¨ì†Œ</button>
        </div>
        
        <!-- ì•ˆë‚´ ë©”ì‹œì§€ -->
        <div id="chip-info-message" class="mt-3 text-xs text-gray-400 text-center">
          ğŸ’¡ PCì—ì„œëŠ” íŒŒì¼ ì„ íƒ, ëª¨ë°”ì¼ì—ì„œëŠ” ì¹´ë©”ë¼ ì´¬ì˜ì„ ê¶Œì¥í•©ë‹ˆë‹¤
        </div>
      </div>
    </div>
  </div>

  <!-- ì¹© ìŠ¤íƒ ë¶„ì„ ëª¨ë‹¬ -->
  <div id="stack-analysis-modal" class="modal fixed inset-0 bg-black bg-opacity-75 hidden z-50">
    <div class="flex items-center justify-center h-full p-4">
      <div class="bg-gray-800 rounded-lg p-4 max-w-lg w-full max-h-[90vh] overflow-y-auto">
        <h3 class="text-lg font-bold mb-3 text-amber-400">
          <span id="analyzing-player-name">í”Œë ˆì´ì–´</span> ì¹© ìŠ¤íƒ ë¶„ì„
        </h3>
        <div id="stack-images-container" class="grid grid-cols-2 gap-2 mb-3"></div>
        <video id="stack-video" class="w-full rounded-lg mb-3" autoplay playsinline></video>
        <canvas id="stack-canvas" class="hidden"></canvas>
        <div class="flex gap-2 mb-3">
          <button id="capture-stack-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded-lg font-medium">ì‚¬ì§„ ì¶”ê°€</button>
          <button id="analyze-stack-btn" class="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded-lg font-medium" disabled>AI ë¶„ì„</button>
        </div>
        <button id="close-stack-modal" class="w-full bg-gray-600 hover:bg-gray-700 py-2 rounded-lg font-medium">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- AI ë¶„ì„ ì¤‘ ì˜¤ë²„ë ˆì´ -->
  <div id="analyzing-overlay" class="fixed inset-0 bg-black bg-opacity-80 hidden z-[60]">
    <div class="flex items-center justify-center h-full">
      <div class="bg-gray-900 rounded-lg p-6 text-center">
        <div class="text-3xl mb-3 pulse-animation">ğŸ¤–</div>
        <p class="text-lg font-medium mb-2">AI ë¶„ì„ ì¤‘...</p>
        <p class="text-sm text-gray-400">ì¹© ìŠ¤íƒì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤</p>
      </div>
    </div>
  </div>

  <!-- í…Œì´ë¸” ì„ íƒ ëª¨ë‹¬ -->
  <div id="table-selector-modal" class="modal fixed inset-0 bg-black bg-opacity-75 hidden z-50">
    <div class="flex items-center justify-center h-full p-2">
      <div class="bg-gray-800 rounded-lg w-full max-w-md h-full max-h-screen flex flex-col">
        <!-- í—¤ë” -->
        <div class="flex items-center justify-between p-4 border-b border-gray-700">
          <h3 class="text-lg font-bold text-amber-400">ğŸ¯ í…Œì´ë¸” ì„ íƒ</h3>
          <button id="close-table-selector" class="text-gray-400 hover:text-white text-xl">Ã—</button>
        </div>
        
        <!-- ê²€ìƒ‰ ë° í•„í„° -->
        <div class="p-4 border-b border-gray-700">
          <input type="text" id="table-search" placeholder="í…Œì´ë¸” ë²ˆí˜¸ ë˜ëŠ” í”Œë ˆì´ì–´ ê²€ìƒ‰..." 
                 class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm mb-3">
          <div class="flex gap-2 flex-wrap">
            <button id="filter-all" class="filter-btn px-3 py-1 rounded-full text-xs bg-blue-600 text-white">ì „ì²´</button>
            <button id="filter-active" class="filter-btn px-3 py-1 rounded-full text-xs bg-gray-600 hover:bg-gray-500">í™œì„±</button>
            <button id="filter-empty" class="filter-btn px-3 py-1 rounded-full text-xs bg-gray-600 hover:bg-gray-500">ë¹ˆí…Œì´ë¸”</button>
          </div>
        </div>
        
        <!-- í˜ì´ì§€ í† ê¸€ -->
        <div class="px-4 py-2 border-b border-gray-700">
          <div class="flex items-center justify-between">
            <button id="prev-page" class="px-3 py-1 bg-gray-600 rounded hover:bg-gray-500 disabled:opacity-50">â—€</button>
            <span id="page-info" class="text-sm text-gray-400">1-20 / 100</span>
            <button id="next-page" class="px-3 py-1 bg-gray-600 rounded hover:bg-gray-500 disabled:opacity-50">â–¶</button>
          </div>
        </div>
        
        <!-- í…Œì´ë¸” ê·¸ë¦¬ë“œ -->
        <div class="flex-1 overflow-y-auto p-4">
          <div id="table-grid" class="grid grid-cols-4 gap-2">
            <!-- í…Œì´ë¸” ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— ë™ì  ìƒì„±ë©ë‹ˆë‹¤ -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ì„¤ì • ëª¨ë‹¬ -->
  <div id="settings-modal" class="modal fixed inset-0 bg-black bg-opacity-75 hidden z-50">
    <div class="flex items-center justify-center h-full p-4">
      <div class="bg-gray-800 rounded-lg w-full max-w-lg">
        <!-- í—¤ë” -->
        <div class="flex items-center justify-between p-4 border-b border-gray-700">
          <h3 class="text-lg font-bold text-amber-400">âš™ï¸ ì„¤ì •</h3>
          <button id="close-settings" class="text-gray-400 hover:text-white text-xl">Ã—</button>
        </div>
        
        <!-- ì„¤ì • ë‚´ìš© -->
        <div class="p-4 space-y-4">
          <!-- Apps Script URL ì„¤ì • -->
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">
              Apps Script URL
              <span class="text-xs text-gray-500 ml-2">(ì¬ë°°í¬ í›„ ìƒˆ URL ì…ë ¥)</span>
            </label>
            <div class="space-y-2">
              <input type="text" id="apps-script-url-input"
                     class="w-full bg-gray-700 text-white rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500"
                     placeholder="https://script.google.com/macros/s/.../exec">
              <div class="text-xs text-gray-500">
                í˜„ì¬: <span id="current-apps-url" class="text-gray-400 break-all"></span>
              </div>

              <!-- í´ë¼ìš°ë“œ ë™ê¸°í™” ìƒíƒœ -->
              <div class="bg-gray-700 rounded-md p-3 space-y-2">
                <div class="flex items-center justify-between">
                  <span class="text-xs font-medium text-gray-300">â˜ï¸ í´ë¼ìš°ë“œ ë™ê¸°í™”</span>
                  <span id="cloud-sync-status" class="text-xs px-2 py-1 rounded-full bg-gray-600 text-gray-400">í™•ì¸ ì¤‘...</span>
                </div>
                <div class="text-xs text-gray-500 space-y-1">
                  <div>ê¸°ê¸° ID: <span id="device-id-display" class="text-gray-400 font-mono text-xs"></span></div>
                  <div id="last-sync-display" class="hidden">ë§ˆì§€ë§‰ ë™ê¸°í™”: <span class="text-gray-400"></span></div>
                </div>
                <div class="flex space-x-2">
                  <button id="sync-now-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-xs py-1.5 px-3 rounded transition-colors">
                    ğŸ”„ ì§€ê¸ˆ ë™ê¸°í™”
                  </button>
                  <button id="reset-cloud-btn" class="bg-gray-600 hover:bg-gray-500 text-white text-xs py-1.5 px-3 rounded transition-colors">
                    ğŸ—‘ï¸ ì´ˆê¸°í™”
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- ì¹© ìŠ¤íƒ ê²€ì¦ ì„¤ì • -->
          <div>
            <label class="flex items-center space-x-2">
              <input type="checkbox" id="chip-validation-toggle" class="rounded text-amber-500 focus:ring-amber-500">
              <span class="text-sm font-medium text-gray-300">ì¹© ìŠ¤íƒ ê²€ì¦ í™œì„±í™”</span>
            </label>
            <p class="text-xs text-gray-500 mt-1 ml-6">
              í™œì„±í™” ì‹œ ë³´ìœ  ì¹©ë³´ë‹¤ í° ê¸ˆì•¡ ì…ë ¥ì„ ì œí•œí•©ë‹ˆë‹¤
            </p>
          </div>
          
          <!-- ì•¡ì…˜ ì…ë ¥ ëª¨ë“œ ì„¤ì • -->
          <div>
            <label class="flex items-center space-x-2">
              <input type="checkbox" id="action-input-mode-toggle" class="rounded text-amber-500 focus:ring-amber-500">
              <span class="text-sm font-medium text-gray-300">ìë™ ì•¡ì…˜ ë§¤í•‘ ëª¨ë“œ</span>
            </label>
            <p class="text-xs text-gray-500 mt-1 ml-6">
              í™œì„±í™” ì‹œ ì•¡ì…˜ì´ ìˆœì„œëŒ€ë¡œ ìë™ ë§¤í•‘ë©ë‹ˆë‹¤ (í”Œë ˆì´ì–´ ì„ íƒ ë¶ˆí•„ìš”)
            </p>
          </div>
          
          <!-- ë²„ì „ ì •ë³´ -->
          <div class="pt-2 border-t border-gray-700">
            <div class="text-xs text-gray-500 space-y-1">
              <div>ë²„ì „: <span class="text-gray-400">${APP_VERSION}</span></div>
              <div>ì—…ë°ì´íŠ¸: <span class="text-gray-400">${VERSION_DATE}</span></div>
              <div>Sheet ID: <span class="text-gray-400 text-xs">1J-lf8bYTLPbpdhieUNdb8ckW_uwdQ3MtSBLmyRIwH7U</span></div>
            </div>
          </div>
        </div>
        
        <!-- í‘¸í„° -->
        <div class="flex justify-end gap-2 p-4 border-t border-gray-700">
          <button id="cancel-settings" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md text-sm font-medium">
            ì·¨ì†Œ
          </button>
          <button id="save-settings" class="px-4 py-2 bg-amber-600 hover:bg-amber-500 rounded-md text-sm font-medium">
            ì €ì¥
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
  /**
   * ============================================
   * í¬ì»¤ í•¸ë“œ ë¡œê±° - Main JavaScript
   * ë²„ì „ ê´€ë¦¬ëŠ” APP_VERSION ìƒìˆ˜ë¥¼ í†µí•´ ì¤‘ì•™í™”ë¨
   * Author: garimto81 with Claude
   * ============================================
   */
  
  // ========================================
  // ì¤‘ì•™ ë²„ì „ ê´€ë¦¬ ì‹œìŠ¤í…œ
  // ========================================
  const APP_VERSION = 'v3.4.17';
  const VERSION_DATE = '2025-09-18';
  const VERSION_INFO = `í¬ì»¤ í•¸ë“œ ë¡œê±° ${APP_VERSION} (${VERSION_DATE})`;

  // ========================================
  // ìŠ¤íŠ¸ë¦¿ ìë™ ì§„í–‰ ì‹œìŠ¤í…œ v2.0 - ì™„ë²½í•œ ë³´ì•ˆ êµ¬í˜„
  // ========================================

  // Layer 1: ì‹œí€€ìŠ¤ ê¸°ë°˜ íƒ€ì„ìŠ¤íƒ¬í”„ (ë¡œê¹… ì „ìš©)
  class SequentialTimekeeper {
    constructor() {
      this.sequence = 0;
      this.lastTimestamp = Date.now();
    }

    generateTimestamp() {
      const now = Date.now();
      this.sequence++;

      // ë¡œê¹…ë§Œ í•˜ê³  í•­ìƒ ìœ íš¨í•œ íƒ€ì„ìŠ¤íƒ¬í”„ ë°˜í™˜
      console.log(`ì•¡ì…˜ íƒ€ì„ìŠ¤íƒ¬í”„: #${this.sequence} at ${new Date(now).toLocaleTimeString()}`);

      return {
        sequence: this.sequence,
        timestamp: now,
        hash: this.hashTimestamp(this.sequence, now)
      };
    }

    validateAndUpdate(actionTimestamp) {
      // í•­ìƒ true ë°˜í™˜ - ëª¨ë“  ì•¡ì…˜ í—ˆìš©
      this.lastTimestamp = actionTimestamp.timestamp;
      return true;
    }

    hashTimestamp(sequence, timestamp) {
      return btoa(`${sequence}-${timestamp}-${window.location.hostname}`);
    }
  }

  // Layer 2: íŠ¸ë˜í”½ ëª¨ë‹ˆí„°ë§ (ë¡œê¹… ì „ìš©)
  class RateLimiter {
    constructor() {
      this.attempts = new Map();
      this.actionCount = 0;
    }

    check(playerId, actionType = 'action') {
      const now = Date.now();
      const window = 1000;

      // ì•¡ì…˜ ì¹´ìš´íŠ¸ ì¦ê°€
      this.actionCount++;

      // í†µê³„ ë¡œê¹…ë§Œ
      const key = `${playerId}-${Math.floor(now / window)}`;
      const attempts = this.attempts.get(key) || 0;
      this.attempts.set(key, attempts + 1);

      if (attempts >= 3) {
        console.log(`ë¹ ë¥¸ ì•¡ì…˜ ê°ì§€: ${playerId} - ${attempts + 1}íšŒ/ì´ˆ`);
      }

      // ì˜¤ë˜ëœ ê¸°ë¡ ì •ë¦¬
      if (this.attempts.size > 100) {
        const oldKeys = Array.from(this.attempts.keys()).slice(0, 50);
        oldKeys.forEach(k => this.attempts.delete(k));
      }

      // í•­ìƒ true ë°˜í™˜ - ëª¨ë“  ì•¡ì…˜ í—ˆìš©
      return true;
    }
  }

  // Layer 3: ìƒíƒœ ëª¨ë‹ˆí„°ë§ (ìë™ ì ì‘)
  class StateValidator {
    constructor() {
      this.knownPlayers = new Set();
      this.stateHash = null;
    }

    initialize(players) {
      // ì´ˆê¸° í”Œë ˆì´ì–´ ë“±ë¡
      players.forEach(p => this.knownPlayers.add(p.name));
      this.stateHash = this.calculateHash(players);
    }

    validatePlayer(playerName) {
      // ìƒˆ í”Œë ˆì´ì–´ ìë™ ì¶”ê°€
      if (!this.knownPlayers.has(playerName)) {
        console.log(`ìƒˆ í”Œë ˆì´ì–´ ìë™ ë“±ë¡: ${playerName}`);
        this.knownPlayers.add(playerName);

        // playersInHandì—ë„ ìë™ ì¶”ê°€
        if (!window.state.playersInHand.find(p => p.name === playerName)) {
          window.state.playersInHand.push({
            name: playerName,
            chips: '100000', // ê¸°ë³¸ ì¹©
            initialChips: '100000',
            hand: [],
            role: null
          });
        }
      }
      return true; // í•­ìƒ true ë°˜í™˜
    }

    validateState(state) {
      // ìƒíƒœ ë¡œê¹…ë§Œ
      console.log(`í˜„ì¬ í”Œë ˆì´ì–´ ìˆ˜: ${state.playersInHand.length}`);
      return true; // í•­ìƒ true ë°˜í™˜
    }

    updateState() {
      // ìƒíƒœ ì—…ë°ì´íŠ¸ (ë¡œê¹…ìš©)
      console.log('ìƒíƒœ ì—…ë°ì´íŠ¸');
      return true;
    }

    calculateHash(data) {
      return JSON.stringify(data).split('').reduce((a, b) => {
        a = ((a << 5) - a) + b.charCodeAt(0);
        return a & a;
      }, 0).toString(16);
    }
  }

  // ë©”ì¸ ì•¡ì…˜ ê´€ë¦¬ì (ê¸°ì¡´ + ë³´ì•ˆ ê°•í™”)
  class ActionOrderManager {
    constructor() {
      this.currentStreet = 'preflop';
      this.currentPlayerIndex = 0;
      this.actionMode = 'auto'; // 'auto' | 'manual'
      this.actionQueue = [];
      this.bettingRoundComplete = false;

      // ë³´ì•ˆ ë ˆì´ì–´ ì¶”ê°€
      this.timekeeper = new SequentialTimekeeper();
      this.rateLimiter = new RateLimiter();
      this.stateValidator = new StateValidator();

      // ì•¡ì…˜ ë®¤í…ìŠ¤ (ë™ì‹œ ì‹¤í–‰ ë°©ì§€)
      this.isProcessing = false;
    }

    // í¬ì§€ì…˜ë³„ ì•¡ì…˜ ìˆœì„œ ê³„ì‚°
    calculateActionOrder(street) {
      const playersInHand = window.state.playersInHand || [];
      if (playersInHand.length === 0) return [];

      const buttonPosition = parseInt(window.state.buttonPosition) || 1;
      const activePlayers = this.getActivePlayers(playersInHand);

      if (street === 'preflop') {
        return this.getPreflopOrder(activePlayers, buttonPosition);
      } else {
        return this.getPostflopOrder(activePlayers, buttonPosition);
      }
    }

    // í™œì„± í”Œë ˆì´ì–´ í•„í„°ë§ (í´ë“œ/ì˜¬ì¸ ì œì™¸)
    getActivePlayers(players) {
      return players.filter(p =>
        window.state.playerStatus[p.name] !== 'folded' &&
        window.state.playerStatus[p.name] !== 'allin'
      );
    }

    // í”„ë¦¬í”Œë ìˆœì„œ (UTG â†’ BTN â†’ SB â†’ BB)
    getPreflopOrder(players, buttonPosition) {
      if (players.length === 0) return [];

      const seatMap = {};
      players.forEach(p => {
        if (p.seat) seatMap[p.seat] = p;
      });

      const occupiedSeats = Object.keys(seatMap).map(Number).sort((a, b) => a - b);
      const order = [];

      // UTGë¶€í„° ì‹œì‘í•˜ì—¬ BTNê¹Œì§€
      let utgSeat = this.getNextOccupiedSeat(buttonPosition, occupiedSeats);
      if (occupiedSeats.length > 2) {
        utgSeat = this.getNextOccupiedSeat(utgSeat, occupiedSeats); // SB ìŠ¤í‚µ
        utgSeat = this.getNextOccupiedSeat(utgSeat, occupiedSeats); // BB ìŠ¤í‚µ
      }

      let currentSeat = utgSeat;
      const visited = new Set();

      while (!visited.has(currentSeat) && order.length < players.length) {
        visited.add(currentSeat);
        if (seatMap[currentSeat]) {
          order.push(seatMap[currentSeat]);
        }
        currentSeat = this.getNextOccupiedSeat(currentSeat, occupiedSeats);

        // BTNê¹Œì§€ ë„ë‹¬í–ˆìœ¼ë©´ SB, BB ì¶”ê°€
        if (currentSeat === buttonPosition) {
          if (seatMap[currentSeat]) order.push(seatMap[currentSeat]);

          // SB ì¶”ê°€
          const sbSeat = this.getNextOccupiedSeat(buttonPosition, occupiedSeats);
          if (seatMap[sbSeat]) order.push(seatMap[sbSeat]);

          // BB ì¶”ê°€
          const bbSeat = this.getNextOccupiedSeat(sbSeat, occupiedSeats);
          if (seatMap[bbSeat]) order.push(seatMap[bbSeat]);
          break;
        }
      }

      return order;
    }

    // í¬ìŠ¤íŠ¸í”Œë ìˆœì„œ (SB â†’ BB â†’ UTG â†’ BTN)
    getPostflopOrder(players, buttonPosition) {
      if (players.length === 0) return [];

      const seatMap = {};
      players.forEach(p => {
        if (p.seat) seatMap[p.seat] = p;
      });

      const occupiedSeats = Object.keys(seatMap).map(Number).sort((a, b) => a - b);
      const order = [];

      // SBë¶€í„° ì‹œì‘
      let sbSeat = this.getNextOccupiedSeat(buttonPosition, occupiedSeats);
      let currentSeat = sbSeat;
      const visited = new Set();

      while (!visited.has(currentSeat) && order.length < players.length) {
        visited.add(currentSeat);
        if (seatMap[currentSeat]) {
          order.push(seatMap[currentSeat]);
        }
        currentSeat = this.getNextOccupiedSeat(currentSeat, occupiedSeats);
      }

      return order;
    }

    // ë‹¤ìŒ ì ìœ ëœ ì¢Œì„ ì°¾ê¸°
    getNextOccupiedSeat(currentSeat, occupiedSeats) {
      const maxSeat = Math.max(...occupiedSeats);
      let nextSeat = currentSeat + 1;

      while (nextSeat <= maxSeat + occupiedSeats.length) {
        const seat = ((nextSeat - 1) % maxSeat) + 1;
        if (occupiedSeats.includes(seat)) {
          return seat;
        }
        nextSeat++;
      }

      return occupiedSeats[0];
    }

    // í˜„ì¬ ì•¡ì…˜í•  í”Œë ˆì´ì–´ ë°˜í™˜
    getCurrentActionPlayer() {
      if (this.actionMode === 'manual') return null;

      const actionOrder = this.calculateActionOrder(this.currentStreet);
      if (actionOrder.length === 0) return null;

      return actionOrder[this.currentPlayerIndex % actionOrder.length];
    }

    // ë‹¤ìŒ í”Œë ˆì´ì–´ë¡œ ì´ë™
    moveToNextPlayer() {
      const actionOrder = this.calculateActionOrder(this.currentStreet);
      if (actionOrder.length === 0) return null;

      this.currentPlayerIndex++;

      // ë² íŒ… ë¼ìš´ë“œ ì™„ë£Œ ì²´í¬
      if (this.currentPlayerIndex >= actionOrder.length) {
        if (this.isBettingRoundComplete()) {
          this.advanceToNextStreet();
          return null;
        } else {
          this.currentPlayerIndex = 0; // ë‹¤ì‹œ ì²˜ìŒë¶€í„°
        }
      }

      return this.getCurrentActionPlayer();
    }

    // ë² íŒ… ë¼ìš´ë“œ ì™„ë£Œ ì—¬ë¶€ ì²´í¬ (íŠ¹ìˆ˜ ì¼€ì´ìŠ¤ í¬í•¨)
    isBettingRoundComplete() {
      const actions = window.state.actionState[this.currentStreet] || [];
      const activePlayers = this.getActivePlayers(window.state.playersInHand || []);
      const allPlayers = window.state.playersInHand || [];

      // íŠ¹ìˆ˜ ì¼€ì´ìŠ¤ 1: 1ëª…ë§Œ ë‚¨ì€ ê²½ìš° (ë‚˜ë¨¸ì§€ í´ë“œ)
      if (activePlayers.length <= 1) {
        console.log('ğŸ† 1ëª…ë§Œ ë‚¨ìŒ - ë¼ìš´ë“œ ì™„ë£Œ');
        return true;
      }

      // íŠ¹ìˆ˜ ì¼€ì´ìŠ¤ 2: í—¤ì¦ˆì—…ì—ì„œ BB ì²´í¬ ì˜µì…˜
      if (allPlayers.length === 2 && this.currentStreet === 'preflop') {
        const bbPlayer = this.getBigBlindPlayer();
        const sbPlayer = this.getSmallBlindPlayer();

        if (bbPlayer && sbPlayer) {
          const bbActions = actions.filter(a => a.player === bbPlayer.name);
          const sbActions = actions.filter(a => a.player === sbPlayer.name);

          // SBê°€ ì½œí–ˆê³  BBê°€ ì²´í¬í•œ ê²½ìš°
          if (sbActions.some(a => a.action === 'Calls') &&
              bbActions.some(a => a.action === 'Checks')) {
            console.log('ğŸ¯ í—¤ì¦ˆì—… BB ì²´í¬ - ë¼ìš´ë“œ ì™„ë£Œ');
            return true;
          }
        }
      }

      // íŠ¹ìˆ˜ ì¼€ì´ìŠ¤ 3: ëª¨ë“  í™œì„± í”Œë ˆì´ì–´ê°€ ì˜¬ì¸ì¸ ê²½ìš°
      const allActiveAreAllIn = activePlayers.every(p =>
        window.state.playerStatus[p.name] === 'allin'
      );
      if (allActiveAreAllIn && activePlayers.length > 0) {
        console.log('ğŸš€ ëª¨ë“  í”Œë ˆì´ì–´ ì˜¬ì¸ - ë¼ìš´ë“œ ì™„ë£Œ');
        return true;
      }

      // ì¼ë°˜ ì¼€ì´ìŠ¤: ëª¨ë“  í”Œë ˆì´ì–´ê°€ ì•¡ì…˜í–ˆëŠ”ì§€ í™•ì¸
      const playersActed = new Set(actions.map(a => a.player));
      const allActed = activePlayers.every(p => playersActed.has(p.name));

      if (!allActed) return false;

      // ë² íŒ… ê¸ˆì•¡ì´ ë§ëŠ”ì§€ í™•ì¸
      return this.areAllBetsEqual(activePlayers, actions);
    }

    // ë¹…ë¸”ë¼ì¸ë“œ í”Œë ˆì´ì–´ ì°¾ê¸°
    getBigBlindPlayer() {
      const buttonPosition = parseInt(window.state.buttonPosition) || 1;
      const players = window.state.playersInHand || [];
      const occupiedSeats = players.map(p => p.seat).filter(s => s).map(Number).sort((a, b) => a - b);

      if (occupiedSeats.length < 2) return null;

      const sbSeat = this.getNextOccupiedSeat(buttonPosition, occupiedSeats);
      const bbSeat = this.getNextOccupiedSeat(sbSeat, occupiedSeats);

      return players.find(p => p.seat === bbSeat);
    }

    // ìŠ¤ëª°ë¸”ë¼ì¸ë“œ í”Œë ˆì´ì–´ ì°¾ê¸°
    getSmallBlindPlayer() {
      const buttonPosition = parseInt(window.state.buttonPosition) || 1;
      const players = window.state.playersInHand || [];
      const occupiedSeats = players.map(p => p.seat).filter(s => s).map(Number).sort((a, b) => a - b);

      if (occupiedSeats.length < 2) return null;

      const sbSeat = this.getNextOccupiedSeat(buttonPosition, occupiedSeats);
      return players.find(p => p.seat === sbSeat);
    }

    // ëª¨ë“  ë² íŒ…ì´ ê°™ì€ì§€ í™•ì¸ (ì‚¬ì´ë“œíŒŸ ê³ ë ¤)
    areAllBetsEqual(players, actions) {
      const playerBets = {};

      // ê° í”Œë ˆì´ì–´ì˜ ì´ ë² íŒ… ê³„ì‚°
      actions.forEach(action => {
        if (!playerBets[action.player]) playerBets[action.player] = 0;

        if (action.action.includes('Call') || action.action.includes('Raise') || action.action.includes('Bet')) {
          playerBets[action.player] = action.amount || 0;
        } else if (action.action === 'All In') {
          const player = window.state.playersInHand.find(p => p.name === action.player);
          playerBets[action.player] = player ? parseInt(unformatNumber(player.chips), 10) : 0;
        }
      });

      const bets = Object.values(playerBets);
      const maxBet = Math.max(...bets, 0);

      // ì‚¬ì´ë“œíŒŸ ì¼€ì´ìŠ¤: ì˜¬ì¸ í”Œë ˆì´ì–´ê°€ ìˆëŠ” ê²½ìš°
      const hasAllIn = players.some(p => window.state.playerStatus[p.name] === 'allin');

      if (hasAllIn) {
        // ì˜¬ì¸ í”Œë ˆì´ì–´ë“¤ì˜ ë² íŒ… ê¸ˆì•¡
        const allInAmounts = players
          .filter(p => window.state.playerStatus[p.name] === 'allin')
          .map(p => playerBets[p.name] || 0);

        // ì•¡í‹°ë¸Œ í”Œë ˆì´ì–´ë“¤ì´ ìµœì†Œí•œ ì˜¬ì¸ ê¸ˆì•¡ ì´ìƒ ë² íŒ…í–ˆëŠ”ì§€ í™•ì¸
        return players.every(p => {
          const playerBet = playerBets[p.name] || 0;
          const isAllIn = window.state.playerStatus[p.name] === 'allin';

          if (isAllIn) {
            return true; // ì˜¬ì¸ í”Œë ˆì´ì–´ëŠ” í•­ìƒ OK
          }

          // ì•¡í‹°ë¸Œ í”Œë ˆì´ì–´ëŠ” ìµœëŒ€ ë² íŒ…ê³¼ ê°™ì•„ì•¼ í•¨
          return playerBet === maxBet;
        });
      }

      // ì¼ë°˜ ì¼€ì´ìŠ¤: ëª¨ë“  ì•¡í‹°ë¸Œ í”Œë ˆì´ì–´ì˜ ë² íŒ…ì´ ê°™ì•„ì•¼ í•¨
      return players.every(p => {
        const playerBet = playerBets[p.name] || 0;
        return playerBet === maxBet;
      });
    }

    // ë‹¤ìŒ ìŠ¤íŠ¸ë¦¿ìœ¼ë¡œ ì§„í–‰ (ë³´ì•ˆ ë ˆì´ì–´ í¬í•¨)
    async advanceToNextStreet() {
      const streets = ['preflop', 'flop', 'turn', 'river'];
      const currentIndex = streets.indexOf(this.currentStreet);

      if (currentIndex < streets.length - 1) {
        const nextStreet = streets[currentIndex + 1];

        // Layer 4: ë³´ë“œ ì¹´ë“œ ê²€ì¦
        if (nextStreet !== 'preflop' && !this.checkBoardCards(nextStreet)) {
          // ë³´ë“œ ì¹´ë“œ ì…ë ¥ í”„ë¡¬í”„íŠ¸
          this.promptForBoardCards(nextStreet);
          return;
        }

        // Layer 5: íŠ¸ëœì­ì…˜ ë³´í˜¸
        const transaction = this.startTransaction();
        try {
          // íƒ€ì„ìŠ¤íƒ¬í”„ ê²€ì¦
          const timestamp = this.timekeeper.generateTimestamp();

          // ìƒíƒœ ë³€ê²½
          this.currentStreet = nextStreet;
          this.currentPlayerIndex = 0;
          window.state.currentStreet = this.currentStreet;

          // ìƒíƒœ í•´ì‹œ ì—…ë°ì´íŠ¸
          this.stateValidator.updateState();

          console.log(`%cğŸ¯ ìë™ ì§„í–‰: ${this.currentStreet.toUpperCase()}`, 'color: #10b981; font-weight: bold');
          this.showStreetAdvanceNotification();

          // íŠ¸ëœì­ì…˜ ì»¤ë°‹
          transaction.commit();
        } catch (error) {
          // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ìµœëŒ€í•œ ì§„í–‰
          console.log('ìŠ¤íŠ¸ë¦¿ ì§„í–‰ ì¤‘ ì˜ˆì™¸:', error.message);
          transaction.rollback();
          // ê·¸ë˜ë„ ìŠ¤íŠ¸ë¦¿ì€ ì§„í–‰
          this.currentStreet = nextStreet;
          this.currentPlayerIndex = 0;
          window.state.currentStreet = this.currentStreet;
          this.showStreetAdvanceNotification();
        }
      }
    }

    // ë³´ë“œ ì¹´ë“œ í™•ì¸
    checkBoardCards(street) {
      const boardCards = window.state.boardCards || {};

      switch(street) {
        case 'flop':
          return boardCards.flop1 && boardCards.flop2 && boardCards.flop3;
        case 'turn':
          return boardCards.turn;
        case 'river':
          return boardCards.river;
        default:
          return true;
      }
    }

    // ë³´ë“œ ì¹´ë“œ ì…ë ¥ í”„ë¡¬í”„íŠ¸ (v3.4.7 - ì¹´ë“œ ì„ íƒ UI ì‚¬ìš©)
    promptForBoardCards(street) {
      // ì¹´ë“œ ì„ íƒ UI ì—´ê¸° (openCardSelector ì‚¬ìš©)
      window.state.modalState.cardTarget = {
        target: 'board',
        count: street === 'flop' ? 3 : 1,
        street: street,
        player: null,
        index: street === 'turn' ? 3 : street === 'river' ? 4 : 0
      };

      // ê¸°ì¡´ ì¹´ë“œ ì„ íƒ ëª¨ë‹¬ ì‚¬ìš©
      openCardSelector();
    }

    // ë³´ë“œ ì¹´ë“œ ì €ì¥ (v3.4.7 - ì¹´ë“œ ì„ íƒ UIì™€ ì—°ë™)
    saveBoardCards(street) {
      // ì´ í•¨ìˆ˜ëŠ” ë” ì´ìƒ ì§ì ‘ í˜¸ì¶œë˜ì§€ ì•ŠìŒ
      // openCardSelectorì˜ assignCard í•¨ìˆ˜ê°€ ì²˜ë¦¬
      console.log('[v3.4.7] saveBoardCardsëŠ” deprecated - assignCard ì‚¬ìš©');
    }

    // ë³´ë“œ ì¹´ë“œ ê±´ë„ˆë›°ê¸° (v3.4.7 - ìˆ˜ì •ë¨)
    skipBoardCards(street) {
      console.log(`ë³´ë“œ ì¹´ë“œ ì…ë ¥ ê±´ë„ˆë›°ê¸°: ${street}`);
      // ë³´ë“œ ì¹´ë“œ ì—†ì´ ì§„í–‰
      this.currentStreet = street;
      this.currentPlayerIndex = 0;
      window.state.currentStreet = this.currentStreet;

      // showFeedback í•¨ìˆ˜ í™•ì¸
      if (typeof showFeedback === 'function') {
        showFeedback(`ğŸ¯ ${this.currentStreet.toUpperCase()} ìŠ¤íŠ¸ë¦¿ìœ¼ë¡œ ì§„í–‰`, false);
      } else {
        console.log(`ğŸ¯ ${this.currentStreet.toUpperCase()} ìŠ¤íŠ¸ë¦¿ìœ¼ë¡œ ì§„í–‰`);
      }
    }

    // íŠ¸ëœì­ì…˜ ì‹œì‘ (Layer 5)
    startTransaction() {
      const snapshot = {
        currentStreet: this.currentStreet,
        currentPlayerIndex: this.currentPlayerIndex,
        actionState: JSON.parse(JSON.stringify(window.state.actionState || {})),
        playerStatus: {...window.state.playerStatus}
      };

      return {
        commit: () => {
          console.log('íŠ¸ëœì­ì…˜ ì»¤ë°‹');
        },
        rollback: () => {
          this.currentStreet = snapshot.currentStreet;
          this.currentPlayerIndex = snapshot.currentPlayerIndex;
          window.state.actionState = snapshot.actionState;
          window.state.playerStatus = snapshot.playerStatus;
          console.error('íŠ¸ëœì­ì…˜ ë¡¤ë°±');
        }
      };
    }

    // ìŠ¤íŠ¸ë¦¿ ì§„í–‰ ì•Œë¦¼ (v3.4.7 - showFeedback í•¨ìˆ˜ ì²´í¬ ì¶”ê°€)
    showStreetAdvanceNotification() {
      if (typeof showFeedback === 'function') {
        showFeedback(`ğŸ¯ ${this.currentStreet.toUpperCase()} ìŠ¤íŠ¸ë¦¿ìœ¼ë¡œ ìë™ ì§„í–‰`, false);
      } else {
        console.log(`ğŸ¯ ${this.currentStreet.toUpperCase()} ìŠ¤íŠ¸ë¦¿ìœ¼ë¡œ ìë™ ì§„í–‰`);
      }
    }

    // ëª¨ë“œ ì „í™˜
    toggleMode() {
      this.actionMode = this.actionMode === 'auto' ? 'manual' : 'auto';
      console.log(`%cì•¡ì…˜ ëª¨ë“œ ë³€ê²½: ${this.actionMode}`, 'color: #f59e0b; font-weight: bold');
      return this.actionMode;
    }
  }

  // ì „ì—­ ì•¡ì…˜ ê´€ë¦¬ì ì¸ìŠ¤í„´ìŠ¤
  window.actionManager = new ActionOrderManager();

  // ëª¨ë“  ë²„ì „ í‘œì‹œë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
  function updateAllVersionDisplays() {
    // ë²„ì „ í‘œì‹œ ì—˜ë¦¬ë¨¼íŠ¸ ì—…ë°ì´íŠ¸
    const versionDisplay = document.getElementById('version-display');
    if (versionDisplay) {
      versionDisplay.textContent = APP_VERSION;
    }
    
    // íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
    document.title = `í¬ì»¤ í•¸ë“œ ë¡œê±° ${APP_VERSION}`;
    
    // ì½˜ì†”ì— ë²„ì „ ì •ë³´ ì¶œë ¥
    console.log(`%c${VERSION_INFO}`, 'color: #10b981; font-weight: bold; font-size: 14px');
  }
  
  // Gemini API ì„¤ì •
  const GEMINI_API_KEY = 'AIzaSyBB8uqP1ECTe40jknSy5XK71TCs8_KbGV0';
  const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';
  
  // ë²„ì „ ì •ë³´ë¥¼ í•­ìƒ ì½˜ì†”ì— í‘œì‹œ
  console.log(`%c====================================`, 'color: #fbbf24');
  console.log(`%cğŸ¯ ${VERSION_INFO}`, 'color: #fbbf24; font-size: 18px; font-weight: bold');
  console.log(`%c====================================`, 'color: #fbbf24');
  console.log('%cğŸ“± AI ì¹© ìŠ¤íƒ ë¶„ì„ ê¸°ëŠ¥ í™œì„±í™”', 'color: #10b981');
  console.log('%cğŸ’¡ ê´€ë¦¬ ë²„íŠ¼ â†’ ì¹© ì»¬ëŸ¬ íƒ­ì—ì„œ ì¹© ë“±ë¡', 'color: #60a5fa');
  
  // ëª¨ë“  ì—ëŸ¬ë¥¼ ë¡œê·¸ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (ì˜¤ë¥˜ ë°©ì§€)
  const originalError = console.error;
  const originalWarn = console.warn;
  console.error = function(...args) {
    // console.logë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    console.log.apply(console, [`[${APP_VERSION}] INFO:`, ...args]);
  };
  console.warn = function(...args) {
    // console.logë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    console.log.apply(console, [`[${APP_VERSION}] NOTICE:`, ...args]);
  };
  
  document.addEventListener('DOMContentLoaded', () => {
    // ë²„ì „ í‘œì‹œ ì—…ë°ì´íŠ¸
    updateAllVersionDisplays();
    
    console.log(`%cğŸš€ ì•± ì´ˆê¸°í™” ì‹œì‘ - ${VERSION_INFO}`, 'color: #10b981; font-weight: bold');
    console.log('Initialized at', new Date().toISOString());
    
    // ì¹© ë¶„ì„ ëª¨ë“ˆ ì´ˆê¸°í™”ëŠ” state ê°ì²´ ìƒì„± í›„ì— ì§„í–‰
    
    // í™”ë©´ì— ë²„ì „ í‘œì‹œ ì—…ë°ì´íŠ¸
    const versionDisplay = document.getElementById('version-display');
    if(versionDisplay) {
      versionDisplay.textContent = `${APP_VERSION} (${VERSION_DATE})`;
    }
    
    // ====== CONFIG (í•„ìˆ˜: ì‹¤ì œ URLë¡œ êµì²´) ======
    // Apps Script URL ì„¤ì • (localStorageì—ì„œ ë¡œë“œ ë˜ëŠ” ê¸°ë³¸ê°’ ì‚¬ìš©)
    const DEFAULT_APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwEcsF1F_RLLW_qkQIFkrwmut-zN0fHOqsAKs5B8PgHZAz2_O5sA8o2W5zZ3nD-5tjY/exec";
    let APPS_SCRIPT_URL = localStorage.getItem('appsScriptUrl') || DEFAULT_APPS_SCRIPT_URL;
    
    // CSV URLs (ê³ ì •)
    const CSV_HAND_URL  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSDY_i4330JANAjIz4sMncdJdRHsOkfUCjQusHTGQk2tykrhA4d09LeIp3XRbLd8hkN6SgSB47k_nux/pub?gid=1906746276&single=true&output=csv"; // Hand íƒ­ CSV
    const CSV_INDEX_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSDY_i4330JANAjIz4sMncdJdRHsOkfUCjQusHTGQk2tykrhA4d09LeIp3XRbLd8hkN6SgSB47k_nux/pub?gid=1354012271&single=true&output=csv"; // Index íƒ­ CSV (HandIndex ëŒ€ì‹  Index ì‚¬ìš©)
    const CSV_TYPE_URL  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSDY_i4330JANAjIz4sMncdJdRHsOkfUCjQusHTGQk2tykrhA4d09LeIp3XRbLd8hkN6SgSB47k_nux/pub?gid=998576925&single=true&output=csv";
    
    // ì „ì—­ ë³€ìˆ˜ë¡œë„ ì„¤ì • (í…Œì´ë¸” ê´€ë¦¬ ëª¨ë“ˆìš©)
    window.APPS_SCRIPT_URL = APPS_SCRIPT_URL;
    
    // Apps Script URL í´ë¼ìš°ë“œ ë™ê¸°í™” ì‹œìŠ¤í…œ
    const CLOUD_SYNC_CONFIG = {
      enabled: true,
      gistApiUrl: 'https://api.github.com/gists',
      configGistId: localStorage.getItem('configGistId') || null,
      deviceId: localStorage.getItem('deviceId') || generateDeviceId()
    };

    // ê¸°ê¸° IDë¥¼ localStorageì— ì €ì¥ (ì²˜ìŒ ìƒì„±ì‹œ)
    if (!localStorage.getItem('deviceId')) {
      localStorage.setItem('deviceId', CLOUD_SYNC_CONFIG.deviceId);
    }

    // ê³ ìœ  ê¸°ê¸° ID ìƒì„±
    function generateDeviceId() {
      const id = 'device_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now().toString(36);
      localStorage.setItem('deviceId', id);
      return id;
    }

    // í´ë¼ìš°ë“œì—ì„œ ì„¤ì • ë¡œë“œ
    async function loadConfigFromCloud() {
      if (!CLOUD_SYNC_CONFIG.enabled || !CLOUD_SYNC_CONFIG.configGistId) {
        return null;
      }

      try {
        const response = await fetch(`${CLOUD_SYNC_CONFIG.gistApiUrl}/${CLOUD_SYNC_CONFIG.configGistId}`);
        if (response.ok) {
          const gist = await response.json();
          const configFile = gist.files['poker-config.json'];
          if (configFile) {
            const config = JSON.parse(configFile.content);
            console.log('â˜ï¸ í´ë¼ìš°ë“œì—ì„œ ì„¤ì • ë¡œë“œ:', config);
            return config;
          }
        }
      } catch (error) {
        console.log('í´ë¼ìš°ë“œ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error.message);
      }
      return null;
    }

    // í´ë¼ìš°ë“œì— ì„¤ì • ì €ì¥
    async function saveConfigToCloud(appsScriptUrl) {
      if (!CLOUD_SYNC_CONFIG.enabled) return false;

      const config = {
        appsScriptUrl: appsScriptUrl,
        lastUpdated: new Date().toISOString(),
        deviceId: CLOUD_SYNC_CONFIG.deviceId,
        version: APP_VERSION
      };

      const gistContent = {
        description: 'Poker Hand Logger Configuration',
        public: false,
        files: {
          'poker-config.json': {
            content: JSON.stringify(config, null, 2)
          }
        }
      };

      try {
        let response;
        if (CLOUD_SYNC_CONFIG.configGistId) {
          // ê¸°ì¡´ Gist ì—…ë°ì´íŠ¸
          response = await fetch(`${CLOUD_SYNC_CONFIG.gistApiUrl}/${CLOUD_SYNC_CONFIG.configGistId}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(gistContent)
          });
        } else {
          // ìƒˆ Gist ìƒì„±
          response = await fetch(CLOUD_SYNC_CONFIG.gistApiUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(gistContent)
          });
        }

        if (response.ok) {
          const gist = await response.json();
          CLOUD_SYNC_CONFIG.configGistId = gist.id;
          localStorage.setItem('configGistId', gist.id);
          console.log('â˜ï¸ ì„¤ì •ì´ í´ë¼ìš°ë“œì— ì €ì¥ë¨:', gist.id);
          return true;
        }
      } catch (error) {
        console.log('í´ë¼ìš°ë“œ ì €ì¥ ì‹¤íŒ¨:', error.message);
      }
      return false;
    }

    // Apps Script URL ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (í´ë¼ìš°ë“œ ë™ê¸°í™” í¬í•¨)
    async function updateAppsScriptUrl(newUrl, skipCloudSync = false) {
      if (newUrl && newUrl.trim()) {
        APPS_SCRIPT_URL = newUrl.trim();
        window.APPS_SCRIPT_URL = APPS_SCRIPT_URL;
        localStorage.setItem('appsScriptUrl', APPS_SCRIPT_URL);
        console.log('âœ… Apps Script URL ì—…ë°ì´íŠ¸:', APPS_SCRIPT_URL);

        // í´ë¼ìš°ë“œì— ì €ì¥ (ì˜µì…˜)
        if (!skipCloudSync && CLOUD_SYNC_CONFIG.enabled) {
          const cloudSaved = await saveConfigToCloud(APPS_SCRIPT_URL);
          if (cloudSaved) {
            showFeedback('âœ… Apps Script URL ì—…ë°ì´íŠ¸ ë° í´ë¼ìš°ë“œ ë™ê¸°í™” ì™„ë£Œ');
          } else {
            showFeedback('âœ… Apps Script URL ì—…ë°ì´íŠ¸ ì™„ë£Œ (ë¡œì»¬ ì €ì¥)');
          }
        } else {
          showFeedback('âœ… Apps Script URL ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        }
        return true;
      }
      return false;
    }

    // ====== LOADING & UI LOCK SYSTEM ======
    let isUILocked = false;

    // UI ì „ì²´ ë¹„í™œì„±í™”
    function lockUI(title = 'ì²˜ë¦¬ ì¤‘...', message = 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”') {
      if (isUILocked) return; // ì´ë¯¸ ì ê¸ˆ ìƒíƒœë©´ ë¬´ì‹œ

      isUILocked = true;

      // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
      if (el.loadingOverlay) {
        if (el.loadingTitle) el.loadingTitle.textContent = title;
        if (el.loadingMessage) el.loadingMessage.textContent = message;
        el.loadingOverlay.classList.remove('hidden');
      }

      // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
      document.querySelectorAll('button').forEach(btn => {
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
      });

      // ëª¨ë“  ì…ë ¥ í•„ë“œ ë¹„í™œì„±í™”
      document.querySelectorAll('input, select, textarea').forEach(input => {
        input.disabled = true;
        input.classList.add('opacity-50', 'cursor-not-allowed');
      });

      console.log(`ğŸ”’ UI ì ê¸ˆ: ${title}`);
    }

    // UI ì „ì²´ í™œì„±í™”
    function unlockUI() {
      if (!isUILocked) return; // ì´ë¯¸ í•´ì œ ìƒíƒœë©´ ë¬´ì‹œ

      isUILocked = false;

      // ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
      if (el.loadingOverlay) {
        el.loadingOverlay.classList.add('hidden');
      }

      // ëª¨ë“  ë²„íŠ¼ í™œì„±í™”
      document.querySelectorAll('button').forEach(btn => {
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
      });

      // ëª¨ë“  ì…ë ¥ í•„ë“œ í™œì„±í™”
      document.querySelectorAll('input, select, textarea').forEach(input => {
        input.disabled = false;
        input.classList.remove('opacity-50', 'cursor-not-allowed');
      });

      console.log('ğŸ”“ UI ì ê¸ˆ í•´ì œ');
    }

    // ì‘ì—… ì‹¤í–‰ ë˜í¼ (ìë™ UI ì ê¸ˆ/í•´ì œ)
    async function executeWithLock(asyncFunction, title = 'ì²˜ë¦¬ ì¤‘...', message = 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”') {
      try {
        lockUI(title, message);
        await asyncFunction();
      } catch (error) {
        console.log('ì‘ì—… ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜:', error);
        showFeedback('ì‘ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, true);
      } finally {
        unlockUI();
      }
    }

    // í´ë¼ìš°ë“œ ë™ê¸°í™” UI ì—…ë°ì´íŠ¸
    function updateCloudSyncUI() {
      if (!el.cloudSyncStatus || !el.deviceIdDisplay) return;

      // ê¸°ê¸° ID í‘œì‹œ
      el.deviceIdDisplay.textContent = CLOUD_SYNC_CONFIG.deviceId.substring(0, 8) + '...';

      // ë™ê¸°í™” ìƒíƒœ í‘œì‹œ
      if (CLOUD_SYNC_CONFIG.enabled && CLOUD_SYNC_CONFIG.configGistId) {
        el.cloudSyncStatus.textContent = 'ì—°ê²°ë¨';
        el.cloudSyncStatus.className = 'text-xs px-2 py-1 rounded-full bg-green-600 text-white';

        // ë§ˆì§€ë§‰ ë™ê¸°í™” ì‹œê°„ í‘œì‹œ
        const lastSync = localStorage.getItem('lastCloudSync');
        if (lastSync && el.lastSyncDisplay) {
          const syncDate = new Date(lastSync);
          el.lastSyncDisplay.querySelector('span').textContent = syncDate.toLocaleString('ko-KR');
          el.lastSyncDisplay.classList.remove('hidden');
        }
      } else {
        el.cloudSyncStatus.textContent = 'ë¯¸ì—°ê²°';
        el.cloudSyncStatus.className = 'text-xs px-2 py-1 rounded-full bg-gray-600 text-gray-400';
        if (el.lastSyncDisplay) {
          el.lastSyncDisplay.classList.add('hidden');
        }
      }
    }

    // ìˆ˜ë™ í´ë¼ìš°ë“œ ë™ê¸°í™”
    async function syncCloudNow() {
      if (!CLOUD_SYNC_CONFIG.enabled) {
        showFeedback('í´ë¼ìš°ë“œ ë™ê¸°í™”ê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤', true);
        return;
      }

      await executeWithLock(async () => {
        // í˜„ì¬ ì„¤ì •ì„ í´ë¼ìš°ë“œì— ì €ì¥
        await saveConfigToCloud(APPS_SCRIPT_URL);
        localStorage.setItem('lastCloudSync', new Date().toISOString());

        // UI ì—…ë°ì´íŠ¸
        updateCloudSyncUI();
        showFeedback('â˜ï¸ í´ë¼ìš°ë“œ ë™ê¸°í™” ì™„ë£Œ');
      }, 'í´ë¼ìš°ë“œ ë™ê¸°í™”', 'Apps Script URLì„ í´ë¼ìš°ë“œì— ì €ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
    }

    // í´ë¼ìš°ë“œ ì„¤ì • ì´ˆê¸°í™” (Phase 2: ë”ë¸”íƒ­ ì ìš©)
    function resetCloudConfig() {
      // ì‹¤ì œ ì´ˆê¸°í™” ë¡œì§
      const performReset = () => {
        // ë¡œì»¬ ì €ì¥ì†Œì—ì„œ í´ë¼ìš°ë“œ ê´€ë ¨ ì •ë³´ ì œê±°
        localStorage.removeItem('configGistId');
        localStorage.removeItem('lastCloudSync');
        CLOUD_SYNC_CONFIG.configGistId = null;

        // UI ì—…ë°ì´íŠ¸
        updateCloudSyncUI();

        // ìŠ¤ë‚µë°”ë¡œ í”¼ë“œë°±
        if (window.actionHistory) {
          window.actionHistory.showSnackbar('â˜ï¸ í´ë¼ìš°ë“œ ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤', null, 'success');
        } else {
          showFeedback('í´ë¼ìš°ë“œ ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
        }
      };

      // ì¦‰ì‹œ ì‹¤í–‰ (ë”ë¸”íƒ­ì€ ë‚˜ì¤‘ì— ì„¤ì • ê°€ëŠ¥)
      performReset();
    }

    // ì•± ì‹œì‘ ì‹œ í´ë¼ìš°ë“œ ì„¤ì • í™•ì¸
    async function initializeAppConfig() {
      const cloudConfig = await loadConfigFromCloud();
      if (cloudConfig && cloudConfig.appsScriptUrl) {
        // í´ë¼ìš°ë“œ ì„¤ì •ì´ ë” ìµœì‹ ì¸ ê²½ìš° ì ìš©
        const localUpdated = localStorage.getItem('appsScriptUrlUpdatedAt');
        const cloudUpdated = cloudConfig.lastUpdated;

        if (!localUpdated || (cloudUpdated && new Date(cloudUpdated) > new Date(localUpdated))) {
          console.log('â˜ï¸ í´ë¼ìš°ë“œì—ì„œ ìµœì‹  ì„¤ì • ì ìš©');
          await updateAppsScriptUrl(cloudConfig.appsScriptUrl, true);
          localStorage.setItem('appsScriptUrlUpdatedAt', cloudConfig.lastUpdated);
        }
      }
    }

    // ì´ˆê¸°í™” ì‹¤í–‰ (ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìˆ˜í–‰)
    initializeAppConfig().catch(err => console.log('í´ë¼ìš°ë“œ ì„¤ì • ì´ˆê¸°í™” ì‹¤íŒ¨:', err.message));

    // ====== STATE ======
    let timeUpdater;
    window.state = {
      currentStreet: 'preflop',  // í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ìŠ¤íŠ¸ë¦¬íŠ¸
      camNumbers: { cam1no:'', cam2no:'' }, // íŒŒì¼ ë„˜ë²„ ì…ë ¥ì´ ìˆë‹¤ë©´ ì—¬ê¸°ì— ì €ì¥
      lastCamNo: null,        // ë§ˆì§€ë§‰ ì…ë ¥ ì¶”ì (ì—°ì† ì¦ê°€ ê¸°ë³¸ê°’ ì œê³µìš©)

      playerDataByTable: {},     // { [table]: [{name, chips, notable}] }
      camPreset: { cam1:'', cam2:'' }, // Type!A2/A3
      allTables: [],
      indexRows: [],             // [{handNumber, handUpdatedAt, table, ...}]
      allHandNumbers: [],        // latest numbers (from Index)
      handCsvCache: null,        // raw rows for on-demand hand parsing
      allHandData: {},           // { [handNumber]: parsed hand block (latest) }
      selectedTable: null,
      playersInHand: [],
      board: [],
      playerStatus: {},          // { playerName: 'active' | 'folded' | 'allin' }
      buttonPosition: null,      // ë²„íŠ¼ ìœ„ì¹˜ (seat ë²ˆí˜¸)
      seatMap: {},              // { seat: playerName } 10ê°œ ì¢Œì„ ë§¤í•‘
      nextActionSeat: null,      // ë‹¤ìŒ ì•¡ì…˜ í”Œë ˆì´ì–´ ì¢Œì„
      
      // ì•¡ì…˜ ìë™ ë§¤í•‘ ì‹œìŠ¤í…œ
      actionInputMode: localStorage.getItem('actionInputMode') || 'auto', // 'auto' | 'manual'
      currentActionIndex: 0,     // í˜„ì¬ ì•¡ì…˜ ìˆœì„œ ì¸ë±ìŠ¤
      actionQueue: [],          // ì•¡ì…˜ ìˆœì„œ ëŒ€ê¸°ì—´
      nextActionPlayer: null,    // ë‹¤ìŒ ì•¡ì…˜ í”Œë ˆì´ì–´
      smartCheckCall: true,      // ìŠ¤ë§ˆíŠ¸ Check/Call ë²„íŠ¼ ì‚¬ìš©
      actionState: {
        handNumber: '',
        smallBlind: '', bigBlind: '', hasBBAnte: false,
        preflop: [], flop: [], turn: [], river: [],
      },
      modalState: {
        cardTarget: null,
        actionPadStreet: null, actionPadPlayer: null, actionPadCurrentAction: null,
        keypadTarget: null, keypadOptions: {},
      },
      selectedTimezone: 'Asia/Seoul',
      // ì¹© ë¶„ì„ ê´€ë ¨ ìƒíƒœ
      chipColors: [], // [{color: '#fff', value: 1000, image: 'base64...'}]
      maxChips: 5,
      currentChipSlot: null,
      playerStacks: {}, // {playerName: {images: [], estimatedStack: 0, analysis: ''}}
      currentAnalyzingPlayer: null,
      stackImages: [] // í˜„ì¬ ì´¬ì˜ ì¤‘ì¸ ìŠ¤íƒ ì´ë¯¸ì§€ë“¤
    };

    // ì¹© ë¶„ì„ ëª¨ë“ˆ ì´ˆê¸°í™” (state ê°ì²´ ìƒì„± í›„)
    if (typeof initChipAnalyzer === 'function') {
      setTimeout(() => {
        initChipAnalyzer();
        console.log('âœ… AI ì¹© ë¶„ì„ ëª¨ë“ˆ í™œì„±í™”');
      }, 100);
    }

    // ====== CONSTS ======
    const SUITS = { s:'â™ ', h:'â™¥', d:'â™¦', c:'â™£' };
    const RANKS = ['A','K','Q','J','10','9','8','7','6','5','4','3','2'];

    // ====== EL ======
    const el = {
      refreshDataBtn: document.getElementById('refresh-data'),
      tableSelectorBtn: document.getElementById('table-selector-btn'),
      selectedTableDisplay: document.getElementById('selected-table-display'),
      tableSelectorModal: document.getElementById('table-selector-modal'),
      playerSelectionButtons: document.getElementById('player-selection-buttons'),
      boardCardPlaceholders: document.getElementById('board-card-placeholders'),
      playerDetailsSection: document.getElementById('player-details-section'),
      handNumberDisplay: document.getElementById('hand-number-display'),
      loadHandBtn: document.getElementById('load-hand-btn'),
      smallBlindInput: document.getElementById('small-blind-input'),
      bigBlindInput: document.getElementById('big-blind-input'),
      bbAnteCheckbox: document.getElementById('bb-ante-checkbox'),
      streetLogsContainer: document.getElementById('street-logs-container'),
      winnerButtons: document.getElementById('winner-buttons'),
      sendToSheetBtn: document.getElementById('send-to-sheet-btn'),
      resetBtn: document.getElementById('reset-btn'),
      feedbackMessage: document.getElementById('feedback-message'),
      logDisplay: document.getElementById('log-display'),
      logModal: document.getElementById('log-modal'),
      showLogBtn: document.getElementById('show-log-btn'),
      closeLogModalBtn: document.getElementById('close-log-modal'),
      cardSelectorModal: document.getElementById('card-selector-modal'),
      actionPadModal: document.getElementById('action-pad-modal'),
      keypadModal: document.getElementById('keypad-modal'),
      loadHandModal: document.getElementById('load-hand-modal'),
      timezoneSelector: document.getElementById('timezone-selector'),
      timeDisplay: document.getElementById('time-display'),
      managePlayersBtn: document.getElementById('manage-players-btn'),
      registrationModal: document.getElementById('registration-modal'),
      cam1: document.getElementById('cam-btn-1'),
      cam2: document.getElementById('cam-btn-2'),
      dataStamp: document.getElementById('data-stamp'),
      // ì„¤ì • ëª¨ë‹¬ ê´€ë ¨
      settingsBtn: document.getElementById('settings-btn'),
      settingsModal: document.getElementById('settings-modal'),
      closeSettingsBtn: document.getElementById('close-settings'),
      cancelSettingsBtn: document.getElementById('cancel-settings'),
      saveSettingsBtn: document.getElementById('save-settings'),
      appsScriptUrlInput: document.getElementById('apps-script-url-input'),
      currentAppsUrl: document.getElementById('current-apps-url'),
      chipValidationToggle: document.getElementById('chip-validation-toggle'),
      cloudSyncStatus: document.getElementById('cloud-sync-status'),
      deviceIdDisplay: document.getElementById('device-id-display'),
      lastSyncDisplay: document.getElementById('last-sync-display'),
      syncNowBtn: document.getElementById('sync-now-btn'),
      resetCloudBtn: document.getElementById('reset-cloud-btn'),
      loadingOverlay: document.getElementById('loading-overlay'),
      loadingTitle: document.getElementById('loading-title'),
      loadingMessage: document.getElementById('loading-message'),
    };

    // ====== LOG MODAL ======
    function openLogModal(){
      el.logModal.classList.remove('hidden');
      el.logModal.classList.remove('opacity-0');
    }
    function closeLogModal(){ el.logModal.classList.add('opacity-0', 'hidden'); }
    function logMessage(msg,isError=false){
      const d=document.createElement('div');
      d.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`;
      d.className=isError?'text-red-400':'text-green-400';
      el.logDisplay.appendChild(d); el.logDisplay.scrollTop=el.logDisplay.scrollHeight;
    }

    // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ (DuplicateRemoverì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡)
    window.openLogModal = openLogModal;
    window.closeLogModal = closeLogModal;
    window.logMessage = logMessage;

    // ====== TIME/TZ ======
    function getFormattedTimeInTimezone(date, tz){
      try{
        return new Intl.DateTimeFormat('ko-KR',{timeZone:tz,hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(date);
      }catch(_){
        const pad=n=>String(n).padStart(2,'0');
        return `${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
      }
    }
    function populateTimezones(){
      const tzs={ "Asia/Seoul":"í•œêµ­(KST)", "Asia/Nicosia":"í‚¤í”„ë¡œìŠ¤(EET)" };
      const s=el.timezoneSelector; s.innerHTML='';
      for(const [v,t] of Object.entries(tzs)){
        const opt=document.createElement('option'); opt.value=v; opt.textContent=t; s.appendChild(opt);
      }
      s.value=window.state.selectedTimezone;
    }
    function updateTimeDisplay(){ el.timeDisplay.textContent=getFormattedTimeInTimezone(new Date(),window.state.selectedTimezone); }

    // ====== UTILS ======
    const formatNumber = (val) => val ? new Intl.NumberFormat('en-US').format(String(val).replace(/,/g,'')) : '';
    const unformatNumber = (val) => String(val || '').replace(/,/g, '');
    const toCamelCase = (s) => s.replace(/-([a-z])/g, g => g[1].toUpperCase());
    const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
    const pad4 = n => String(Math.max(0, parseInt(String(n||'0').replace(/\D/g,''),10)||0)).padStart(4, '0');

    // Robust CSV parse (handles quotes)
    function parseCSV(text){
      const rows=[]; let i=0, field='', inQ=false, row=[];
      while(i<text.length){
        const c=text[i];
        if(inQ){
          if(c==='"'){
            if(text[i+1]==='"'){ field+='"'; i++; } else inQ=false;
          }else field+=c;
        }else{
          if(c===','){ row.push(field); field=''; }
          else if(c==='\n'){ row.push(field); rows.push(row); row=[]; field=''; }
          else if(c==='"'){ inQ=true; }
          else if(c!=='\r'){ field+=c; }
        }
        i++;
      }
      if(field!==''||row.length) { row.push(field); rows.push(row); }
      return rows;
    }

    function formatCardDisplay(cardId){
      const rank=cardId.slice(0,-1), suitKey=cardId.slice(-1);
      const colorClass=(suitKey==='h'||suitKey==='d')?'text-red-500':'text-black';
      return `<div class="card-display h-full w-full ${colorClass}"><div class="rank">${rank}</div><div>${SUITS[suitKey]}</div></div>`;
    }

    // ====== RENDERERS ======
    function renderTableSelection(){
      // ë”ì´ìƒ í•„ìš”í•˜ì§€ ì•Šì§€ë§Œ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€
      updateSelectedTableDisplay();
    }

    // ====== ìƒˆë¡œìš´ í…Œì´ë¸” ì„ íƒ ì‹œìŠ¤í…œ ======
    let tableModalState = {
      currentPage: 1,
      tablesPerPage: 20,
      currentFilter: 'all',
      searchTerm: ''
    };

    function updateSelectedTableDisplay() {
      const display = el.selectedTableDisplay;
      const managementTableName = document.getElementById('selected-table-name');

      if (window.state.selectedTable) {
        const playerCount = (window.state.playerDataByTable[window.state.selectedTable] || []).length;
        const text = `${window.state.selectedTable} (${playerCount}ëª…)`;
        display.textContent = text;
        if (managementTableName) managementTableName.textContent = window.state.selectedTable;
      } else {
        display.textContent = 'í…Œì´ë¸” ì„ íƒ';
        if (managementTableName) managementTableName.textContent = 'í…Œì´ë¸”ì„ ì„ íƒí•´ì£¼ì„¸ìš”';
      }
    }

    function getFilteredTables() {
      let tables = window.state.allTables;
      
      // ê²€ìƒ‰ í•„í„°
      if (tableModalState.searchTerm) {
        const term = tableModalState.searchTerm.toLowerCase();
        tables = tables.filter(table => {
          // í…Œì´ë¸” ì´ë¦„ ë§¤ì¹˜
          if (table.toLowerCase().includes(term)) return true;
          // í”Œë ˆì´ì–´ ì´ë¦„ ë§¤ì¹˜
          const players = window.state.playerDataByTable[table] || [];
          return players.some(p => p.name.toLowerCase().includes(term));
        });
      }
      
      // ìƒíƒœ í•„í„°
      if (tableModalState.currentFilter === 'active') {
        tables = tables.filter(table => {
          const players = window.state.playerDataByTable[table] || [];
          return players.length > 0;
        });
      } else if (tableModalState.currentFilter === 'empty') {
        tables = tables.filter(table => {
          const players = window.state.playerDataByTable[table] || [];
          return players.length === 0;
        });
      }
      
      return tables;
    }

    function renderTableGrid() {
      const filteredTables = getFilteredTables();
      const startIdx = (tableModalState.currentPage - 1) * tableModalState.tablesPerPage;
      const endIdx = startIdx + tableModalState.tablesPerPage;
      const pageTables = filteredTables.slice(startIdx, endIdx);
      
      const grid = document.getElementById('table-grid');
      grid.innerHTML = '';
      
      pageTables.forEach(table => {
        const players = window.state.playerDataByTable[table] || [];
        const playerCount = players.length;
        const isSelected = window.state.selectedTable === table;
        
        // ìƒíƒœë³„ ìƒ‰ìƒ
        let statusColor = 'bg-gray-600'; // ë¹ˆ í…Œì´ë¸”
        if (playerCount >= 7) statusColor = 'bg-green-600'; // í™œì„±
        else if (playerCount >= 4) statusColor = 'bg-yellow-600'; // ë³´í†µ
        else if (playerCount >= 1) statusColor = 'bg-blue-600'; // ì ìŒ
        
        const button = document.createElement('button');
        button.className = `table-btn ${statusColor} hover:brightness-110 p-3 rounded-lg text-white text-sm font-medium relative ${isSelected ? 'ring-2 ring-amber-400' : ''}`;
        button.innerHTML = `
          <div class="text-xs font-bold">${table}</div>
          <div class="text-xs opacity-75">${playerCount}ëª…</div>
          ${isSelected ? '<div class="absolute top-1 right-1 text-amber-400">â—</div>' : ''}
        `;
        
        button.onclick = () => {
          window.state.selectedTable = table;
          window.state.playersInHand = [];
          updateSelectedTableDisplay();
          closeTableSelectorModal();

          // í…Œì´ë¸” ê´€ë¦¬ ëª¨ë“œì¸ì§€ í™•ì¸
          if (window.isTableManagementMode) {
            // í…Œì´ë¸” ê´€ë¦¬ ëª¨ë“œ: ê´€ë¦¬ UIë¡œ ì „í™˜
            document.getElementById('management-menu').classList.add('hidden');
            document.getElementById('player-management-content').classList.remove('hidden');
            // ìˆœì„œ ë³€ê²½: onManagementTableSelectedë¥¼ ë¨¼ì € í˜¸ì¶œí•˜ì—¬ ë°ì´í„°ë¥¼ ì„¤ì •í•œ í›„ UIë¥¼ ì´ˆê¸°í™”
            onManagementTableSelected(table);

            // í”Œë˜ê·¸ ë¦¬ì…‹
            window.isTableManagementMode = false;
          } else {
            // ì¼ë°˜ ëª¨ë“œ: ê¸°ë³¸ ë Œë”ë§
            renderAll();
          }
        };
        
        grid.appendChild(button);
      });
      
      // í˜ì´ì§€ ì •ë³´ ì—…ë°ì´íŠ¸
      const totalPages = Math.ceil(filteredTables.length / tableModalState.tablesPerPage);
      const pageInfo = document.getElementById('page-info');
      const startNum = startIdx + 1;
      const endNum = Math.min(endIdx, filteredTables.length);
      pageInfo.textContent = `${startNum}-${endNum} / ${filteredTables.length}`;
      
      // í˜ì´ì§€ ë²„íŠ¼ ìƒíƒœ
      document.getElementById('prev-page').disabled = tableModalState.currentPage === 1;
      document.getElementById('next-page').disabled = tableModalState.currentPage >= totalPages;
    }

    function openTableSelectorModal() {
      el.tableSelectorModal.classList.remove('hidden');
      renderTableGrid();
      document.getElementById('table-search').focus();
    }

    function closeTableSelectorModal() {
      el.tableSelectorModal.classList.add('hidden');
      tableModalState.searchTerm = '';
      document.getElementById('table-search').value = '';
    }
    function renderPlayerSelection(){
      const seatButtons = document.getElementById('seat-buttons');
      if(!seatButtons) return;
      
      if(!window.state.selectedTable){
        seatButtons.innerHTML='<p class="text-gray-500 text-xs col-span-11">í…Œì´ë¸”ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.</p>';
        return;
      }
      
      const tableData = window.state.playerDataByTable[window.state.selectedTable]||[];
      
      // 10ê°œ ì¢Œì„ ë²„íŠ¼ + ë²„íŠ¼ ìœ„ì¹˜ ë“œë¡­ë‹¤ìš´ ìƒì„±
      let html = '';
      
      // 1-10ë²ˆ ì¢Œì„ ë²„íŠ¼ (ì¢Œì„ ë²ˆí˜¸ í‘œì‹œ ì œê±°)
      for(let seatNum = 1; seatNum <= 10; seatNum++){
        // Type ì‹œíŠ¸ì—ì„œ í•´ë‹¹ ì¢Œì„ì˜ í”Œë ˆì´ì–´ ì°¾ê¸°
        const playerData = tableData.find(p => parseInt(p.seat) === seatNum);
        const isInHand = playerData && window.state.playersInHand.some(pp => pp.name === playerData.name);
        
        // í¬ì§€ì…˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const positions = getPositionsForSeat(seatNum);
        let positionBadge = '';
        let borderClass = '';
        
        if(positions.includes('BTN')) {
          positionBadge = 'ğŸ¯';
          borderClass = 'border-2 border-yellow-400';
        } else if(positions.includes('SB')) {
          positionBadge = 'SB';
          borderClass = 'border-2 border-green-400';
        } else if(positions.includes('BB')) {
          positionBadge = 'BB';
          borderClass = 'border-2 border-blue-400';
        }
        
        if(playerData){
          const notable = playerData.notable ? 'â­' : '';
          const btnClass = isInHand ? 'bg-amber-600' : 'bg-gray-600 hover:bg-gray-500';
          // í¬ì§€ì…˜ ë°°ì§€ì™€ í”Œë ˆì´ì–´ ì´ë¦„ í‘œì‹œ
          let displayText = '';
          if(positionBadge) {
            displayText = positionBadge; // í¬ì§€ì…˜ì´ ìˆìœ¼ë©´ í¬ì§€ì…˜ë§Œ í‘œì‹œ
          } else {
            // í¬ì§€ì…˜ì´ ì—†ìœ¼ë©´ ì´ë¦„ í‘œì‹œ (notable í¬í•¨)
            const shortName = playerData.name.length > 8 ? playerData.name.substring(0, 7) + 'â€¦' : playerData.name;
            displayText = notable + shortName;
          }
          
          html += `<button class="seat-player-btn btn ${btnClass} ${borderClass} px-1 py-0.5 text-[9px] rounded truncate h-7" 
                    data-seat="${seatNum}" 
                    data-player-name="${playerData.name}"
                    title="Seat ${seatNum}: ${playerData.name}">
                    <div class="truncate">${displayText}</div>
                  </button>`;
        } else {
          // ë¹ˆ ì¢Œì„
          html += `<button class="seat-empty-btn btn bg-gray-800 ${borderClass} px-1 py-0.5 text-[9px] rounded h-7" 
                    data-seat="${seatNum}"
                    title="Seat ${seatNum}: ë¹ˆìë¦¬">
                    <div class="text-gray-600">${positionBadge || 'â€¢'}</div>
                  </button>`;
        }
      }
      
      // 11ë²ˆì§¸ ìœ„ì¹˜: ë²„íŠ¼ ë“œë¡­ë‹¤ìš´ (1x11 ê·¸ë¦¬ë“œ) - ì „ì²´ í”Œë ˆì´ì–´ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì„ íƒ ê°€ëŠ¥
      const currentBtnPos = window.state.buttonPosition || '';
      
      // ì „ì²´ í…Œì´ë¸” í”Œë ˆì´ì–´ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì¢Œì„ì´ ìˆëŠ” í”Œë ˆì´ì–´ë“¤ ê°€ì ¸ì˜¤ê¸°
      const allPlayersWithSeats = tableData.filter(player => player.seat).map(player => ({
        seat: parseInt(player.seat),
        name: player.name
      })).sort((a, b) => a.seat - b.seat);
      
      html += `
        <select id="button-position-select" class="bg-gray-600 text-[9px] px-1 py-0.5 rounded h-7 cursor-pointer">
          <option value="">BTN</option>
          ${allPlayersWithSeats.map(player => {
            const selected = player.seat.toString() === currentBtnPos.toString() ? 'selected' : '';
            const isInGame = window.state.playersInHand.some(p => p.name === player.name);
            const statusIndicator = isInGame ? 'ğŸŸ¢' : 'âš«';
            return `<option value="${player.seat}" ${selected} title="${player.seat}ë²ˆ - ${player.name} ${isInGame ? '(ì°¸ì—¬ì¤‘)' : '(ëŒ€ê¸°ì¤‘)'}">${statusIndicator}${player.seat}</option>`;
          }).join('')}
        </select>
      `;
      
      seatButtons.innerHTML = html;
      
      // ë²„íŠ¼ ìœ„ì¹˜ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      const btnSelect = document.getElementById('button-position-select');
      if(btnSelect) {
        // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
        const newBtnSelect = btnSelect.cloneNode(true);
        btnSelect.parentNode.replaceChild(newBtnSelect, btnSelect);
        
        newBtnSelect.addEventListener('change', (e) => {
          window.state.buttonPosition = e.target.value || null;
          console.log(`ğŸ¯ ë²„íŠ¼ ìœ„ì¹˜ ë³€ê²½: ${window.state.buttonPosition || 'ì—†ìŒ'}`);
          updateSeatDisplay();
          // updatePositionIndicatorsëŠ” renderPlayerSelection ë‚´ë¶€ì—ì„œ ì´ë¯¸ í˜¸ì¶œë¨
          saveActionState();
          
          // ì‹œê°ì  í”¼ë“œë°±
          showFeedback(window.state.buttonPosition ? 
            `ë²„íŠ¼ ìœ„ì¹˜: ${window.state.buttonPosition}ë²ˆ ì¢Œì„` : 
            'ë²„íŠ¼ ìœ„ì¹˜ í•´ì œ', false);
        });
      }
    }
    function renderPlayerDetails(){
      const finalPot = calculateFinalPot();
      
      el.playerDetailsSection.innerHTML = window.state.playersInHand.map(p=>{
        const roleClass=(p.role==='winner')?'is-winner':'';
        const winnerBadge = p.role === 'winner' && finalPot > 0 ?
          `<span class="ml-2 text-amber-300 font-bold text-xs animate-pulse">ğŸ† +${formatNumber(finalPot)}</span>` : '';

        // ì¹© í‘œì‹œ ìŠ¤íƒ€ì¼ (ë§ˆì´ë„ˆìŠ¤ì¼ ë•Œ ë¹¨ê°„ìƒ‰)
        const chipValue = parseInt(unformatNumber(p.chips) || 0, 10);
        const chipClass = chipValue < 0 ? 'bg-red-900 text-red-300' : 'bg-gray-700';
        const chipWarning = chipValue < 0 ? 'âš ï¸ ' : '';

        return `<div class="player-card flex items-center gap-2 text-sm border-b border-gray-700 pb-1 ${roleClass}" data-player-name="${p.name}">
          <div class="w-1/4 truncate font-bold">${p.name}${winnerBadge}</div>
          <div class="w-1/2"><button class="player-chip-btn btn ${chipClass} w-full p-1 rounded-md text-xs text-left" data-player-name="${p.name}">${chipWarning}${formatNumber(p.chips) || '0'}</button></div>
          <div class="w-1/4 card-placeholder h-10 flex justify-center items-center gap-1" data-player-name="${p.name}" data-count="2">
            ${p.hand?.length? p.hand.map(formatCardDisplay).join('') : '<span class="text-gray-400 text-lg">+</span>'}
          </div>
        </div>`;
      }).join('');
      
      // í”Œë ˆì´ì–´ ì¹© ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¶”ê°€
      document.querySelectorAll('.player-chip-btn').forEach(btn => {
        btn.onclick = () => {
          const playerName = btn.dataset.playerName;
          const player = window.state.playersInHand.find(p => p.name === playerName);
          if(player) {
            openChipInput(player, false);
          }
        };
      });
    }
    function renderBoard(){
      const flop=`<div class="card-placeholder h-10 w-24" data-target="board" data-index="0" data-count="3">${[0,1,2].map(i=>window.state.board[i]?formatCardDisplay(window.state.board[i]):'').join('') || '<span class="text-gray-400 text-lg">+</span>'}</div>`;
      const turn=`<div class="card-placeholder h-10 w-8" data-target="board" data-index="3" data-count="1">${window.state.board[3]?formatCardDisplay(window.state.board[3]):'<span class="text-gray-400 text-lg">+</span>'}</div>`;
      const river=`<div class="card-placeholder h-10 w-8" data-target="board" data-index="4" data-count="1">${window.state.board[4]?formatCardDisplay(window.state.board[4]):'<span class="text-gray-400 text-lg">+</span>'}</div>`;
      el.boardCardPlaceholders.innerHTML = flop+turn+river;
    }
    // ìµœì¢… íŒŸ ê³„ì‚° í•¨ìˆ˜
    function calculateFinalPot(){
      // ì‹¤ì œ íŒŸ ê³„ì‚° ì‚¬ìš© (í´ë“œí•œ í”Œë ˆì´ì–´ì˜ ë² íŒ… í¬í•¨, ì–¸ì½œ ë² íŒ… ì œì™¸)
      return calculateActualPot();
    }
    
    function renderWinnerSelection(){
      const finalPot = calculateFinalPot();
      
      el.winnerButtons.innerHTML = window.state.playersInHand.map(p=>{
        const sel=(p.role==='winner');
        const potDisplay = sel && finalPot > 0 ? ` <span class="text-amber-300 font-bold">+${formatNumber(finalPot)}</span>` : '';
        return `<button class="btn ${sel?'btn-selected bg-amber-600':'bg-gray-600 hover:bg-gray-500'} px-2 py-1 text-xs rounded-md set-winner-btn" data-player-name="${p.name}">${p.name}${potDisplay}</button>`;
      }).join('');
    }
    function renderActionStreets(){
      const streets=['preflop','flop','turn','river']; 
      let displayPot=0;  // UI í‘œì‹œìš© íŒŸ
      
      el.streetLogsContainer.innerHTML = streets.map(street=>{
        const logs=window.state.actionState[street]||[]; 
        let streetPot=0;
        
        if(street==='preflop'){
          streetPot += parseInt(unformatNumber(window.state.actionState.smallBlind)||0,10);
          streetPot += parseInt(unformatNumber(window.state.actionState.bigBlind)||0,10);
          if(window.state.actionState.hasBBAnte) streetPot += parseInt(unformatNumber(window.state.actionState.bigBlind)||0,10);
        }
        
        // Pot Correctionì´ ìˆëŠ”ì§€ í™•ì¸
        const potCorrection = logs.find(a => a.action === 'Pot Correction');
        if(potCorrection) {
          // Pot Correctionì´ ìˆìœ¼ë©´ ê·¸ ê°’ì„ ì§ì ‘ ì‚¬ìš©
          displayPot = parseInt(unformatNumber(potCorrection.amount),10);
        } else {
          // ì¼ë°˜ ì•¡ì…˜ë“¤ë§Œ ë”í•¨
          logs.forEach(a=>{ 
            if(a.amount && a.action !== 'Pot Correction') {
              streetPot += parseInt(unformatNumber(a.amount),10); 
            }
          });
          displayPot += streetPot;
        }
        
        // ì‹¤ì œ íŒŸ ê³„ì‚° (í´ë“œí•œ í”Œë ˆì´ì–´ì˜ ë² íŒ… í¬í•¨)
        const actualPot = calculateActualPot();
        const uncalledBet = calculateUncalledBet();
        
        // ì‹¤ì œ íŒŸê³¼ í‘œì‹œ íŒŸì´ ë‹¤ë¥¸ ê²½ìš°ë¥¼ ìœ„í•œ í‘œì‹œ
        let potDisplay = formatNumber(displayPot);
        if(displayPot !== actualPot && logs.length > 0) {
          potDisplay = `${formatNumber(displayPot)} <span class="text-xs text-amber-400">(ì‹¤ì œ: ${formatNumber(actualPot)})</span>`;
        }
        const logHTML = logs.map(log=>{
          // Pot Correctionì€ ì‹œìŠ¤í…œ ì•¡ì…˜ì´ë¯€ë¡œ playerê°€ ì—†ìŒ
          if(log.action === 'Pot Correction'){
            const amt = log.amount ? ` <span class="font-mono text-white">${formatNumber(log.amount)}</span>` : '';
            return `<span class="action-log-entry mr-2"><span class="text-blue-400">Pot</span>${amt}</span>`;
          }
          // ì¼ë°˜ í”Œë ˆì´ì–´ ì•¡ì…˜
          const player=window.state.playersInHand.find(p=>p.name===log.player);
          const cls=(player?.role==='winner')?'text-amber-400':'text-gray-300';
          const amt=log.amount?` <span class="font-mono text-white">${formatNumber(log.amount)}</span>`:'';
          return `<span class="action-log-entry mr-2"><span class="${cls}">${log.player || 'Unknown'}</span> ${log.action}${amt}</span>`;
        }).join('');
        const isActive = window.state.currentStreet === street;
        const streetBtnClass = isActive 
          ? 'bg-amber-500 text-black border-2 border-amber-300 shadow-lg' 
          : 'bg-gray-700 text-gray-300 border-2 border-gray-600 hover:bg-gray-600 hover:text-white';
        const containerClass = isActive 
          ? 'bg-gradient-to-r from-amber-900/40 to-yellow-900/30 border-2 border-amber-400 shadow-xl ring-2 ring-amber-500/30' 
          : 'bg-gray-900/50 border border-gray-700';
        
        return `<div class="street-container ${containerClass} p-2 rounded-md">
          <div class="flex justify-between items-center text-xs mb-1">
            <button class="street-select-btn ${streetBtnClass} px-3 py-1 rounded-md font-bold min-w-[70px] text-center cursor-pointer" 
                    data-street="${street}" style="${isActive ? 'box-shadow: 0 0 10px rgba(251, 191, 36, 0.5);' : ''}">${street.toUpperCase()}</button>
            <div class="flex items-center gap-1">
              <span class="font-mono">Pot: ${potDisplay}</span>
              <button class="pot-keypad-btn btn bg-gray-600 px-1 py-0 rounded" data-street="${street}" data-current-pot="${displayPot}">âŒ¨ï¸</button>
            </div>
            <div class="flex gap-1">
              <button class="add-action-btn btn bg-indigo-600 text-white font-bold py-1 px-2 rounded" data-street="${street}">ì•¡ì…˜+</button>
              <button class="undo-action-btn btn bg-gray-600 py-1 px-2 rounded" data-street="${street}">â†©</button>
            </div>
          </div>
          <div id="${street}-log" class="action-log-display text-xs whitespace-nowrap overflow-x-auto">${logHTML || '<span class="text-gray-500">No actions</span>'}</div>
        </div>`;
      }).join('');
    }
    function renderAll(){ 
      renderPlayerSelection(); 
      renderPlayerDetails(); 
      renderBoard(); 
      renderActionStreets(); 
      renderWinnerSelection();
      updateButtonPositionDisplay();
    }
    // ====== MODALS ======
    function openModal(node, html){ node.innerHTML=html; node.classList.remove('hidden', 'opacity-0'); }
    function closeModal(node){ node.classList.add('hidden', 'opacity-0'); }

    function openCardSelector(){
      const { target, player, index, count } = window.state.modalState.cardTarget;
      
      // í”Œëì—ì„œëŠ” 5ì¥ê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡ ìˆ˜ì •
      let maxCards = count;
      let isFlop = false;
      if(target === 'board' && count === 3) {
        maxCards = 5; // í”Œëì—ì„œëŠ” ìµœëŒ€ 5ì¥ê¹Œì§€ ì„ íƒ ê°€ëŠ¥
        isFlop = true;
      }
      
      // í˜„ì¬ ì„ íƒëœ ì¹´ë“œë“¤ì„ ì´ˆê¸°ê°’ìœ¼ë¡œ ì„¤ì •
      let selected = [];
      if(target === 'playerHand' && player) {
        const p = window.state.playersInHand.find(p => p.name === player);
        if(p && p.hand) selected = [...p.hand];
      } else if(target === 'board') {
        if(isFlop) { // flop - ëª¨ë“  ë³´ë“œ ì¹´ë“œ í¬í•¨
          selected = window.state.board.filter(Boolean);
        } else if(index === 3) { // turn
          if(window.state.board[3]) selected = [window.state.board[3]];
        } else if(index === 4) { // river
          if(window.state.board[4]) selected = [window.state.board[4]];
        }
      }
      
      const used=[...window.state.playersInHand.flatMap(p=>p.hand||[]), ...window.state.board].filter(Boolean);
      let deckHTML='';
      Object.keys(SUITS).forEach(suitKey=>{
        deckHTML+='<div class="flex justify-center gap-1 mb-1">';
        RANKS.forEach(rank=>{
          const id=`${rank}${suitKey}`;
          // ë‹¤ë¥¸ ê³³ì—ì„œ ì‚¬ìš© ì¤‘ì¸ ì¹´ë“œ ì²´í¬ (í˜„ì¬ ëŒ€ìƒ ì œì™¸)
          let usedByOthers = false;
          const othersCards = [...window.state.playersInHand.flatMap(p => {
            if(target === 'playerHand' && p.name === player) return []; // í˜„ì¬ í”Œë ˆì´ì–´ ì œì™¸
            return p.hand || [];
          })];
          if(target !== 'board') {
            othersCards.push(...window.state.board.filter(Boolean));
          }
          usedByOthers = othersCards.includes(id) && !selected.includes(id);
          
          const isSelected = selected.includes(id);
          const color=(suitKey==='h'||suitKey==='d')?'card-red':'card-black';
          const bgClass = isSelected ? 'bg-amber-300' : (usedByOthers ? 'bg-gray-600 text-gray-500' : 'bg-white hover:bg-amber-300');
          const selectedClass = isSelected ? 'selected' : '';
          
          deckHTML+=`<button class="btn card-selector-btn rounded-md w-9 h-11 ${bgClass} ${color} ${selectedClass}" data-card-id="${id}" ${usedByOthers?'disabled':''}>${rank}${SUITS[suitKey]}</button>`;
        });
        deckHTML+='</div>';
      });
      const html=`<div class="bg-gray-800 rounded-lg p-2 w-full max-w-md">
        <h2 class="text-lg font-bold text-amber-400 mb-2 text-center">ì¹´ë“œ ì„ íƒ ${isFlop ? '(í”Œë/í„´/ë¦¬ë²„)' : `(${count}ì¥)`}</h2>
        <div id="selected-cards" class="text-center mb-2 text-sm text-gray-300">ì„ íƒëœ ì¹´ë“œ: <span id="selected-count">${selected.length}</span>/${isFlop ? '3-5' : maxCards}</div>
        <div id="card-deck">${deckHTML}</div>
        <div class="flex gap-2 mt-2">
          <button id="close-card-modal" class="btn flex-1 bg-red-600 py-2 rounded-md">ë‹«ê¸°</button>
          <button id="confirm-cards" class="btn flex-1 bg-green-600 py-2 rounded-md">í™•ì¸</button>
        </div>
      </div>`;
      openModal(el.cardSelectorModal, html);
      // ì¹´ë“œ ì„ íƒ ì´ë²¤íŠ¸
      const updateSelectedCount = () => {
        const counter = el.cardSelectorModal.querySelector('#selected-count');
        if(counter) counter.textContent = selected.length;
      };
      
      el.cardSelectorModal.querySelector('#card-deck').onclick=e=>{
        const btn=e.target.closest('.card-selector-btn'); if(!btn) return;
        const id=btn.dataset.cardId; const idx=selected.indexOf(id);
        const { target, count } = window.state.modalState.cardTarget;
        const isFlop = target === 'board' && count === 3;
        const maxAllowed = isFlop ? 5 : count; // í”Œëì—ì„œëŠ” ìµœëŒ€ 5ì¥ê¹Œì§€
        
        if(idx>-1){ 
          // ì´ë¯¸ ì„ íƒëœ ì¹´ë“œë¥¼ ë‹¤ì‹œ í´ë¦­í•˜ë©´ ì„ íƒ í•´ì œ
          selected.splice(idx,1); 
          btn.classList.remove('selected');
          btn.classList.remove('bg-amber-300');
          btn.classList.add('bg-white', 'hover:bg-amber-300');
        }
        else if(selected.length<maxAllowed){ 
          selected.push(id); 
          btn.classList.add('selected');
          btn.classList.remove('bg-white', 'hover:bg-amber-300');
          btn.classList.add('bg-amber-300');
        }
        updateSelectedCount();
      };
      
      // í™•ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸
      el.cardSelectorModal.querySelector('#confirm-cards').onclick=()=>{
        const { target, count } = window.state.modalState.cardTarget;
        const isFlop = target === 'board' && count === 3;
        
        // í”Œëì—ì„œëŠ” ìµœì†Œ 3ì¥ í•„ìˆ˜
        if(isFlop && selected.length > 0 && selected.length < 3) {
          showFeedback('í”Œëì€ ìµœì†Œ 3ì¥ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.', true);
          return;
        }
        
        // ì¹´ë“œê°€ ì—†ìœ¼ë©´ ì œê±°, ìˆìœ¼ë©´ í• ë‹¹
        assignCard(selected.length > 0 ? selected : null);
      };
    }

    // ìƒˆë¡œìš´ ìŠ¤íŠ¸ë¦¿ ê¸°ë°˜ ì•¡ì…˜ ì‹œìŠ¤í…œ
    function openActionPad(street){
      if(window.state.playersInHand.length<1){ showFeedback('ë¨¼ì € í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', true); return; }

      // ì•¡ì…˜ ê´€ë¦¬ì ë™ê¸°í™”
      window.actionManager.currentStreet = street;
      window.state.currentStreet = street;
      window.state.modalState.actionPadStreet = street;

      const activePlayers = window.actionManager.getActivePlayers(window.state.playersInHand);
      if(activePlayers.length === 0) {
        showFeedback('ë² íŒ… ê°€ëŠ¥í•œ í”Œë ˆì´ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.', true);
        return;
      }

      // í˜„ì¬ ì•¡ì…˜í•  í”Œë ˆì´ì–´
      const currentPlayer = window.actionManager.getCurrentActionPlayer();
      const actionOrder = window.actionManager.calculateActionOrder(street);

      // ì•¡ì…˜ ëª¨ë“œ í† ê¸€ ë²„íŠ¼
      const modeIcon = window.actionManager.actionMode === 'auto' ? 'ğŸ¤–' : 'ğŸ‘†';
      const modeText = window.actionManager.actionMode === 'auto' ? 'ìë™ ìˆœì„œ' : 'ìˆ˜ë™ ì„ íƒ';

      // ì•¡ì…˜ í í‘œì‹œ
      const queueDisplay = actionOrder.map((p, index) => {
        const isCurrent = currentPlayer && p.name === currentPlayer.name;
        const hasActed = (window.state.actionState[street] || []).some(a => a.player === p.name);

        let statusIcon = 'â³';
        let statusClass = 'text-gray-400';

        if (hasActed) {
          statusIcon = 'âœ…';
          statusClass = 'text-green-400';
        } else if (isCurrent) {
          statusIcon = 'ğŸ¯';
          statusClass = 'text-amber-400 animate-pulse';
        }

        return `<span class="${statusClass}">${statusIcon} ${p.name}</span>`;
      }).join(' â†’ ');

      // Check/Call ì•¡ì…˜ ê²°ì • (í˜„ì¬ í”Œë ˆì´ì–´ìš©)
      let checkCallButtonHTML = '';
      if(currentPlayer) {
        const smartAction = getSmartCheckCallAction(currentPlayer.name, street);
        const btnColor = smartAction.action === 'Checks' ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-600 hover:bg-blue-700';
        const btnIcon = smartAction.action === 'Checks' ? 'âœ…' : 'ğŸ“';
        const btnText = smartAction.action === 'Checks' ? 'Check' : `Call ${formatNumber(smartAction.amount)}`;

        checkCallButtonHTML = `
          <button id="smart-check-call-btn" class="btn ${btnColor} p-3 rounded-md" data-action="SmartCheckCall" data-player="${currentPlayer.name}">
            ${btnIcon} ${btnText}
          </button>`;
      }

      const html=`<div class="bg-gray-800 rounded-lg p-4 w-full max-w-lg">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold text-amber-400">${street.toUpperCase()} ì•¡ì…˜</h2>
          <button id="toggle-action-mode" class="text-sm bg-gray-700 px-3 py-1 rounded">
            ${modeIcon} ${modeText}
          </button>
        </div>

        <!-- ì•¡ì…˜ í í‘œì‹œ -->
        <div class="bg-gray-900 p-3 rounded mb-4">
          <div class="text-xs text-gray-400 mb-1">ì•¡ì…˜ ìˆœì„œ:</div>
          <div class="text-sm">${queueDisplay}</div>
          ${currentPlayer ? `<div class="text-xs text-amber-400 mt-2">í˜„ì¬ ì°¨ë¡€: ${currentPlayer.name}</div>` : ''}
        </div>

        <!-- í˜„ì¬ í”Œë ˆì´ì–´ ì•¡ì…˜ ë²„íŠ¼ -->
        ${currentPlayer && window.actionManager.actionMode === 'auto' ? `
          <div class="mb-4">
            <div class="text-center text-lg font-bold text-amber-400 mb-3">${currentPlayer.name}ì˜ ì•¡ì…˜</div>
            <div id="current-player-actions" class="grid grid-cols-2 gap-2">
              <button class="btn bg-red-600 hover:bg-red-700 p-3 rounded-md" data-action="Folds" data-player="${currentPlayer.name}">
                âŒ Fold
              </button>
              ${checkCallButtonHTML}
              <button class="btn bg-blue-600 hover:bg-blue-700 p-3 rounded-md" data-action="Bet/Raises" data-player="${currentPlayer.name}">
                ğŸ’° Bet/Raise
              </button>
              <button class="btn bg-red-800 hover:bg-red-900 font-bold p-3 rounded-md" data-action="All In" data-player="${currentPlayer.name}">
                ğŸš€ ALL IN
              </button>
            </div>
          </div>
        ` : ''}

        <!-- ìˆ˜ë™ ëª¨ë“œ ë˜ëŠ” ëª¨ë“  í”Œë ˆì´ì–´ ì„ íƒ -->
        ${window.actionManager.actionMode === 'manual' || !currentPlayer ? `
          <div class="mb-4">
            <div class="text-sm text-gray-400 mb-2">í”Œë ˆì´ì–´ ì„ íƒ:</div>
            <div id="action-pad-players" class="grid grid-cols-3 gap-2 mb-3">
              ${activePlayers.map(p => {
                const hasActed = (window.state.actionState[street] || []).some(a => a.player === p.name);
                const btnClass = hasActed ? 'bg-gray-600' : 'bg-gray-700 hover:bg-gray-600';
                const indicator = hasActed ? ' âœ…' : '';
                return `<button class="btn ${btnClass} p-2 rounded-md" data-player-name="${p.name}">${p.name}${indicator}</button>`;
              }).join('')}
            </div>
            <div id="action-pad-actions" class="grid grid-cols-2 gap-2 hidden">
              <button class="btn bg-red-600 p-3 rounded-md" data-action="Folds">âŒ Fold</button>
              <button id="manual-smart-check-call-btn" class="btn bg-green-600 p-3 rounded-md" data-action="SmartCheckCall">
                <span class="action-label">âœ… Check</span>
                <span class="amount-label"></span>
              </button>
              <button class="btn bg-blue-600 p-3 rounded-md" data-action="Bet/Raises">ğŸ’° Bet/Raise</button>
              <button class="btn bg-red-800 font-bold p-3 rounded-md" data-action="All In">ğŸš€ ALL IN</button>
            </div>
          </div>
        ` : ''}

        <!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ -->
        <div class="flex gap-2">
          ${window.actionManager.actionMode === 'auto' && currentPlayer ? `
            <button id="skip-current-player" class="btn bg-yellow-600 hover:bg-yellow-700 px-3 py-2 rounded text-sm">
              â­ï¸ ìŠ¤í‚µ
            </button>
          ` : ''}
          <button id="close-action-pad" class="btn flex-1 bg-gray-600 hover:bg-gray-700 py-2 rounded-md">ë‹«ê¸°</button>
        </div>
      </div>`;

      openModal(el.actionPadModal, html);
    }

    // í”Œë ˆì´ì–´ ì•¡ì…˜ ì‹¤í–‰ í•¨ìˆ˜ (ë³´ì•ˆ ë ˆì´ì–´ í¬í•¨)
    async function executePlayerAction(playerName, action, btn) {
      const modal = el.actionPadModal;
      const manager = window.actionManager;

      // Layer 6: ë®¤í…ìŠ¤ ì²´í¬ (ë™ì‹œ ì•¡ì…˜ ë°©ì§€)
      if (manager.isProcessing) {
        console.warn('ì´ë¯¸ ì•¡ì…˜ì´ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤');
        showFeedback('âš ï¸ ì´ì „ ì•¡ì…˜ ì²˜ë¦¬ ì¤‘...', true);
        return;
      }

      manager.isProcessing = true;

      try {
        // Layer 1: íƒ€ì„ìŠ¤íƒ¬í”„ ìƒì„± (ë¡œê¹…ìš©)
        const timestamp = manager.timekeeper.generateTimestamp();
        manager.timekeeper.validateAndUpdate(timestamp);

        // Layer 2: Rate monitoring (ë¡œê¹…ìš©)
        manager.rateLimiter.check(playerName);

        // Layer 3: í”Œë ˆì´ì–´ ê²€ì¦ (ìë™ ë“±ë¡ ì œê±°)
        // manager.stateValidator.validatePlayer(playerName); // ì¤‘ë³µ ë“±ë¡ ë°©ì§€ë¥¼ ìœ„í•´ ì œê±°

        // í˜„ì¬ í”Œë ˆì´ì–´ í™•ì¸ (ìë™ ëª¨ë“œ)
        if (manager.actionMode === 'auto') {
          const currentPlayer = manager.getCurrentActionPlayer();
          if (currentPlayer && currentPlayer.name !== playerName) {
            console.log(`ìˆœì„œ ë°– ì•¡ì…˜: ${playerName} (í˜„ì¬: ${currentPlayer.name})`);
            // ê·¸ë˜ë„ í—ˆìš©
          }
        }

        // Layer 5: íŠ¸ëœì­ì…˜ ì‹œì‘
        const transaction = manager.startTransaction();

        try {
          // í˜„ì¬ í”Œë ˆì´ì–´ë¥¼ actionPadPlayerë¡œ ì„¤ì •
          window.state.modalState.actionPadPlayer = playerName;

          // ì•¡ì…˜ ì²˜ë¦¬
          if(action === 'SmartCheckCall') {
            const smartAction = getSmartCheckCallAction(playerName, manager.currentStreet);
            addActionToLog(smartAction.label, smartAction.amount, playerName);
          } else if(action === 'Folds') {
            addActionToLog('Folds', null, playerName);
            // í”Œë ˆì´ì–´ ìƒíƒœ ì—…ë°ì´íŠ¸
            window.state.playerStatus[playerName] = 'folded';
          } else if(action === 'All In') {
            const player = window.state.playersInHand.find(p => p.name === playerName);
            if(player) {
              addActionToLog('All In', player.chips, playerName);
              window.state.playerStatus[playerName] = 'allin';
            }
          } else if(action === 'Bet/Raises') {
            closeModal(modal);
            window.state.modalState.actionPadPlayer = playerName;

            const st = manager.currentStreet;
            const hasBet = window.state.actionState[st]?.some(a => /BET|RAISE/i.test(a.action || ''));
            window.state.modalState.actionPadCurrentAction = hasBet ? 'Raises' : 'Bets';

            openKeypad(null, { purpose: 'bet', playerName: playerName });
            manager.isProcessing = false; // í‚¤íŒ¨ë“œ ëŒ€ê¸° ì¤‘ ì²˜ë¦¬ í•´ì œ
            return;
          }

          // ìƒíƒœ í•´ì‹œ ì—…ë°ì´íŠ¸
          manager.stateValidator.updateState();

          // íŠ¸ëœì­ì…˜ ì»¤ë°‹
          transaction.commit();

          // ìë™ ëª¨ë“œì—ì„œ ë‹¤ìŒ í”Œë ˆì´ì–´ë¡œ ì´ë™
          if(manager.actionMode === 'auto') {
            const nextPlayer = manager.moveToNextPlayer();

            showFeedback(`âœ… ${playerName} ${action}`, false);

            if(nextPlayer) {
              // ì ì‹œ ëŒ€ê¸° í›„ ë‹¤ìŒ í”Œë ˆì´ì–´ ì•¡ì…˜ íŒì—…
              setTimeout(() => {
                openActionPad(manager.currentStreet);
              }, 300);
            } else {
              closeModal(modal);

              // ìŠ¤íŠ¸ë¦¿ ì™„ë£Œ ì²´í¬
              if (manager.isBettingRoundComplete()) {
                showFeedback(`ğŸ¯ ${manager.currentStreet.toUpperCase()} ì™„ë£Œ! ë‹¤ìŒ ìŠ¤íŠ¸ë¦¿ ì¤€ë¹„...`, false);

                // ìë™ìœ¼ë¡œ ë‹¤ìŒ ìŠ¤íŠ¸ë¦¿ ì§„í–‰
                setTimeout(() => {
                  manager.advanceToNextStreet();
                }, 500);
              }
            }
          } else {
            closeModal(modal);
            showFeedback(`âœ… ${playerName} ${action}`, false);
          }

        } catch (innerError) {
          // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ê³„ì† ì§„í–‰
          console.warn('ì•¡ì…˜ ì²˜ë¦¬ ì¤‘ ê²½ê³ :', innerError.message);
          transaction.rollback();
        }

      } catch (error) {
        // ì—ëŸ¬ ë¡œê·¸ë§Œ ì¶œë ¥í•˜ê³  ê³„ì† ì§„í–‰
        console.log('ì•¡ì…˜ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸:', error.message);
      } finally {
        manager.isProcessing = false;
      }
    }

    // ì¹© ì…ë ¥ ê°œì„  í•¨ìˆ˜
    function openChipInput(player, isInitial = false) {
      const currentChips = player.chips || '0';
      const placeholder = isInitial ? 'ì‹œì‘ ì¹© ì…ë ¥' : `í˜„ì¬: ${formatNumber(currentChips)}`;
      
      // í‚¤íŒ¨ë“œ ì˜µì…˜ ì„¤ì •
      window.state.modalState.keypadOptions = {
        purpose: 'chip',
        playerName: player.name
      };
      
      // íŒì—… ëª¨ë‹¬ ìƒì„±
      const html = `<div class="bg-gray-800 rounded-lg p-4 w-full max-w-xs">
        <h3 class="text-center text-amber-400 font-bold mb-3">${player.name} ì¹© ìˆ˜ì •</h3>
        <div class="text-xs text-gray-400 text-center mb-2">í˜„ì¬: ${formatNumber(currentChips)}</div>
        <input type="text" id="chip-text-input" class="w-full bg-gray-900 text-white p-2 rounded mb-3 text-center" placeholder="0" value="0">
        <div id="keypad-display" class="bg-gray-900 text-right text-2xl font-mono p-2 rounded mb-2 h-12">0</div>
        <div class="grid grid-cols-3 gap-2 text-xl font-bold">
          ${['7','8','9','4','5','6','1','2','3','0','00','000'].map(k=>`<button class="keypad-btn btn bg-gray-700 p-3 rounded-md">${k}</button>`).join('')}
        </div>
        <div class="grid grid-cols-2 gap-2 mt-2">
          <button class="keypad-btn btn bg-gray-600 text-amber-400 p-3 rounded-md">C</button>
          <button class="keypad-btn btn bg-gray-600 text-amber-400 p-3 rounded-md">â†</button>
        </div>
        <div class="grid grid-cols-2 gap-2 mt-2">
          <button id="keypad-cancel" class="btn bg-red-600 p-3 rounded-md">ì·¨ì†Œ</button>
          <button id="keypad-confirm" class="btn bg-green-600 p-3 rounded-md">í™•ì¸</button>
        </div>
      </div>`;
      
      openModal(el.keypadModal, html);
      
      // í…ìŠ¤íŠ¸ ì…ë ¥ê³¼ í‚¤íŒ¨ë“œ ë””ìŠ¤í”Œë ˆì´ ë™ê¸°í™”
      setTimeout(() => {
        const textInput = document.getElementById('chip-text-input');
        const display = document.getElementById('keypad-display');
        let currentInput = '0';
        
        if(textInput && display) {
          // í…ìŠ¤íŠ¸ ì…ë ¥ ì´ë²¤íŠ¸
          textInput.addEventListener('input', () => {
            currentInput = unformatNumber(textInput.value) || '0';
            display.textContent = formatNumber(currentInput);
          });
          
          // í‚¤íŒ¨ë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ëŠ” ì „ì—­ í‚¤íŒ¨ë“œ ëª¨ë‹¬ ì´ë²¤íŠ¸ì—ì„œ ì²˜ë¦¬
          // (ì¤‘ë³µ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°)
          
          // ì·¨ì†Œ/í™•ì¸ ë²„íŠ¼ì€ ì „ì—­ í‚¤íŒ¨ë“œ ëª¨ë‹¬ ì´ë²¤íŠ¸ì—ì„œ ì²˜ë¦¬
          // (ì¤‘ë³µ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°)
          
          // í™•ì¸ ë²„íŠ¼ì€ ì „ì—­ í‚¤íŒ¨ë“œ ëª¨ë‹¬ ì´ë²¤íŠ¸ì—ì„œ ì²˜ë¦¬
          // (ì¤‘ë³µ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°)
        }
      }, 10);
    }
    
    function openKeypad(targetInput, options={}){
      window.state.modalState.keypadTarget=targetInput;
      window.state.modalState.keypadOptions=options;
      const initial = options.prefill !== undefined ? options.prefill : (targetInput?targetInput.value:'');

      // ë² íŒ… í‚¤íŒ¨ë“œì¸ ê²½ìš° í”Œë ˆì´ì–´ ì¹© í™•ì¸
      let playerChips = 0;
      let chipWarning = '';
      if(options.purpose === 'bet' && options.playerName) {
        const player = window.state.playersInHand.find(p => p.name === options.playerName);
        if(player) {
          playerChips = parseInt(unformatNumber(player.chips), 10);
          chipWarning = `<div class="text-xs text-gray-400 text-center mb-1">ë³´ìœ  ì¹©: ${formatNumber(playerChips)}</div>`;
        }
      } else if(options.purpose === 'bet' && window.state.modalState.actionPadPlayer) {
        const player = window.state.playersInHand.find(p => p.name === window.state.modalState.actionPadPlayer);
        if(player) {
          playerChips = parseInt(unformatNumber(player.chips), 10);
          chipWarning = `<div class="text-xs text-gray-400 text-center mb-1">ë³´ìœ  ì¹©: ${formatNumber(playerChips)}</div>`;
        }
      }

      const html=`<div class="bg-gray-800 rounded-lg p-2 w-full max-w-xs">
        ${chipWarning}
        <div id="keypad-display" class="bg-gray-900 text-right text-2xl font-mono p-2 rounded mb-2 h-12">${initial}</div>
        <div id="keypad-warning" class="text-xs text-amber-400 text-center mb-2 hidden">âš ï¸ ì¹© ë¶€ì¡± - ì˜¬ì¸ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤</div>
        <div class="grid grid-cols-3 gap-2 text-xl font-bold">
          ${['7','8','9','4','5','6','1','2','3','0','00','000'].map(k=>`<button class="keypad-btn btn bg-gray-700 p-3 rounded-md">${k}</button>`).join('')}
        </div>
        <div class="grid grid-cols-${options.purpose === 'bet' ? '3' : '2'} gap-2 mt-2">
          <button class="keypad-btn btn bg-gray-600 text-amber-400 p-3 rounded-md">C</button>
          <button class="keypad-btn btn bg-gray-600 text-amber-400 p-3 rounded-md">â†</button>
          ${options.purpose === 'bet' && playerChips > 0 ?
            `<button class="keypad-btn btn bg-purple-600 text-white p-3 rounded-md font-bold" data-action="max">MAX</button>` : ''
          }
        </div>
        <div class="grid grid-cols-2 gap-2 mt-2">
          <button id="keypad-cancel" class="btn bg-red-600 p-3 rounded-md">ì·¨ì†Œ</button>
          <button id="keypad-confirm" class="btn bg-green-600 p-3 rounded-md">í™•ì¸</button>
        </div>
      </div>`;
      openModal(el.keypadModal, html);

      // ì‹¤ì‹œê°„ ì¹© ì²´í¬ ê¸°ëŠ¥ ì¶”ê°€
      if(options.purpose === 'bet' && playerChips > 0) {
        const display = el.keypadModal.querySelector('#keypad-display');
        const warning = el.keypadModal.querySelector('#keypad-warning');

        // ë””ìŠ¤í”Œë ˆì´ ê°’ ë³€ê²½ ê°ì§€
        const observer = new MutationObserver(() => {
          const value = parseInt(unformatNumber(display.textContent) || 0, 10);
          if(value > playerChips) {
            warning.classList.remove('hidden');
            warning.textContent = `âš ï¸ ì¹© ë¶€ì¡±! ìµœëŒ€ ë² íŒ… ê°€ëŠ¥: ${formatNumber(playerChips)}`;
            warning.className = 'text-xs text-red-400 text-center mb-2';
          } else if(value === playerChips && value > 0) {
            warning.classList.remove('hidden');
            warning.textContent = `ğŸ’° ìµœëŒ€ ë² íŒ… - ë³´ìœ  ì¹© ì „ì²´`;
            warning.className = 'text-xs text-blue-400 text-center mb-2';
          } else {
            warning.classList.add('hidden');
          }
        });

        observer.observe(display, { childList: true, characterData: true, subtree: true });
      }
    }

    // ====== SELECTORS & INPUTS ======
    function togglePlayerInHand(name){
      const i=window.state.playersInHand.findIndex(p=>p.name===name);
      if(i>-1) {
        // í”Œë ˆì´ì–´ ì œê±° (ê²Œì„ì—ì„œ ì œì™¸)
        const player = window.state.playersInHand[i];
        window.state.playersInHand.splice(i,1);
        // seatMapì—ì„œë„ ì œê±°
        if(player.seat) {
          delete window.state.seatMap[player.seat];
        }
        console.log(`â– ${name} ê²Œì„ì—ì„œ ì œì™¸ (Seat ${player.seat})`);
      } else {
        // í”Œë ˆì´ì–´ ì¶”ê°€ (ê²Œì„ì— ì°¸ì—¬)
        const pool=window.state.playerDataByTable[window.state.selectedTable]||[];
        const pd=pool.find(p=>p.name===name);
        if(!pd) return;
        
        const chips=pd.chips||'';
        const notable=pd.notable||false;
        const seat=pd.seat||''; // Type ì‹œíŠ¸ì˜ seat ì •ë³´
        
        // seatMapì— ì¶”ê°€
        if(seat) {
          window.state.seatMap[seat] = name;
        }
        
        // ìƒˆ í”Œë ˆì´ì–´ ì¶”ê°€ ì‹œ initialChipsë¥¼ í˜„ì¬ ì¹©ìœ¼ë¡œ ì„¤ì •
        console.log(`â• ${name} ê²Œì„ ì°¸ì—¬: ì‹œì‘ì¹© = ${chips}, ì¢Œì„ = ${seat}`);
        window.state.playersInHand.push({
          name, 
          hand:[], 
          chips, 
          initialChips:chips,  // ì‹œì‘ì¹©ì€ í˜„ì¬ ì¹© ê°’ìœ¼ë¡œ ì„¤ì •
          role:null,
          notable:notable,  // Notable ì •ë³´ ì¶”ê°€
          seat:seat,  // Seat ì •ë³´ ìœ ì§€
          chipsSetAt: new Date().toISOString()  // ì¹© ì„¤ì • ì‹œê°„ ê¸°ë¡
        });
      }
      renderPlayerSelection(); 
      renderPlayerDetails(); 
      renderWinnerSelection();
    }
    function setPlayerRole(name){
      const finalPot = calculateFinalPot();
      
      // ê¸°ì¡´ ìŠ¹ì ì°¾ê¸°
      const prevWinner = window.state.playersInHand.find(p => p.role === 'winner');
      
      // ê¸°ì¡´ ìŠ¹ìê°€ ìˆìœ¼ë©´ íŒŸ ê¸ˆì•¡ ì°¨ê°
      if(prevWinner && prevWinner.name !== name) {
        const prevChips = parseInt(unformatNumber(prevWinner.chips) || 0, 10);
        prevWinner.chips = (prevChips - finalPot).toString();
        prevWinner.role = null;
      }
      
      // ìƒˆ ìŠ¹ì ì„¤ì •
      const p = window.state.playersInHand.find(pp => pp.name === name);
      if(!p) return;
      
      if(p.role === 'winner') {
        // ìŠ¹ì í•´ì œ
        const currentChips = parseInt(unformatNumber(p.chips) || 0, 10);
        p.chips = (currentChips - finalPot).toString();
        p.role = null;
      } else {
        // ìŠ¹ì ì„¤ì •
        const currentChips = parseInt(unformatNumber(p.chips) || 0, 10);
        p.chips = (currentChips + finalPot).toString();
        p.role = 'winner';
        
        // ë‹¤ë¥¸ ëª¨ë“  í”Œë ˆì´ì–´ì˜ role í•´ì œ
        window.state.playersInHand.forEach(player => {
          if(player.name !== name) player.role = null;
        });
      }
      
      // ì¹© ë³€ê²½ íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë¡
      p.chipsUpdatedAt = new Date().toISOString();
      
      renderPlayerDetails(); 
      renderWinnerSelection();
      renderActionStreets(); // ì•¡ì…˜ ë¡œê·¸ì—ë„ ìŠ¹ì í•˜ì´ë¼ì´íŠ¸ ì—…ë°ì´íŠ¸
    }
    function assignCard(cards){
      const {target,player,index,count} = window.state.modalState.cardTarget;
      if(target==='board'){
        if(!cards || cards.length === 0) {
          // ì¹´ë“œ ì œê±°
          if(count === 3) { // flop
            window.state.board[0] = null;
            window.state.board[1] = null;
            window.state.board[2] = null;
            window.state.board[3] = null; // í„´ë„ ì œê±°
            window.state.board[4] = null; // ë¦¬ë²„ë„ ì œê±°
          } else if(index === 3) { // turn
            window.state.board[3] = null;
          } else if(index === 4) { // river
            window.state.board[4] = null;
          }
        } else {
          // ë³´ë“œ ë°°ì—´ì´ ì¶©ë¶„í•œ í¬ê¸°ì¸ì§€ í™•ì¸
          while(window.state.board.length <= 4) {
            window.state.board.push(null);
          }
          
          // ì¹´ë“œ í• ë‹¹
          if(count === 3) { // flopì—ì„œ ì„ íƒ
            // í”Œë 3ì¥
            window.state.board[0] = cards[0] || null;
            window.state.board[1] = cards[1] || null;
            window.state.board[2] = cards[2] || null;
            
            // 4ì¥ ì´ìƒ ì„ íƒí–ˆìœ¼ë©´ í„´ì— í• ë‹¹
            if(cards.length >= 4) {
              window.state.board[3] = cards[3];
            }
            
            // 5ì¥ ì„ íƒí–ˆìœ¼ë©´ ë¦¬ë²„ì—ë„ í• ë‹¹
            if(cards.length >= 5) {
              window.state.board[4] = cards[4];
            }
          } else {
            // turn(index=3) ë˜ëŠ” river(index=4): í•´ë‹¹ ì¸ë±ìŠ¤ë§Œ ì—…ë°ì´íŠ¸
            window.state.board[index] = cards[0] || null;
          }
        }
        renderBoard();
      }
      else{
        const p=window.state.playersInHand.find(pp=>pp.name===player);
        if(p){ 
          p.hand = cards || []; // nullì´ë©´ ë¹ˆ ë°°ì—´ë¡œ
          renderPlayerDetails();
        }
      }
      closeModal(el.cardSelectorModal);
    }
    function addActionToLog(action, amount=null, player=null){
      const { actionPadStreet, actionPadPlayer } = window.state.modalState;
      const playerName = player || actionPadPlayer;

      // í”Œë ˆì´ì–´ ìƒíƒœ ì—…ë°ì´íŠ¸ (null ì²´í¬ ì¶”ê°€)
      if (!action) {
        console.warn('addActionToLog: actionì´ null ë˜ëŠ” undefinedì…ë‹ˆë‹¤');
        return;
      }

      if (action === 'Folds') {
        window.state.playerStatus[playerName] = 'folded';
      } else if (action === 'All In') {
        window.state.playerStatus[playerName] = 'allin';
      } else if (action.includes('Call')) {
        window.state.playerStatus[playerName] = 'called';
      } else if (action.includes('Bet') || action.includes('Raise')) {
        window.state.playerStatus[playerName] = 'bet';
      }

      // ì•¡ì…˜ ê´€ë¦¬ìì™€ ë™ê¸°í™”
      if(window.actionManager && window.actionManager.actionMode === 'auto') {
        window.actionManager.currentStreet = actionPadStreet;
      }
      
      if (amount){
        const p = window.state.playersInHand.find(pp => pp.name === actionPadPlayer);
        if (p){
          const cur = parseInt(unformatNumber(p.chips) || 0, 10);
          const amountToDeduct = parseInt(unformatNumber(amount), 10);

          // ì¹© ì´ˆê³¼ ê²½ê³  (ì°¨ë‹¨í•˜ì§€ ì•ŠìŒ)
          // ìŒìˆ˜ ì¹©ë„ í—ˆìš©í•˜ì—¬ ìœ ì—°í•˜ê²Œ ì²˜ë¦¬
          if(amountToDeduct > cur && action !== 'All In') {
            console.log(`[v3.3.3] ì¹© ì´ˆê³¼ ê²½ê³ : ${playerName} - ìš”ì²­: ${amountToDeduct}, ë³´ìœ : ${cur}`);

            // ê²½ê³ ë§Œ í‘œì‹œí•˜ê³  ì§„í–‰ì€ í—ˆìš©
            showFeedback(`âš ï¸ ì£¼ì˜: ì¹©ì´ ë¶€ì¡±í•©ë‹ˆë‹¤ (ë³´ìœ : ${formatNumber(cur)}, ë² íŒ…: ${formatNumber(amountToDeduct)})`, true);
            showFeedback(`ğŸ’° ì¹©ì´ ë§ˆì´ë„ˆìŠ¤ê°€ ë©ë‹ˆë‹¤: ${formatNumber(cur - amountToDeduct)}`, false);
          }

          // ì¹© ì°¨ê° ì²˜ë¦¬ (ë§ˆì´ë„ˆìŠ¤ í—ˆìš©)
          if(action === 'All In') {
            p.chips = '0';
          } else {
            // ì¹© ì°¨ê° - ë§ˆì´ë„ˆìŠ¤ë„ í—ˆìš©
            const newChips = cur - amountToDeduct;
            p.chips = newChips.toString();

            // ë§ˆì´ë„ˆìŠ¤ ì¹©ì¸ ê²½ìš° ì‹œê°ì  í‘œì‹œë¥¼ ìœ„í•œ í”Œë˜ê·¸
            if(newChips < 0) {
              p.hasNegativeChips = true;
              console.log(`[v3.3.3] ë§ˆì´ë„ˆìŠ¤ ì¹© ë°œìƒ: ${playerName} = ${newChips}`);
            } else {
              p.hasNegativeChips = false;
            }
          }
          p.chipsUpdatedAt = new Date().toISOString();
        }
      }
      window.state.actionState[actionPadStreet].push({
        player: actionPadPlayer,
        action,
        amount,
        timestamp: new Date().toISOString()
      });
      saveActionState();
      renderAll();
      closeModal(el.actionPadModal);
      
      // ìŠ¤íŠ¸ë¦¬íŠ¸ ì™„ë£Œ ì²´í¬
      checkStreetComplete(actionPadStreet);
    }

    function undoLastAction(street){
      const last=window.state.actionState[street].pop();
      if(last) {
        // í”Œë ˆì´ì–´ ìƒíƒœ ë³µì›
        if(last.action === 'Folds' || last.action === 'All In') {
          delete window.state.playerStatus[last.player];
        }
        
        // ì¹© ë³µì›
        if(last.amount){
          const p=window.state.playersInHand.find(pp=>pp.name===last.player);
          if(p){ 
            const cur=parseInt(unformatNumber(p.chips)||0,10); 
            p.chips=(cur+parseInt(unformatNumber(last.amount),10)).toString(); 
          }
        }
      }
      saveActionState(); renderAll();
    }

    // ====== SEAT ARRANGEMENT & ACTION ORDER ======
    function initializeSeatGrid() {
      const buttonSelect = document.getElementById('button-position-select');
      
      // ë²„íŠ¼ ìœ„ì¹˜ ì˜µì…˜ ìƒì„± (10ê°œ)
      if(buttonSelect) {
        buttonSelect.innerHTML = '<option value="">ì„ íƒ</option>';
        for(let i = 1; i <= 10; i++) {
          const option = document.createElement('option');
          option.value = i;
          option.textContent = `${i}ë²ˆ`;
          buttonSelect.appendChild(option);
        }
      }
      
      // ì´ˆê¸° ë Œë”ë§
      renderPlayerSelection();
    }
    
    function updateSeatDisplay() {
      // ìƒˆë¡œìš´ êµ¬ì¡°ì—ì„œëŠ” renderPlayerSelectionì´ ëª¨ë“  ê²ƒì„ ì²˜ë¦¬
      // renderPlayerSelection ë‚´ë¶€ì—ì„œ updatePositionIndicatorsë¥¼ í˜¸ì¶œí•¨
      renderPlayerSelection();
    }
    
    function getPositionsForSeat(seatNum) {
      const positions = [];
      if(!window.state.buttonPosition) return positions;
      
      const btnPos = parseInt(window.state.buttonPosition);
      const allPlayerSeats = getAllPlayerSeats();
      
      if(seatNum === btnPos) positions.push('BTN');
      
      // SB, BB ê³„ì‚° (ì „ì²´ í”Œë ˆì´ì–´ ì¤‘ ë²„íŠ¼ ë‹¤ìŒ í”Œë ˆì´ì–´ë“¤)
      const sbSeat = getNextPlayerSeat(btnPos, allPlayerSeats);
      const bbSeat = getNextPlayerSeat(sbSeat, allPlayerSeats);
      
      if(seatNum === sbSeat) positions.push('SB');
      if(seatNum === bbSeat) positions.push('BB');
      
      return positions;
    }
    
    function getOccupiedSeats() {
      return Object.keys(window.state.seatMap)
        .map(s => parseInt(s))
        .filter(s => window.state.seatMap[s])
        .sort((a, b) => a - b);
    }
    
    // ì „ì²´ í”Œë ˆì´ì–´ ì¢Œì„ ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸° (ê²Œì„ ì°¸ì—¬ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´)
    function getAllPlayerSeats() {
      if(!window.state.selectedTable) return [];
      const tableData = window.state.playerDataByTable[window.state.selectedTable] || [];
      return tableData
        .filter(player => player.seat)
        .map(player => parseInt(player.seat))
        .sort((a, b) => a - b);
    }
    
    // ì „ì²´ í”Œë ˆì´ì–´ ì¤‘ì—ì„œ ë‹¤ìŒ ì¢Œì„ ì°¾ê¸° (SB/BB ê³„ì‚°ìš©)
    function getNextPlayerSeat(currentSeat, allSeats) {
      if(!allSeats.length) return null;
      
      // í˜„ì¬ ì¢Œì„ ë‹¤ìŒì˜ ì²« ë²ˆì§¸ í”Œë ˆì´ì–´ ì¢Œì„ ì°¾ê¸°
      for(let i = 1; i <= 10; i++) {
        const nextSeat = ((currentSeat + i - 1) % 10) + 1;
        if(allSeats.includes(nextSeat)) {
          return nextSeat;
        }
      }
      return allSeats[0];
    }
    
    function getNextOccupiedSeat(currentSeat, occupiedSeats) {
      if(!occupiedSeats.length) return null;
      
      // í˜„ì¬ ì¢Œì„ ë‹¤ìŒì˜ ì²« ë²ˆì§¸ ì ìœ  ì¢Œì„ ì°¾ê¸°
      for(let i = 1; i <= 10; i++) {
        const nextSeat = ((currentSeat + i - 1) % 10) + 1;
        if(occupiedSeats.includes(nextSeat)) {
          return nextSeat;
        }
      }
      return occupiedSeats[0];
    }
    
    function updateButtonPositionDisplay() {
      const display = document.getElementById('position-display');
      if(!display) return;
      
      if(!window.state.buttonPosition) {
        display.innerHTML = '<span class="text-gray-400">ë²„íŠ¼ì„ ì„ íƒí•˜ë©´ SB/BBê°€ ìë™ìœ¼ë¡œ ì„¤ì •ë©ë‹ˆë‹¤</span>';
        return;
      }
      
      // ì „ì²´ í”Œë ˆì´ì–´ ì¢Œì„ ë¦¬ìŠ¤íŠ¸ì—ì„œ SB/BB ê³„ì‚°
      const allPlayerSeats = getAllPlayerSeats();
      const btnPos = parseInt(window.state.buttonPosition);
      const sbSeat = getNextPlayerSeat(btnPos, allPlayerSeats);
      const bbSeat = getNextPlayerSeat(sbSeat, allPlayerSeats);
      
      // í”Œë ˆì´ì–´ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (ì „ì²´ í…Œì´ë¸” ë°ì´í„°ì—ì„œ)
      const tableData = window.state.playerDataByTable[window.state.selectedTable] || [];
      const btnPlayer = tableData.find(p => parseInt(p.seat) === btnPos)?.name || 'ë¹ˆìë¦¬';
      const sbPlayer = tableData.find(p => parseInt(p.seat) === sbSeat)?.name || 'ë¹ˆìë¦¬';
      const bbPlayer = tableData.find(p => parseInt(p.seat) === bbSeat)?.name || 'ë¹ˆìë¦¬';
      
      display.innerHTML = `
        <div class="grid grid-cols-3 gap-2 text-center">
          <div class="bg-yellow-900/30 rounded p-1">
            <span class="text-yellow-400 font-bold">ğŸ¯ BTN</span>
            <div class="text-white text-xs">${btnPlayer}</div>
          </div>
          <div class="bg-green-900/30 rounded p-1">
            <span class="text-green-400 font-bold">SB</span>
            <div class="text-white text-xs">${sbPlayer}</div>
          </div>
          <div class="bg-blue-900/30 rounded p-1">
            <span class="text-blue-400 font-bold">BB</span>
            <div class="text-white text-xs">${bbPlayer}</div>
          </div>
        </div>
      `;
    }
    
    function updatePositionIndicators() {
      const indicators = document.getElementById('position-indicators');
      if(!window.state.buttonPosition) {
        indicators.textContent = '';
        return;
      }
      
      // ì „ì²´ í”Œë ˆì´ì–´ ì¢Œì„ ë¦¬ìŠ¤íŠ¸ì—ì„œ SB/BB ê³„ì‚°
      const allPlayerSeats = getAllPlayerSeats();
      const btnPos = parseInt(window.state.buttonPosition);
      const sbSeat = getNextPlayerSeat(btnPos, allPlayerSeats);
      const bbSeat = getNextPlayerSeat(sbSeat, allPlayerSeats);
      
      // í”Œë ˆì´ì–´ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (ì „ì²´ í…Œì´ë¸” ë°ì´í„°ì—ì„œ)
      const tableData = window.state.playerDataByTable[window.state.selectedTable] || [];
      const btnPlayer = tableData.find(p => parseInt(p.seat) === btnPos)?.name || 'ë¹ˆìë¦¬';
      const sbPlayer = tableData.find(p => parseInt(p.seat) === sbSeat)?.name || 'ë¹ˆìë¦¬';
      const bbPlayer = tableData.find(p => parseInt(p.seat) === bbSeat)?.name || 'ë¹ˆìë¦¬';
      
      indicators.innerHTML = `
        <span class="text-yellow-400">BTN: ${btnPlayer}</span>
        <span class="text-green-400">SB: ${sbPlayer}</span>
        <span class="text-blue-400">BB: ${bbPlayer}</span>
      `;
    }
    
    function getActionOrder(street) {
      const occupiedSeats = getOccupiedSeats();
      if(!occupiedSeats.length || !window.state.buttonPosition) {
        // ë²„íŠ¼ ìœ„ì¹˜ê°€ ì—†ìœ¼ë©´ ë°°ì—´ ìˆœì„œëŒ€ë¡œ
        return window.state.playersInHand.map(p => p.name);
      }
      
      const btnPos = parseInt(window.state.buttonPosition);
      const sbSeat = getNextOccupiedSeat(btnPos, occupiedSeats);
      const bbSeat = getNextOccupiedSeat(sbSeat, occupiedSeats);
      
      let actionOrder = [];
      
      if(street === 'preflop') {
        // í”„ë¦¬í”Œë: UTG(BB ë‹¤ìŒ) â†’ ... â†’ BTN â†’ SB â†’ BB
        let startSeat = getNextOccupiedSeat(bbSeat, occupiedSeats);
        let currentSeat = startSeat;
        
        // BB ì „ê¹Œì§€ ìˆœíšŒ
        while(currentSeat !== bbSeat) {
          if(window.state.seatMap[currentSeat]) {
            actionOrder.push(window.state.seatMap[currentSeat]);
          }
          currentSeat = getNextOccupiedSeat(currentSeat, occupiedSeats);
        }
        // ë§ˆì§€ë§‰ì— BB ì¶”ê°€
        if(window.state.seatMap[bbSeat]) {
          actionOrder.push(window.state.seatMap[bbSeat]);
        }
      } else {
        // í¬ìŠ¤íŠ¸í”Œë: SB â†’ BB â†’ ... â†’ BTN
        let currentSeat = sbSeat;
        let count = 0;
        
        while(count < occupiedSeats.length) {
          if(window.state.seatMap[currentSeat]) {
            actionOrder.push(window.state.seatMap[currentSeat]);
          }
          currentSeat = getNextOccupiedSeat(currentSeat, occupiedSeats);
          count++;
        }
      }
      
      return actionOrder;
    }
    
    function getNextActionPlayer(street) {
      const actionOrder = getActionOrder(street);
      const actions = window.state.actionState[street] || [];
      
      // í´ë“œ/ì˜¬ì¸ í”Œë ˆì´ì–´ ì œì™¸
      const activePlayers = actionOrder.filter(name => 
        window.state.playerStatus[name] !== 'folded' && 
        window.state.playerStatus[name] !== 'allin'
      );
      
      if(activePlayers.length === 0) return null;
      
      // ë§ˆì§€ë§‰ ì•¡ì…˜í•œ í”Œë ˆì´ì–´ ì°¾ê¸°
      for(let i = actions.length - 1; i >= 0; i--) {
        const lastPlayer = actions[i].player;
        const idx = activePlayers.indexOf(lastPlayer);
        if(idx !== -1) {
          // ë‹¤ìŒ í”Œë ˆì´ì–´ ë°˜í™˜
          return activePlayers[(idx + 1) % activePlayers.length];
        }
      }
      
      // ì•¡ì…˜ì´ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ í™œì„± í”Œë ˆì´ì–´
      return activePlayers[0];
    }

    // ====== ì•¡ì…˜ ìë™ ë§¤í•‘ ì‹œìŠ¤í…œ ======
    
    // ë‹¤ìŒ ì•¡ì…˜ í”Œë ˆì´ì–´ ê³„ì‚°
    function calculateNextActionPlayer(street) {
      const actionOrder = getActionOrder(street);
      const actions = window.state.actionState[street] || [];
      
      // í´ë“œ/ì˜¬ì¸ í”Œë ˆì´ì–´ ì œì™¸í•œ í™œì„± í”Œë ˆì´ì–´ë§Œ
      const activePlayers = actionOrder.filter(name => {
        const status = window.state.playerStatus[name];
        return status !== 'folded' && status !== 'allin';
      });
      
      if(activePlayers.length === 0) {
        return null; // ëª¨ë“  í”Œë ˆì´ì–´ê°€ í´ë“œ/ì˜¬ì¸
      }
      
      // ì´ë²ˆ ìŠ¤íŠ¸ë¦¬íŠ¸ì—ì„œ ì•¡ì…˜í•œ íšŸìˆ˜ ê³„ì‚°
      const actionCounts = {};
      activePlayers.forEach(name => actionCounts[name] = 0);
      
      actions.forEach(action => {
        if(actionCounts.hasOwnProperty(action.player)) {
          actionCounts[action.player]++;
        }
      });
      
      // ê°€ì¥ ì ê²Œ ì•¡ì…˜í•œ í”Œë ˆì´ì–´ ì°¾ê¸° (ìˆœì„œëŒ€ë¡œ)
      for(const player of activePlayers) {
        const minActionCount = Math.min(...Object.values(actionCounts));
        if(actionCounts[player] === minActionCount) {
          return player;
        }
      }
      
      return activePlayers[0];
    }
    
    // ë‹¤ìŒ ì•¡ì…˜ í”Œë ˆì´ì–´ í‘œì‹œ ì—…ë°ì´íŠ¸
    function updateNextActionDisplay() {
      const street = window.state.currentStreet;
      const nextPlayer = calculateNextActionPlayer(street);
      
      window.state.nextActionPlayer = nextPlayer;
      
      // í—¤ë”ì— í˜„ì¬ ì°¨ë¡€ í‘œì‹œ
      const turnIndicator = document.getElementById('current-turn-indicator');
      if(turnIndicator && nextPlayer) {
        const playerData = window.state.playersInHand.find(p => p.name === nextPlayer);
        const positions = playerData ? getPositionsForSeat(parseInt(playerData.seat) || 0) : [];
        const positionStr = positions.length > 0 ? `(${positions.join(',')})` : '';
        
        turnIndicator.innerHTML = `
          <span class="text-amber-400">í˜„ì¬ ì°¨ë¡€:</span>
          <span class="font-bold text-white">${nextPlayer} ${positionStr}</span>
        `;
        turnIndicator.classList.remove('hidden');
      } else if(turnIndicator) {
        turnIndicator.classList.add('hidden');
      }
      
      // í”Œë ˆì´ì–´ ì¹´ë“œ í•˜ì´ë¼ì´íŠ¸
      document.querySelectorAll('.player-card').forEach(card => {
        const playerName = card.dataset.playerName;
        if(playerName === nextPlayer) {
          card.classList.add('border-2', 'border-amber-400', 'animate-pulse');
        } else {
          card.classList.remove('border-2', 'border-amber-400', 'animate-pulse');
        }
      });
    }
    
    // ì•¡ì…˜ ìë™ ì¶”ê°€ (ìë™ ëª¨ë“œ)
    function addAutoAction(actionType, amount = '') {
      if(window.state.actionInputMode !== 'auto') {
        return false;
      }
      
      const street = window.state.currentStreet;
      const nextPlayer = window.state.nextActionPlayer || calculateNextActionPlayer(street);
      
      if(!nextPlayer) {
        showFeedback('ëª¨ë“  í”Œë ˆì´ì–´ê°€ ì•¡ì…˜ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤', true);
        return false;
      }
      
      // ì•¡ì…˜ ì¶”ê°€
      addActionToState(nextPlayer, actionType, amount, street);
      
      // í”Œë ˆì´ì–´ ìƒíƒœ ì—…ë°ì´íŠ¸
      if(actionType === 'Folds') {
        window.state.playerStatus[nextPlayer] = 'folded';
      } else if(actionType === 'All-in' || actionType === 'All In') {
        window.state.playerStatus[nextPlayer] = 'allin';
      }
      
      // UI ì—…ë°ì´íŠ¸
      renderActionStreets();
      updateNextActionDisplay();
      saveActionState();
      
      return true;
    }
    
    // ìŠ¤ë§ˆíŠ¸ ì½œ ì²˜ë¦¬
    function handleSmartCall() {
      const street = window.state.currentStreet;
      const nextPlayer = window.state.nextActionPlayer || calculateNextActionPlayer(street);
      
      if(!nextPlayer) {
        showFeedback('ëª¨ë“  í”Œë ˆì´ì–´ê°€ ì•¡ì…˜ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤', true);
        return;
      }
      
      const smartAction = getSmartCheckCallAction(nextPlayer, street);
      if(smartAction.action === 'Checks') {
        addAutoAction('Checks');
      } else {
        addAutoAction(smartAction.action, smartAction.amount);
      }
    }
    
    // ì˜¬ì¸ ì²˜ë¦¬
    function handleAllIn() {
      const nextPlayer = window.state.nextActionPlayer || calculateNextActionPlayer(window.state.currentStreet);
      
      if(!nextPlayer) {
        showFeedback('ëª¨ë“  í”Œë ˆì´ì–´ê°€ ì•¡ì…˜ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤', true);
        return;
      }
      
      const playerData = window.state.playersInHand.find(p => p.name === nextPlayer);
      if(playerData) {
        addAutoAction('All-in', playerData.chips);
      }
    }
    
    // ë¹ ë¥¸ ë²³/ë ˆì´ì¦ˆ ì…ë ¥
    function openQuickBetRaise() {
      const street = window.state.currentStreet;
      const nextPlayer = window.state.nextActionPlayer || calculateNextActionPlayer(street);
      
      if(!nextPlayer) {
        showFeedback('ëª¨ë“  í”Œë ˆì´ì–´ê°€ ì•¡ì…˜ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤', true);
        return;
      }
      
      // í‚¤íŒ¨ë“œ ì—´ê¸°
      openKeypad(null, { 
        purpose: 'quickBet',
        player: nextPlayer,
        street: street
      });
    }
    
    // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
    window.addAutoAction = addAutoAction;
    window.handleSmartCall = handleSmartCall;
    window.handleAllIn = handleAllIn;
    window.openQuickBetRaise = openQuickBetRaise;
    
    // ====== PERSIST (localStorage) ======
    function saveActionState(){ localStorage.setItem('phl_v46_state', JSON.stringify(window.state.actionState)); }
    function loadActionState(){
      const s=localStorage.getItem('phl_v46_state');
      if(s) window.state.actionState={...window.state.actionState, ...JSON.parse(s)};
      updateBlindButtons();
    }

    function updateBlindButtons() {
      const smallBlindBtn = document.getElementById('small-blind-btn');
      const bigBlindBtn = document.getElementById('big-blind-btn');

      if(smallBlindBtn) {
        smallBlindBtn.textContent = formatNumber(window.state.actionState.smallBlind || '0');
      }
      if(bigBlindBtn) {
        bigBlindBtn.textContent = formatNumber(window.state.actionState.bigBlind || '0');
      }
    }

    // ====== SMART CHECK/CALL ======
    function getSmartCheckCallAction(player, street) {
      const actions = window.state.actionState[street];
      let lastBet = null;
      let requiredAmt = 0;
      
      // í˜„ì¬ ìŠ¤íŠ¸ë¦¬íŠ¸ì—ì„œë§Œ ë§ˆì§€ë§‰ ë² íŒ… ì°¾ê¸° (ê° ìŠ¤íŠ¸ë¦¬íŠ¸ëŠ” ë…ë¦½ì )
      for(let i = actions.length - 1; i >= 0; i--) {
        const action = actions[i];
        if(['Bets', 'Raises', 'All In'].includes(action.action) && action.amount) {
          lastBet = action;
          break;
        }
      }
      
      const p = window.state.playersInHand.find(pp => pp.name === player);
      const playerChips = p ? parseInt(unformatNumber(p.chips), 10) : 0;
      
      if(!lastBet) {
        // í˜„ì¬ ìŠ¤íŠ¸ë¦¬íŠ¸ì— ë² íŒ… ì—†ìŒ â†’ CHECK
        if(street === 'preflop') {
          // í”„ë¦¬í”Œëì—ì„œ ë² íŒ… ì—†ìœ¼ë©´ ë¹…ë¸”ë¼ì¸ë“œ ì½œ
          requiredAmt = unformatNumber(window.state.actionState.bigBlind);
          if(playerChips <= parseInt(requiredAmt, 10)) {
            return { action: 'All In', amount: p.chips, label: `All-in ${formatNumber(p.chips)}` };
          }
          return { action: 'Calls', amount: requiredAmt, label: `Call ${formatNumber(requiredAmt)}` };
        }
        // í”Œë, í„´, ë¦¬ë²„ì—ì„œëŠ” ê° ìŠ¤íŠ¸ë¦¬íŠ¸ê°€ ìƒˆë¡œ ì‹œì‘ë˜ë¯€ë¡œ ì²´í¬ ê°€ëŠ¥
        return { action: 'Checks', amount: null, label: 'Check' };
      } else {
        // í˜„ì¬ ìŠ¤íŠ¸ë¦¬íŠ¸ì— ë² íŒ… ìˆìŒ â†’ CALL
        requiredAmt = lastBet.amount;
        if(playerChips <= parseInt(unformatNumber(requiredAmt), 10)) {
          // ì¹© ë¶€ì¡± â†’ ALL-IN
          return { action: 'All In', amount: p.chips, label: `All-in ${formatNumber(p.chips)}` };
        } else {
          // ì¼ë°˜ CALL
          return { action: 'Calls', amount: requiredAmt, label: `Call ${formatNumber(requiredAmt)}` };
        }
      }
    }
    
    // ====== STREET COMPLETE CHECK ======
    function checkStreetComplete(street) {
      const actions = window.state.actionState[street];
      const activePlayers = window.state.playersInHand.filter(p => 
        window.state.playerStatus[p.name] !== 'folded'
      );
      const bettingPlayers = activePlayers.filter(p =>
        window.state.playerStatus[p.name] !== 'allin'
      );
      
      // 1. í•¸ë“œ ì¢…ë£Œ ì²´í¬
      if(activePlayers.length === 1) {
        showFeedback(`${activePlayers[0].name} ìŠ¹ë¦¬!`);
        return { status: 'HAND_END', winner: activePlayers[0].name };
      }
      
      // 2. ì˜¬ì¸ ì‡¼ë‹¤ìš´ ì²´í¬
      if(bettingPlayers.length <= 1) {
        showFeedback('ì˜¬ì¸ ì‡¼ë‹¤ìš´! ë‚˜ë¨¸ì§€ ì¹´ë“œë¥¼ ì˜¤í”ˆí•˜ì„¸ìš”.');
        return { status: 'SHOWDOWN' };
      }
      
      // 3. ìŠ¤íŠ¸ë¦¬íŠ¸ ì™„ë£Œ ì²´í¬
      if(actions.length === 0) return { status: 'WAITING' };
      
      const lastAction = actions[actions.length - 1];
      if(!['Checks', 'Calls', 'Folds'].includes(lastAction.action)) {
        return { status: 'WAITING' };
      }
      
      // ê° í”Œë ˆì´ì–´ì˜ ì´ ë² íŒ…ì•¡ ê³„ì‚°
      const playerBets = {};
      actions.forEach(a => {
        if(a.amount && a.player) {
          playerBets[a.player] = (playerBets[a.player] || 0) + parseInt(unformatNumber(a.amount), 10);
        }
      });
      
      // ë² íŒ… ê°€ëŠ¥í•œ í”Œë ˆì´ì–´ë“¤ì˜ ë² íŒ…ì•¡ í™•ì¸
      const betAmounts = bettingPlayers.map(p => playerBets[p.name] || 0);
      const maxBet = Math.max(...betAmounts, 0);
      const allEqual = betAmounts.every(amt => amt === maxBet);
      
      if(allEqual) {
        const nextStreet = getNextStreet(street);
        if(nextStreet) {
          showFeedback(`${street} ì™„ë£Œ! ${nextStreet}ë¡œ ì§„í–‰`);
          // ìë™ ì§„í–‰ ì˜µì…˜ì´ ìˆë‹¤ë©´ ì—¬ê¸°ì„œ ì²˜ë¦¬
          return { status: 'STREET_COMPLETE', nextStreet };
        }
      }
      
      return { status: 'WAITING' };
    }
    
    function getNextStreet(current) {
      const streets = ['preflop', 'flop', 'turn', 'river'];
      const idx = streets.indexOf(current);
      return idx >= 0 && idx < 3 ? streets[idx + 1] : null;
    }
    
    // ====== POT ======
    // í”Œë ˆì´ì–´ë³„ ì´ ê¸°ì—¬ì•¡ ê³„ì‚° (í´ë“œí•œ í”Œë ˆì´ì–´ í¬í•¨)
    function calculatePlayerContributions() {
      const contributions = {};
      const playersInHand = window.state.playersInHand || [];
      
      // 1. ëª¨ë“  í”Œë ˆì´ì–´ ì´ˆê¸°í™”
      playersInHand.forEach(player => {
        contributions[player.name] = 0;
      });
      
      // 2. ë¸”ë¼ì¸ë“œì™€ ì•ˆí‹° ë¨¼ì € ì¶”ê°€
      playersInHand.forEach(player => {
        const playerName = player.name;
        
        // ìŠ¤ëª° ë¸”ë¼ì¸ë“œ (ì²« ë²ˆì§¸ í”Œë ˆì´ì–´)
        if (player.role === 'SB' || playersInHand.indexOf(player) === 0) {
          const sbAmount = parseInt(unformatNumber(window.state.actionState.smallBlind) || 0, 10);
          contributions[playerName] += sbAmount;
        }
        
        // ë¹… ë¸”ë¼ì¸ë“œ (ë‘ ë²ˆì§¸ í”Œë ˆì´ì–´)  
        if (player.role === 'BB' || playersInHand.indexOf(player) === 1) {
          const bbAmount = parseInt(unformatNumber(window.state.actionState.bigBlind) || 0, 10);
          contributions[playerName] += bbAmount;
        }
        
        // BB ì•ˆí‹° (ëª¨ë“  í”Œë ˆì´ì–´)
        if (window.state.actionState.hasBBAnte) {
          const bbAmount = parseInt(unformatNumber(window.state.actionState.bigBlind) || 0, 10);
          contributions[playerName] += bbAmount;
        }
      });
      
      // 3. ê° ìŠ¤íŠ¸ë¦¬íŠ¸ë³„ë¡œ ìµœì¢… ë² íŒ… ê¸ˆì•¡ ê³„ì‚° (ì˜¬ë°”ë¥¸ í¬ì»¤ ë¡œì§)
      ['preflop', 'flop', 'turn', 'river'].forEach(street => {
        const actions = window.state.actionState[street] || [];
        const streetBets = {}; // ì´ ìŠ¤íŠ¸ë¦¬íŠ¸ì—ì„œ ê° í”Œë ˆì´ì–´ì˜ ë² íŒ… ê¸ˆì•¡
        
        // í•´ë‹¹ ìŠ¤íŠ¸ë¦¬íŠ¸ì˜ ëª¨ë“  ì•¡ì…˜ì„ ìˆœíšŒí•˜ë©° ìµœì¢… ë² íŒ… ê¸ˆì•¡ ê³„ì‚°
        actions.forEach(action => {
          if(action.amount && action.player && action.action !== 'Pot Correction') {
            const player = action.player;
            const amount = parseInt(unformatNumber(action.amount), 10);
            
            // ì´ í”Œë ˆì´ì–´ì˜ ì´ ìŠ¤íŠ¸ë¦¬íŠ¸ ë² íŒ… ê¸ˆì•¡ì„ action.amountë¡œ ì„¤ì •
            // (ì½œ/ë ˆì´ì¦ˆëŠ” ëˆ„ì ì´ ì•„ë‹ˆë¼ ìµœì¢… ë² íŒ… ê¸ˆì•¡)
            streetBets[player] = amount;
          }
        });
        
        // ì´ ìŠ¤íŠ¸ë¦¬íŠ¸ì˜ ìµœì¢… ë² íŒ… ê¸ˆì•¡ì„ ì „ì²´ ê¸°ì—¬ì•¡ì— ì¶”ê°€
        Object.entries(streetBets).forEach(([player, amount]) => {
          const playerData = playersInHand.find(p => p.name === player);
          const maxChips = playerData ? parseInt(unformatNumber(playerData.initialChips) || 0, 10) : Infinity;
          
          // í˜„ì¬ ì´ ê¸°ì—¬ì•¡ + ì´ ìŠ¤íŠ¸ë¦¬íŠ¸ ë² íŒ…ì´ ìµœëŒ€ ì¹©ì„ ì´ˆê³¼í•˜ì§€ ì•Šë„ë¡ ì œí•œ
          const currentContribution = contributions[player] || 0;
          const allowedAmount = Math.min(amount, Math.max(0, maxChips - currentContribution));
          
          contributions[player] = currentContribution + allowedAmount;
          
          if (allowedAmount < amount) {
            console.log(`âš ï¸ ${player} (${street}): ${amount} ìš”ì²­ â†’ ${allowedAmount} ì œí•œ (ìµœëŒ€: ${maxChips}, í˜„ì¬: ${currentContribution})`);
          }
        });
      });
      
      console.log('ğŸ“Š í”Œë ˆì´ì–´ë³„ ê¸°ì—¬ì•¡ (ì˜¬ì¸ ì œí•œ ì ìš©):', contributions);
      return contributions;
    }
    
    // ì‹¤ì œ íŒŸ ê³„ì‚° (ì˜¬ì¸ ì œí•œê³¼ ì‚¬ì´ë“œíŒŸì„ ê³ ë ¤í•œ ì •í™•í•œ ê³„ì‚°)
    function calculateActualPot() {
      console.log(`%cğŸ² === ìƒˆë¡œìš´ íŒŸ ê³„ì‚° ì‹œì‘ [${APP_VERSION}] ===`, 'color: #10b981; font-weight: bold');
      
      // Pot Correctionì´ ìˆìœ¼ë©´ ê¸°ì¡´ ë¡œì§ ì‚¬ìš©
      let potCorrectionFound = false;
      ['preflop', 'flop', 'turn', 'river'].forEach(street => {
        const actions = window.state.actionState[street] || [];
        if(actions.find(a => a.action === 'Pot Correction')) {
          potCorrectionFound = true;
        }
      });
      
      if(potCorrectionFound) {
        return calculatePotWithCorrection();
      }
      
      // ìƒˆë¡œìš´ ì •í™•í•œ íŒŸ ê³„ì‚°
      const result = calculateAccuratePot();
      console.log(`%cğŸ² === íŒŸ ê³„ì‚° ì¢…ë£Œ [${APP_VERSION}] ===`, 'color: #10b981; font-weight: bold');
      return result.totalPot;
    }
    
    // ì •í™•í•œ íŒŸ ê³„ì‚° (ì˜¬ì¸ ì œí•œ ê³ ë ¤)
    function calculateAccuratePot() {
      const playersInHand = window.state.playersInHand || [];
      if (playersInHand.length === 0) {
        return { totalPot: 0, mainPot: 0, sidePots: [] };
      }
      
      // 1. ê° í”Œë ˆì´ì–´ì˜ ì´ ë² íŒ… ê°€ëŠ¥ ê¸ˆì•¡ ê³„ì‚° (ì´ˆê¸° ì¹©)
      const playerMaxBets = {};
      playersInHand.forEach(player => {
        playerMaxBets[player.name] = parseInt(unformatNumber(player.initialChips) || 0, 10);
      });
      
      console.log('ğŸ’° í”Œë ˆì´ì–´ë³„ ìµœëŒ€ ë² íŒ… ê°€ëŠ¥:', playerMaxBets);
      
      // 2. ì‹¤ì œ ë² íŒ… ê¸ˆì•¡ ê³„ì‚° (ë¸”ë¼ì¸ë“œ + ì•ˆí‹° + ì•¡ì…˜)
      const playerBets = calculatePlayerContributions();
      console.log('ğŸ“Š í”Œë ˆì´ì–´ë³„ ì‹¤ì œ ë² íŒ…:', playerBets);
      
      // 3. ì˜¬ì¸ í”Œë ˆì´ì–´ë“¤ì˜ ê¸ˆì•¡ëŒ€ë³„ë¡œ íŒŸ ë¶„ë¦¬
      const allInAmounts = [];
      playersInHand.forEach(player => {
        const playerName = player.name;
        const maxBet = playerMaxBets[playerName];
        const actualBet = Math.min(playerBets[playerName] || 0, maxBet);
        
        if (actualBet > 0 && !allInAmounts.includes(actualBet)) {
          allInAmounts.push(actualBet);
        }
      });
      
      allInAmounts.sort((a, b) => a - b);
      console.log('ğŸ¯ ì˜¬ì¸ ê¸ˆì•¡ëŒ€:', allInAmounts);
      
      // 4. ê°€ì¥ ì‘ì€ ì˜¬ì¸ ê¸ˆì•¡ì´ ë©”ì¸íŒŸ ê¸°ì¤€
      const mainPotCap = Math.min(...allInAmounts);
      let totalPot = 0;
      
      // ë©”ì¸íŒŸ: ëª¨ë“  í”Œë ˆì´ì–´ê°€ mainPotCapë§Œí¼ ê¸°ì—¬
      const eligiblePlayers = playersInHand.filter(p => 
        window.state.playerStatus[p.name] !== 'folded'
      );
      
      const mainPot = mainPotCap * eligiblePlayers.length;
      totalPot = mainPot;
      
      console.log(`ğŸ² ë©”ì¸íŒŸ: ${mainPot} (${eligiblePlayers.length}ëª… Ã— ${mainPotCap})`);
      
      // ì‚¬ì´ë“œíŒŸì€ í˜„ì¬ êµ¬í˜„í•˜ì§€ ì•Šê³  ë©”ì¸íŒŸë§Œ ë°˜í™˜
      // (ëŒ€ë¶€ë¶„ì˜ ê²½ìš° 2ëª…ì´ë¯€ë¡œ ì‚¬ì´ë“œíŒŸì´ ë¶ˆí•„ìš”)
      
      return { 
        totalPot: totalPot,
        mainPot: mainPot,
        sidePots: []
      };
    }
    
    // ê¸°ì¡´ Pot Correction ë¡œì§
    function calculatePotWithCorrection() {
      let totalPot = 0;
      let potCorrectionValue = 0;
      let additionalBets = 0;
      
      ['preflop', 'flop', 'turn', 'river'].forEach(street => {
        const actions = window.state.actionState[street] || [];
        
        const potCorrectionIdx = actions.findIndex(a => a.action === 'Pot Correction');
        if(potCorrectionIdx !== -1) {
          const potCorrection = actions[potCorrectionIdx];
          potCorrectionValue = parseInt(unformatNumber(potCorrection.amount), 10);
          
          for(let i = potCorrectionIdx + 1; i < actions.length; i++) {
            if(actions[i].amount && actions[i].action !== 'Pot Correction') {
              additionalBets += parseInt(unformatNumber(actions[i].amount), 10);
            }
          }
          return;
        }
        
        actions.forEach(action => {
          if(action.amount && action.action !== 'Pot Correction') {
            totalPot += parseInt(unformatNumber(action.amount), 10);
          }
        });
      });
      
      if(potCorrectionValue > 0) {
        totalPot = potCorrectionValue + additionalBets;
      } else {
        totalPot += parseInt(unformatNumber(window.state.actionState.smallBlind) || 0, 10);
        totalPot += parseInt(unformatNumber(window.state.actionState.bigBlind) || 0, 10);
        if(window.state.actionState.hasBBAnte) {
          const bbAmount = parseInt(unformatNumber(window.state.actionState.bigBlind) || 0, 10);
          totalPot += bbAmount * (window.state.playersInHand || []).length;
        }
      }
      
      return totalPot;
    }
    
    // ì–¸ì½œ ë² íŒ… ê³„ì‚°
    function calculateUncalledBet() {
      const contributions = calculatePlayerContributions();
      const activePlayers = window.state.playersInHand.filter(p => 
        window.state.playerStatus[p.name] !== 'folded'
      );
      
      // í™œì„± í”Œë ˆì´ì–´ê°€ 1ëª…ì¼ ë•Œë§Œ ì–¸ì½œ ë² íŒ… ê³„ì‚°
      if(activePlayers.length === 1) {
        const winner = activePlayers[0];
        const winnerContribution = contributions[winner.name] || 0;
        
        // ë‹¤ë¥¸ í”Œë ˆì´ì–´ë“¤ì˜ ìµœëŒ€ ê¸°ì—¬ì•¡
        const otherMaxContribution = Math.max(
          ...Object.entries(contributions)
            .filter(([player]) => player !== winner.name)
            .map(([_, amount]) => amount),
          0
        );
        
        // ì–¸ì½œ ë² íŒ… = ìŠ¹ì ê¸°ì—¬ì•¡ - íƒ€ í”Œë ˆì´ì–´ ìµœëŒ€ ê¸°ì—¬ì•¡
        const uncalledAmount = Math.max(0, winnerContribution - otherMaxContribution);
        
        return {
          amount: uncalledAmount,
          player: winner.name
        };
      }
      
      return { amount: 0, player: null };
    }
    
    // ê¸°ì¡´ calculatePotSize í•¨ìˆ˜ëŠ” UI í‘œì‹œìš©ìœ¼ë¡œ ìœ ì§€
    function calculatePotSize(){
      let pot=0;
      let potCorrectionFound = false;
      let potCorrectionValue = 0;
      
      // ëª¨ë“  ìŠ¤íŠ¸ë¦¬íŠ¸ ìˆœíšŒ
      ['preflop','flop','turn','river'].forEach(st=> {
        const actions = window.state.actionState[st];
        
        // Pot Correction ì°¾ê¸°
        const correctionIdx = actions.findIndex(a => a.action === 'Pot Correction');
        if(correctionIdx !== -1) {
          potCorrectionFound = true;
          potCorrectionValue = parseInt(unformatNumber(actions[correctionIdx].amount), 10);
          
          // Pot Correction ì´í›„ì˜ ì•¡ì…˜ë“¤ë§Œ ì¶”ê°€
          for(let i = correctionIdx + 1; i < actions.length; i++) {
            if(actions[i].amount && actions[i].action !== 'Pot Correction') {
              pot += parseInt(unformatNumber(actions[i].amount), 10);
            }
          }
        } else if(potCorrectionFound) {
          // Pot Correction ì´í›„ì˜ ìŠ¤íŠ¸ë¦¬íŠ¸
          actions.forEach(a => {
            if(a.amount && a.action !== 'Pot Correction') {
              pot += parseInt(unformatNumber(a.amount), 10);
            }
          });
        } else {
          // Pot Correction ì´ì „ì˜ ì•¡ì…˜ë“¤
          actions.forEach(a => {
            if(a.amount && a.action !== 'Pot Correction') {
              pot += parseInt(unformatNumber(a.amount), 10);
            }
          });
        }
      });
      
      // Pot Correctionì´ ì—†ìœ¼ë©´ ë¸”ë¼ì¸ë“œ/ì•¤í‹° ì¶”ê°€
      if(!potCorrectionFound) {
        pot += parseInt(unformatNumber(window.state.actionState.smallBlind)||0,10);
        pot += parseInt(unformatNumber(window.state.actionState.bigBlind)||0,10);
        if(window.state.actionState.hasBBAnte) {
          pot += parseInt(unformatNumber(window.state.actionState.bigBlind)||0,10);
        }
      } else {
        // Pot Correction ê°’ì´ ê¸°ì¤€
        pot = potCorrectionValue + pot;
      }
      
      return pot;
    }

    // ====== CSV LOADERS ======
    async function fetchCsv(url){
      const res=await fetch(url);
      if(!res.ok) {
        console.log(`CSV fetch status: ${res.status}`);
        return []; // ë¹ˆ ë°°ì—´ ë°˜í™˜
      }
      const txt=await res.text();
      return parseCSV(txt);
    }

    function buildTypeFromCsv(rows){
      // Type ì‹œíŠ¸ êµ¬ì¡°:
      // A:Camera Preset, B:Player, C:Table, D:Notable, E:Chips, F:updatedAt, G:Seat
      // A2: Cam1 name, A3: Cam2 name (ì¹´ë©”ë¼ í”„ë¦¬ì…‹ ì •ë³´)
      if(!rows||rows.length<1) return;
      const header=rows[0];
      const A2=(rows[1]&&rows[1][0])?String(rows[1][0]).trim():'';
      const A3=(rows[2]&&rows[2][0])?String(rows[2][0]).trim():'';
      window.state.camPreset.cam1=A2||'Cam1';
      window.state.camPreset.cam2=A3||'Cam2';
      // localStorageì—ì„œ ë§ˆì§€ë§‰ ì¹´ë©”ë¼ ë²ˆí˜¸ ì½ì–´ì„œ í‘œì‹œ
      const lastCam1No = localStorage.getItem('pokerHandLogger_lastCam1');
      const lastCam2No = localStorage.getItem('pokerHandLogger_lastCam2');
      
      console.log(`ğŸï¸ ì¹´ë©”ë¼ ë²„íŠ¼ ì´ˆê¸°í™”:`);
      console.log(`  ${window.state.camPreset.cam1} ì €ì¥ëœ ë²ˆí˜¸: ${lastCam1No || 'ì—†ìŒ'}`);
      console.log(`  ${window.state.camPreset.cam2} ì €ì¥ëœ ë²ˆí˜¸: ${lastCam2No || 'ì—†ìŒ'}`);
      
      if(lastCam1No) {
        const nextNo = parseInt(lastCam1No, 10) + 1;
        el.cam1.textContent = `${window.state.camPreset.cam1}${pad4(nextNo)}`;
        console.log(`  â†’ ${window.state.camPreset.cam1} í‘œì‹œ: ${pad4(nextNo)}`);
      } else {
        el.cam1.textContent = `${window.state.camPreset.cam1}0001`;
        console.log(`  â†’ ${window.state.camPreset.cam1} í‘œì‹œ: 0001 (ì´ˆê¸°ê°’)`);
      }
      
      if(lastCam2No) {
        const nextNo = parseInt(lastCam2No, 10) + 1;
        el.cam2.textContent = `${window.state.camPreset.cam2}${pad4(nextNo)}`;
        console.log(`  â†’ ${window.state.camPreset.cam2} í‘œì‹œ: ${pad4(nextNo)}`);
      } else {
        el.cam2.textContent = `${window.state.camPreset.cam2}0001`;
        console.log(`  â†’ ${window.state.camPreset.cam2} í‘œì‹œ: 0001 (ì´ˆê¸°ê°’)`);
      }

      const byTable={};
      for(let i=1;i<rows.length;i++){
        const r=rows[i]||[];
        // A:Camera Preset, B:Player, C:Table, D:Notable, E:Chips, F:updatedAt, G:Seat, H:Status
        const player=String(r[1]||'').trim();
        const table =String(r[2]||'').trim();
        const notable = String(r[3]||'').toUpperCase()==='TRUE';
        const chips = String(r[4]!=null?r[4]:'0').trim();
        const updatedAt = String(r[5]||'').trim(); // Fì—´: updatedAt
        const seat = String(r[6]||'').trim(); // Gì—´: Seat
        const status = String(r[7]||'IN').trim().toUpperCase(); // Hì—´: Status (ê¸°ë³¸ê°’: IN)

        console.log(`[v3.4.3] í”Œë ˆì´ì–´ ì²˜ë¦¬: ${player} (${table}) - ìƒíƒœ: ${status}`);

        // IN ìƒíƒœì¸ í”Œë ˆì´ì–´ë§Œ ì²˜ë¦¬ (ë¹ˆ ê°’ì´ë©´ INìœ¼ë¡œ ê°„ì£¼)
        if(player && table && status === 'IN'){
          if(!byTable[table]) byTable[table]=[];
          // v3.4.3: ì¤‘ë³µ í•„í„°ë§ ì™„ì „ ì œê±° - ëª¨ë“  í”Œë ˆì´ì–´ë¥¼ ë¡œì»¬ ë°ì´í„°ì— ìœ ì§€
          // ì¤‘ë³µ ì œê±°ëŠ” ë³„ë„ ì‹œìŠ¤í…œì—ì„œ ì²˜ë¦¬
          byTable[table].push({
            name: player,
            chips,
            notable,
            updatedAt,
            seat,
            status // ìƒíƒœë„ ì €ì¥
          });
          console.log(`[v3.4.3] âœ… ${player} ì¶”ê°€ë¨ (${table}, ì¢Œì„: ${seat}) - ì¤‘ë³µ í•„í„°ë§ ë¹„í™œì„±í™”`);
        } else {
          console.log(`[v3.4.3] âŒ ${player} ì œì™¸ë¨ - ìƒíƒœ: ${status} (${table})`);
        }
      }

      // ì²˜ë¦¬ ê²°ê³¼ ìš”ì•½ ë¡œê·¸
      console.log(`[v3.4.3] === buildTypeFromCsv ì™„ë£Œ ===`);
      console.log(`[v3.4.3] ì´ í…Œì´ë¸” ìˆ˜: ${Object.keys(byTable).length}`);
      Object.keys(byTable).forEach(table => {
        console.log(`[v3.4.3] ${table}: ${byTable[table].length}ëª… (IN ìƒíƒœë§Œ)`);
      });

      window.state.playerDataByTable=byTable;
      window.state.allTables=Object.keys(byTable).sort();
    }

    function buildIndexFromCsv(rows){
      // Index CSV columns:
      // A handNumber | B startRow | C endRow | D handUpdatedAt | E handEdit | F handEditTime | G label | H table | I tableUpdatedAt | J Cam | K CamFile01name | L CamFile01number | M CamFile02name | N CamFile02number
      // O lastStreet | P lastAction | Q workStatus (ìƒˆë¡œìš´ ì—´ë“¤)
      const out=[]; for(let i=1;i<rows.length;i++){
        const r=rows[i]||[];
        const item={
          handNumber:String(r[0]||''), startRow:+(r[1]||0), endRow:+(r[2]||0),
          handUpdatedAt:String(r[3]||''), handEdit:r[4], handEditTime:r[5], label:r[6],
          table:String(r[7]||''), tableUpdatedAt:r[8], cam:r[9], cam1:r[10], cam1no:r[11], cam2:r[12], cam2no:r[13],
          lastStreet:String(r[14]||''), lastAction:String(r[15]||''), workStatus:String(r[16]||'')  // ìƒˆë¡œìš´ ì—´ë“¤
        };
        if(item.handNumber) out.push(item);
      }
      window.state.indexRows=out;
      // ìµœì‹  ìš°ì„  ì •ë ¬
      out.sort((a,b)=> a.handUpdatedAt<b.handUpdatedAt?1:-1);
      window.state.allHandNumbers = [...new Set(out.map(x=>x.handNumber))];
    }

    // íŒŒì‹±: Hand CSV â†’ íŠ¹ì • handNumberì˜ "ê°€ì¥ ìµœê·¼ updatedAt" ë¸”ë¡
    function parseHandBlock(rows, handNumber, preferDate){
      // HAND ì‹œì‘ ìœ„ì¹˜ ìˆ˜ì§‘
      const starts=[];
      for(let r=0;r<rows.length;r++){
        const row=rows[r]||[];
        if(row[1]==='HAND'){
          const no=String(row[2]||'');
          if(no===String(handNumber)){
            starts.push({r});
          }
        }
      }
      if(!starts.length) return null;
    
      // Indexì—ì„œ ìµœì‹  updatedAt ê¸°ì¤€ ë¸”ë¡ ë²”ìœ„ ì°¾ê¸°
      let updatedAt=preferDate||null;
      if(!updatedAt){
        const candidates=window.state.indexRows.filter(x=>x.handNumber===String(handNumber));
        candidates.sort((a,b)=> a.handUpdatedAt<b.handUpdatedAt?1:-1);
        updatedAt=candidates[0]?.handUpdatedAt||null;
      }
      let startRowIdx=-1, endRowIdx=-1;
      const idxRow=window.state.indexRows.find(x=>x.handNumber===String(handNumber) && x.handUpdatedAt===updatedAt);
      if(idxRow){ startRowIdx=idxRow.startRow-1; endRowIdx=idxRow.endRow-1; }
      else{
        const last=starts[starts.length-1].r;
        startRowIdx=last;
        let r=last+1; while(r<rows.length && rows[r][1]!=='HAND') r++;
        endRowIdx=r-1;
      }
      if(startRowIdx<0 || endRowIdx<startRowIdx) return null;
    
      const block=rows.slice(startRowIdx,endRowIdx+1);
    
      // íŒŒì‹±
      let handInfo=null, players=[], board=[], smallBlind='', bigBlind='', ante=0, table='';
      // ìŠ¤íŠ¸ë¦¬íŠ¸ ë¶„í• : ë¸”ë¡ì„ **ìˆœì„œëŒ€ë¡œ** ëŒë©´ì„œ BOARDë¥¼ ë§Œë‚  ë•Œë§ˆë‹¤ ì „í™˜í•œë‹¤
      const streets={preflop:[],flop:[],turn:[],river:[]};
      let street='preflop';
      let seenBoard=0;
    
      for(const row of block){
        if(row[1]==='HAND'){
          handInfo=row;
          ante=parseInt(row[6]||0,10)||0;
          smallBlind=row[8]||'';
          bigBlind=row[9]||'';
          table=row[17]||'';
        }else if(row[1]==='PLAYER'){
          const name=row[2];
          const seat=row[3];
          // PLAYER íŒŒì‹±: row[4]ëŠ” 0, row[5]ëŠ” ì‹œì‘ì¹©, row[6]ì€ ì¢…ë£Œì¹©, row[7]ì€ í•¸ë“œ
          const init=row[5], final=row[6];
          const cards=(row[7]||'').trim()? String(row[7]).trim().split(' ') : [];
          players.push({name, seat, initialChips:init, finalChips:final, hand:cards});
        }else if(row[1]==='EVENT'){
          const etype=String(row[2]||'').toUpperCase();
          if(etype==='BOARD'){
            // ë³´ë“œ ì „í™˜ ì§€ì 
            const card=row[4];
            if(card) board.push(card);
            seenBoard++;
            if(seenBoard===3) street='flop';
            else if(seenBoard===4) street='turn';
            else if(seenBoard===5) street='river';
          }else{
            // ì¢Œì„ â†’ ì´ë¦„
            const seat=row[3];
            const amount=row[4];
            const time=row[5];
            const p=players.find(pp=>String(pp.seat)===String(seat));
            const name=p?p.name:'';
            streets[street].push({
              player:name,
              action:etype,
              amount:amount||null,
              timestamp:time||null
            });
          }
        }
      }

  // ìŠ¹ì íŒë‹¨ ë¡œì§ ê°œì„ : ê°€ì¥ ë§ì€ ì¹© ì¦ê°€ëŸ‰ì„ ê°€ì§„ í”Œë ˆì´ì–´ í•œ ëª…ë§Œ ìŠ¹ìë¡œ ì§€ì •
  let winnerName = null;
  let maxGain = 0;
  
  players.forEach(p => {
    const initial = parseInt(p.initialChips || 0, 10);
    const final = parseInt(p.finalChips || 0, 10);
    const gain = final - initial;
    
    if(gain > maxGain) {
      maxGain = gain;
      winnerName = p.name;
    }
  });

  return {
    handInfo,
    table,
    ante,
    smallBlind,
    bigBlind,
    hasBBAnte: ante>0,
    board,
    actions: streets,
    players: players.map(p=>({
      name:p.name,
      initialChips:p.initialChips,
      finalChips:p.finalChips,
      hand:p.hand,
      role: (p.name === winnerName && maxGain > 0) ? 'winner' : null
    }))
  };
}



    // ====== LOADERS (initial) ======
    async function loadInitial(){
      openLogModal(); el.logDisplay.innerHTML='';
      logMessage(`ğŸš€ ${APP_VERSION} ì´ˆê¸° ë°ì´í„° ë¡œë”© ì‹œì‘ (Type/Index) ...`);
      try{
        const [typeRows, idxRows] = await Promise.all([
          CSV_TYPE_URL.includes('http')? fetchCsv(CSV_TYPE_URL) : Promise.resolve([]),
          CSV_INDEX_URL.includes('http')? fetchCsv(CSV_INDEX_URL) : Promise.resolve([])
        ]);
        if(typeRows.length) buildTypeFromCsv(typeRows);
        if(idxRows.length) buildIndexFromCsv(idxRows);
        window.state.actionState.handNumber = (window.state.allHandNumbers.length>0? Math.max(...window.state.allHandNumbers.map(n=>parseInt(n,10)||0)) + 1 : 1).toString();
        el.handNumberDisplay.textContent = `#${window.state.actionState.handNumber}`;
        el.dataStamp.textContent = `IDX rows: ${window.state.indexRows.length}`;
        
        // Indexì—ì„œ ë§ˆì§€ë§‰ ì¹´ë©”ë¼ ë²ˆí˜¸ ì°¾ê¸° ë° localStorage ë™ê¸°í™”
        logMessage('ğŸ“· ì¹´ë©”ë¼ ë²ˆí˜¸ ë°ì´í„° ë¶„ì„ ì‹œì‘...');
        
        if(window.state.indexRows.length > 0) {
          logMessage(`ğŸ“Š ì´ ${window.state.indexRows.length}ê°œì˜ í•¸ë“œ ë°ì´í„° ê²€ìƒ‰ ì¤‘...`);
          
          // ê°€ì¥ ìµœê·¼ í•¸ë“œ ì°¾ê¸° (í•¸ë“œ ë²ˆí˜¸ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ)
          const sortedRows = window.state.indexRows.slice().sort((a,b) => {
            const numA = parseInt(a.handNumber, 10) || 0;
            const numB = parseInt(b.handNumber, 10) || 0;
            return numB - numA;
          });
          
          // ì¹´ë©”ë¼ ë²ˆí˜¸ê°€ ìˆëŠ” ê°€ì¥ ìµœê·¼ í•¸ë“œ ì°¾ê¸°
          let maxCam1 = 0, maxCam2 = 0;
          let foundInHand = null;
          
          for(const row of sortedRows) {
            const cam1Num = parseInt(row.cam1no, 10) || 0;
            const cam2Num = parseInt(row.cam2no, 10) || 0;
            
            if(cam1Num > maxCam1) {
              maxCam1 = cam1Num;
              if(!foundInHand) foundInHand = row.handNumber;
            }
            if(cam2Num > maxCam2) {
              maxCam2 = cam2Num;
              if(!foundInHand) foundInHand = row.handNumber;
            }
          }
          
          if(foundInHand) {
            logMessage(`ğŸ“ í•¸ë“œ #${foundInHand}ì—ì„œ ì¹´ë©”ë¼ ë²ˆí˜¸ ë°œê²¬`);
          }
          
          if(maxCam1 > 0) {
            localStorage.setItem('pokerHandLogger_lastCam1', String(maxCam1));
            logMessage(`âœ… ${window.state.camPreset.cam1} ë§ˆì§€ë§‰ ë²ˆí˜¸: ${maxCam1} â†’ ë‹¤ìŒ ë²ˆí˜¸: ${pad4(maxCam1 + 1)}`);
          } else {
            logMessage(`âš ï¸ ${window.state.camPreset.cam1} ë²ˆí˜¸ ë°ì´í„° ì—†ìŒ â†’ 0001ë¶€í„° ì‹œì‘`);
          }
          
          if(maxCam2 > 0) {
            localStorage.setItem('pokerHandLogger_lastCam2', String(maxCam2));
            logMessage(`âœ… ${window.state.camPreset.cam2} ë§ˆì§€ë§‰ ë²ˆí˜¸: ${maxCam2} â†’ ë‹¤ìŒ ë²ˆí˜¸: ${pad4(maxCam2 + 1)}`);
          } else {
            logMessage(`âš ï¸ ${window.state.camPreset.cam2} ë²ˆí˜¸ ë°ì´í„° ì—†ìŒ â†’ 0001ë¶€í„° ì‹œì‘`);
          }
        } else {
          logMessage('âš ï¸ Index ë°ì´í„°ê°€ ë¹„ì–´ìˆìŒ â†’ ì¹´ë©”ë¼ ë²ˆí˜¸ 0001ë¶€í„° ì‹œì‘');
        }
        
        renderAll();
        logMessage(`âœ… ${APP_VERSION} ì´ˆê¸° ë°ì´í„° ë¡œë”© ì™„ë£Œ`);
      }catch(err){
        console.error(err); logMessage(`ì´ˆê¸° ë¡œë”© ì‹¤íŒ¨: ${err.message}`, true);
      }finally{
        setTimeout(closeLogModal, 800);
      }
    }

    // ====== LOAD HAND MODAL ======
    function openLoadHandModal(){
      console.log('ğŸ“‚ Load Hand ëª¨ë‹¬ ì—´ê¸° ì‹œë„...');
      console.log('ğŸ“‹ Index í–‰ ê°œìˆ˜:', window.state.indexRows.length);
      
      if(!window.state.indexRows.length){
        console.error('âŒ Index ë°ì´í„° ì—†ìŒ');
        showFeedback('Index ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. CSV ê²Œì‹œì™€ URLì„ í™•ì¸í•˜ì„¸ìš”.', true);
        return;
      }
      
      // í•¸ë“œ ë²ˆí˜¸ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ìµœì‹  í•¸ë“œê°€ ìœ„ë¡œ)
      const items = window.state.indexRows.slice().sort((a,b)=> {
        const numA = parseInt(a.handNumber, 10) || 0;
        const numB = parseInt(b.handNumber, 10) || 0;
        return numB - numA; // ë‚´ë¦¼ì°¨ìˆœ
      });
      
      const htmlItems = items.map(it=>{
        // ìƒíƒœ ì•„ì´ì½˜ ê²°ì •
        const statusIcon = {
          'ì™„ë£Œ': 'âœ…',
          'ì§„í–‰ì¤‘': 'ğŸ”„',
          'ê²€í† í•„ìš”': 'âš ï¸'
        }[it.workStatus] || 'ğŸ“';
        
        // ìŠ¤íŠ¸ë¦¬íŠ¸ ë°°ì§€ ìƒ‰ìƒê³¼ ìŠ¤íƒ€ì¼
        const streetColors = {
          'preflop': 'bg-green-500 text-white',
          'flop': 'bg-blue-500 text-white',
          'turn': 'bg-orange-500 text-white',
          'river': 'bg-red-500 text-white'
        };
        const streetBadge = it.lastStreet ? 
          `<span class="${streetColors[it.lastStreet] || 'bg-gray-500 text-white'} px-2 py-0.5 rounded text-xs font-bold">${it.lastStreet?.toUpperCase() || ''}</span>` : '';
        
        // ë²„íŠ¼ ë°°ê²½ìƒ‰ (ìƒíƒœë³„)
        const btnBgClass = it.workStatus === 'ì™„ë£Œ' ? 'bg-gray-800' : 
                          it.workStatus === 'ê²€í† í•„ìš”' ? 'bg-yellow-900/30' : 'bg-gray-700';
        
        return `<button class="btn ${btnBgClass} p-2 rounded-md w-full text-left load-hand-item-btn mb-2 hover:bg-gray-600" 
                data-no="${it.handNumber}" data-date="${it.handUpdatedAt}">
          <div class="flex justify-between items-center mb-1">
            <span class="font-bold text-white flex items-center gap-1">
              ${statusIcon} #${it.handNumber}
            </span>
            ${streetBadge}
            <span class="text-xs text-amber-400 truncate max-w-[100px]">${it.table||''}</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-xs text-gray-400">${it.lastAction || 'ì•¡ì…˜ ì—†ìŒ'}</span>
            <span class="text-xs text-gray-500">${it.handUpdatedAt||''}</span>
          </div>
        </button>`;
      }).join('');
      
      const html = `<div class="bg-gray-800 rounded-lg p-4 w-full max-w-md flex flex-col h-2/3">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold text-amber-400">í•¸ë“œ ë¶ˆëŸ¬ì˜¤ê¸°</h2>
          <button id="close-load-hand-modal" class="text-2xl">&times;</button>
        </div>
        <div class="overflow-y-auto space-y-2 flex-grow pr-2">${htmlItems}</div>
      </div>`;
      openModal(el.loadHandModal, html);
      
      // ëª¨ë‹¬ ë°– í´ë¦­ ì‹œ ë‹«ê¸° (ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì™€ ì¶©ëŒ ë°©ì§€)
      // onclick ëŒ€ì‹  ë³„ë„ì˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì‚¬ìš©
    }
    async function ensureHandCsv(){
      if(window.state.handCsvCache) return window.state.handCsvCache;
      logMessage('Hand CSV ë‹¤ìš´ë¡œë“œ ì¤‘...');
      const rows = await fetchCsv(CSV_HAND_URL + `&cb=${Date.now()}`);
      window.state.handCsvCache = rows;
      logMessage(`Hand CSV ë¡œë“œ ì™„ë£Œ (rows=${rows.length})`);
      return rows;
    }

    async function loadHandData(handNumber, preferDate){
      console.log(`ğŸ“¥ í•¸ë“œ #${handNumber} ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘...`);
      try{
        const rows = await ensureHandCsv();
        console.log(`ğŸ“Š Hand CSV ë¡œë“œ ì™„ë£Œ: ${rows.length} í–‰`);
        
        const data = parseHandBlock(rows, handNumber, preferDate);
        console.log('ğŸ“ íŒŒì‹±ëœ ë°ì´í„°:', data);
        
        if(!data){ 
          console.error(`âŒ Hand #${handNumber} ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
          showFeedback(`Hand #${handNumber} ë¸”ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, true); 
          return; 
        }

        // ìƒíƒœ ì´ˆê¸°í™”
        window.state.playersInHand=[];
        window.state.board = data.board||[];
        window.state.playerStatus = {}; // í”Œë ˆì´ì–´ ìƒíƒœ ì´ˆê¸°í™” ì¶”ê°€
        
        window.state.actionState = {
          ...window.state.actionState,
          handNumber: String(handNumber),
          smallBlind: data.smallBlind || '',
          bigBlind: data.bigBlind || '',
          hasBBAnte: data.ante>0,
          preflop: data.actions?.preflop||[],
          flop: data.actions?.flop||[],
          turn: data.actions?.turn||[],
          river: data.actions?.river||[],
        };
        window.state.selectedTable = data.table || '';
        updateSelectedTableDisplay();

        window.state.playersInHand = (data.players||[]).map(p=>({
          name:p.name, hand:p.hand||[], chips:p.finalChips, initialChips:p.initialChips, role:p.role||null
        }));
        
        // í”Œë ˆì´ì–´ ìƒíƒœ ë³µì› (ì•¡ì…˜ì—ì„œ í´ë“œ/ì˜¬ì¸ í™•ì¸)
        ['preflop', 'flop', 'turn', 'river'].forEach(street => {
          (data.actions?.[street] || []).forEach(action => {
            if(action.player && action.action === 'Folds') {
              window.state.playerStatus[action.player] = 'folded';
            } else if(action.player && action.action === 'All In') {
              window.state.playerStatus[action.player] = 'allin';
            }
          });
        });

        el.handNumberDisplay.textContent = `#${handNumber}`;
        el.smallBlindInput.value = formatNumber(window.state.actionState.smallBlind);
        el.bigBlindInput.value = formatNumber(window.state.actionState.bigBlind);
        el.bbAnteCheckbox.checked = window.state.actionState.hasBBAnte;

        // currentStreet ê²°ì •: Indexì—ì„œ ì €ì¥ëœ ê°’ ìš°ì„ , ì—†ìœ¼ë©´ ì•¡ì…˜ìœ¼ë¡œ íŒë‹¨
        const indexRow = window.state.indexRows.find(r => r.handNumber === String(handNumber));
        console.log(`ğŸ” í•¸ë“œ #${handNumber} ë¡œë“œ ì¤‘...`);
        console.log('ğŸ“‹ Index í–‰ ë°ì´í„°:', indexRow);
        
        if(indexRow) {
          // ì¹´ë©”ë¼ ì •ë³´ ë¡œë“œ ë° ë¡œê¹…
          if(indexRow.cam1 || indexRow.cam1no) {
            console.log(`ğŸ“· ì¹´ë©”ë¼1 ì •ë³´ ë°œê²¬:`);
            console.log(`   - ì´ë¦„: ${indexRow.cam1 || 'ì—†ìŒ'}`);
            console.log(`   - ë²ˆí˜¸: ${indexRow.cam1no || 'ì—†ìŒ'}`);
            
            // ì¹´ë©”ë¼1 ì •ë³´ ì—…ë°ì´íŠ¸
            if(indexRow.cam1) {
              window.state.camPreset.cam1 = indexRow.cam1;
              console.log(`ğŸ“· ì¹´ë©”ë¼1 í”„ë¦¬ì…‹ ì—…ë°ì´íŠ¸: ${indexRow.cam1}`);
            }
            if(indexRow.cam1no) {
              window.state.camNumbers.cam1no = indexRow.cam1no;
              el.cam1.textContent = window.state.camPreset.cam1 + pad4(indexRow.cam1no);
            }
          }
          
          if(indexRow.cam2 || indexRow.cam2no) {
            console.log(`ğŸ“· ì¹´ë©”ë¼2 ì •ë³´ ë°œê²¬:`);
            console.log(`   - ì´ë¦„: ${indexRow.cam2 || 'ì—†ìŒ'}`);
            console.log(`   - ë²ˆí˜¸: ${indexRow.cam2no || 'ì—†ìŒ'}`);
            
            // ì¹´ë©”ë¼2 ì •ë³´ ì—…ë°ì´íŠ¸
            if(indexRow.cam2) {
              window.state.camPreset.cam2 = indexRow.cam2;
              console.log(`ğŸ“· ì¹´ë©”ë¼2 í”„ë¦¬ì…‹ ì—…ë°ì´íŠ¸: ${indexRow.cam2}`);
            }
            if(indexRow.cam2no) {
              window.state.camNumbers.cam2no = indexRow.cam2no;
              el.cam2.textContent = window.state.camPreset.cam2 + pad4(indexRow.cam2no);
            }
          }
          
          console.log('ğŸ“Š ë¡œë“œ í›„ ì¹´ë©”ë¼ ìƒíƒœ:');
          console.log(`   - cam1: ${window.state.camPreset.cam1}${pad4(window.state.camNumbers.cam1no || '0')}`);
          console.log(`   - cam2: ${window.state.camPreset.cam2}${pad4(window.state.camNumbers.cam2no || '0')}`);
          
          if(indexRow.lastStreet) {
            window.state.currentStreet = indexRow.lastStreet;
          }
          
          // ì‘ì—… ìƒíƒœ í‘œì‹œ
          if(indexRow.workStatus) {
            const statusText = {
              'ì™„ë£Œ': 'âœ… ì™„ë£Œëœ í•¸ë“œ',
              'ì§„í–‰ì¤‘': 'ğŸ”„ ì‘ì—… ì§„í–‰ ì¤‘',
              'ê²€í† í•„ìš”': 'âš ï¸ ê²€í†  í•„ìš”'
            }[indexRow.workStatus] || indexRow.workStatus;
            showFeedback(`#${handNumber} ${statusText}`);
          }
        } else {
          // ê¸°ì¡´ ë¡œì§: ì•¡ì…˜ìœ¼ë¡œ íŒë‹¨
          if(window.state.actionState.river.length > 0) {
            window.state.currentStreet = 'river';
          } else if(window.state.actionState.turn.length > 0) {
            window.state.currentStreet = 'turn';
          } else if(window.state.actionState.flop.length > 0) {
            window.state.currentStreet = 'flop';
          } else {
            window.state.currentStreet = 'preflop';
          }
        }

        renderAll(); saveActionState();
        
        
        closeModal(el.loadHandModal);
        showFeedback(`#${handNumber} í•¸ë“œë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
      }catch(err){
        console.error('í•¸ë“œ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', err);
        console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', err.stack);
        showFeedback(`ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${err.message}`, true);
      }
    }

    // ====== GENERATE & SEND ======
    function formatISODateInTZ(date, tz){
      // yyyy-MM-dd
      const y = new Intl.DateTimeFormat('en-CA', { timeZone: tz, year:'numeric' }).format(date);
      const m = new Intl.DateTimeFormat('en-CA', { timeZone: tz, month:'2-digit' }).format(date);
      const d = new Intl.DateTimeFormat('en-CA', { timeZone: tz, day:'2-digit' }).format(date);
      return `${y}-${m}-${d}`;
    }

    function generateRows_v46(){
      const out=[]; let no=1;
      const push=(arr)=>{ const a=[no, ...arr]; while(a.length<18) a.push(''); out.push(a); no++; };

      const epochSec = Math.floor(Date.now()/1000);
      const sb = unformatNumber(window.state.actionState.smallBlind)||'0';
      const bb = unformatNumber(window.state.actionState.bigBlind)||'0';
      const ante = window.state.actionState.hasBBAnte ? bb : '0';
      const table = window.state.selectedTable || '';
      const currentDate = new Date().toISOString().split('T')[0]; // YYYY-MM-DD í˜•ì‹

      // GAME / PAYOUTS - Eì—´(ì¸ë±ìŠ¤ 4)ì— ë‚ ì§œ ì¶”ê°€
      const gameRow = ['GAME','GGProd Hand Logger','Virtual Table', currentDate];
      push(gameRow);
      push(['PAYOUTS']);

      // HAND: C no, D code, G ante, I SB, J BB, R table
      const handDate = formatISODateInTZ(new Date(), window.state.selectedTimezone); // yyyy-MM-dd
      
      // HAND: C no, D code, G ante, I SB, J BB, R table
      push(['HAND',
        String(window.state.actionState.handNumber),
        epochSec,
        'HOLDEM',
        window.state.actionState.hasBBAnte ? 'BB_ANTE':'NO_ANTE',
        ante,
        handDate, // â˜… ì—¬ê¸°(H) ì¹¸ì— ë‚ ì§œë¥¼ ë„£ë„ë¡ ì•½ì† (Apps Scriptë„ ì´ ì¹¸ì€ ë‚ ì§œë¡œ ì“°ê²Œ)
        sb,       // I
        bb,       // J
        0,1,2,3,0,0,1,
        table     // R
      ]);

      // PLAYERS
      const players = window.state.playersInHand.map((p,i)=>({
        ...p, 
        seat: p.seat || (i+1)  // Typeì—ì„œ ê°€ì ¸ì˜¨ seat ì •ë³´ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ì¸ë±ìŠ¤+1
      }));
      
      console.log(`%c=== PLAYER í–‰ ìƒì„± [${APP_VERSION}] ===`, 'color: #3b82f6; font-weight: bold');
      console.log(`í˜„ì¬ í–‰ë²ˆí˜¸(no): ${no}`);
      console.log(`í”Œë ˆì´ì–´ ìˆ˜: ${players.length}`);
      console.log('%cí˜•ì‹: A=í–‰ë²ˆí˜¸, B=PLAYER, C=ì´ë¦„, D=ì¢Œì„, E=0(ê³ ì •), F=ì‹œì‘ì¹©, G=ì¢…ë£Œì¹©, H=í•¸ë“œ, I=í¬ì§€ì…˜', 'color: #9ca3af');
      
      players.forEach(p=>{
        console.log(`\n--- ${p.name} ì²˜ë¦¬ ì‹œì‘ ---`);
        console.log(`  ì›ë³¸ ë°ì´í„°:`, p);
        
        // ì¹© ê°’ í™•ì¸ - initialChipsê°€ ì—†ìœ¼ë©´ chips ê°’ì„ ì‚¬ìš©
        let initialChips;
        let finalChips = parseInt(unformatNumber(p.chips)||0,10);
        
        // initialChipsê°€ undefinedì´ê±°ë‚˜ ë¹ˆ ë¬¸ìì—´ì¸ ê²½ìš° ì²˜ë¦¬
        if(p.initialChips === undefined || p.initialChips === '' || p.initialChips === null) {
          console.warn(`  âš ï¸ initialChipsê°€ ì—†ìŒ. chips ê°’ ì‚¬ìš©: ${p.chips}`);
          initialChips = finalChips; // ì‹œì‘ì¹©ì´ ì—†ìœ¼ë©´ í˜„ì¬ ì¹©ì„ ì‹œì‘ì¹©ìœ¼ë¡œ ì‚¬ìš©
        } else {
          const unformattedInitial = unformatNumber(p.initialChips);
          console.log(`  unformatNumber(p.initialChips) = "${unformattedInitial}"`);
          initialChips = parseInt(unformattedInitial || '0', 10);
          if(isNaN(initialChips)) {
            console.error(`  âŒ parseIntê°€ NaN ë°˜í™˜! ì›ë³¸: "${p.initialChips}"`);
            initialChips = 0;
          }
        }
        
        // ë””ë²„ê¹…: ì‹¤ì œ ê°’ í™•ì¸
        console.log(`  ì´ˆê¸°ì¹©(raw): "${p.initialChips}" â†’ ${initialChips}`);
        console.log(`  ìµœì¢…ì¹©(raw): "${p.chips}" â†’ ${finalChips}`);
        console.log(`  í•¸ë“œ: ${p.hand?.join(' ') || '(ì—†ìŒ)'}`);
        
        // ë°°ì—´ ìƒì„± ì „ ê°’ íƒ€ì… í™•ì¸
        console.log(`  initialChips íƒ€ì…: ${typeof initialChips}, ê°’: ${initialChips}`);
        console.log(`  finalChips íƒ€ì…: ${typeof finalChips}, ê°’: ${finalChips}`);
        
        // í¬ì§€ì…˜ ì •ë³´ ê³„ì‚° (BTN/SB/BB)
        const positions = getPositionsForSeat(parseInt(p.seat) || 1);
        const positionStr = positions.length > 0 ? positions.join(',') : '';
        
        // PLAYER í˜•ì‹: B=PLAYER, C=name, D=seat, E=0, F=ì‹œì‘ì¹©, G=ì¢…ë£Œì¹©, H=í•¸ë“œ, I=í¬ì§€ì…˜
        // push í•¨ìˆ˜ê°€ ìë™ìœ¼ë¡œ í–‰ë²ˆí˜¸ë¥¼ Aì—´ì— ì¶”ê°€í•˜ë¯€ë¡œ 8ê°œ ìš”ì†Œ í•„ìš”
        const playerRow = ['PLAYER', p.name, parseInt(p.seat) || 1, 0, initialChips, finalChips, p.hand?.length? p.hand.join(' ') : '', positionStr];
        
        console.log(`  ===== PLAYER í–‰ ìƒì„± =====`);
        console.log(`  playerRow ë°°ì—´:`, playerRow);
        console.log(`  playerRow.length: ${playerRow.length}`);
        
        // ê° ìš”ì†Œ ê²€ì¦
        console.log(`  [0] = '${playerRow[0]}' (PLAYER ë¬¸ìì—´)`);
        console.log(`  [1] = '${playerRow[1]}' (ì´ë¦„: ${p.name})`);
        console.log(`  [2] = ${playerRow[2]} (ì¢Œì„: ${p.seat})`);
        console.log(`  [3] = ${playerRow[3]} (0 ê³ ì •ê°’)`);
        console.log(`  [4] = ${playerRow[4]} (ì‹œì‘ì¹©: ${initialChips})`);
        console.log(`  [5] = ${playerRow[5]} (ì¢…ë£Œì¹©: ${finalChips})`);
        console.log(`  [6] = '${playerRow[6]}' (í•¸ë“œ)`);
        console.log(`  [7] = '${playerRow[7]}' (í¬ì§€ì…˜: ${positionStr})`);
        
        // push ì „ í˜„ì¬ í–‰ë²ˆí˜¸
        const currentNo = no;
        console.log(`  push ì „ í–‰ë²ˆí˜¸: ${currentNo}`);
        
        push(playerRow);
        
        // push í›„ ì‹¤ì œ ì €ì¥ëœ ë°ì´í„° í™•ì¸
        const pushedRow = out[out.length - 1];
        console.log(`  push í›„ ì €ì¥ëœ í–‰:`, pushedRow);
        console.log(`  ìµœì¢… CSV í˜•ì‹:`);
        console.log(`    A=${pushedRow[0]} (í–‰ë²ˆí˜¸), B=${pushedRow[1]} (PLAYER), C=${pushedRow[2]} (ì´ë¦„), D=${pushedRow[3]} (ì¢Œì„),`);
        console.log(`    E=${pushedRow[4]} (0 ê³ ì •ê°’), F=${pushedRow[5]} (ì‹œì‘ì¹©), G=${pushedRow[6]} (ì¢…ë£Œì¹©), H=${pushedRow[7]} (í•¸ë“œ), I=${pushedRow[8]} (í¬ì§€ì…˜)`);
        console.log(`--- ${p.name} ì²˜ë¦¬ ì™„ë£Œ ---\n`);
      });

      // EVENTS
      const addEv=(log)=>{
        const p=players.find(x=>x.name===log.player);
        const seat=p?p.seat:'';
        const amt=log.amount? unformatNumber(log.amount):'';
        let t=(log.action||'').toUpperCase().replace(/S$/,'');
        if(t==='BET/RAISES') t='RAISE TO';
        push(['EVENT', t, seat, amt, '' ]);
      };
      window.state.actionState.preflop.forEach(addEv);
      if(window.state.board.length>=3){ push(['EVENT','BOARD',1,window.state.board[0],'' ]); push(['EVENT','BOARD',1,window.state.board[1],'' ]); push(['EVENT','BOARD',1,window.state.board[2],'' ]); }
      window.state.actionState.flop.forEach(addEv);
      if(window.state.board.length>=4){ push(['EVENT','BOARD',1,window.state.board[3],'' ]); }
      window.state.actionState.turn.forEach(addEv);
      if(window.state.board.length>=5){ push(['EVENT','BOARD',1,window.state.board[4],'' ]); }
      window.state.actionState.river.forEach(addEv);

      // ë§ˆì§€ë§‰ ë²ˆí˜¸í–‰(ì„ íƒ)
      out.push([no]); 
      return { rows: out, epochSec, currentDate };
    }
    
let isSending = false;

async function sendDataToGoogleSheet(){
  if (isSending) return;     // ì¤‘ë³µ ì „ì†¡ ê°€ë“œ
  isSending = true;

  // ìŠ¹ì ì²´í¬ ì œê±° - ìŠ¹ì ì—†ì–´ë„ ì „ì†¡ ê°€ëŠ¥
  const winners = window.state.playersInHand.filter(p=>p.role==='winner');

  await executeWithLock(async () => {
    openLogModal();
    logMessage('ì‹œíŠ¸ ì „ì†¡ ì‹œì‘...');

  try{
    const { rows, epochSec } = generateRows_v46();
    const indexMeta   = buildIndexMeta();
    // ìŠ¹ì ì •ë³´ ì¶”ê°€ (ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)
    indexMeta.winners = winners.map(w => w.name).join(', ') || '';
    const typeUpdates = buildTypeUpdates();
    // ë…¸íŠ¸ ê¸°ëŠ¥ ì œê±°
    const payload = { rows, indexMeta, typeUpdates };

    // x-www-form-urlencodedë¡œ ì „ì†¡ â†’ í”„ë¦¬í”Œë¼ì´íŠ¸ ì—†ìŒ (CORS ìš°íšŒ)
    const form = new URLSearchParams();
    form.append('payload', JSON.stringify(payload));

    const res = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
      body: form.toString(),
      // mode: 'cors'  // ìƒëµ ê°€ëŠ¥ (ê¸°ë³¸)
    });

    if(!res.ok){
      const text = await res.text().catch(()=> '');
      console.log(`ì„œë²„ ì‘ë‹µ: ${res.status} ${text || ''}`);
      showFeedback('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜', true);
      return;
    }

    const json = await res.json().catch(()=> ({}));

    if(json.status === 'duplicate'){
      logMessage(`âš ï¸ í•¸ë“œ #${json.handNumber}ëŠ” ì´ë¯¸ ê¸°ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
      showFeedback('âš ï¸ ì¤‘ë³µëœ í•¸ë“œì…ë‹ˆë‹¤', true);
      // ì¤‘ë³µì¸ ê²½ìš°ì—ë„ í•¸ë“œ ë²ˆí˜¸ë¥¼ ì¦ê°€ì‹œì¼œì•¼ í•¨
      const currentNo = parseInt(window.state.actionState.handNumber, 10) || 0;
      window.state.actionState.handNumber = String(currentNo + 1);
      el.handNumberDisplay.textContent = `#${window.state.actionState.handNumber}`;
      
      // ì¤‘ë³µì´ì–´ë„ ì‹œíŠ¸ì—ëŠ” ê¸°ë¡ëìœ¼ë¯€ë¡œ ìƒˆ í•¸ë“œë¡œ ì¬ì„¤ì •
      await resetApp();
      logMessage('âœ… ìƒˆ í•¸ë“œ ì¤€ë¹„ ì™„ë£Œ');
      
    } else if(json.status !== 'success'){
      logMessage('âš ï¸ Apps Scriptê°€ successë¥¼ ë°˜í™˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      logMessage('âš ï¸ ì‹œíŠ¸ í™•ì¸ í›„ ìˆ˜ë™ìœ¼ë¡œ ì¬ì„¤ì • ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
      showFeedback('âš ï¸ ì‹œíŠ¸ ì „ì†¡ í™•ì¸ í•„ìš”', true);
      // ì„±ê³µ ì—¬ë¶€ê°€ ë¶ˆí™•ì‹¤í•˜ë¯€ë¡œ ìë™ ì¬ì„¤ì •í•˜ì§€ ì•ŠìŒ
      
    } else {
      logMessage(`âœ… ì €ì¥ ì™„ë£Œ: #${json.handNumber || indexMeta.handNumber} (rows=${json.rowsAdded})`);
      showFeedback('âœ… ì‹œíŠ¸ ê¸°ë¡ ì™„ë£Œ');
      
      // ì‹œíŠ¸ê°€ ì—…ë°ì´íŠ¸ë˜ë„ë¡ ì¶©ë¶„í•œ ì‹œê°„ì„ ê¸°ë‹¤ë¦¼
      logMessage('ì‹œíŠ¸ ë™ê¸°í™” ì¤‘...');
      await sleep(3000); // 3ì´ˆ ëŒ€ê¸°
      
      // Index CSV ë¦¬í”„ë ˆì‹œ
      try{
        if(CSV_INDEX_URL.includes('http')){
          const idxRows = await fetchCsv(CSV_INDEX_URL + `&cb=${Date.now()}`);
          buildIndexFromCsv(idxRows);
          el.dataStamp.textContent = `IDX rows: ${window.state.indexRows.length}`;
        }
      }catch(_){ /* noop */ }
      
      // ì„±ê³µì ìœ¼ë¡œ ì €ì¥ëœ ê²½ìš°ì—ë§Œ ìƒˆ í•¸ë“œë¡œ ì¬ì„¤ì •
      // ì‹œíŠ¸ ì „ì†¡ ì§í›„ì—ëŠ” Index ì¬ë¡œë“œ ì—†ì´ ë°”ë¡œ ë‹¤ìŒ ë²ˆí˜¸ë¡œ ì´ë™
      await resetApp(false, true);
      logMessage(`âœ… ${APP_VERSION} ìƒˆ í•¸ë“œ ì¤€ë¹„ ì™„ë£Œ`);
    }

  }catch(err){
    console.error(err);
    logMessage(`âŒ ì „ì†¡ ì‹¤íŒ¨: ${err.message}`, true);
    showFeedback(`âŒ ì „ì†¡ ì‹¤íŒ¨: ${err.message}`, true);
    // ì „ì†¡ ì‹¤íŒ¨ ì‹œì—ëŠ” ì¬ì„¤ì •í•˜ì§€ ì•ŠìŒ
    logMessage('âš ï¸ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ ì¬ì„¤ì •í•´ì£¼ì„¸ìš”.');
  }finally{
    closeLogModal(); // ë¡œê·¸ë¥¼ ì¢€ ë” ì˜¤ë˜ ë³´ì—¬ì¤Œ
  }
  }, 'ì‹œíŠ¸ ì „ì†¡', 'ë°ì´í„°ë¥¼ Google ì‹œíŠ¸ì— ì €ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤...');

  isSending = false;
}


    function nowIso() {
      // ì„œë²„ì—ì„œ timezone ë³€í™˜í•˜ë¯€ë¡œ UTC ISOë¡œ ë³´ëƒ„
      return new Date().toISOString();
    }
    function buildIndexMeta(){
      const handNumber = String(window.state.actionState.handNumber);
      const handUpdatedAt = new Date().toISOString().split('T')[0]; // YYYY-MM-DD í˜•ì‹
      const table = window.state.selectedTable || '';
      
      // ì¹´ë©”ë¼ ì •ë³´ ë¡œê¹…
      console.log('ğŸ“¦ Index ë©”íƒ€ë°ì´í„° ë¹Œë“œ:');
      console.log(`  cam1: ${window.state.camPreset.cam1} / ë²ˆí˜¸: ${window.state.camNumbers.cam1no}`);
      console.log(`  cam2: ${window.state.camPreset.cam2} / ë²ˆí˜¸: ${window.state.camNumbers.cam2no}`);
      
      // ë§ˆì§€ë§‰ ì•¡ì…˜ ì°¾ê¸°
      let lastActionDesc = '';
      const streets = ['river', 'turn', 'flop', 'preflop'];
      for(const st of streets) {
        const actions = window.state.actionState[st];
        if(actions.length > 0) {
          const last = actions[actions.length - 1];
          lastActionDesc = `${last.player} ${last.action} ${last.amount || ''}`.trim();
          break;
        }
      }
      
      // ì‘ì—… ìƒíƒœ íŒë‹¨
      function determineWorkStatus() {
        // ìŠ¹ìê°€ ì„ íƒë˜ì—ˆìœ¼ë©´ 'ì™„ë£Œ'
        if(window.state.playersInHand.some(p => p.role === 'winner')) {
          return 'ì™„ë£Œ';
        }
        // ë¦¬ë²„ê¹Œì§€ ê°”ìœ¼ë©´ 'ê²€í† í•„ìš”'
        if(window.state.currentStreet === 'river' && window.state.actionState.river.length > 0) {
          return 'ê²€í† í•„ìš”';
        }
        return 'ì§„í–‰ì¤‘';
      }
      
      // Index ì‹œíŠ¸ì˜ ì „ì²´ ì—´ êµ¬ì¡°ì— ë§ê²Œ ë°ì´í„° ì¤€ë¹„
      return {
        handNumber,                                           // Aì—´
        // startRow, endRowëŠ” ì„œë²„ì—ì„œ ê³„ì‚°                    // B,Cì—´
        handUpdatedAt,                                        // Dì—´ (YYYY-MM-DD)
        // handEditëŠ” ë¹„ì›Œë‘                                   // Eì—´
        // handEditTimeì€ ì„œë²„ì—ì„œ ì²˜ë¦¬                        // Fì—´
        label: 'HOLDEM',                                      // Gì—´
        table,                                                 // Hì—´
        tableUpdatedAt: handUpdatedAt,                        // Iì—´ (YYYY-MM-DD)
        cam: `${window.state.camPreset.cam1 || ''}+${window.state.camPreset.cam2 || ''}`, // Jì—´
        camFile01name: window.state.camPreset.cam1 || '',            // Kì—´
        camFile01number: getCamNumber('cam1'), // Lì—´ - ìë™ ê³„ì‚°ëœ ë²ˆí˜¸
        camFile02name: window.state.camPreset.cam2 || '',            // Mì—´
        camFile02number: getCamNumber('cam2'), // Nì—´ - ìë™ ê³„ì‚°ëœ ë²ˆí˜¸
        lastStreet: window.state.currentStreet,                      // Oì—´
        lastAction: lastActionDesc,                           // Pì—´
        workStatus: determineWorkStatus()                     // Qì—´
      };
    }

    function buildTypeUpdates(){
      // ì´ë²ˆ í•¸ë“œ ë™ì•ˆ ì¹©ì´ ìˆ˜ì •ëœ í”Œë ˆì´ì–´ë§Œ ì¶”ë ¤ì„œ Typeì— updatedAt ê¸°ë¡
      const table = window.state.selectedTable || '';
      return window.state.playersInHand
        .filter(p => p.chipsUpdatedAt) // ìˆ˜ì •ëœ ì¼€ì´ìŠ¤ë§Œ
        .map((p, index) => ({
          player: p.name,
          table,
          notable: p.notable || false, // Notable ì •ë³´ ì¶”ê°€
          chips: String(p.chips || ''),
          updatedAt: p.chipsUpdatedAt, // ISO. ì•± ìŠ¤í¬ë¦½íŠ¸ì—ì„œ Dateë¡œ set
          seat: String(p.seat || index + 1) // Seat ì •ë³´ ì¶”ê°€ (ì¢Œì„ ë²ˆí˜¸ ë˜ëŠ” ì¸ë±ìŠ¤+1)
        }));
    }



    // ====== CAM PREFILL ======
    function computeCamPrefill(which){
      // 1) ìì‹ ì˜ ê°’ ìˆìœ¼ë©´ ê·¸ê±¸ í‘œì‹œ
      if (which==='cam1' && window.state.camNumbers.cam1no) return pad4(window.state.camNumbers.cam1no);
      if (which==='cam2' && window.state.camNumbers.cam2no) return pad4(window.state.camNumbers.cam2no);

      // 2) ì§ì˜ ê°’ ê¸°ë°˜ ìë™ ì¦ê°€
      if (which==='cam2' && window.state.camNumbers.cam1no){
        return pad4((parseInt(window.state.camNumbers.cam1no,10)||0)+1);
      }
      if (which==='cam1' && window.state.camNumbers.cam2no){
        const v = (parseInt(window.state.camNumbers.cam2no,10)||0)-1;
        return pad4(v<0?0:v);
      }

      // 3) ë§ˆì§€ë§‰ ì…ë ¥(ì„¸ì…˜ ê¸°ì¤€) +1
      if (window.state.lastCamNo!=null){
        return pad4((parseInt(window.state.lastCamNo,10)||0)+1);
      }

      // 4) ê¸°ë³¸ê°’
      return '0001';
    }

    // ì¹´ë©”ë¼ ë²ˆí˜¸ë§Œ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜ (íŒ¨ë”© ì—†ì´)
    function getCamNumber(which) {
      // 1) ìì‹ ì˜ ê°’ ìˆìœ¼ë©´ ê·¸ê±¸ ë°˜í™˜
      if (which === 'cam1' && window.state.camNumbers.cam1no) return window.state.camNumbers.cam1no;
      if (which === 'cam2' && window.state.camNumbers.cam2no) return window.state.camNumbers.cam2no;

      // 2) ì§ì˜ ê°’ ê¸°ë°˜ ìë™ ì¦ê°€
      if (which === 'cam2' && window.state.camNumbers.cam1no) {
        return String((parseInt(window.state.camNumbers.cam1no, 10) || 0) + 1);
      }
      if (which === 'cam1' && window.state.camNumbers.cam2no) {
        const v = (parseInt(window.state.camNumbers.cam2no, 10) || 0) - 1;
        return String(v < 0 ? 0 : v);  // 0ë³´ë‹¤ ì‘ìœ¼ë©´ 0ìœ¼ë¡œ
      }

      // 3) ë§ˆì§€ë§‰ ì…ë ¥(ì„¸ì…˜ ê¸°ì¤€) +1
      if (window.state.lastCamNo != null) {
        return String((parseInt(window.state.lastCamNo, 10) || 0) + 1);
      }

      // 4) í˜„ì¬ í‘œì‹œëœ ì¹´ë©”ë¼ ê°’ì—ì„œ íŒ¨ë”©ì„ ì œê±°í•œ ìˆ«ìê°’ ë°˜í™˜
      // computeCamPrefillê³¼ ê°™ì€ ë¡œì§ì´ì§€ë§Œ ìˆœí™˜ì°¸ì¡°ë¥¼ í”¼í•˜ê¸° ìœ„í•´ ì§ì ‘ êµ¬í˜„
      if (which === 'cam1' && el.cam1) {
        const displayText = el.cam1.textContent || '';
        const match = displayText.match(/(\d+)$/); // ë§ˆì§€ë§‰ ìˆ«ìë“¤ ì¶”ì¶œ
        if (match) {
          return String(parseInt(match[1], 10) || 0);
        }
      }
      if (which === 'cam2' && el.cam2) {
        const displayText = el.cam2.textContent || '';
        const match = displayText.match(/(\d+)$/); // ë§ˆì§€ë§‰ ìˆ«ìë“¤ ì¶”ì¶œ
        if (match) {
          return String(parseInt(match[1], 10) || 0);
        }
      }

      // 5) ìµœì¢… ê¸°ë³¸ê°’
      return '0';
    }


    // ====== SIDEPOT CALCULATION ======
    function calculateSidePots() {
      const contributions = {};
      
      // ê° ìŠ¤íŠ¸ë¦¬íŠ¸ë³„ í”Œë ˆì´ì–´ ê¸°ì—¬ì•¡ ê³„ì‚°
      ['preflop', 'flop', 'turn', 'river'].forEach(street => {
        window.state.actionState[street].forEach(action => {
          if(action.amount && action.player) {
            contributions[action.player] = (contributions[action.player] || 0) + 
                                          parseInt(unformatNumber(action.amount), 10);
          }
        });
      });
      
      // ì˜¬ì¸ í”Œë ˆì´ì–´ ì •ë ¬ (ê¸ˆì•¡ ì˜¤ë¦„ì°¨ìˆœ)
      const allInPlayers = window.state.playersInHand
        .filter(p => window.state.playerStatus[p.name] === 'allin')
        .map(p => ({ name: p.name, amount: contributions[p.name] || 0 }))
        .sort((a, b) => a.amount - b.amount);
      
      const activePlayers = window.state.playersInHand
        .filter(p => window.state.playerStatus[p.name] !== 'folded')
        .map(p => p.name);
      
      const pots = [];
      let remainingPlayers = [...activePlayers];
      let previousCap = 0;
      
      // ê° ì˜¬ì¸ ë ˆë²¨ë³„ íŒŸ ìƒì„±
      allInPlayers.forEach(allinPlayer => {
        const cap = allinPlayer.amount;
        const potPlayers = remainingPlayers.filter(p => contributions[p] >= cap);
        const potAmount = (cap - previousCap) * potPlayers.length;
        
        if(potAmount > 0) {
          pots.push({
            amount: potAmount,
            players: [...potPlayers],
            cap: cap,
            type: pots.length === 0 ? 'main' : `side${pots.length}`
          });
        }
        
        remainingPlayers = remainingPlayers.filter(p => p !== allinPlayer.name);
        previousCap = cap;
      });
      
      // ë‚¨ì€ ë² íŒ… (ìµœê³  ë² íŒ…ìë“¤ë¼ë¦¬)
      if(remainingPlayers.length > 0) {
        const maxBet = Math.max(...remainingPlayers.map(p => contributions[p] || 0));
        const finalPot = (maxBet - previousCap) * remainingPlayers.length;
        
        if(finalPot > 0) {
          pots.push({
            amount: finalPot,
            players: remainingPlayers,
            cap: maxBet,
            type: pots.length === 0 ? 'main' : `side${pots.length}`
          });
        }
      }
      
      return { pots, contributions };
    }
    
    // ====== RESET & FEEDBACK ======
    async function resetApp(reloadIndex = true, autoIncrement = false){
      let lastNo;
      
      if(autoIncrement) {
        // ì‹œíŠ¸ ì „ì†¡ ì§í›„: í˜„ì¬ í•¸ë“œ ë²ˆí˜¸ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ì´ë¯¸ ì „ì†¡ëœ ë²ˆí˜¸)
        lastNo = parseInt(window.state.actionState.handNumber, 10) || 0;
        console.log('ğŸ”„ ì‹œíŠ¸ ì „ì†¡ ì™„ë£Œ - ë‹¤ìŒ í•¸ë“œë¡œ ìë™ ì¦ê°€:', lastNo, 'â†’', lastNo + 1);
      } else if(reloadIndex) {
        // ìƒˆë¡œê³ ì¹¨ì´ë‚˜ ìˆ˜ë™ ì¬ì„¤ì •: Indexë¥¼ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ìµœì‹  í•¸ë“œ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
        try {
          if(CSV_INDEX_URL.includes('http')){
            const idxRows = await fetchCsv(CSV_INDEX_URL + `&cb=${Date.now()}`);
            buildIndexFromCsv(idxRows);
          }
        } catch(err) {
          console.error('Index ì¬ë¡œë“œ ì‹¤íŒ¨:', err);
        }
        
        lastNo = window.state.indexRows.length
          ? Math.max(...window.state.indexRows.map(r=>parseInt(r.handNumber,10)||0))
          : 0;
        console.log('ğŸ”„ Index ì¬ë¡œë“œ - ë§ˆì§€ë§‰ í•¸ë“œ:', lastNo, 'â†’ ë‹¤ìŒ:', lastNo + 1);
      } else {
        // Index ì¬ë¡œë“œ ì—†ì´ í˜„ì¬ ìƒíƒœ ìœ ì§€
        lastNo = window.state.indexRows.length
          ? Math.max(...window.state.indexRows.map(r=>parseInt(r.handNumber,10)||0))
          : 0;
      }
      
      // ë§ˆì§€ë§‰ ì¹´ë©”ë¼ ë²ˆí˜¸ ì €ì¥ ë° ë‹¤ìŒ ë²ˆí˜¸ ì¤€ë¹„
      const lastCam1 = window.state.camNumbers.cam1no;
      const lastCam2 = window.state.camNumbers.cam2no;
      
      // í”Œë ˆì´ì–´ ìœ ì§€í•˜ë©´ì„œ ìƒˆ í•¸ë“œ ì‹œì‘
      console.log('ğŸ”„ ìƒˆ í•¸ë“œ ì‹œì‘ - í”Œë ˆì´ì–´ ì´ˆê¸°í™”');
      
      // ê¸°ì¡´ í”Œë ˆì´ì–´ë“¤ì˜ í˜„ì¬ ì¹©ì„ ë‹¤ìŒ í•¸ë“œì˜ ì‹œì‘ì¹©ìœ¼ë¡œ ì„¤ì •
      window.state.playersInHand.forEach(p => {
        // í˜„ì¬ ì¹©ì„ ì‹œì‘ì¹©ìœ¼ë¡œ ì¬ì„¤ì •
        p.initialChips = p.chips;
        p.hand = [];  // í•¸ë“œ ì¹´ë“œ ì´ˆê¸°í™”
        p.role = null;  // ì—­í•  ì´ˆê¸°í™”
        console.log(`  ${p.name}: ì‹œì‘ì¹© = ${p.initialChips} (í˜„ì¬ì¹© ìœ ì§€)`);
      });
      
      window.state.board = [];
      window.state.playerStatus = {}; // í”Œë ˆì´ì–´ ìƒíƒœ ì´ˆê¸°í™”
      window.state.currentStreet = 'preflop'; // ìŠ¤íŠ¸ë¦¬íŠ¸ ì´ˆê¸°í™”
      window.state.actionState = {
        handNumber: String(lastNo + 1),
        smallBlind: window.state.actionState.smallBlind,
        bigBlind: window.state.actionState.bigBlind,
        hasBBAnte: window.state.actionState.hasBBAnte,
        preflop: [], flop: [], turn: [], river: [],
      };
      
      // localStorageì—ì„œ ë§ˆì§€ë§‰ ì¹´ë©”ë¼ ë²ˆí˜¸ ì½ê¸°
      const savedCam1 = localStorage.getItem('pokerHandLogger_lastCam1') || '';
      const savedCam2 = localStorage.getItem('pokerHandLogger_lastCam2') || '';
      
      console.log('ğŸ“· ìƒˆ í•¸ë“œ - ì¹´ë©”ë¼ ë²ˆí˜¸ ìë™ ì¦ê°€:');
      console.log(`  localStorage cam1: ${savedCam1 || 'ì—†ìŒ'}`);
      console.log(`  localStorage cam2: ${savedCam2 || 'ì—†ìŒ'}`);
      console.log(`  í˜„ì¬ cam1: ${lastCam1 || 'ì—†ìŒ'}`);
      console.log(`  í˜„ì¬ cam2: ${lastCam2 || 'ì—†ìŒ'}`);
      
      // ì¹´ë©”ë¼ ë²ˆí˜¸ ìë™ ì¦ê°€
      // cam1 ì²˜ë¦¬: ì €ì¥ëœ ë²ˆí˜¸ ë˜ëŠ” í˜„ì¬ ë²ˆí˜¸ì—ì„œ +1
      const cam1Base = savedCam1 || lastCam1 || '0';
      const currentNum1 = parseInt(cam1Base, 10) || 0;
      const nextCam1 = currentNum1 > 0 ? currentNum1 + 1 : 1;
      window.state.camNumbers.cam1no = String(nextCam1);
      window.state.lastCamNo = String(nextCam1);
      el.cam1.textContent = `${window.state.camPreset.cam1}${pad4(nextCam1)}`;
      localStorage.setItem('pokerHandLogger_lastCam1', String(nextCam1));
      console.log(`  â†’ ${window.state.camPreset.cam1} ë‹¤ìŒ ë²ˆí˜¸: ${nextCam1}`);
      
      // cam2 ì²˜ë¦¬: ì €ì¥ëœ ë²ˆí˜¸ ë˜ëŠ” í˜„ì¬ ë²ˆí˜¸ì—ì„œ +1
      const cam2Base = savedCam2 || lastCam2 || '0';
      const currentNum2 = parseInt(cam2Base, 10) || 0;
      const nextCam2 = currentNum2 > 0 ? currentNum2 + 1 : 1;
      window.state.camNumbers.cam2no = String(nextCam2);
      window.state.lastCamNo = String(nextCam2);
      el.cam2.textContent = `${window.state.camPreset.cam2}${pad4(nextCam2)}`;
      localStorage.setItem('pokerHandLogger_lastCam2', String(nextCam2));
      console.log(`  â†’ ${window.state.camPreset.cam2} ë‹¤ìŒ ë²ˆí˜¸: ${nextCam2}`);
      
      renderAll(); saveActionState();
      el.handNumberDisplay.textContent = `#${window.state.actionState.handNumber}`;
    }
    function showFeedback(msg,isErr=false){
      el.feedbackMessage.textContent = msg;
      el.feedbackMessage.className = `text-center h-4 text-xs font-semibold ${isErr?'text-red-400':'text-green-400'}`;
    }

    // ì „ì—­ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì • (v3.4.9)
    window.showFeedback = showFeedback;
    window.openCardSelector = openCardSelector;

    // ====== EVENT LISTENERS ======
    function setupEventListeners(){
      el.loadHandBtn.onclick = openLoadHandModal;
      el.refreshDataBtn.onclick = () => executeWithLock(loadInitial, 'ë°ì´í„° ìƒˆë¡œê³ ì¹¨', 'ìµœì‹  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...');
      el.resetBtn.onclick = () => executeWithLock(resetApp, 'ì•± ë¦¬ì…‹', 'ì•±ì„ ì´ˆê¸°í™”í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
      
      // Cam ë²„íŠ¼ í´ë¦­ - ë°”ë¡œ í‚¤íŒ¨ë“œ ì—´ê¸°
      el.cam1.addEventListener('click', ()=>{
        const prefill = computeCamPrefill('cam1');
        openKeypad(null, { purpose:'cam', cam:'cam1', prefill });
      });

      el.cam2.addEventListener('click', ()=>{
        const prefill = computeCamPrefill('cam2');
        openKeypad(null, { purpose:'cam', cam:'cam2', prefill });
      });
      // "ì‹œíŠ¸ ì „ì†¡" ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ â†’ ë°”ë¡œ ì „ì†¡ (ë…¸íŠ¸ ê¸°ëŠ¥ ì œê±°)
      el.sendToSheetBtn.onclick = () => { sendDataToGoogleSheet(); };
      
      // SB/BB ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
      const smallBlindBtn = document.getElementById('small-blind-btn');
      const bigBlindBtn = document.getElementById('big-blind-btn');
      
      if(smallBlindBtn) {
        smallBlindBtn.onclick = () => {
          const currentValue = window.state.actionState.smallBlind || '0';
          const html = `<div class="bg-gray-800 rounded-lg p-4 w-full max-w-xs">
            <h3 class="text-center text-amber-400 font-bold mb-3">Small Blind ì„¤ì •</h3>
            <div class="text-xs text-gray-400 text-center mb-2">í˜„ì¬: ${formatNumber(currentValue)}</div>
            <input type="text" id="blind-text-input" class="w-full bg-gray-900 text-white p-2 rounded mb-3 text-center" placeholder="0" value="0">
            <div id="keypad-display" class="bg-gray-900 text-right text-2xl font-mono p-2 rounded mb-2 h-12">0</div>
            <div class="grid grid-cols-3 gap-2 text-xl font-bold">
              ${['7','8','9','4','5','6','1','2','3','0','00','000'].map(k=>`<button class="keypad-btn btn bg-gray-700 p-3 rounded-md">${k}</button>`).join('')}
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <button class="keypad-btn btn bg-gray-600 text-amber-400 p-3 rounded-md">C</button>
              <button class="keypad-btn btn bg-gray-600 text-amber-400 p-3 rounded-md">â†</button>
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <button id="keypad-cancel" class="btn bg-red-600 p-3 rounded-md">ì·¨ì†Œ</button>
              <button id="keypad-confirm" class="btn bg-green-600 p-3 rounded-md">í™•ì¸</button>
            </div>
          </div>`;
          
          // í‚¤íŒ¨ë“œ ì˜µì…˜ ì„¤ì •
          window.state.modalState.keypadOptions = {
            purpose: 'smallBlind'
          };
          
          openModal(el.keypadModal, html);
          
          setTimeout(() => {
            const textInput = document.getElementById('blind-text-input');
            const display = document.getElementById('keypad-display');
            let currentInput = '0';
            
            if(textInput && display) {
              // í…ìŠ¤íŠ¸ ì…ë ¥ ì´ë²¤íŠ¸
              textInput.addEventListener('input', () => {
                currentInput = unformatNumber(textInput.value) || '0';
                display.textContent = formatNumber(currentInput);
              });
              
              // í‚¤íŒ¨ë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ëŠ” ì „ì—­ í‚¤íŒ¨ë“œ ëª¨ë‹¬ ì´ë²¤íŠ¸ì—ì„œ ì²˜ë¦¬
              // (ì¤‘ë³µ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°)
              
              // ì·¨ì†Œ ë²„íŠ¼
              document.getElementById('keypad-cancel').onclick = () => {
                closeModal(el.keypadModal);
              };
              
              // í™•ì¸ ë²„íŠ¼ì€ ì „ì—­ í‚¤íŒ¨ë“œ ëª¨ë‹¬ ì´ë²¤íŠ¸ì—ì„œ ì²˜ë¦¬
              // (ì¤‘ë³µ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°)
            }
          }, 10);
        };
      }
      
      if(bigBlindBtn) {
        bigBlindBtn.onclick = () => {
          const currentValue = window.state.actionState.bigBlind || '0';
          const html = `<div class="bg-gray-800 rounded-lg p-4 w-full max-w-xs">
            <h3 class="text-center text-amber-400 font-bold mb-3">Big Blind ì„¤ì •</h3>
            <div class="text-xs text-gray-400 text-center mb-2">í˜„ì¬: ${formatNumber(currentValue)}</div>
            <input type="text" id="blind-text-input" class="w-full bg-gray-900 text-white p-2 rounded mb-3 text-center" placeholder="0" value="0">
            <div id="keypad-display" class="bg-gray-900 text-right text-2xl font-mono p-2 rounded mb-2 h-12">0</div>
            <div class="grid grid-cols-3 gap-2 text-xl font-bold">
              ${['7','8','9','4','5','6','1','2','3','0','00','000'].map(k=>`<button class="keypad-btn btn bg-gray-700 p-3 rounded-md">${k}</button>`).join('')}
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <button class="keypad-btn btn bg-gray-600 text-amber-400 p-3 rounded-md">C</button>
              <button class="keypad-btn btn bg-gray-600 text-amber-400 p-3 rounded-md">â†</button>
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <button id="keypad-cancel" class="btn bg-red-600 p-3 rounded-md">ì·¨ì†Œ</button>
              <button id="keypad-confirm" class="btn bg-green-600 p-3 rounded-md">í™•ì¸</button>
            </div>
          </div>`;
          
          // í‚¤íŒ¨ë“œ ì˜µì…˜ ì„¤ì •
          window.state.modalState.keypadOptions = {
            purpose: 'bigBlind'
          };
          
          openModal(el.keypadModal, html);
          
          setTimeout(() => {
            const textInput = document.getElementById('blind-text-input');
            const display = document.getElementById('keypad-display');
            let currentInput = '0';
            
            if(textInput && display) {
              // í…ìŠ¤íŠ¸ ì…ë ¥ ì´ë²¤íŠ¸
              textInput.addEventListener('input', () => {
                currentInput = unformatNumber(textInput.value) || '0';
                display.textContent = formatNumber(currentInput);
              });
              
              // í‚¤íŒ¨ë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ëŠ” ì „ì—­ í‚¤íŒ¨ë“œ ëª¨ë‹¬ ì´ë²¤íŠ¸ì—ì„œ ì²˜ë¦¬
              // (ì¤‘ë³µ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°)
              
              // ì·¨ì†Œ ë²„íŠ¼
              document.getElementById('keypad-cancel').onclick = () => {
                closeModal(el.keypadModal);
              };
              
              // í™•ì¸ ë²„íŠ¼ì€ ì „ì—­ í‚¤íŒ¨ë“œ ëª¨ë‹¬ ì´ë²¤íŠ¸ì—ì„œ ì²˜ë¦¬
              // (ì¤‘ë³µ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°)
            }
          }, 10);
        };
      }
      
      // ë…¸íŠ¸ ëª¨ë‹¬ ê´€ë ¨ ì´ë²¤íŠ¸ ì œê±° (ë…¸íŠ¸ ê¸°ëŠ¥ ì‚­ì œ)
      
      el.showLogBtn.onclick = openLogModal;
      el.closeLogModalBtn.onclick = closeLogModal;
      
      // ë¡œê·¸ ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
      el.logModal.addEventListener('click', (e)=>{
        if(e.target === el.logModal) {
          closeLogModal();
        }
      });

      // í…Œì´ë¸” ì„ íƒ ë²„íŠ¼ ë° ëª¨ë‹¬ ì´ë²¤íŠ¸
      el.tableSelectorBtn.onclick = openTableSelectorModal;
      document.getElementById('close-table-selector').onclick = closeTableSelectorModal;

      // ê´€ë¦¬ ëª¨ë‹¬ì˜ í…Œì´ë¸” ë³€ê²½ ë²„íŠ¼
      document.getElementById('change-table-btn')?.addEventListener('click', () => {
        window.isTableManagementMode = true;
        openTableSelectorModal();
      });
      
      // í…Œì´ë¸” ëª¨ë‹¬ ê²€ìƒ‰ ë° í•„í„°
      document.getElementById('table-search').oninput = (e) => {
        tableModalState.searchTerm = e.target.value;
        tableModalState.currentPage = 1;
        renderTableGrid();
      };
      
      // í•„í„° ë²„íŠ¼ë“¤
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.onclick = () => {
          // ëª¨ë“  í•„í„° ë²„íŠ¼ ë¹„í™œì„±í™”
          document.querySelectorAll('.filter-btn').forEach(b => {
            b.classList.remove('bg-blue-600', 'text-white');
            b.classList.add('bg-gray-600', 'hover:bg-gray-500');
          });
          // í´ë¦­ëœ ë²„íŠ¼ í™œì„±í™”
          btn.classList.remove('bg-gray-600', 'hover:bg-gray-500');
          btn.classList.add('bg-blue-600', 'text-white');
          
          tableModalState.currentFilter = btn.id.replace('filter-', '');
          tableModalState.currentPage = 1;
          renderTableGrid();
        };
      });
      
      // í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜
      document.getElementById('prev-page').onclick = () => {
        if (tableModalState.currentPage > 1) {
          tableModalState.currentPage--;
          renderTableGrid();
        }
      };
      
      document.getElementById('next-page').onclick = () => {
        const filteredTables = getFilteredTables();
        const totalPages = Math.ceil(filteredTables.length / tableModalState.tablesPerPage);
        if (tableModalState.currentPage < totalPages) {
          tableModalState.currentPage++;
          renderTableGrid();
        }
      };
      
      // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
      el.tableSelectorModal.onclick = (e) => {
        if (e.target === el.tableSelectorModal) {
          closeTableSelectorModal();
        }
      };
      el.timezoneSelector.onchange = (e)=>{ window.state.selectedTimezone=e.target.value; updateTimeDisplay(); renderAll(); };
      
      // Smart Mode í† ê¸€
      document.getElementById('smart-mode-toggle').onchange = (e) => {
        window.state.smartCheckCall = e.target.checked;
        showFeedback(window.state.smartCheckCall ? 'Smart Mode í™œì„±í™”' : 'Smart Mode ë¹„í™œì„±í™”');
      };

      // ì¢Œì„ í”Œë ˆì´ì–´ ì„ íƒ/í•´ì œ (ìƒˆë¡œìš´ 10ê°œ ì¢Œì„ êµ¬ì¡°)
      document.getElementById('seat-buttons')?.addEventListener('click', (e)=>{
        const btn = e.target.closest('button'); 
        if(!btn) return;
        
        const playerName = btn.dataset.playerName;
        const seatNum = btn.dataset.seat;
        
        if(playerName) {
          // í”Œë ˆì´ì–´ê°€ ìˆëŠ” ì¢Œì„ í´ë¦­ - ê²Œì„ ì°¸ì—¬ í† ê¸€
          togglePlayerInHand(playerName);
        } else {
          // ë¹ˆ ì¢Œì„ í´ë¦­ - ë‚˜ì¤‘ì— í•„ìš”ì‹œ í”Œë ˆì´ì–´ ì¶”ê°€ ê¸°ëŠ¥
          console.log(`ë¹ˆ ì¢Œì„ ${seatNum} í´ë¦­`);
        }
      });

      // í”Œë ˆì´ì–´ ì¹´ë“œ/ì¹© ì…ë ¥
      el.playerDetailsSection.addEventListener('click', (e)=>{
        const cardPlaceholder = e.target.closest('.card-placeholder');
        const keypadBtn = e.target.closest('.keypad-icon-btn');
        const playerCard = e.target.closest('.player-card');
        if(!playerCard) return;
        if(cardPlaceholder){
          window.state.modalState.cardTarget = { target:'playerHand', player:cardPlaceholder.dataset.playerName, count:parseInt(cardPlaceholder.dataset.count) };
          openCardSelector();
        }else if(keypadBtn){
          const pn = playerCard.dataset.playerName;
          const p = window.state.playersInHand.find(pp=>pp.name===pn);
          if(p) {
            // ê°œì„ ëœ ì¹© ì…ë ¥ í•¨ìˆ˜ ì‚¬ìš©
            openChipInput(p, false);
          }
        }
      });

      // ìŠ¹ì í† ê¸€
      el.winnerButtons.addEventListener('click', (e)=>{
        const btn=e.target.closest('.set-winner-btn'); if(!btn) return;
        setPlayerRole(btn.dataset.playerName);
      });

      // ì¹© ì…ë ¥ í¬ë§·íŒ…
      el.playerDetailsSection.addEventListener('input', (e)=>{
        if(!e.target.classList.contains('player-chip-input')) return;
        const parent = e.target.closest('.player-card');
        const player = window.state.playersInHand.find(p=>p.name===parent.dataset.playerName);
        const raw = unformatNumber(e.target.value);
        e.target.value = formatNumber(raw);
        
        if (player){
          const oldChips = player.chips;
          player.chips = raw;
          player.chipsUpdatedAt = new Date().toISOString();
          
          // í•­ìƒ í˜„ì¬ ì…ë ¥ëœ ì¹© ê°’ì„ ì‹œì‘ì¹©ìœ¼ë¡œ ì—…ë°ì´íŠ¸
          // (ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ì¹©ì„ ë³€ê²½í•˜ë©´ ê·¸ê²ƒì´ ìƒˆë¡œìš´ ì‹œì‘ì¹©ì´ ë¨)
          player.initialChips = raw;
          console.log(`ğŸ° ${player.name}ì˜ ì‹œì‘ì¹© ì—…ë°ì´íŠ¸: ${oldChips} â†’ ${raw}`);
        }
      });

      // ë³´ë“œ ì¹´ë“œ ì„ íƒ
      el.boardCardPlaceholders.addEventListener('click', (e)=>{
        const ph = e.target.closest('.card-placeholder'); if(!ph) return;
        window.state.modalState.cardTarget = { target:'board', index:parseInt(ph.dataset.index), count:parseInt(ph.dataset.count) };
        openCardSelector();
      });

      // ì¹´ë“œ ì„ íƒ ëª¨ë‹¬ ì´ë²¤íŠ¸
      el.cardSelectorModal.addEventListener('click', (e)=>{
        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        if(e.target === el.cardSelectorModal) {
          closeModal(el.cardSelectorModal);
          return;
        }
        // ë‹«ê¸° ë²„íŠ¼ í´ë¦­
        if(e.target.id==='close-card-modal') closeModal(el.cardSelectorModal);
      });

      // ìŠ¤íŠ¸ë¦¬íŠ¸ ë²„íŠ¼(ì¶”ê°€/ë˜ëŒë¦¬ê¸°/Pot êµì •/ìŠ¤íŠ¸ë¦¬íŠ¸ ì„ íƒ)
      el.streetLogsContainer.addEventListener('click', (e)=>{
        const streetBtn = e.target.closest('.street-select-btn');
        const addBtn = e.target.closest('.add-action-btn');
        const undoBtn = e.target.closest('.undo-action-btn');
        const potBtn = e.target.closest('.pot-keypad-btn');
        
        if(streetBtn) {
          const selectedStreet = streetBtn.dataset.street;
          window.state.currentStreet = selectedStreet;
          renderActionStreets(); // í•˜ì´ë¼ì´íŠ¸ ì—…ë°ì´íŠ¸

          // ìŠ¤íŠ¸ë¦¿ ì„ íƒ ì‹œ ë°”ë¡œ ì•¡ì…˜ íŒ¨ë“œ ì—´ê¸°
          openActionPad(selectedStreet);
        }
        if(addBtn) openActionPad(addBtn.dataset.street);
        if(undoBtn) undoLastAction(undoBtn.dataset.street);
        if(potBtn){
          window.state.modalState.actionPadStreet = potBtn.dataset.street;
          openKeypad(null, { purpose:'pot', currentPot: potBtn.dataset.currentPot });
        }
      });

      // ìƒˆë¡œìš´ ì•¡ì…˜ íŒ¨ë“œ ë‚´ë¶€ ë²„íŠ¼ ì´ë²¤íŠ¸
      el.actionPadModal.addEventListener('click', (e)=>{
        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        if(e.target === el.actionPadModal) {
          closeModal(el.actionPadModal);
          return;
        }

        const btn = e.target.closest('button'); if(!btn) return;

        // ë‹«ê¸° ë²„íŠ¼
        if(btn.id==='close-action-pad'){
          closeModal(el.actionPadModal);
          return;
        }

        // ì•¡ì…˜ ëª¨ë“œ í† ê¸€
        if(btn.id==='toggle-action-mode') {
          const newMode = window.actionManager.toggleMode();
          showFeedback(`ì•¡ì…˜ ëª¨ë“œ: ${newMode === 'auto' ? 'ğŸ¤– ìë™ ìˆœì„œ' : 'ğŸ‘† ìˆ˜ë™ ì„ íƒ'}`, false);
          // ëª¨ë‹¬ ë‹¤ì‹œ ì—´ê¸° (UI ì—…ë°ì´íŠ¸)
          openActionPad(window.actionManager.currentStreet);
          return;
        }

        // í˜„ì¬ í”Œë ˆì´ì–´ ìŠ¤í‚µ
        if(btn.id==='skip-current-player') {
          const nextPlayer = window.actionManager.moveToNextPlayer();
          showFeedback(`í”Œë ˆì´ì–´ ìŠ¤í‚µë¨. ${nextPlayer ? `ë‹¤ìŒ: ${nextPlayer.name}` : 'ìŠ¤íŠ¸ë¦¿ ì™„ë£Œ'}`, false);
          openActionPad(window.actionManager.currentStreet);
          return;
        }

        // ìë™ ëª¨ë“œì—ì„œ í˜„ì¬ í”Œë ˆì´ì–´ ì•¡ì…˜
        if(btn.dataset.player && window.actionManager.actionMode === 'auto') {
          const playerName = btn.dataset.player;
          const action = btn.dataset.action;

          // ì•¡ì…˜ ì‹¤í–‰
          executePlayerAction(playerName, action, btn);
          return;
        }

        // ìˆ˜ë™ ëª¨ë“œ í”Œë ˆì´ì–´ ì„ íƒ
        const modal = el.actionPadModal;
        if(btn.parentElement?.id==='action-pad-players'){
          window.state.modalState.actionPadPlayer = btn.dataset.playerName;
          const actionSection = modal.querySelector('#action-pad-actions');
          if(actionSection) {
            modal.querySelector('#action-pad-players').classList.add('hidden');
            actionSection.classList.remove('hidden');

            // ìˆ˜ë™ ëª¨ë“œ Check/Call ë²„íŠ¼ ì—…ë°ì´íŠ¸
            const smartBtn = modal.querySelector('#manual-smart-check-call-btn');
            if(smartBtn) {
              const playerName = btn.dataset.playerName;
              const street = window.state.modalState.actionPadStreet;
              const smartAction = getSmartCheckCallAction(playerName, street);

              // ë²„íŠ¼ ìƒ‰ìƒê³¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
              if(smartAction.action === 'Checks') {
                smartBtn.className = 'btn bg-green-600 hover:bg-green-700 p-3 rounded-md';
                smartBtn.innerHTML = 'âœ… Check';
              } else {
                smartBtn.className = 'btn bg-blue-600 hover:bg-blue-700 p-3 rounded-md';
                smartBtn.innerHTML = `ğŸ“ Call ${formatNumber(smartAction.amount)}`;
              }
              smartBtn.dataset.smartAction = JSON.stringify(smartAction);
            }
          }
          return;
        }

        // ìˆ˜ë™ ëª¨ë“œ ì•¡ì…˜ ì²˜ë¦¬
        if(btn.parentElement?.id==='action-pad-actions'){
          const action = btn.dataset.action;
          const playerName = window.state.modalState.actionPadPlayer;

          if(!playerName) {
            showFeedback('í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', true);
            return;
          }

          // ìˆ˜ë™ ëª¨ë“œì—ì„œ ì•¡ì…˜ ì‹¤í–‰
          executePlayerAction(playerName, action, btn);
          return;
        }

        // ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•œ ì²˜ë¦¬ (ì‚­ì œ ì˜ˆì •)
        if(btn.parentElement?.id==='action-pad-actions-legacy'){
          const action = btn.dataset.action;
          if(action==='Bet/Raises'){
            const st = window.state.modalState.actionPadStreet;
            const hasBet = window.state.actionState[st].some(a=>/BET|RAISE/i.test(a.action||''));
            window.state.modalState.actionPadCurrentAction = hasBet ? 'Raises' : 'Bets';
            closeModal(el.actionPadModal); openKeypad(null, { purpose:'bet' });
          }else if(action==='SmartCheckCall'){
            // ìŠ¤ë§ˆíŠ¸ Check/Call ì²˜ë¦¬
            const smartBtn = btn;
            const smartAction = JSON.parse(smartBtn.dataset.smartAction || '{}');
            if(smartAction.action) {
              addActionToLog(smartAction.action, smartAction.amount);
            }
          }else if(action==='All In'){
            const p = window.state.playersInHand.find(pp=>pp.name===window.state.modalState.actionPadPlayer);
            if(p) addActionToLog('All In', p.chips);
          }else if(action==='Calls'){
            const st = window.state.modalState.actionPadStreet;
            const p = window.state.playersInHand.find(pp=>pp.name===window.state.modalState.actionPadPlayer);
            
            // í˜„ì¬ ìŠ¤íŠ¸ë¦¬íŠ¸ì™€ ì´ì „ ìŠ¤íŠ¸ë¦¬íŠ¸ì—ì„œ ë§ˆì§€ë§‰ ë² íŒ…/ë ˆì´ì¦ˆ ì°¾ê¸°
            let lastBet = null;
            let requiredAmt = 0;
            
            // í˜„ì¬ ìŠ¤íŠ¸ë¦¬íŠ¸ì—ì„œ ì°¾ê¸°
            lastBet = [...window.state.actionState[st]].reverse().find(a=>/BET|RAISE|All In/i.test(a.action||''));
            
            if(!lastBet && st !== 'preflop') {
              // í˜„ì¬ ìŠ¤íŠ¸ë¦¬íŠ¸ì— ë² íŒ…ì´ ì—†ìœ¼ë©´ ì´ì „ ìŠ¤íŠ¸ë¦¬íŠ¸ í™•ì¸
              const streetOrder = ['preflop', 'flop', 'turn', 'river'];
              const currentIdx = streetOrder.indexOf(st);
              for(let i = currentIdx - 1; i >= 0; i--) {
                lastBet = [...window.state.actionState[streetOrder[i]]].reverse().find(a=>/BET|RAISE|All In/i.test(a.action||''));
                if(lastBet) break;
              }
            }
            
            // ì½œ ê¸ˆì•¡ ê²°ì •
            if(lastBet) {
              requiredAmt = lastBet.amount;
            } else if(st === 'preflop') {
              // í”„ë¦¬í”Œëì—ì„œ ì•„ë¬´ë„ ë² íŒ…í•˜ì§€ ì•Šì•˜ìœ¼ë©´ ë¹…ë¸”ë¼ì¸ë“œ ì½œ
              requiredAmt = unformatNumber(window.state.actionState.bigBlind);
            } else {
              // í¬ìŠ¤íŠ¸í”Œëì—ì„œ ë² íŒ…ì´ ì—†ìœ¼ë©´ ì²´í¬í•´ì•¼ í•¨
              showFeedback('ë² íŒ…ì´ ì—†ì–´ ì²´í¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”', true);
              return;
            }
            
            // í”Œë ˆì´ì–´ í˜„ì¬ ì¹©
            const playerChips = p ? parseInt(unformatNumber(p.chips), 10) : 0;
            
            // ì˜¬ì¸ ì½œ ì²´í¬: í•„ìš” ê¸ˆì•¡ì´ í”Œë ˆì´ì–´ ì¹©ë³´ë‹¤ í¬ë©´ ì˜¬ì¸
            if(playerChips > 0 && playerChips <= parseInt(unformatNumber(requiredAmt), 10)){
              // ì˜¬ì¸ ì½œ (í”Œë ˆì´ì–´ì˜ ëª¨ë“  ì¹©)
              addActionToLog('All In', p.chips);
            } else {
              // ì¼ë°˜ ì½œ
              addActionToLog('Calls', requiredAmt);
            }
          }else{
            addActionToLog(action);
          }
        }
      });

      // ë°”ê¹¥ìª½ í‚¤íŒ¨ë“œ ë²„íŠ¼(SB/BB ë“±)
      document.body.addEventListener('click', (e)=>{
        const kb = e.target.closest('.keypad-icon-btn');
        if(kb && !kb.closest('.player-card')) openKeypad(kb.previousElementSibling, { purpose:'input' });
      });

      // ğŸš€ ìŠ¤ë§ˆíŠ¸í° í‚¤ë³´ë“œ ìˆ˜ì¤€ í‚¤íŒ¨ë“œ ì…ë ¥ (v3.4.17 ì„±ëŠ¥ ìµœì í™”)
      // ë²„íŠ¼ë³„ ëˆ„ë¦„ ìƒíƒœ ì¶”ì 
      const buttonPressState = new Map();

      // ê¸°ì¡´ click ì´ë²¤íŠ¸ ëŒ€ì‹  down/up ì´ë²¤íŠ¸ë¡œ ì¦‰ì‹œ ë°˜ì‘
      el.keypadModal.addEventListener('mousedown', handleKeypadDown, { passive: false });
      el.keypadModal.addEventListener('touchstart', handleKeypadDown, { passive: false });
      el.keypadModal.addEventListener('mouseup', handleKeypadUp);
      el.keypadModal.addEventListener('touchend', handleKeypadUp);
      el.keypadModal.addEventListener('mouseleave', handleKeypadUp);

      function handleKeypadDown(e) {
        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        if(e.target === el.keypadModal) {
          closeModal(el.keypadModal);
          return;
        }

        const btn = e.target.closest('button');
        if(!btn) return;

        // ì´ë¯¸ ëˆŒë¦° ìƒíƒœë©´ ë¬´ì‹œ (ë¬¼ë¦¬ì  ëˆ„ë¦„ ìƒíƒœë§Œ ì²´í¬)
        if (buttonPressState.get(btn)) return;

        // ì¦‰ì‹œ ì²˜ë¦¬ ì‹œì‘
        buttonPressState.set(btn, true);

        // ì¦‰ì‹œ ì‹œê°ì  í”¼ë“œë°±
        btn.style.transform = 'scale(0.95)';
        btn.style.filter = 'brightness(1.2)';

        // í‚¤íŒ¨ë“œ ë²„íŠ¼ë§Œ ì¦‰ì‹œ ì²˜ë¦¬ (í™•ì¸/ì·¨ì†Œ ë²„íŠ¼ì€ ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        if(btn.classList.contains('keypad-btn')) {
          processKeypadInputImmediate(btn);
        }

        // í„°ì¹˜ ì´ë²¤íŠ¸ ì‹œ click ì¤‘ë³µ ë°©ì§€
        e.preventDefault();
      }

      function handleKeypadUp(e) {
        const btn = e.target.closest('button');
        if(!btn) return;

        // ëˆ„ë¦„ ìƒíƒœ í•´ì œ
        buttonPressState.set(btn, false);

        // ì‹œê°ì  ë³µêµ¬
        btn.style.transform = '';
        btn.style.filter = '';
      }

      // ì¦‰ì‹œ ì…ë ¥ ì²˜ë¦¬ í•¨ìˆ˜
      function processKeypadInputImmediate(btn) {
        const display = el.keypadModal.querySelector('#keypad-display');
        const key = btn.textContent;

        if(key==='C'){
          display.textContent='0';
        }else if(key==='â†'){
          const current = unformatNumber(display.textContent);
          const newValue = current.slice(0,-1) || '0';
          display.textContent = formatNumber(newValue);
        }else if(btn.dataset.action === 'max') {
          const { purpose } = window.state.modalState.keypadOptions;
          if(purpose === 'bet') {
            const playerName = window.state.modalState.keypadOptions.playerName ||
                              window.state.modalState.actionPadPlayer;
            const player = window.state.playersInHand.find(p => p.name === playerName);
            if(player) {
              display.textContent = player.chips;
              const warning = el.keypadModal.querySelector('#keypad-warning');
              if(warning) {
                warning.classList.remove('hidden');
                warning.textContent = `ğŸ’° ìµœëŒ€ ë² íŒ… - ë³´ìœ  ì¹© ì „ì²´(${formatNumber(player.chips)})`;
                warning.className = 'text-xs text-blue-400 text-center mb-2';
              }
            }
          }
        }else{
          // ìˆ«ì ì…ë ¥ ì²˜ë¦¬
          const current = unformatNumber(display.textContent);
          let newValue;
          if(current === '0') {
            newValue = key;
          } else {
            newValue = current + key;
          }
          display.textContent = formatNumber(newValue);
        }

        // DOM ê°•ì œ ë Œë”ë§ìœ¼ë¡œ ì¦‰ì‹œ ë°˜ì˜
        display.offsetHeight;
      }

      // í™•ì¸/ì·¨ì†Œ ë²„íŠ¼ì€ ê¸°ì¡´ click ì´ë²¤íŠ¸ ìœ ì§€
      el.keypadModal.addEventListener('click', (e)=>{
        const btn = e.target.closest('button');
        if(!btn) return;

        // í‚¤íŒ¨ë“œ ë²„íŠ¼ì€ ì´ë¯¸ down ì´ë²¤íŠ¸ì—ì„œ ì²˜ë¦¬ë¨
        if(btn.classList.contains('keypad-btn')) return;

        const display = el.keypadModal.querySelector('#keypad-display');

        // MAX ë²„íŠ¼ ì²˜ë¦¬
        if(btn.dataset.action === 'max') {
          const { purpose } = window.state.modalState.keypadOptions;
          if(purpose === 'bet') {
            const playerName = window.state.modalState.keypadOptions.playerName ||
                              window.state.modalState.actionPadPlayer;
            const player = window.state.playersInHand.find(p => p.name === playerName);
            if(player) {
              display.textContent = player.chips; // ëª¨ë“  ì¹©ì„ ë² íŒ…
              const warning = el.keypadModal.querySelector('#keypad-warning');
              if(warning) {
                warning.classList.remove('hidden');
                warning.textContent = `ğŸ’° ìµœëŒ€ ë² íŒ… - ë³´ìœ  ì¹© ì „ì²´(${formatNumber(player.chips)})`;
                warning.className = 'text-xs text-blue-400 text-center mb-2';
              }
            }
          }
          return;
        }

        if(btn.id==='keypad-confirm'){
          const finalAmt = unformatNumber(display.textContent);
          const { purpose, currentPot } = window.state.modalState.keypadOptions;
          if(purpose==='cam'){
            const which = window.state.modalState.keypadOptions.cam; // 'cam1'|'cam2'
            const padded = pad4(finalAmt);
            const numValue = String(finalAmt); // ìˆ«ìë§Œ ì €ì¥ (0007 â†’ 7)
            if (which==='cam1'){
              window.state.camNumbers.cam1no = numValue; // ìˆ«ìë¡œ ì €ì¥
              window.state.lastCamNo = numValue;
              el.cam1.textContent = `${window.state.camPreset.cam1}${padded}`; // í‘œì‹œëŠ” íŒ¨ë”©ëœ í˜•íƒœë¡œ
              localStorage.setItem('pokerHandLogger_lastCam1', numValue); // localStorageì— ìˆ«ìë¡œ ì €ì¥
              showFeedback(`${window.state.camPreset.cam1 || 'Cam1'}${padded} ì…ë ¥ë¨`);
              console.log(`ğŸ“· cam1 ì €ì¥: ${window.state.camPreset.cam1}=${numValue}`);
            }else if (which==='cam2'){
              window.state.camNumbers.cam2no = numValue; // ìˆ«ìë¡œ ì €ì¥
              window.state.lastCamNo = numValue;
              el.cam2.textContent = `${window.state.camPreset.cam2}${padded}`; // í‘œì‹œëŠ” íŒ¨ë”©ëœ í˜•íƒœë¡œ
              localStorage.setItem('pokerHandLogger_lastCam2', numValue); // localStorageì— ìˆ«ìë¡œ ì €ì¥
              console.log(`ğŸ“· cam2 ì €ì¥: ${window.state.camPreset.cam2}=${numValue}`);
              showFeedback(`${window.state.camPreset.cam2 || 'Cam2'}${padded} ì…ë ¥ë¨`);
            }
          }else if(purpose==='bet'){
            const { playerName } = window.state.modalState.keypadOptions;
            if(finalAmt) {
              // ì¹© ì´ˆê³¼ ê²€ì¦ ì¶”ê°€
              const actualPlayerName = playerName || window.state.modalState.actionPadPlayer;
              const player = window.state.playersInHand.find(p => p.name === actualPlayerName);
              if(player) {
                const playerChips = parseInt(unformatNumber(player.chips), 10);
                const betAmount = parseInt(finalAmt, 10);

                // ë² íŒ… ê¸ˆì•¡ì´ ë³´ìœ  ì¹©ì„ ì´ˆê³¼í•˜ëŠ” ê²½ìš° ê²½ê³ ë§Œ í‘œì‹œ (ì§„í–‰ì€ í—ˆìš©)
                if(betAmount > playerChips) {
                  showFeedback(`âš ï¸ ì£¼ì˜: ì¹© ì´ˆê³¼ ë² íŒ… (ë³´ìœ : ${formatNumber(playerChips)}, ë² íŒ…: ${formatNumber(betAmount)})`, true);
                  const resultingChips = playerChips - betAmount;
                  showFeedback(`ğŸ’° ì¹©ì´ ${formatNumber(resultingChips)}ê°€ ë©ë‹ˆë‹¤`, false);
                  // ê²½ê³ ë§Œ í•˜ê³  ì§„í–‰ì€ ê³„ì†í•¨
                }
              }

              addActionToLog(window.state.modalState.actionPadCurrentAction, finalAmt, actualPlayerName);

              // ìë™ ëª¨ë“œì—ì„œ ë‹¤ìŒ í”Œë ˆì´ì–´ë¡œ ì´ë™
              if(window.actionManager && window.actionManager.actionMode === 'auto') {
                const nextPlayer = window.actionManager.moveToNextPlayer();
                showFeedback(`${playerName} ${window.state.modalState.actionPadCurrentAction} ${formatNumber(finalAmt)}`, false);

                if(nextPlayer) {
                  openActionPad(window.actionManager.currentStreet);
                } else {
                  setTimeout(() => {
                    showFeedback(`${window.actionManager.currentStreet.toUpperCase()} ìŠ¤íŠ¸ë¦¿ ì™„ë£Œ`, false);
                  }, 500);
                }
              }
            }
          }else if(purpose==='pot'){
            // Pot correction: ì…ë ¥í•œ ê°’ ê·¸ëŒ€ë¡œ ì €ì¥ (ì´ì „ íŒŸ í¬ê¸°ë¥¼ ë¹¼ì§€ ì•ŠìŒ)
            const potSize = finalAmt; // í¬ë§·ëœ ê°’ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            if(potSize){
              const st = window.state.modalState.actionPadStreet;
              // Pot Correctionì€ player ì—†ì´ ì €ì¥ (ì‹œìŠ¤í…œ ì•¡ì…˜)
              window.state.actionState[st].push({ 
                action:'Pot Correction', 
                amount:potSize,  // í¬ë§·ëœ ê°’ ê·¸ëŒ€ë¡œ ì €ì¥
                timestamp:new Date().toISOString() 
              });
              saveActionState(); renderAll();
            }
          }else if(purpose==='input'){
            if(window.state.modalState.keypadTarget){
              window.state.modalState.keypadTarget.value = display.textContent;
              window.state.modalState.keypadTarget.dispatchEvent(new Event('input',{bubbles:true}));
            }
          }else if(purpose==='chip'){
            // openChipInputì—ì„œ í˜¸ì¶œëœ ê²½ìš°
            const { playerName } = window.state.modalState.keypadOptions;
            const player = window.state.playersInHand.find(p => p.name === playerName);
            if(player) {
              const value = unformatNumber(display.textContent) || '0';
              player.chips = value;
              player.initialChips = value;
              player.chipsUpdatedAt = new Date().toISOString();
              renderPlayerDetails();
            }
          }else if(purpose==='smallBlind'){
            // SB ë²„íŠ¼ì—ì„œ í˜¸ì¶œëœ ê²½ìš°
            const value = unformatNumber(display.textContent) || '0';
            window.state.actionState.smallBlind = value;
            const smallBlindBtn = document.getElementById('small-blind-btn');
            if(smallBlindBtn) {
              smallBlindBtn.textContent = formatNumber(value);
            }
            saveActionState();
          }else if(purpose==='bigBlind'){
            // BB ë²„íŠ¼ì—ì„œ í˜¸ì¶œëœ ê²½ìš°
            const value = unformatNumber(display.textContent) || '0';
            window.state.actionState.bigBlind = value;
            const bigBlindBtn = document.getElementById('big-blind-btn');
            if(bigBlindBtn) {
              bigBlindBtn.textContent = formatNumber(value);
            }
            saveActionState();
          }else if(purpose==='quickBet'){
            // í€µ ë²³/ë ˆì´ì¦ˆ ì²˜ë¦¬
            const { player, street } = window.state.modalState.keypadOptions;
            const amount = unformatNumber(display.textContent);
            if(amount && player && street) {
              // í˜„ì¬ ìŠ¤íŠ¸ë¦¬íŠ¸ì— ë² íŒ…ì´ ìˆëŠ”ì§€ í™•ì¸
              const hasBet = window.state.actionState[street].some(a => 
                /BET|RAISE/i.test(a.action || '')
              );
              const action = hasBet ? 'Raises' : 'Bets';
              
              // ì•¡ì…˜ ì¶”ê°€
              window.state.actionState[street].push({
                player: player,
                action: action,
                amount: amount,
                timestamp: new Date().toISOString()
              });
              
              // ë‹¤ìŒ í”Œë ˆì´ì–´ ê³„ì‚°
              window.state.nextActionPlayer = calculateNextActionPlayer(street);
              
              saveActionState();
              renderAll();
              showFeedback(`${player} ${action} ${formatNumber(amount)}`);
            }
          }
          closeModal(el.keypadModal);
        }else if(btn.id==='keypad-cancel'){
          closeModal(el.keypadModal);
        }
        // ë‚˜ë¨¸ì§€ ë²„íŠ¼ë“¤ì€ ê¸°ì¡´ ë¡œì§ ìœ ì§€ (í‚¤íŒ¨ë“œ ë²„íŠ¼ì€ down ì´ë²¤íŠ¸ì—ì„œ ì²˜ë¦¬ë¨)
      });

      // SB/BB/Ante ì²´í¬
      document.querySelectorAll('.number-input').forEach(inp=>{
        inp.addEventListener('input', (e)=>{
          const raw = unformatNumber(e.target.value);
          const fmt = formatNumber(raw);
          if(e.target.value!==fmt) e.target.value=fmt;
          const k = toCamelCase(e.target.id.replace('-input','')); // small-blind-input -> smallBlind
          if(k in window.state.actionState) window.state.actionState[k]=raw;
          saveActionState();
        });
      });
      el.bbAnteCheckbox.onchange = (e)=>{ window.state.actionState.hasBBAnte = e.target.checked; saveActionState(); renderAll(); };

      // Load Hand ëª¨ë‹¬ ë‚´ë¶€ í´ë¦­
      el.loadHandModal.addEventListener('click', (e)=>{
        // í•¸ë“œ í•­ëª© í´ë¦­ ìš°ì„  ì²˜ë¦¬
        const itemBtn = e.target.closest('.load-hand-item-btn');
        if(itemBtn){
          const no = itemBtn.dataset.no;
          const dt = itemBtn.dataset.date || null;
          loadHandData(no, dt);
          return;
        }
        
        // ë‹«ê¸° ë²„íŠ¼ í´ë¦­
        const closeBtn = e.target.closest('#close-load-hand-modal');
        if(closeBtn) {
          closeModal(el.loadHandModal);
          return;
        }
        
        // ëª¨ë‹¬ ì»¨í…ì¸  ì˜ì—­ í´ë¦­ì€ ë¬´ì‹œ
        const content = e.target.closest('.bg-gray-800');
        if(content) return;
        
        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        if (e.target === el.loadHandModal) {
          closeModal(el.loadHandModal);
        }
      });
    }

    // ====== ê´€ë¦¬ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ ======
    function openRegistrationModal() {
      const modal = el.registrationModal;
      if (modal) {
        modal.classList.remove('hidden');
        modal.classList.remove('opacity-0');
      }
    }
    
    function closeRegistrationModal() {
      const modal = el.registrationModal;
      if (modal) {
        modal.classList.add('opacity-0');
        modal.classList.add('hidden');
      }
    }
    
    
    // ê´€ë¦¬ ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    if (el.managePlayersBtn) {
      el.managePlayersBtn.addEventListener('click', () => {
        openRegistrationModal();
        // ì´ˆê¸°í™”: ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        document.getElementById('management-menu').classList.remove('hidden');
        document.getElementById('player-management-content').classList.add('hidden');

        // Apps Script URL í‘œì‹œ
        const currentUrlSpan = document.getElementById('management-current-url');
        const urlInput = document.getElementById('management-apps-url-input');
        const urlStatus = document.getElementById('url-save-status');

        if (currentUrlSpan) {
          currentUrlSpan.textContent = APPS_SCRIPT_URL || 'ì„¤ì •ë˜ì§€ ì•ŠìŒ';
          // URLì´ ê¸°ë³¸ê°’ì¸ì§€ ì‚¬ìš©ì ì„¤ì •ê°’ì¸ì§€ í‘œì‹œ
          const isCustomUrl = APPS_SCRIPT_URL !== DEFAULT_APPS_SCRIPT_URL;
          currentUrlSpan.className = isCustomUrl ?
            'text-xs text-green-400 break-all font-mono' :
            'text-xs text-amber-400 break-all font-mono';
        }

        if (urlInput) {
          urlInput.value = '';
          urlInput.placeholder = 'ìƒˆ URLì„ ì…ë ¥í•˜ì„¸ìš” (í˜„ì¬ì™€ ë‹¤ë¥¸ URLë§Œ ì €ì¥ ê°€ëŠ¥)';
        }

        if (urlStatus) {
          urlStatus.classList.add('hidden');
        }
      });
    }

    // Apps Script URL ì €ì¥ ë²„íŠ¼ - ì§€ì—° ì‹¤í–‰ìœ¼ë¡œ DOM ë¡œë“œ ë³´ì¥
    setTimeout(() => {
      const saveUrlBtn = document.getElementById('save-apps-url-btn');
      console.log('[v3.3.1] Apps Script URL ì €ì¥ ë²„íŠ¼:', saveUrlBtn);

      if (saveUrlBtn) {
        saveUrlBtn.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('[v3.3.1] URL ì €ì¥ ë²„íŠ¼ í´ë¦­ë¨');

          const urlInput = document.getElementById('management-apps-url-input');
          const urlStatus = document.getElementById('url-save-status');
          const currentUrlSpan = document.getElementById('management-current-url');
          const newUrl = urlInput?.value.trim();

          console.log('[v3.3.1] ì…ë ¥ëœ URL:', newUrl);
          console.log('[v3.3.1] í˜„ì¬ URL:', APPS_SCRIPT_URL);

          // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
          function showUrlStatus(message, isSuccess) {
            if (urlStatus) {
              urlStatus.textContent = message;
              urlStatus.className = isSuccess ?
                'text-xs p-2 rounded bg-green-600 text-white' :
                'text-xs p-2 rounded bg-red-600 text-white';
              urlStatus.classList.remove('hidden');

              // 3ì´ˆ í›„ ìë™ ìˆ¨ê¹€
              setTimeout(() => {
                urlStatus.classList.add('hidden');
              }, 3000);
            }
          }

          if (newUrl && newUrl !== APPS_SCRIPT_URL) {
            if (updateAppsScriptUrl(newUrl)) {
              // ì„±ê³µ ì‹œ UI ì—…ë°ì´íŠ¸
              if (currentUrlSpan) {
                currentUrlSpan.textContent = newUrl;
                currentUrlSpan.className = 'text-xs text-green-400 break-all font-mono';
              }
              showUrlStatus('âœ… URLì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', true);
              showFeedback('âœ… Apps Script URLì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');

              // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” ë° í”Œë ˆì´ìŠ¤í™€ë” ì—…ë°ì´íŠ¸
              urlInput.value = '';
              urlInput.placeholder = 'ì €ì¥ ì™„ë£Œ! ë‹¤ë¥¸ URLì„ ì…ë ¥í•˜ë ¤ë©´ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”';

              // ì €ì¥ ë²„íŠ¼ ì„ì‹œ ë¹„í™œì„±í™” ë° í…ìŠ¤íŠ¸ ë³€ê²½
              saveUrlBtn.disabled = true;
              saveUrlBtn.textContent = 'âœ… ì €ì¥ ì™„ë£Œ';
              saveUrlBtn.className = 'w-full bg-green-600 py-1.5 rounded text-sm font-medium';

              setTimeout(() => {
                saveUrlBtn.disabled = false;
                saveUrlBtn.textContent = 'ğŸ’¾ ìƒˆ URL ì €ì¥';
                saveUrlBtn.className = 'w-full bg-amber-600 hover:bg-amber-700 py-1.5 rounded text-sm font-medium';
              }, 2000);
            } else {
              showUrlStatus('âŒ ì˜¬ë°”ë¥¸ URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤', false);
              showFeedback('âŒ ì˜¬ë°”ë¥¸ URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤', true);
            }
          } else if (!newUrl) {
            showUrlStatus('âš ï¸ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”', false);
            showFeedback('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”', true);
          } else if (newUrl === APPS_SCRIPT_URL) {
            showUrlStatus('â„¹ï¸ í˜„ì¬ ì €ì¥ëœ URLê³¼ ë™ì¼í•©ë‹ˆë‹¤', false);
            showFeedback('ë™ì¼í•œ URLì…ë‹ˆë‹¤', true);
          }
        });
        console.log('[v3.3.1] URL ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
      } else {
        console.error('[v3.3.1] save-apps-url-btn ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      }
    }, 100);

    // í…Œì´ë¸” ê´€ë¦¬ ë²„íŠ¼ í´ë¦­ - ë°”ë¡œ í…Œì´ë¸” ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
    document.getElementById('open-table-management-btn')?.addEventListener('click', () => {
      // í…Œì´ë¸” ê´€ë¦¬ ëª¨ë“œ í™œì„±í™” í”Œë˜ê·¸ ì„¤ì •
      window.isTableManagementMode = true;

      // ë°”ë¡œ í…Œì´ë¸” ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
      openTableSelectorModal();
    });

    // í”Œë ˆì´ì–´ ê´€ë¦¬ ì‹œìŠ¤í…œ ìƒíƒœ - ì „ì—­ ìŠ¤ì½”í”„ë¡œ ë…¸ì¶œ
    window.managementState = {
      selectedTable: '',
      originalPlayers: [],
      currentPlayers: [],
      changes: {
        added: [],
        modified: [],
        deleted: []
      }
    };

    // í”Œë ˆì´ì–´ ê´€ë¦¬ ì´ˆê¸°í™”
    function initPlayerManagement() {
      // ì´ˆê¸° ìƒíƒœë¡œ ë¦¬ì…‹
      window.managementState = {
        selectedTable: '',
        originalPlayers: [],
        currentPlayers: [],
        changes: { added: [], modified: [], deleted: [] }
      };

      // UI ì´ˆê¸°í™” - ì¦‰ì‹œ ì„ íƒ ë°©ì‹ìœ¼ë¡œ ë³€ê²½
      document.getElementById('selected-table-info').classList.add('hidden');
      document.getElementById('player-add-section').classList.add('hidden');
      document.getElementById('player-list-section').classList.add('hidden');
      document.getElementById('batch-actions').classList.add('hidden');
      document.getElementById('sync-status').textContent = '';
    }

    // ê´€ë¦¬ ëª¨ë‹¬ì—ì„œ í…Œì´ë¸” ì„ íƒ ì²˜ë¦¬ - selectTableì—ì„œ í˜¸ì¶œë¨
    function onManagementTableSelected(tableName) {
      console.log('[DEBUG] onManagementTableSelected í˜¸ì¶œë¨, tableName:', tableName);
      if (!tableName) return;

      window.managementState.selectedTable = tableName;
      window.managementState.originalPlayers = JSON.parse(JSON.stringify(
        window.state.playerDataByTable[tableName] || []
      ));
      window.managementState.currentPlayers = JSON.parse(JSON.stringify(
        window.managementState.originalPlayers
      ));
      window.managementState.changes = { added: [], modified: [], deleted: [] };

      console.log('[DEBUG] managementState ì„¤ì •ë¨:', window.managementState);

      // UI ì—…ë°ì´íŠ¸ - í…Œì´ë¸” ì •ë³´ëŠ” í•­ìƒ í‘œì‹œ
      document.getElementById('selected-table-name').textContent = tableName;
      document.getElementById('player-add-section').classList.remove('hidden');
      document.getElementById('player-list-section').classList.remove('hidden');
      document.getElementById('batch-actions').classList.remove('hidden');

      // í”Œë ˆì´ì–´ ëª©ë¡ ë Œë”ë§
      renderManagementPlayersList();
      updateChangesSummary();
    }


    // ë¡œì»¬ í”Œë ˆì´ì–´ ëª©ë¡ ë Œë”ë§ - 10ê°œ ì‹œíŠ¸ ê³ ì • ë°©ì‹
    function renderManagementPlayersList() {
      console.log('[DEBUG] renderManagementPlayersList í˜¸ì¶œë¨');
      const listContainer = document.getElementById('current-players-list');
      const countDisplay = document.getElementById('player-count');

      if (!listContainer) {
        console.log('[DEBUG] listContainerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
        return;
      }

      const players = window.managementState.currentPlayers;
      console.log('[DEBUG] ë Œë”ë§í•  í”Œë ˆì´ì–´:', players);
      countDisplay.textContent = `${players.length}/10ëª…`;

      // 10ê°œ ì‹œíŠ¸ ë°°ì—´ ìƒì„± (1ë²ˆë¶€í„° 10ë²ˆê¹Œì§€)
      const seats = [];
      for (let i = 1; i <= 10; i++) {
        seats.push({
          seatNumber: i,
          player: players.find(p => parseInt(p.seat) === i) || null
        });
      }

      // 2ì—´ 5ê°œì”© ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ (ì»´íŒ©íŠ¸)
      listContainer.innerHTML = `
        <div class="grid grid-cols-2 gap-1">
          ${seats.map(({ seatNumber, player }) => {
            const index = player ? players.indexOf(player) : -1;
            const isModified = player && window.managementState.changes.modified.includes(player.name);
            const isAdded = player && window.managementState.changes.added.includes(player.name);
            const isEmpty = !player;

            return `
            <div class="seat-slot bg-gray-700 p-1 rounded ${
              isEmpty ? 'opacity-40' : ''
            } ${
              isAdded ? 'border border-green-500' : isModified ? 'border border-yellow-500' : 'border border-gray-600'
            }" data-seat="${seatNumber}">
              <div class="flex items-center justify-between h-9">
                <div class="flex items-center gap-1 flex-1">
                  <span class="text-sm font-bold text-gray-400 w-6 text-center">
                    ${seatNumber}
                  </span>
                  ${player ? `
                    <div class="flex-1">
                      <input type="text" class="bg-gray-800 px-1 py-0.5 rounded text-xs w-full player-name-input"
                             value="${player.name}"
                             data-index="${index}"
                             data-seat="${seatNumber}">
                    </div>
                  ` : `
                    <div class="flex-1">
                      <input type="text" class="bg-gray-800 px-1 py-0.5 rounded text-xs w-full empty-seat-input"
                             placeholder="ì´ë¦„ ì…ë ¥"
                             data-seat="${seatNumber}">
                    </div>
                  `}
                </div>
                <div class="flex items-center gap-1">
                  ${player ? `
                    <input type="text" class="bg-gray-800 px-1 py-0.5 rounded text-xs w-16 local-chips-input"
                           value="${formatNumber(player.chips || '0')}"
                           placeholder="ì¹©"
                           data-index="${index}">
                    <button class="text-red-400 hover:text-red-300 text-xs local-delete-btn px-1"
                            data-index="${index}"
                            onclick="deleteLocalPlayer(${index})">âœ•</button>
                  ` : `
                    <span class="text-gray-500 text-xs w-16 text-center">-</span>
                  `}
                </div>
              </div>
              ${player && (isAdded || isModified) ? `
                <div class="text-xs px-6">
                  ${isAdded ? '<span class="text-green-400 text-xs">âœ“</span>' : ''}
                  ${isModified ? '<span class="text-yellow-400 text-xs">âœ“</span>' : ''}
                </div>
              ` : ''}
            </div>
          `;
          }).join('')}
        </div>
      `;

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€

      // ë¹ˆ ìë¦¬ ì…ë ¥ ì²˜ë¦¬
      listContainer.querySelectorAll('.empty-seat-input').forEach(input => {
        input.addEventListener('change', (e) => {
          const seatNumber = parseInt(e.target.dataset.seat);
          const playerName = e.target.value.trim();

          if (playerName) {
            addPlayerToSeat(playerName, seatNumber);
            e.target.value = '';
          }
        });
      });

      // í”Œë ˆì´ì–´ ì´ë¦„ ìˆ˜ì •
      listContainer.querySelectorAll('.player-name-input').forEach(input => {
        input.addEventListener('change', (e) => {
          const index = parseInt(e.target.dataset.index);
          const newName = e.target.value.trim();

          if (index >= 0 && newName) {
            const player = window.managementState.currentPlayers[index];
            if (player && player.name !== newName) {
              player.name = newName;

              if (!window.managementState.changes.added.includes(player.name)) {
                if (!window.managementState.changes.modified.includes(player.name)) {
                  window.managementState.changes.modified.push(player.name);
                }
              }
              updateChangesSummary();
            }
          }
        });
      });

      // ì¹© ì…ë ¥ ì²˜ë¦¬
      listContainer.querySelectorAll('.local-chips-input').forEach(input => {
        input.addEventListener('input', (e) => {
          const index = parseInt(e.target.dataset.index);
          const newChips = unformatNumber(e.target.value);
          e.target.value = formatNumber(newChips);
          updateLocalPlayerChips(index, newChips);
        });
      });

      // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ëŠ” ì¸ë¼ì¸ onclickìœ¼ë¡œ ì²˜ë¦¬ë¨
      console.log('[DEBUG] ì‚­ì œ ë²„íŠ¼ ê°œìˆ˜:', listContainer.querySelectorAll('.local-delete-btn').length);
    }

    // íŠ¹ì • ì‹œíŠ¸ì— í”Œë ˆì´ì–´ ì¶”ê°€
    function addPlayerToSeat(name, seatNumber) {
      if (!name) return;

      // ì¤‘ë³µ ì²´í¬
      if (window.managementState.currentPlayers.some(p => p.name === name)) {
        showFeedback(`${name}ì€(ëŠ”) ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤`, true);
        return;
      }

      // ì¢Œì„ ì¤‘ë³µ ì²´í¬
      if (window.managementState.currentPlayers.some(p => parseInt(p.seat) === seatNumber)) {
        showFeedback(`ì¢Œì„ ${seatNumber}ë²ˆì€ ì´ë¯¸ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤`, true);
        return;
      }

      // í”Œë ˆì´ì–´ ìˆ˜ ì œí•œ (10ëª…)
      if (window.managementState.currentPlayers.length >= 10) {
        showFeedback('ìµœëŒ€ 10ëª…ê¹Œì§€ë§Œ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤', true);
        return;
      }

      // ì¶”ê°€
      const newPlayer = {
        name: name,
        seat: String(seatNumber),
        chips: '100000', // ê¸°ë³¸ ì¹©
        table: window.managementState.selectedTable,
        notable: false,
        status: 'IN'
      };

      window.managementState.currentPlayers.push(newPlayer);
      window.managementState.changes.added.push(name);

      renderManagementPlayersList();
      updateChangesSummary();
      showFeedback(`${name} ì¢Œì„ ${seatNumber}ë²ˆì— ì¶”ê°€ë¨`);
    }

    // ê¸°ì¡´ í”Œë ˆì´ì–´ ì¶”ê°€ UI ìˆ¨ê¸°ê¸° (10ê°œ ì‹œíŠ¸ì—ì„œ ì§ì ‘ ì…ë ¥í•˜ë¯€ë¡œ)
    const addPlayerBtn = document.getElementById('add-player-local-btn');
    if (addPlayerBtn) {
      addPlayerBtn.style.display = 'none';
    }
    const addSection = document.getElementById('player-add-section');
    if (addSection) {
      addSection.style.display = 'none';
    }

    // ë¡œì»¬ í”Œë ˆì´ì–´ ì¢Œì„ ì—…ë°ì´íŠ¸
    function updateLocalPlayerSeat(index, newSeat) {
      const player = window.managementState.currentPlayers[index];
      if (!player) return;

      // ì¢Œì„ ì¤‘ë³µ ì²´í¬
      if (newSeat && window.managementState.currentPlayers.some((p, i) => i !== index && p.seat === newSeat)) {
        showFeedback(`ì¢Œì„ ${newSeat}ë²ˆì€ ì´ë¯¸ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤`, true);
        renderManagementPlayersList();
        return;
      }

      player.seat = newSeat;

      // ë³€ê²½ ì‚¬í•­ ì¶”ì 
      if (!window.managementState.changes.added.includes(player.name)) {
        if (!window.managementState.changes.modified.includes(player.name)) {
          window.managementState.changes.modified.push(player.name);
        }
      }

      updateChangesSummary();
    }

    // ë¡œì»¬ í”Œë ˆì´ì–´ ì¹© ì—…ë°ì´íŠ¸
    function updateLocalPlayerChips(index, newChips) {
      const player = window.managementState.currentPlayers[index];
      if (!player) return;

      player.chips = newChips;

      // ë³€ê²½ ì‚¬í•­ ì¶”ì 
      if (!window.managementState.changes.added.includes(player.name)) {
        if (!window.managementState.changes.modified.includes(player.name)) {
          window.managementState.changes.modified.push(player.name);
        }
      }

      updateChangesSummary();
    }

    // ë¡œì»¬ í”Œë ˆì´ì–´ ì‚­ì œ - ì „ì—­ ìŠ¤ì½”í”„ë¡œ ë…¸ì¶œ (ì„œë²„ í†µì‹  ì—†ìŒ)
    window.deleteLocalPlayer = function(index) {
      const player = window.managementState.currentPlayers[index];
      if (!player) {
        console.log('[v3.3.1] ì‚­ì œí•  í”Œë ˆì´ì–´ ì—†ìŒ:', index);
        return;
      }

      console.log('[v3.3.1] í”Œë ˆì´ì–´ ì‚­ì œ:', player.name, 'index:', index);

      // ActionHistoryë¥¼ ì‚¬ìš©í•œ ì¦‰ì‹œ ì‚­ì œ
      const originalIndex = index;
      const originalPlayer = { ...player };
      const originalName = player.name;  // ì´ë¦„ ë³„ë„ ì €ì¥

      // ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸
      window.managementState.currentPlayers.splice(index, 1);

      // ë³€ê²½ ì‚¬í•­ ì¶”ì 
      if (window.managementState.changes.added.includes(originalName)) {
        // ìƒˆë¡œ ì¶”ê°€í•œ í•­ëª©ì´ë©´ addedì—ì„œ ì œê±°
        window.managementState.changes.added = window.managementState.changes.added.filter(n => n !== originalName);
      } else {
        // ê¸°ì¡´ í•­ëª©ì´ë©´ deletedì— ì¶”ê°€
        if (!window.managementState.changes.deleted.includes(originalName)) {
          window.managementState.changes.deleted.push(originalName);
        }
        // modifiedì—ì„œ ì œê±°
        window.managementState.changes.modified = window.managementState.changes.modified.filter(n => n !== originalName);
      }

      console.log('[v3.3.1] ì‚­ì œ í›„ changes:', window.managementState.changes);

      renderManagementPlayersList();
      updateChangesSummary();

      // ìŠ¤ë‚µë°” í‘œì‹œ (ì‹¤í–‰ì·¨ì†Œ ê°€ëŠ¥)
      if (window.actionHistory) {
        window.actionHistory.showSnackbar(`${player.name} ì‚­ì œë¨ (ë¡œì»¬)`, () => {
          // ì‹¤í–‰ ì·¨ì†Œ ë¡œì§
          window.managementState.currentPlayers.splice(originalIndex, 0, originalPlayer);

          // ë³€ê²½ ì‚¬í•­ ë³µêµ¬
          if (window.managementState.changes.deleted.includes(originalPlayer.name)) {
            window.managementState.changes.deleted = window.managementState.changes.deleted.filter(n => n !== originalPlayer.name);
          }

          renderManagementPlayersList();
          updateChangesSummary();
        });
      } else {
        showFeedback(`${player.name} ì‚­ì œë¨ (ë¯¸ë“±ë¡)`);
      }
    }

    // ë³€ê²½ ì‚¬í•­ ìš”ì•½ ì—…ë°ì´íŠ¸
    function updateChangesSummary() {
      const summary = document.getElementById('changes-summary');
      const { added, modified, deleted } = window.managementState.changes;

      const parts = [];
      if (added.length > 0) parts.push(`ì¶”ê°€: ${added.length}ëª…`);
      if (modified.length > 0) parts.push(`ìˆ˜ì •: ${modified.length}ëª…`);
      if (deleted.length > 0) parts.push(`ì‚­ì œ: ${deleted.length}ëª…`);

      if (parts.length > 0) {
        summary.innerHTML = `<span class="text-yellow-400">âš ï¸ ë¯¸ë“±ë¡ ë³€ê²½ì‚¬í•­:</span> ${parts.join(', ')}<br>
        <span class="text-xs text-gray-500">ì¼ê´„ ë“±ë¡ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì„œë²„ì— ì €ì¥í•˜ì„¸ìš”</span>`;
        summary.classList.remove('text-gray-400');
        summary.classList.add('text-amber-300');
      } else {
        summary.textContent = 'ë³€ê²½ ì‚¬í•­ ì—†ìŒ';
        summary.classList.remove('text-amber-300');
        summary.classList.add('text-gray-400');
      }
    }

    // ë³€ê²½ ì‚¬í•­ ì´ˆê¸°í™”
    document.getElementById('reset-changes-btn')?.addEventListener('click', () => {
      // ë°±ì—… ë°ì´í„° ìƒì„± (ì‹¤í–‰ì·¨ì†Œìš©)
      const backup = {
        players: JSON.parse(JSON.stringify(window.managementState.currentPlayers)),
        changes: JSON.parse(JSON.stringify(window.managementState.changes))
      };

      // ì›ë³¸ ë°ì´í„°ë¡œ ë³µì›
      window.managementState.currentPlayers = JSON.parse(JSON.stringify(
        window.managementState.originalPlayers
      ));
      window.managementState.changes = { added: [], modified: [], deleted: [] };

      renderManagementPlayersList();
      updateChangesSummary();

      // ìŠ¤ë‚µë°” í‘œì‹œ (ì‹¤í–‰ì·¨ì†Œ ê°€ëŠ¥)
      if (window.actionHistory) {
        window.actionHistory.showSnackbar('ë³€ê²½ ì‚¬í•­ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤', () => {
          // ì‹¤í–‰ ì·¨ì†Œ - ì´ì „ ìƒíƒœë¡œ ë³µêµ¬
          window.managementState.currentPlayers = backup.players;
          window.managementState.changes = backup.changes;
          renderManagementPlayersList();
          updateChangesSummary();
        });
      } else {
        showFeedback('ë³€ê²½ ì‚¬í•­ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    });

    // ì¼ê´„ ë“±ë¡
    document.getElementById('batch-register-btn')?.addEventListener('click', async () => {
      const { added, modified, deleted } = window.managementState.changes;

      if (added.length === 0 && modified.length === 0 && deleted.length === 0) {
        if (window.actionHistory) {
          window.actionHistory.showSnackbar('ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤', null, 'warning');
        } else {
          showFeedback('ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤', true);
        }
        return;
      }

      // ë³€ê²½ì‚¬í•­ ë©”ì‹œì§€ í‘œì‹œ
      const changeMessage = `ì¶”ê°€: ${added.length}ëª…, ìˆ˜ì •: ${modified.length}ëª…, ì‚­ì œ: ${deleted.length}ëª…`;
      if (window.actionHistory) {
        window.actionHistory.showSnackbar(`ë“±ë¡ ì¤‘... ${changeMessage}`, null, 'info');
      }

      const syncStatus = document.getElementById('sync-status');
      syncStatus.textContent = 'ë™ê¸°í™” ì¤‘...';
      syncStatus.className = 'text-xs text-yellow-400';

      await executeWithLock(async () => {

      try {
        console.log('[v3.3.1] === ì¼ê´„ ë“±ë¡ ì‹œì‘ ===');
        console.log('[v3.3.1] ì„ íƒëœ í…Œì´ë¸”:', window.managementState.selectedTable);
        console.log('[v3.3.1] í˜„ì¬ í”Œë ˆì´ì–´ ìˆ˜:', window.managementState.currentPlayers.length);
        console.log('[v3.3.1] ì¶”ê°€ë  í”Œë ˆì´ì–´:', added);
        console.log('[v3.3.1] ìˆ˜ì •ë  í”Œë ˆì´ì–´:', modified);
        console.log('[v3.3.1] ì‚­ì œë  í”Œë ˆì´ì–´:', deleted);
        console.log('[v3.3.1] Apps Script URL:', APPS_SCRIPT_URL);

        // ì‚­ì œ ëŒ€ìƒ í”Œë ˆì´ì–´ ìƒì„¸ ì •ë³´ í™•ì¸
        console.log('[v3.3.1] === ì‚­ì œ ëŒ€ìƒ ìƒì„¸ ì •ë³´ ===');
        deleted.forEach((playerName, index) => {
          console.log(`[v3.3.1] ì‚­ì œ[${index}]: "${playerName}" (ê¸¸ì´: ${playerName.length})`);
        });

        // ì¼ê´„ ì²˜ë¦¬ ìš”ì²­
        const formData = new FormData();
        formData.append('action', 'batchUpdate');
        formData.append('table', window.managementState.selectedTable);
        formData.append('players', JSON.stringify(window.managementState.currentPlayers));
        formData.append('deleted', JSON.stringify(deleted));

        console.log('[v3.3.1] FormData ìƒì„± ì™„ë£Œ');
        console.log('[v3.3.1] ì „ì†¡í•  í”Œë ˆì´ì–´ ë°ì´í„°:', JSON.stringify(window.managementState.currentPlayers, null, 2));
        console.log('[v3.3.1] ì‚­ì œí•  í”Œë ˆì´ì–´ ì´ë¦„ë“¤:', JSON.stringify(deleted, null, 2));

        // FormData ë‚´ìš© í™•ì¸
        console.log('[v3.3.1] === FormData ë‚´ìš© í™•ì¸ ===');
        for (let [key, value] of formData.entries()) {
          console.log(`[v3.3.1] FormData[${key}]:`, typeof value === 'string' ? value.substring(0, 200) + '...' : value);
        }

        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          body: formData
        });

        console.log('[v3.3.1] ì‘ë‹µ ìˆ˜ì‹ :', response.status, response.statusText);

        if (!response.ok) {
          console.log(`HTTP ${response.status}: ${response.statusText}`);
          showFeedback('ì„œë²„ í†µì‹  ì˜¤ë¥˜', true);
          return;
        }

        const result = await response.json();
        console.log('[v3.3.1] ì‘ë‹µ ë°ì´í„°:', result);

        if (result.success) {
          console.log('[v3.3.1] ì¼ê´„ ë“±ë¡ ì„±ê³µ:', result);
          syncStatus.textContent = 'âœ… ë™ê¸°í™” ì™„ë£Œ';
          syncStatus.className = 'text-xs text-green-400';

          // ìŠ¤ë‚µë°”ë¡œ ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ (ì •ë ¬ í¬í•¨)
          if (window.actionHistory) {
            window.actionHistory.showSnackbar('âœ… ëª¨ë“  ë³€ê²½ ì‚¬í•­ì´ ë“±ë¡ë˜ê³  ì‹œíŠ¸ê°€ ì •ë ¬ë˜ì—ˆìŠµë‹ˆë‹¤', null, 'success');
          } else {
            showFeedback('âœ… ëª¨ë“  ë³€ê²½ ì‚¬í•­ì´ ë“±ë¡ë˜ê³  ì‹œíŠ¸ê°€ ì •ë ¬ë˜ì—ˆìŠµë‹ˆë‹¤');
          }

          // ë°ì´í„° ìƒˆë¡œê³ ì¹¨ - CSV ë°©ì‹ ì‚¬ìš©
          try {
            console.log('[v3.3.1] ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹œì‘...');
            console.log('[v3.3.1] CSV_TYPE_URL:', CSV_TYPE_URL);

            const csv = await fetch(CSV_TYPE_URL).then(r => {
              console.log('[v3.3.1] CSV ì‘ë‹µ ìƒíƒœ:', r.status, r.statusText);
              return r.text();
            });

            console.log('[v3.3.1] CSV ë°ì´í„° ê¸¸ì´:', csv.length);
            console.log('[v3.3.1] CSV ì²« 100ì:', csv.substring(0, 100));

            const rows = parseCSV(csv);
            console.log('[v3.3.1] íŒŒì‹±ëœ í–‰ ìˆ˜:', rows.length);

            buildTypeFromCsv(rows);
            console.log('[v3.3.1] Type ë°ì´í„° ë¹Œë“œ ì™„ë£Œ');
            console.log('[v3.3.1] ì—…ë°ì´íŠ¸ëœ í…Œì´ë¸”:', Object.keys(window.state.playerDataByTable));
          } catch (refreshError) {
            console.error('[v3.3.1] ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', refreshError);
            showFeedback('âš ï¸ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨, í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”', true);
          }

          // ìƒíƒœ ë¦¬ì…‹
          try {
            console.log('[v3.3.1] ìƒíƒœ ë¦¬ì…‹ ì‹œì‘...');
            console.log('[v3.3.1] ì„ íƒëœ í…Œì´ë¸”:', window.managementState.selectedTable);

            const refreshedPlayers = window.state.playerDataByTable[window.managementState.selectedTable] || [];
            console.log('[v3.3.1] ìƒˆë¡œê³ ì¹¨ëœ í”Œë ˆì´ì–´ ìˆ˜:', refreshedPlayers.length);

            window.managementState.originalPlayers = JSON.parse(JSON.stringify(refreshedPlayers));
            window.managementState.currentPlayers = JSON.parse(JSON.stringify(refreshedPlayers));
            window.managementState.changes = { added: [], modified: [], deleted: [] };

            console.log('[v3.3.1] ìƒíƒœ ë¦¬ì…‹ ì™„ë£Œ');
          } catch (resetError) {
            console.error('[v3.3.1] ìƒíƒœ ë¦¬ì…‹ ì‹¤íŒ¨:', resetError);
          }

          try {
            console.log('[v3.3.1] UI ì—…ë°ì´íŠ¸ ì‹œì‘...');
            renderManagementPlayersList();
            updateChangesSummary();
            renderPlayerSelection(); // ë©”ì¸ í™”ë©´ ì—…ë°ì´íŠ¸

            // ì „ì²´ UI ìƒˆë¡œê³ ì¹¨ (ì¦‰ì‹œ ë°˜ì˜ì„ ìœ„í•´)
            if (typeof renderAll === 'function') {
              renderAll();
              console.log('[v3.3.1] ì „ì²´ UI ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
            }

            // í”Œë ˆì´ì–´ ë°ì´í„° ë‹¤ì‹œ ë Œë”ë§
            if (typeof updatePlayersDisplay === 'function') {
              updatePlayersDisplay();
              console.log('[v3.3.1] í”Œë ˆì´ì–´ ë””ìŠ¤í”Œë ˆì´ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
            }

            console.log('[v3.3.1] UI ì—…ë°ì´íŠ¸ ì™„ë£Œ - ëª¨ë“  ë³€ê²½ì‚¬í•­ì´ ì¦‰ì‹œ ì ìš©ë¨');
          } catch (uiError) {
            console.error('[v3.3.1] UI ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', uiError);
          }

          // ëª¨ë‹¬ ìë™ ë‹«ê¸° ë° ëŒ€ì‹œë³´ë“œ ë¦¬ë‹¤ì´ë ‰íŠ¸
          if (typeof autoCloseManagementModal === 'function') {
            console.log('[v3.3.1] ëª¨ë‹¬ ìë™ ë‹«ê¸° ì‹¤í–‰...');
            autoCloseManagementModal();
          } else {
            // í´ë°±: ìˆ˜ë™ìœ¼ë¡œ ëª¨ë‹¬ ë‹«ê¸°
            setTimeout(() => {
              const modal = document.getElementById('management-modal');
              if (modal) {
                modal.classList.add('hidden', 'opacity-0');
                console.log('[v3.3.1] ëª¨ë‹¬ ìˆ˜ë™ ë‹«ê¸° ì™„ë£Œ');
              }
            }, 2000);
          }
        } else {
          // ì˜¤ë¥˜ ì²˜ë¦¬
          syncStatus.textContent = 'âŒ ë™ê¸°í™” ì‹¤íŒ¨';
          syncStatus.className = 'text-xs text-red-400';

          const errorMessage = result.message && result.message.includes('Unknown action')
            ? 'Apps Script ì¬ë°°í¬ê°€ í•„ìš”í•©ë‹ˆë‹¤'
            : result.message || 'ë“±ë¡ ì‹¤íŒ¨';

          // ìŠ¤ë‚µë°”ë¡œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
          if (window.actionHistory) {
            window.actionHistory.showSnackbar(errorMessage, null, 'error');
          } else {
            showFeedback(errorMessage, true);
          }

          // UI í™œì„±í™”
          if (typeof enableModalUI === 'function') {
            enableModalUI();
          }
        }
      } catch(err) {
        console.error('[v3.3.1] === ì¼ê´„ ë“±ë¡ ì˜¤ë¥˜ ===');
        console.error('[v3.3.1] ì˜¤ë¥˜ íƒ€ì…:', err.constructor.name);
        console.error('[v3.3.1] ì˜¤ë¥˜ ë©”ì‹œì§€:', err.message);
        console.error('[v3.3.1] ì˜¤ë¥˜ ìŠ¤íƒ:', err.stack);
        console.error('[v3.3.1] ì „ì²´ ì˜¤ë¥˜ ê°ì²´:', err);

        syncStatus.textContent = 'âŒ ë™ê¸°í™” ì‹¤íŒ¨';
        syncStatus.className = 'text-xs text-red-400';

        // ìƒì„¸í•œ ì—ëŸ¬ ë¶„ì„
        let errorMessage = err.message;
        let debugInfo = '';

        if (err.message.includes('loadTypeSheet is not defined')) {
          errorMessage = 'ë°ì´í„° ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜ ì˜¤ë¥˜ (ì´ë¯¸ ìˆ˜ì •ë¨)';
          debugInfo = 'í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”';
        } else if (err.message.includes('Apps Script ì¬ë°°í¬')) {
          errorMessage = 'âš ï¸ Apps Script ì¬ë°°í¬ í•„ìš” (ê´€ë¦¬ ë©”ë‰´ ì°¸ì¡°)';
        } else if (err.message.includes('NetworkError') || err.message.includes('fetch')) {
          errorMessage = 'ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì˜¤ë¥˜';
          debugInfo = 'Apps Script URLì„ í™•ì¸í•˜ê³  ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”';
        } else if (err.message.includes('JSON')) {
          errorMessage = 'Apps Script ì‘ë‹µ íŒŒì‹± ì˜¤ë¥˜';
          debugInfo = 'Apps Scriptê°€ ì˜¬ë°”ë¥¸ JSONì„ ë°˜í™˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤';
        }

        console.error('[v3.3.1] ë¶„ì„ëœ ì˜¤ë¥˜:', errorMessage);
        console.error('[v3.3.1] ë””ë²„ê·¸ ì •ë³´:', debugInfo);

        showFeedback(`âŒ ${errorMessage}${debugInfo ? ` (${debugInfo})` : ''}`, true);

        // UI í™œì„±í™”
        if (typeof enableModalUI === 'function') {
          enableModalUI();
        }
      } finally {
        console.log('[v3.3.1] === ì¼ê´„ ë“±ë¡ ì¢…ë£Œ ===');
      }
    }, 'í”Œë ˆì´ì–´ ë“±ë¡', 'í”Œë ˆì´ì–´ ì •ë³´ë¥¼ ì„œë²„ì— ì €ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
    });

    // ê¸°ì¡´ í”Œë ˆì´ì–´ ëª©ë¡ ë¡œë“œ í•¨ìˆ˜ (êµ¬ë²„ì „ í˜¸í™˜ìš©)
    function loadPlayersList() {
      const listContainer = document.getElementById('current-players-list');
      if (!listContainer) return;

      const table = window.state.selectedTable;
      if (!table) {
        listContainer.innerHTML = '<p class="text-gray-400 text-xs">í…Œì´ë¸”ì„ ì„ íƒí•˜ë©´ í”Œë ˆì´ì–´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>';
        return;
      }

      const players = window.state.playerDataByTable[table] || [];
      if (players.length === 0) {
        listContainer.innerHTML = '<p class="text-gray-400 text-xs">í”Œë ˆì´ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      listContainer.innerHTML = players.map(player => `
        <div class="flex items-center justify-between bg-gray-600 p-2 rounded player-list-item" data-player="${player.name}">
          <div class="flex-1">
            <span class="font-medium">${player.name}</span>
            ${player.seat ? `<span class="text-xs text-gray-400 ml-2">ì¢Œì„ ${player.seat}</span>` : ''}
          </div>
          <div class="flex items-center gap-2">
            <input type="number" class="bg-gray-700 px-2 py-1 rounded text-sm w-16 seat-input"
                   value="${player.seat || ''}" placeholder="ì¢Œì„" min="1" max="10"
                   data-player="${player.name}">
            <input type="text" class="bg-gray-700 px-2 py-1 rounded text-sm w-20 chips-input"
                   value="${formatNumber(player.chips || '0')}" placeholder="ì¹©"
                   data-player="${player.name}">
            <button class="text-red-500 hover:text-red-400 delete-player-btn" data-player="${player.name}">ğŸ—‘ï¸</button>
          </div>
        </div>
      `).join('');

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      listContainer.querySelectorAll('.seat-input').forEach(input => {
        input.addEventListener('change', (e) => {
          const playerName = e.target.dataset.player;
          const newSeat = e.target.value;
          updatePlayerSeat(playerName, newSeat);
        });
      });

      listContainer.querySelectorAll('.chips-input').forEach(input => {
        input.addEventListener('input', (e) => {
          const playerName = e.target.dataset.player;
          const newChips = unformatNumber(e.target.value);
          e.target.value = formatNumber(newChips);
          updatePlayerChips(playerName, newChips);
        });
      });

      // êµ¬ë²„ì „ ì‚­ì œ ë²„íŠ¼ - ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
      /*
      listContainer.querySelectorAll('.delete-player-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const playerName = e.target.dataset.player;
          // confirm ì œê±°, ì¦‰ì‹œ ì‚­ì œ ì‹¤í–‰
          deletePlayer(playerName);
        });
      });
      */
    }

    // í”Œë ˆì´ì–´ ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('add-player-btn')?.addEventListener('click', () => {
      const nameInput = document.getElementById('new-player-name');
      const seatInput = document.getElementById('new-player-seat');
      const chipsInput = document.getElementById('new-player-chips');

      const name = nameInput.value.trim();
      const seat = seatInput.value;
      const chips = unformatNumber(chipsInput.value) || '0';

      if (!name) {
        showFeedback('í”Œë ˆì´ì–´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', true);
        return;
      }

      if (!window.state.selectedTable) {
        showFeedback('ë¨¼ì € í…Œì´ë¸”ì„ ì„ íƒí•˜ì„¸ìš”', true);
        return;
      }

      addNewPlayer(name, seat, chips);

      // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
      nameInput.value = '';
      seatInput.value = '';
      chipsInput.value = '';
    });


    // í”Œë ˆì´ì–´ ì¶”ê°€ í•¨ìˆ˜ - ì¤‘ë³µ ì²´í¬ ê°•í™”
    async function addNewPlayer(name, seat, chips) {
      try {
        // í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ë¨¼ì € ì¤‘ë³µ ì²´í¬
        const existingPlayer = window.state.playersByTable[window.state.selectedTable]?.find(p =>
          p.name === name && p.status === 'IN'
        );

        if (existingPlayer) {
          showFeedback(`âŒ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í”Œë ˆì´ì–´ì…ë‹ˆë‹¤: ${name}`, true);
          return;
        }

        const formData = new FormData();
        formData.append('action', 'addPlayer');
        formData.append('table', window.state.selectedTable);
        formData.append('player', name);
        formData.append('seat', seat || '');
        formData.append('chips', chips);
        formData.append('status', 'IN');

        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          body: formData
        });

        const result = await response.json();
        if (result.success) {
          console.log('[v3.3.1] í”Œë ˆì´ì–´ ì¶”ê°€ ì„±ê³µ:', result);
          showFeedback(`âœ… ${name} ì¶”ê°€ë¨`);

          // ë°ì´í„° ìƒˆë¡œê³ ì¹¨ - CSV ë°©ì‹ ì‚¬ìš©
          try {
            console.log('[v3.3.1] í”Œë ˆì´ì–´ ì¶”ê°€ í›„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨...');
            const csv = await fetch(CSV_TYPE_URL).then(r => r.text());
            const rows = parseCSV(csv);
            buildTypeFromCsv(rows);
            console.log('[v3.3.1] í”Œë ˆì´ì–´ ì¶”ê°€ í›„ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
          } catch (refreshError) {
            console.error('[v3.3.1] í”Œë ˆì´ì–´ ì¶”ê°€ í›„ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', refreshError);
          }

          loadPlayersList();
          renderPlayerSelection();
        } else {
          console.error('[v3.3.1] í”Œë ˆì´ì–´ ì¶”ê°€ ì‹¤íŒ¨:', result);
          showFeedback(`âŒ ì¶”ê°€ ì‹¤íŒ¨: ${result.error}`, true);
        }
      } catch(err) {
        console.error('í”Œë ˆì´ì–´ ì¶”ê°€ ì˜¤ë¥˜:', err);
        showFeedback('í”Œë ˆì´ì–´ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', true);
      }
    }

    // í”Œë ˆì´ì–´ ì¢Œì„ ì—…ë°ì´íŠ¸
    async function updatePlayerSeat(playerName, newSeat) {
      try {
        const formData = new FormData();
        formData.append('action', 'updateSeat');
        formData.append('table', window.state.selectedTable);
        formData.append('player', playerName);
        formData.append('seat', newSeat || '');

        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          body: formData
        });

        const result = await response.json();
        if (result.success) {
          showFeedback(`âœ… ${playerName} ì¢Œì„ ${newSeat}ìœ¼ë¡œ ë³€ê²½`);
          // ë©”ëª¨ë¦¬ ì—…ë°ì´íŠ¸
          const player = window.state.playerDataByTable[window.state.selectedTable]?.find(p => p.name === playerName);
          if (player) player.seat = newSeat;
          renderPlayerSelection();
        } else {
          showFeedback(`âŒ ì¢Œì„ ë³€ê²½ ì‹¤íŒ¨: ${result.error}`, true);
        }
      } catch(err) {
        console.error('ì¢Œì„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', err);
        showFeedback('ì¢Œì„ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', true);
      }
    }

    // í”Œë ˆì´ì–´ ì¹© ì—…ë°ì´íŠ¸
    async function updatePlayerChips(playerName, newChips) {
      try {
        const formData = new FormData();
        formData.append('action', 'updateChips');
        formData.append('table', window.state.selectedTable);
        formData.append('player', playerName);
        formData.append('chips', newChips);

        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          body: formData
        });

        const result = await response.json();
        if (result.success) {
          // ë©”ëª¨ë¦¬ ì—…ë°ì´íŠ¸
          const player = window.state.playerDataByTable[window.state.selectedTable]?.find(p => p.name === playerName);
          if (player) player.chips = newChips;
        }
      } catch(err) {
        console.error('ì¹© ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', err);
      }
    }

    // í”Œë ˆì´ì–´ ì‚­ì œ (êµ¬ë²„ì „ - ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
    // ìƒˆë¡œìš´ ê´€ë¦¬ ì‹œìŠ¤í…œì—ì„œëŠ” deleteLocalPlayerë¥¼ ì‚¬ìš©í•˜ê³ 
    // ì„œë²„ ë™ê¸°í™”ëŠ” ì¼ê´„ ë“±ë¡ ì‹œì—ë§Œ ì²˜ë¦¬
    /*
    async function deletePlayer(playerName) {
      try {
        const formData = new FormData();
        formData.append('action', 'deletePlayer');
        formData.append('table', window.state.selectedTable);
        formData.append('player', playerName);

        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          body: formData
        });

        const result = await response.json();
        if (result.success) {
          showFeedback(`âœ… ${playerName} ì‚­ì œë¨`);
          // ë©”ëª¨ë¦¬ì—ì„œ ì œê±°
          const players = window.state.playerDataByTable[window.state.selectedTable];
          if (players) {
            const index = players.findIndex(p => p.name === playerName);
            if (index !== -1) players.splice(index, 1);
          }
          loadPlayersList();
          renderPlayerSelection();
        } else {
          showFeedback(`âŒ ì‚­ì œ ì‹¤íŒ¨: ${result.error}`, true);
        }
      } catch(err) {
        console.error('í”Œë ˆì´ì–´ ì‚­ì œ ì˜¤ë¥˜:', err);
        showFeedback('í”Œë ˆì´ì–´ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', true);
      }
    }
    */
    
    // ========================================
    // ì„¤ì • ëª¨ë‹¬ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    // ========================================
    
    // ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
    if (el.settingsBtn) {
      el.settingsBtn.addEventListener('click', () => {
        // í˜„ì¬ URL í‘œì‹œ
        el.currentAppsUrl.textContent = APPS_SCRIPT_URL;
        el.appsScriptUrlInput.value = APPS_SCRIPT_URL;
        
        // ì¹© ê²€ì¦ ì„¤ì • ë¡œë“œ
        const chipValidation = localStorage.getItem('chipValidation') !== 'false';
        el.chipValidationToggle.checked = chipValidation;
        
        // ì•¡ì…˜ ì…ë ¥ ëª¨ë“œ ì„¤ì • ë¡œë“œ
        const actionInputMode = localStorage.getItem('actionInputMode') === 'auto';
        const actionInputToggle = document.getElementById('action-input-mode-toggle');
        if (actionInputToggle) {
          actionInputToggle.checked = actionInputMode;
        }
        
        // í´ë¼ìš°ë“œ ë™ê¸°í™” UI ì—…ë°ì´íŠ¸
        updateCloudSyncUI();

        // ë²„ì „ ì •ë³´ ì—…ë°ì´íŠ¸
        const versionInfo = el.settingsModal.querySelector('.text-gray-400');
        if (versionInfo) {
          el.settingsModal.querySelectorAll('.text-gray-400').forEach((elem, idx) => {
            if (idx === 0) elem.textContent = APP_VERSION;
            if (idx === 1) elem.textContent = VERSION_DATE;
          });
        }
        
        // ëª¨ë‹¬ ì—´ê¸°
        el.settingsModal.classList.remove('hidden');
      });
    }
    
    // ì„¤ì • ëª¨ë‹¬ ë‹«ê¸°
    const closeSettings = () => {
      el.settingsModal.classList.add('hidden');
    };
    
    if (el.closeSettingsBtn) {
      el.closeSettingsBtn.addEventListener('click', closeSettings);
    }
    
    if (el.cancelSettingsBtn) {
      el.cancelSettingsBtn.addEventListener('click', closeSettings);
    }
    
    // ì„¤ì • ì €ì¥
    if (el.saveSettingsBtn) {
      el.saveSettingsBtn.addEventListener('click', () => {
        // Apps Script URL ì €ì¥
        const newUrl = el.appsScriptUrlInput.value.trim();
        if (newUrl && newUrl !== APPS_SCRIPT_URL) {
          if (updateAppsScriptUrl(newUrl)) {
            console.log('âœ… Apps Script URL ì—…ë°ì´íŠ¸ ì™„ë£Œ');
          }
        }
        
        // ì¹© ê²€ì¦ ì„¤ì • ì €ì¥
        const chipValidation = el.chipValidationToggle.checked;
        localStorage.setItem('chipValidation', chipValidation.toString());
        window.state.chipValidation = chipValidation;
        console.log(`âœ… ì¹© ê²€ì¦ ì„¤ì •: ${chipValidation ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}`);
        
        // ì•¡ì…˜ ì…ë ¥ ëª¨ë“œ ì„¤ì • ì €ì¥
        const actionInputToggle = document.getElementById('action-input-mode-toggle');
        if (actionInputToggle) {
          const actionInputMode = actionInputToggle.checked ? 'auto' : 'manual';
          localStorage.setItem('actionInputMode', actionInputMode);
          window.state.actionInputMode = actionInputMode;
          console.log(`âœ… ì•¡ì…˜ ì…ë ¥ ëª¨ë“œ: ${actionInputMode === 'auto' ? 'ìë™ ë§¤í•‘' : 'ìˆ˜ë™ ì„ íƒ'}`);
          
          // UI ì—…ë°ì´íŠ¸
          renderAll();
        }
        
        showFeedback('âœ… ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        closeSettings();
      });
    }

    // í´ë¼ìš°ë“œ ë™ê¸°í™” ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    if (el.syncNowBtn) {
      el.syncNowBtn.addEventListener('click', syncCloudNow);
    }

    if (el.resetCloudBtn) {
      el.resetCloudBtn.addEventListener('click', resetCloudConfig);
    }

    // ESC í‚¤ë¡œ ë‹«ê¸°
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !el.settingsModal.classList.contains('hidden')) {
        closeSettings();
      }
    });
    
    const closeBtn = document.getElementById('close-registration-modal');
    if (closeBtn) {
      closeBtn.addEventListener('click', closeRegistrationModal);
    }
    
    
    
    // ë²„íŠ¼ ìœ„ì¹˜ ì„ íƒ ì´ë²¤íŠ¸ - renderPlayerSelectionì—ì„œ ì²˜ë¦¬í•˜ë„ë¡ ì œê±°
    // (renderPlayerSelection í•¨ìˆ˜ ë‚´ì—ì„œ ì´ë¯¸ ì²˜ë¦¬ì¤‘)

    // ====== INIT ======
    async function initializeApp(){
      await executeWithLock(async () => {
        el.logDisplay.innerHTML='';
        openLogModal();
        logMessage(`ğŸ¯ ${VERSION_INFO}`);
        logMessage(`ğŸ“… ì´ˆê¸°í™” ì‹œì‘: ${new Date().toLocaleString('ko-KR')}`);
        populateTimezones(); loadActionState();
        try{
          await loadInitial();
          renderTableSelection();
          initializeSeatGrid();  // ì¢Œì„ ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
          if(timeUpdater) clearInterval(timeUpdater);
          timeUpdater = setInterval(updateTimeDisplay, 1000);
          updateTimeDisplay();
          logMessage(`âœ… ${APP_VERSION} ì¤€ë¹„ ì™„ë£Œ!`);

          // ì¤‘ë³µ ê²€ì‚¬ ì‹¤í–‰ (ì§ì ‘ í˜¸ì¶œë¡œ ì´ì¤‘ ì‹¤í–‰ ë°©ì§€)
          logMessage(`ğŸ” ì¤‘ë³µ í”Œë ˆì´ì–´ ê²€ì‚¬ ì‹œì‘...`);
          if (window.removeDuplicatePlayers && typeof window.removeDuplicatePlayers === 'function') {
            try {
              // skipModalOpen=trueë¡œ ëª¨ë‹¬ ì¤‘ë³µ ì—´ê¸° ë°©ì§€
              const result = await window.removeDuplicatePlayers(true);
              if (result.success) {
                if (result.removedCount > 0) {
                  logMessage(`âœ… ì¤‘ë³µ ì œê±° ì™„ë£Œ: ${result.removedCount}ëª… ì œê±°`);
                } else {
                  logMessage(`âœ… ì¤‘ë³µ ì—†ìŒ - ì‹œíŠ¸ê°€ ê¹¨ë—í•©ë‹ˆë‹¤`);
                }
              }
            } catch (duplicateError) {
              console.error('ì¤‘ë³µ ê²€ì‚¬ ì˜¤ë¥˜:', duplicateError);
              logMessage(`âš ï¸ ì¤‘ë³µ ê²€ì‚¬ ì‹¤íŒ¨: ${duplicateError.message}`, true);
            }
          }
        }catch(err){
          console.error(err); logMessage(`ì´ˆê¸°í™” ì‹¤íŒ¨: ${err.message}`, true);
        }finally{
          setTimeout(closeLogModal, 3000); // ì¤‘ë³µ ê²€ì‚¬ ì™„ë£Œ í›„ ë‹«ê¸° ìœ„í•´ ì‹œê°„ ì—°ì¥
        }
      }, 'ì•± ì´ˆê¸°í™”', 'ë°ì´í„°ë¥¼ ë¡œë“œí•˜ê³  ìˆìŠµë‹ˆë‹¤...');
    }

    setupEventListeners();
    initializeApp();
  });
  </script>

  <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-75 z-60 hidden flex items-center justify-center">
    <div class="bg-gray-800 rounded-lg p-6 max-w-sm w-full mx-4">
      <div class="flex items-center space-x-3">
        <div class="animate-spin h-5 w-5 border-2 border-amber-500 border-t-transparent rounded-full"></div>
        <div>
          <div id="loading-title" class="text-white font-medium">ì²˜ë¦¬ ì¤‘...</div>
          <div id="loading-message" class="text-gray-400 text-sm mt-1">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
        </div>
      </div>
      <div class="mt-4 text-xs text-gray-500">
        ì‘ì—…ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ë‹¤ë¥¸ ë²„íŠ¼ì„ í´ë¦­í•˜ì§€ ë§ˆì„¸ìš”
      </div>
    </div>
  </div>

  <!-- ìŠ¤ë‚µë°” ì»´í¬ë„ŒíŠ¸ -->
  <div id="snackbar" class="snackbar"></div>

  <!-- ì¤‘ë³µ í”Œë ˆì´ì–´ ì œê±° ëª¨ë“ˆ (ë§¤ ìƒˆë¡œê³ ì¹¨ë§ˆë‹¤ ìë™ ì‹¤í–‰) -->
  <script src="src/js/duplicate-remover.js?v=3.4.16"></script>
</body>
</html>
