<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <title>í¬ì»¤ í•¸ë“œ ë¡œê±° (CSV Read / Apps Script Write)</title>
  <script src="https://cdn-tailwindcss.vercel.app/"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@700&family=Noto+Sans+KR:wght@400;500;700&display=swap');
    html, body { height: 100vh; overflow: hidden; font-family: 'Noto Sans KR', sans-serif; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
    #app-container { display: flex; flex-direction: column; height: 100%; }
    main { flex-grow: 1; overflow-y: auto; }
    .btn { transition: all 0.1s ease-in-out; }
    .btn:active { transform: scale(0.95); }
    .btn-selected { background-color: #FBBF24 !important; color: #111827 !important; font-weight: bold; }
    .card-placeholder { border: 2px dashed #4B5563; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 1px; background-color: rgba(255,255,255,0.05); flex-shrink: 0; }
    .card-display { font-family: 'Roboto', sans-serif; background-color: white; border-radius: 4px; padding: 1px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 0.8rem; }
    .card-display .rank { font-weight: bold; font-size: 1rem; }
    .modal { transition: opacity 0.3s ease; backdrop-filter: blur(4px); }
    .card-selector-btn { font-family: 'Roboto', sans-serif; font-size: 1rem; font-weight: bold; }
    .card-selector-btn.card-red { color: #DC2626; }
    .card-selector-btn.card-black { color: #111827; }
    .card-selector-btn.selected { border: 3px solid #FBBF24; transform: scale(0.95); }
    .player-card.is-winner { background-color: rgba(251, 191, 36, 0.1); }
    select, input[type="text"] { font-size: 0.875rem; }
  </style>
</head>
<body class="bg-gray-900 text-white antialiased">
  <div id="app-container">
    <main class="p-2 space-y-2">
      <div class="bg-gray-800 p-2 rounded-lg space-y-2">
        <div class="flex items-center gap-2 text-sm">
          <div class="flex-1 flex items-center gap-1 bg-gray-700 p-1 rounded-md min-w-0">
            <span id="hand-number-display" class="font-bold px-1 whitespace-nowrap">#--</span>
            <button id="load-hand-btn" class="btn bg-gray-600 px-2 py-1 rounded-md text-xs">Load</button>
          </div>
          <div class="flex-1 min-w-0">
            <select id="table-selector" class="w-full bg-gray-700 border border-gray-600 rounded-md px-2 py-1"></select>
          </div>
          <div class="flex-1 flex items-center gap-1 min-w-0">
            <select id="timezone-selector" class="flex-grow bg-gray-700 border border-gray-600 rounded-md px-2 py-1 text-xs"></select>
            <span id="time-display" class="bg-gray-900/50 p-1 rounded-md font-mono text-xs"></span>
          </div>
          <div class="flex items-center gap-1">
            <button id="manage-players-btn" class="btn bg-gray-600 p-1 rounded-md text-xs">ê´€ë¦¬</button>
            <button id="refresh-data" class="text-lg" title="ë°ì´í„° ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div class="text-xs text-gray-300 flex items-center gap-2">
            <button id="cam-btn-1" class="btn bg-gray-700 px-2 py-1 rounded"></button>
            <button id="cam-btn-2" class="btn bg-gray-700 px-2 py-1 rounded"></button>
          </div>
          <div class="text-right text-xs text-gray-400">
            <span id="data-stamp"></span>
          </div>
        </div>
        <div id="player-selection-buttons" class="flex flex-wrap gap-1"></div>
      </div>

      <div id="player-details-section" class="bg-gray-800 p-2 rounded-lg space-y-1"></div>

      <div class="bg-gray-800 p-2 rounded-lg space-y-2">
        <div class="flex flex-wrap items-center gap-2">
          <div class="flex items-center gap-1">
            <div class="input-with-keypad flex items-center">
              <input type="text" id="small-blind-input" class="number-input w-12 bg-gray-700 p-1 rounded-md text-sm" placeholder="SB">
              <button class="keypad-icon-btn btn bg-gray-600 p-1 rounded-md text-xs h-auto w-auto px-2 py-1">âŒ¨ï¸</button>
            </div>
            <div class="input-with-keypad flex items-center">
              <input type="text" id="big-blind-input" class="number-input w-12 bg-gray-700 p-1 rounded-md text-sm" placeholder="BB">
              <button class="keypad-icon-btn btn bg-gray-600 p-1 rounded-md text-xs h-auto w-auto px-2 py-1">âŒ¨ï¸</button>
            </div>
            <div class="flex items-center">
              <input id="bb-ante-checkbox" type="checkbox" class="h-4 w-4 bg-gray-700 border-gray-600 rounded text-amber-500">
              <label for="bb-ante-checkbox" class="ml-1 text-xs">Ante</label>
            </div>
          </div>
          <div id="board-card-placeholders" class="flex flex-wrap gap-1 items-center flex-grow justify-end"></div>
        </div>
        <div class="space-y-1" id="street-logs-container"></div>
      </div>

      <div class="bg-gray-800 p-2 rounded-lg space-y-2">
        <div class="flex flex-wrap gap-1 items-center">
          <span class="text-sm font-bold mr-2">ìŠ¹ì:</span>
          <div id="winner-buttons" class="flex flex-wrap gap-1 flex-grow"></div>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <button id="reset-btn" class="w-full btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-3 rounded-md text-sm">ìƒˆ í•¸ë“œ</button>
          <button id="send-to-sheet-btn" class="w-full btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-md text-sm">ì‹œíŠ¸ ì „ì†¡</button>
        </div>
        <p id="feedback-message" class="text-center h-4 text-xs font-semibold"></p>
      </div>

      <div id="notes-section" class="bg-gray-800 p-2 rounded-lg space-y-2">
        <div class="flex justify-between items-center">
          <h2 class="text-sm font-bold text-amber-400">ë…¸íŠ¸</h2>
          <span id="notes-count" class="text-xs text-gray-400"></span>
        </div>
        <div id="notes-list" class="space-y-2"></div>
      </div>
    </main>
    <footer class="flex-shrink-0 p-1 text-center">
      <button id="show-log-btn" class="text-gray-500 hover:text-gray-300 text-xs">ë¡œê·¸ ë³´ê¸°</button>
    </footer>
  </div>

  <!-- Modals -->
  <div id="card-selector-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-2 z-50 hidden opacity-0"></div>
  <div id="action-pad-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0"></div>
  <div id="keypad-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0"></div>
  <div id="load-hand-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0"></div>
  <div id="registration-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0"></div>
  <div id="log-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
    <div class="bg-gray-800 rounded-lg p-4 w-full max-w-lg h-2/3 flex flex-col">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-xl font-bold text-amber-400">ë¡œë”© ë¡œê·¸</h2>
        <button id="close-log-modal" class="text-2xl">&times;</button>
      </div>
      <div id="log-display" class="bg-gray-900/50 p-3 rounded-md flex-grow overflow-y-auto text-sm font-mono"></div>
    </div>
  </div>
  <div id="note-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
  <div class="bg-gray-800 rounded-lg p-4 w-full max-w-md">
    <h2 class="text-xl font-bold text-amber-400 mb-2">ë…¸íŠ¸ ì¶”ê°€</h2>
    <textarea id="note-textarea" class="w-full h-32 p-2 bg-gray-900 rounded border border-gray-700 text-sm" placeholder="ì´ë²ˆ í•¸ë“œì— ëŒ€í•œ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”(ì„ íƒ)"></textarea>
    <div class="grid grid-cols-2 gap-2 mt-3">
      <button id="note-skip" class="btn bg-gray-600 py-2 rounded">ë…¸íŠ¸ ì—†ì´ ì €ì¥</button>
      <button id="note-save" class="btn bg-blue-600 py-2 rounded">ë…¸íŠ¸ ì €ì¥ í›„ ê¸°ë¡</button>
    </div>
  </div>
</div>


  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // ====== CONFIG (í•„ìˆ˜: ì‹¤ì œ URLë¡œ êµì²´) ======
    const CSV_HAND_URL  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSDY_i4330JANAjIz4sMncdJdRHsOkfUCjQusHTGQk2tykrhA4d09LeIp3XRbLd8hkN6SgSB47k_nux/pub?gid=1906746276&single=true&output=csv"; // Hand íƒ­ CSV
    const CSV_INDEX_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSDY_i4330JANAjIz4sMncdJdRHsOkfUCjQusHTGQk2tykrhA4d09LeIp3XRbLd8hkN6SgSB47k_nux/pub?gid=1354012271&single=true&output=csv"; // Index íƒ­ CSV (HandIndex ëŒ€ì‹  Index ì‚¬ìš©)
    const CSV_TYPE_URL  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSDY_i4330JANAjIz4sMncdJdRHsOkfUCjQusHTGQk2tykrhA4d09LeIp3XRbLd8hkN6SgSB47k_nux/pub?gid=998576925&single=true&output=csv";
    const CSV_NOTE_URL  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSDY_i4330JANAjIz4sMncdJdRHsOkfUCjQusHTGQk2tykrhA4d09LeIp3XRbLd8hkN6SgSB47k_nux/pub?gid=1016632764&single=true&output=csv"; // ì„ íƒ
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzRRDP0v9LT3Y1Wos_pj7dXg4IVCIC-hAmFpUFUovZBsE2h5hCulMspZsJwANLf1Kl9/exec";

    // ====== STATE ======
    let timeUpdater;
    const state = {
      currentStreet: 'preflop',  // í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ìŠ¤íŠ¸ë¦¬íŠ¸
      camNumbers: { cam1no:'', cam2no:'' }, // íŒŒì¼ ë„˜ë²„ ì…ë ¥ì´ ìˆë‹¤ë©´ ì—¬ê¸°ì— ì €ì¥
      lastCamNo: null,        // ë§ˆì§€ë§‰ ì…ë ¥ ì¶”ì (ì—°ì† ì¦ê°€ ê¸°ë³¸ê°’ ì œê³µìš©)

      playerDataByTable: {},     // { [table]: [{name, chips, notable}] }
      camPreset: { cam1:'', cam2:'' }, // Type!A2/A3
      allTables: [],
      indexRows: [],             // [{handNumber, handUpdatedAt, table, ...}]
      allHandNumbers: [],        // latest numbers (from Index)
      handCsvCache: null,        // raw rows for on-demand hand parsing
      allHandData: {},           // { [handNumber]: parsed hand block (latest) }
      selectedTable: null,
      playersInHand: [],
      board: [],
      actionState: {
        handNumber: '',
        smallBlind: '', bigBlind: '', hasBBAnte: false,
        preflop: [], flop: [], turn: [], river: [],
      },
      modalState: {
        cardTarget: null,
        actionPadStreet: null, actionPadPlayer: null, actionPadCurrentAction: null,
        keypadTarget: null, keypadOptions: {},
      },
      selectedTimezone: 'Asia/Seoul'
    };

    // ====== CONSTS ======
    const SUITS = { s:'â™ ', h:'â™¥', d:'â™¦', c:'â™£' };
    const RANKS = ['A','K','Q','J','10','9','8','7','6','5','4','3','2'];

    // ====== EL ======
    const el = {
      refreshDataBtn: document.getElementById('refresh-data'),
      tableSelector: document.getElementById('table-selector'),
      playerSelectionButtons: document.getElementById('player-selection-buttons'),
      boardCardPlaceholders: document.getElementById('board-card-placeholders'),
      playerDetailsSection: document.getElementById('player-details-section'),
      handNumberDisplay: document.getElementById('hand-number-display'),
      loadHandBtn: document.getElementById('load-hand-btn'),
      smallBlindInput: document.getElementById('small-blind-input'),
      bigBlindInput: document.getElementById('big-blind-input'),
      bbAnteCheckbox: document.getElementById('bb-ante-checkbox'),
      streetLogsContainer: document.getElementById('street-logs-container'),
      winnerButtons: document.getElementById('winner-buttons'),
      sendToSheetBtn: document.getElementById('send-to-sheet-btn'),
      resetBtn: document.getElementById('reset-btn'),
      feedbackMessage: document.getElementById('feedback-message'),
      logDisplay: document.getElementById('log-display'),
      logModal: document.getElementById('log-modal'),
      showLogBtn: document.getElementById('show-log-btn'),
      closeLogModalBtn: document.getElementById('close-log-modal'),
      cardSelectorModal: document.getElementById('card-selector-modal'),
      actionPadModal: document.getElementById('action-pad-modal'),
      keypadModal: document.getElementById('keypad-modal'),
      loadHandModal: document.getElementById('load-hand-modal'),
      timezoneSelector: document.getElementById('timezone-selector'),
      timeDisplay: document.getElementById('time-display'),
      managePlayersBtn: document.getElementById('manage-players-btn'),
      registrationModal: document.getElementById('registration-modal'),
      cam1: document.getElementById('cam-btn-1'),
      cam2: document.getElementById('cam-btn-2'),
      dataStamp: document.getElementById('data-stamp'),
    };

    // ====== LOG MODAL ======
    function openLogModal(){ 
      el.logModal.classList.remove('hidden'); 
      setTimeout(()=>el.logModal.classList.remove('opacity-0'),10);
    }
    function closeLogModal(){ el.logModal.classList.add('opacity-0'); setTimeout(()=>el.logModal.classList.add('hidden'),300); }
    function logMessage(msg,isError=false){
      const d=document.createElement('div');
      d.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`;
      d.className=isError?'text-red-400':'text-green-400';
      el.logDisplay.appendChild(d); el.logDisplay.scrollTop=el.logDisplay.scrollHeight;
    }

    // ====== TIME/TZ ======
    function getFormattedTimeInTimezone(date, tz){
      try{
        return new Intl.DateTimeFormat('ko-KR',{timeZone:tz,hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(date);
      }catch(_){
        const pad=n=>String(n).padStart(2,'0');
        return `${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
      }
    }
    function populateTimezones(){
      const tzs={ "Asia/Seoul":"í•œêµ­(KST)", "Asia/Nicosia":"í‚¤í”„ë¡œìŠ¤(EET)" };
      const s=el.timezoneSelector; s.innerHTML='';
      for(const [v,t] of Object.entries(tzs)){
        const opt=document.createElement('option'); opt.value=v; opt.textContent=t; s.appendChild(opt);
      }
      s.value=state.selectedTimezone;
    }
    function updateTimeDisplay(){ el.timeDisplay.textContent=getFormattedTimeInTimezone(new Date(),state.selectedTimezone); }

    // ====== UTILS ======
    const formatNumber = (val) => val ? new Intl.NumberFormat('en-US').format(String(val).replace(/,/g,'')) : '';
    const unformatNumber = (val) => String(val || '').replace(/,/g, '');
    const toCamelCase = (s) => s.replace(/-([a-z])/g, g => g[1].toUpperCase());
    const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
    const pad4 = n => String(Math.max(0, parseInt(String(n||'0').replace(/\D/g,''),10)||0)).padStart(4, '0');

    // Robust CSV parse (handles quotes)
    function parseCSV(text){
      const rows=[]; let i=0, field='', inQ=false, row=[];
      while(i<text.length){
        const c=text[i];
        if(inQ){
          if(c==='"'){
            if(text[i+1]==='"'){ field+='"'; i++; } else inQ=false;
          }else field+=c;
        }else{
          if(c===','){ row.push(field); field=''; }
          else if(c==='\n'){ row.push(field); rows.push(row); row=[]; field=''; }
          else if(c==='"'){ inQ=true; }
          else if(c!=='\r'){ field+=c; }
        }
        i++;
      }
      if(field!==''||row.length) { row.push(field); rows.push(row); }
      return rows;
    }

    function formatCardDisplay(cardId){
      const rank=cardId.slice(0,-1), suitKey=cardId.slice(-1);
      const colorClass=(suitKey==='h'||suitKey==='d')?'text-red-500':'text-black';
      return `<div class="card-display h-full w-full ${colorClass}"><div class="rank">${rank}</div><div>${SUITS[suitKey]}</div></div>`;
    }

    // ====== RENDERERS ======
    function renderTableSelection(){
      const s=el.tableSelector; s.innerHTML='<option value="">í…Œì´ë¸” ì„ íƒ</option>';
      state.allTables.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; s.appendChild(o); });
    }
    function renderPlayerSelection(){
      if(!state.selectedTable){
        el.playerSelectionButtons.innerHTML='<p class="text-gray-500 text-xs">í…Œì´ë¸”ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.</p>';
        return;
      }
      const arr=state.playerDataByTable[state.selectedTable]||[];
      el.playerSelectionButtons.innerHTML = arr.map(p=>{
        const sel=state.playersInHand.some(pp=>pp.name===p.name);
        const notable = p.notable ? 'â­' : '';
        return `<button class="btn ${sel?'btn-selected':'bg-gray-600 hover:bg-gray-500'} px-2 py-1 text-xs rounded-md" data-player-name="${p.name}">${notable}${p.name}</button>`;
      }).join('');
    }
    function renderPlayerDetails(){
      el.playerDetailsSection.innerHTML = state.playersInHand.map(p=>{
        const roleClass=(p.role==='winner')?'is-winner':'';
        return `<div class="player-card flex items-center gap-2 text-sm border-b border-gray-700 pb-1 ${roleClass}" data-player-name="${p.name}">
          <div class="w-1/4 truncate font-bold">${p.name}</div>
          <div class="w-1/4"><input type="text" readonly class="number-input player-chip-input w-full bg-gray-700 border border-gray-600 rounded-md p-1 text-xs" placeholder="ì¹©" value="${formatNumber(p.chips)}"></div>
          <div class="w-1/4"><button class="keypad-icon-btn btn bg-gray-600 p-1 rounded-md text-xs w-full">âŒ¨ï¸</button></div>
          <div class="w-1/4 card-placeholder h-10 flex justify-center items-center gap-1" data-player-name="${p.name}" data-count="2">
            ${p.hand?.length? p.hand.map(formatCardDisplay).join('') : '<span class="text-gray-400 text-lg">+</span>'}
          </div>
        </div>`;
      }).join('');
    }
    function renderBoard(){
      const flop=`<div class="card-placeholder h-10 w-24" data-target="board" data-index="0" data-count="3">${[0,1,2].map(i=>state.board[i]?formatCardDisplay(state.board[i]):'').join('') || '<span class="text-gray-400 text-lg">+</span>'}</div>`;
      const turn=`<div class="card-placeholder h-10 w-8" data-target="board" data-index="3" data-count="1">${state.board[3]?formatCardDisplay(state.board[3]):'<span class="text-gray-400 text-lg">+</span>'}</div>`;
      const river=`<div class="card-placeholder h-10 w-8" data-target="board" data-index="4" data-count="1">${state.board[4]?formatCardDisplay(state.board[4]):'<span class="text-gray-400 text-lg">+</span>'}</div>`;
      el.boardCardPlaceholders.innerHTML = flop+turn+river;
    }
    function renderWinnerSelection(){
      el.winnerButtons.innerHTML = state.playersInHand.map(p=>{
        const sel=(p.role==='winner');
        return `<button class="btn ${sel?'btn-selected':'bg-gray-600 hover:bg-gray-500'} px-2 py-1 text-xs rounded-md set-winner-btn" data-player-name="${p.name}">${p.name}</button>`;
      }).join('');
    }
    function renderActionStreets(){
      const streets=['preflop','flop','turn','river']; let cumulativePot=0;
      el.streetLogsContainer.innerHTML = streets.map(street=>{
        const logs=state.actionState[street]||[]; let streetPot=0;
        if(street==='preflop'){
          streetPot += parseInt(unformatNumber(state.actionState.smallBlind)||0,10);
          streetPot += parseInt(unformatNumber(state.actionState.bigBlind)||0,10);
          if(state.actionState.hasBBAnte) streetPot += parseInt(unformatNumber(state.actionState.bigBlind)||0,10);
        }
        logs.forEach(a=>{ if(a.amount) streetPot += parseInt(unformatNumber(a.amount),10); });
        cumulativePot += streetPot;
        const logHTML = logs.map(log=>{
          // Pot Correctionì€ ì‹œìŠ¤í…œ ì•¡ì…˜ì´ë¯€ë¡œ playerê°€ ì—†ìŒ
          if(log.action === 'Pot Correction'){
            const amt = log.amount ? ` <span class="font-mono text-white">${formatNumber(log.amount)}</span>` : '';
            return `<span class="action-log-entry mr-2"><span class="text-blue-400">Pot</span> ${log.action}${amt}</span>`;
          }
          // ì¼ë°˜ í”Œë ˆì´ì–´ ì•¡ì…˜
          const player=state.playersInHand.find(p=>p.name===log.player);
          const cls=(player?.role==='winner')?'text-amber-400':'text-gray-300';
          const amt=log.amount?` <span class="font-mono text-white">${formatNumber(log.amount)}</span>`:'';
          return `<span class="action-log-entry mr-2"><span class="${cls}">${log.player || 'Unknown'}</span> ${log.action}${amt}</span>`;
        }).join('');
        const isActive = state.currentStreet === street;
        const streetBtnClass = isActive 
          ? 'bg-amber-500 text-black border-2 border-amber-300 shadow-lg' 
          : 'bg-gray-700 text-gray-300 border-2 border-gray-600 hover:bg-gray-600 hover:text-white';
        
        return `<div class="street-container bg-gray-900/50 p-1 rounded-md">
          <div class="flex justify-between items-center text-xs mb-1">
            <button class="street-select-btn ${streetBtnClass} px-3 py-1 rounded-md font-bold min-w-[70px] text-center transition-all cursor-pointer" 
                    data-street="${street}" style="${isActive ? 'box-shadow: 0 0 10px rgba(251, 191, 36, 0.5);' : ''}">${street.toUpperCase()}</button>
            <div class="flex items-center gap-1">
              <span class="font-mono">Pot: ${formatNumber(cumulativePot)}</span>
              <button class="pot-keypad-btn btn bg-gray-600 px-1 py-0 rounded" data-street="${street}" data-current-pot="${cumulativePot}">âŒ¨ï¸</button>
            </div>
            <div class="flex gap-1">
              <button class="add-action-btn btn bg-indigo-600 text-white font-bold py-1 px-2 rounded" data-street="${street}">ì•¡ì…˜+</button>
              <button class="undo-action-btn btn bg-gray-600 py-1 px-2 rounded" data-street="${street}">â†©</button>
            </div>
          </div>
          <div id="${street}-log" class="action-log-display text-xs whitespace-nowrap overflow-x-auto">${logHTML || '<span class="text-gray-500">No actions</span>'}</div>
        </div>`;
      }).join('');
    }
    function renderAll(){ renderPlayerSelection(); renderPlayerDetails(); renderBoard(); renderActionStreets(); renderWinnerSelection(); }
    // ====== MODALS ======
    function openModal(node, html){ node.innerHTML=html; node.classList.remove('hidden'); setTimeout(()=>node.classList.remove('opacity-0'),10); }
    function closeModal(node){ node.classList.add('opacity-0'); setTimeout(()=>node.classList.add('hidden'),300); }

    function openCardSelector(){
      const { count } = state.modalState.cardTarget;
      const used=[...state.playersInHand.flatMap(p=>p.hand||[]), ...state.board].filter(Boolean);
      let selected=[], deckHTML='';
      Object.keys(SUITS).forEach(suitKey=>{
        deckHTML+='<div class="flex justify-center gap-1 mb-1">';
        RANKS.forEach(rank=>{
          const id=`${rank}${suitKey}`, usedFlag=used.includes(id);
          const color=(suitKey==='h'||suitKey==='d')?'card-red':'card-black';
          deckHTML+=`<button class="btn card-selector-btn rounded-md w-9 h-11 ${usedFlag?'bg-gray-600 text-gray-500':'bg-white hover:bg-amber-300'} ${color}" data-card-id="${id}" ${usedFlag?'disabled':''}>${rank}${SUITS[suitKey]}</button>`;
        });
        deckHTML+='</div>';
      });
      const html=`<div class="bg-gray-800 rounded-lg p-2 w-full max-w-md">
        <h2 class="text-lg font-bold text-amber-400 mb-2 text-center">ì¹´ë“œ ì„ íƒ (${count}ì¥)</h2>
        <div id="card-deck">${deckHTML}</div>
        <button id="close-card-modal" class="btn mt-2 w-full bg-red-600 py-2 rounded-md">ë‹«ê¸°</button>
      </div>`;
      openModal(el.cardSelectorModal, html);
      el.cardSelectorModal.querySelector('#card-deck').onclick=e=>{
        const btn=e.target.closest('.card-selector-btn'); if(!btn) return;
        const id=btn.dataset.cardId; const idx=selected.indexOf(id);
        if(idx>-1){ selected.splice(idx,1); btn.classList.remove('selected'); }
        else if(selected.length<count){ selected.push(id); btn.classList.add('selected'); }
        if(selected.length===count) assignCard(selected);
      };
    }

    function openActionPad(street){
      if(state.playersInHand.length<1){ showFeedback('ë¨¼ì € í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', true); return; }
      state.modalState.actionPadStreet=street;
      // ì•¡ì…˜ ì¶”ê°€ ì‹œ í•´ë‹¹ ìŠ¤íŠ¸ë¦¬íŠ¸ë¡œ ìë™ ì „í™˜
      state.currentStreet = street;
      const playersHTML=state.playersInHand.map(p=>`<button class="btn bg-gray-700 p-2 rounded-md" data-player-name="${p.name}">${p.name}</button>`).join('');
      const html=`<div class="bg-gray-800 rounded-lg p-4 w-full max-w-md">
        <h2 class="text-xl font-bold text-amber-400 mb-4 text-center">${street.toUpperCase()} ì•¡ì…˜</h2>
        <div id="action-pad-players" class="grid grid-cols-3 gap-2 mb-4">${playersHTML}</div>
        <div id="action-pad-actions" class="grid grid-cols-3 gap-2 mb-4 hidden">
          <button class="btn bg-red-600 p-3 rounded-md" data-action="Folds">Fold</button>
          <button class="btn bg-gray-600 p-3 rounded-md" data-action="Checks">Check</button>
          <button class="btn bg-blue-600 p-3 rounded-md" data-action="Calls">Call</button>
          <button class="btn bg-amber-500 col-span-2 p-3 rounded-md" data-action="Bet/Raises">Bet/Raise</button>
          <button class="btn bg-red-800 font-bold p-3 rounded-md" data-action="All In">ALL IN</button>
        </div>
        <button id="close-action-pad" class="btn mt-4 w-full bg-gray-600 py-2 rounded-md">ë‹«ê¸°</button>
      </div>`;
      openModal(el.actionPadModal, html);
    }

    function openKeypad(targetInput, options={}){
      state.modalState.keypadTarget=targetInput;
      state.modalState.keypadOptions=options;
      const initial = options.prefill ? options.prefill : (targetInput?targetInput.value:'');
      const html=`<div class="bg-gray-800 rounded-lg p-2 w-full max-w-xs">
        <div id="keypad-display" class="bg-gray-900 text-right text-2xl font-mono p-2 rounded mb-2 h-12">${initial}</div>
        <div class="grid grid-cols-3 gap-2 text-xl font-bold">
          ${['7','8','9','4','5','6','1','2','3','0','00','000'].map(k=>`<button class="keypad-btn btn bg-gray-700 p-3 rounded-md">${k}</button>`).join('')}
        </div>
        <div class="grid grid-cols-2 gap-2 mt-2">
          <button class="keypad-btn btn bg-gray-600 text-amber-400 p-3 rounded-md">C</button>
          <button class="keypad-btn btn bg-gray-600 text-amber-400 p-3 rounded-md">â†</button>
        </div>
        <div class="grid grid-cols-2 gap-2 mt-2">
          <button id="keypad-cancel" class="btn bg-red-600 p-3 rounded-md">ì·¨ì†Œ</button>
          <button id="keypad-confirm" class="btn bg-green-600 p-3 rounded-md">í™•ì¸</button>
        </div>
      </div>`;
      openModal(el.keypadModal, html);
    }
    function openNoteModal(){
      const node = document.getElementById('note-modal');
      node.classList.remove('hidden'); setTimeout(()=>node.classList.remove('opacity-0'),10);
      const ta = document.getElementById('note-textarea');
      ta.value = state.noteDraft || '';
    }
    function closeNoteModal(){
      const node = document.getElementById('note-modal');
      node.classList.add('opacity-0'); setTimeout(()=>node.classList.add('hidden'),300);
    }

    // ====== SELECTORS & INPUTS ======
    function togglePlayerInHand(name){
      const i=state.playersInHand.findIndex(p=>p.name===name);
      if(i>-1) state.playersInHand.splice(i,1);
      else{
        const pool=state.playerDataByTable[state.selectedTable]||[];
        const pd=pool.find(p=>p.name===name);
        const chips=pd?pd.chips:'';
        state.playersInHand.push({name, hand:[], chips, initialChips:chips, role:null});
      }
      renderPlayerSelection(); renderPlayerDetails(); renderWinnerSelection();
    }
    function setPlayerRole(name){
      const p=state.playersInHand.find(pp=>pp.name===name); if(!p) return;
      p.role = (p.role==='winner')? null : 'winner';
      renderPlayerDetails(); renderWinnerSelection();
    }
    function assignCard(cards){
      const {target,player,index} = state.modalState.cardTarget;
      if(target==='board'){ cards.forEach((c,i)=> state.board[index+i]=c); renderBoard(); }
      else{
        const p=state.playersInHand.find(pp=>pp.name===player);
        if(p){ p.hand=cards; renderPlayerDetails(); }
      }
      closeModal(el.cardSelectorModal);
    }
    function addActionToLog(action, amount=null){
      const { actionPadStreet, actionPadPlayer } = state.modalState;
      if (amount){
        const p = state.playersInHand.find(pp => pp.name === actionPadPlayer);
        if (p){
          const cur = parseInt(unformatNumber(p.chips) || 0, 10);
          const amountToDeduct = parseInt(unformatNumber(amount), 10);
          // ìŒìˆ˜ ë°©ì§€: ì¹©ì´ 0 ì´í•˜ë¡œ ë–¨ì–´ì§€ì§€ ì•Šë„ë¡
          const newChips = Math.max(0, cur - amountToDeduct);
          p.chips = newChips.toString();
          p.chipsUpdatedAt = new Date().toISOString(); // â˜… í”„ë¡œê·¸ë¨ì  ë³€ê²½ë„ íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë¡
        }
      }
      state.actionState[actionPadStreet].push({
        player: actionPadPlayer,
        action,
        amount,
        timestamp: new Date().toISOString()
      });
      saveActionState();
      renderAll();
      closeModal(el.actionPadModal);
    }

    function undoLastAction(street){
      const last=state.actionState[street].pop();
      if(last&&last.amount){
        const p=state.playersInHand.find(pp=>pp.name===last.player);
        if(p){ const cur=parseInt(unformatNumber(p.chips)||0,10); p.chips=(cur+parseInt(unformatNumber(last.amount),10)).toString(); }
      }
      saveActionState(); renderAll();
    }

    // ====== PERSIST (localStorage) ======
    function saveActionState(){ localStorage.setItem('phl_v46_state', JSON.stringify(state.actionState)); }
    function loadActionState(){ const s=localStorage.getItem('phl_v46_state'); if(s) state.actionState={...state.actionState, ...JSON.parse(s)}; }

    // ====== POT ======
    function calculatePotSize(){
      let pot=0;
      pot+=parseInt(unformatNumber(state.actionState.smallBlind)||0,10);
      pot+=parseInt(unformatNumber(state.actionState.bigBlind)||0,10);
      if(state.actionState.hasBBAnte) pot+=parseInt(unformatNumber(state.actionState.bigBlind)||0,10);
      
      ['preflop','flop','turn','river'].forEach(st=> {
        state.actionState[st].forEach(a=>{ 
          if(a.amount) {
            // Pot Correctionì€ íŒŸì„ ì§ì ‘ ì„¤ì •í•˜ëŠ” ê°’ì´ë¯€ë¡œ ë‹¤ë¥´ê²Œ ì²˜ë¦¬
            if(a.action === 'Pot Correction') {
              // Pot Correction: ì…ë ¥í•œ ê°’ì´ ìƒˆë¡œìš´ íŒŸ í¬ê¸°ê°€ ë¨
              pot = parseInt(unformatNumber(a.amount),10);
            } else {
              // ì¼ë°˜ ì•¡ì…˜: íŒŸì— ì¶”ê°€
              pot+=parseInt(unformatNumber(a.amount),10); 
            }
          }
        });
      });
      return pot;
    }

    // ====== CSV LOADERS ======
    async function fetchCsv(url){
      const res=await fetch(url); if(!res.ok) throw new Error(`CSV fetch failed: ${res.status}`);
      const txt=await res.text(); return parseCSV(txt);
    }

    function buildTypeFromCsv(rows){
      // Type: header in row[0]
      // B:Player, C:Table, D:Notable(checkbox TRUE/FALSE), E:Chips
      // A2: Cam1 name, A3: Cam2 name
      if(!rows||rows.length<1) return;
      const header=rows[0];
      const A2=(rows[1]&&rows[1][0])?String(rows[1][0]).trim():'';
      const A3=(rows[2]&&rows[2][0])?String(rows[2][0]).trim():'';
      state.camPreset.cam1=A2||'Cam1';
      state.camPreset.cam2=A3||'Cam2';
      el.cam1.textContent = state.camPreset.cam1 || 'Cam1';
      el.cam2.textContent = state.camPreset.cam2 || 'Cam2';

      const byTable={};
      for(let i=1;i<rows.length;i++){
        const r=rows[i]||[];
        const player=String(r[1]||'').trim();
        const table =String(r[2]||'').trim();
        const notable = String(r[3]||'').toUpperCase()==='TRUE';
        const chips = String(r[4]!=null?r[4]:'0').trim();
        if(player && table){
          if(!byTable[table]) byTable[table]=[];
          if(!byTable[table].some(p=>p.name===player)){
            byTable[table].push({name:player, chips, notable});
          }
        }
      }
      state.playerDataByTable=byTable;
      state.allTables=Object.keys(byTable).sort();
    }

    function buildIndexFromCsv(rows){
      // Index CSV columns:
      // A handNumber | B startRow | C endRow | D handUpdatedAt | E handEdit | F handEditTime | G label | H table | I tableUpdatedAt | J Cam | K CamFile01name | L CamFile01number | M CamFile02name | N CamFile02number
      const out=[]; for(let i=1;i<rows.length;i++){
        const r=rows[i]||[];
        const item={
          handNumber:String(r[0]||''), startRow:+(r[1]||0), endRow:+(r[2]||0),
          handUpdatedAt:String(r[3]||''), handEdit:r[4], handEditTime:r[5], label:r[6],
          table:String(r[7]||''), tableUpdatedAt:r[8], cam:r[9], cam1:r[10], cam1no:r[11], cam2:r[12], cam2no:r[13]
        };
        if(item.handNumber) out.push(item);
      }
      state.indexRows=out;
      // ìµœì‹  ìš°ì„  ì •ë ¬
      out.sort((a,b)=> a.handUpdatedAt<b.handUpdatedAt?1:-1);
      state.allHandNumbers = [...new Set(out.map(x=>x.handNumber))];
    }

    // íŒŒì‹±: Hand CSV â†’ íŠ¹ì • handNumberì˜ "ê°€ì¥ ìµœê·¼ updatedAt" ë¸”ë¡
    function parseHandBlock(rows, handNumber, preferDate){
      // HAND ì‹œì‘ ìœ„ì¹˜ ìˆ˜ì§‘
      const starts=[];
      for(let r=0;r<rows.length;r++){
        const row=rows[r]||[];
        if(row[1]==='HAND'){
          const no=String(row[2]||'');
          if(no===String(handNumber)){
            starts.push({r});
          }
        }
      }
      if(!starts.length) return null;
    
      // Indexì—ì„œ ìµœì‹  updatedAt ê¸°ì¤€ ë¸”ë¡ ë²”ìœ„ ì°¾ê¸°
      let updatedAt=preferDate||null;
      if(!updatedAt){
        const candidates=state.indexRows.filter(x=>x.handNumber===String(handNumber));
        candidates.sort((a,b)=> a.handUpdatedAt<b.handUpdatedAt?1:-1);
        updatedAt=candidates[0]?.handUpdatedAt||null;
      }
      let startRowIdx=-1, endRowIdx=-1;
      const idxRow=state.indexRows.find(x=>x.handNumber===String(handNumber) && x.handUpdatedAt===updatedAt);
      if(idxRow){ startRowIdx=idxRow.startRow-1; endRowIdx=idxRow.endRow-1; }
      else{
        const last=starts[starts.length-1].r;
        startRowIdx=last;
        let r=last+1; while(r<rows.length && rows[r][1]!=='HAND') r++;
        endRowIdx=r-1;
      }
      if(startRowIdx<0 || endRowIdx<startRowIdx) return null;
    
      const block=rows.slice(startRowIdx,endRowIdx+1);
    
      // íŒŒì‹±
      let handInfo=null, players=[], board=[], smallBlind='', bigBlind='', ante=0, table='';
      // ìŠ¤íŠ¸ë¦¬íŠ¸ ë¶„í• : ë¸”ë¡ì„ **ìˆœì„œëŒ€ë¡œ** ëŒë©´ì„œ BOARDë¥¼ ë§Œë‚  ë•Œë§ˆë‹¤ ì „í™˜í•œë‹¤
      const streets={preflop:[],flop:[],turn:[],river:[]};
      let street='preflop';
      let seenBoard=0;
    
      for(const row of block){
        if(row[1]==='HAND'){
          handInfo=row;
          ante=parseInt(row[6]||0,10)||0;
          smallBlind=row[8]||'';
          bigBlind=row[9]||'';
          table=row[17]||'';
        }else if(row[1]==='PLAYER'){
          const name=row[2];
          const seat=row[3];
          const init=row[5], final=row[6];
          const cards=(row[7]||'').trim()? String(row[7]).trim().split(' ') : [];
          players.push({name, seat, initialChips:init, finalChips:final, hand:cards});
        }else if(row[1]==='EVENT'){
          const etype=String(row[2]||'').toUpperCase();
          if(etype==='BOARD'){
            // ë³´ë“œ ì „í™˜ ì§€ì 
            const card=row[4];
            if(card) board.push(card);
            seenBoard++;
            if(seenBoard===3) street='flop';
            else if(seenBoard===4) street='turn';
            else if(seenBoard===5) street='river';
          }else{
            // ì¢Œì„ â†’ ì´ë¦„
            const seat=row[3];
            const amount=row[4];
            const time=row[5];
            const p=players.find(pp=>String(pp.seat)===String(seat));
            const name=p?p.name:'';
            streets[street].push({
              player:name,
              action:etype,
              amount:amount||null,
              timestamp:time||null
            });
          }
        }
      }

  return {
    handInfo,
    table,
    ante,
    smallBlind,
    bigBlind,
    hasBBAnte: ante>0,
    board,
    actions: streets,
    players: players.map(p=>({
      name:p.name,
      initialChips:p.initialChips,
      finalChips:p.finalChips,
      hand:p.hand,
      role: (parseInt(p.finalChips||0,10)>parseInt(p.initialChips||0,10)) ? 'winner' : null
    }))
  };
}



    // ====== LOADERS (initial) ======
    async function loadInitial(){
      openLogModal(); el.logDisplay.innerHTML='';
      logMessage('ì´ˆê¸° ë°ì´í„° ë¡œë”© ì‹œì‘ (Type/Index) ...');
      try{
        const [typeRows, idxRows] = await Promise.all([
          CSV_TYPE_URL.includes('http')? fetchCsv(CSV_TYPE_URL) : Promise.resolve([]),
          CSV_INDEX_URL.includes('http')? fetchCsv(CSV_INDEX_URL) : Promise.resolve([])
        ]);
        if(typeRows.length) buildTypeFromCsv(typeRows);
        if(idxRows.length) buildIndexFromCsv(idxRows);
        state.actionState.handNumber = (state.allHandNumbers.length>0? Math.max(...state.allHandNumbers.map(n=>parseInt(n,10)||0)) + 1 : 1).toString();
        el.handNumberDisplay.textContent = `#${state.actionState.handNumber}`;
        el.dataStamp.textContent = `IDX rows: ${state.indexRows.length}`;
        renderAll();
        logMessage('ì´ˆê¸° ë°ì´í„° ë¡œë”© ì™„ë£Œ');
      }catch(err){
        console.error(err); logMessage(`ì´ˆê¸° ë¡œë”© ì‹¤íŒ¨: ${err.message}`, true);
      }finally{
        setTimeout(closeLogModal, 800);
      }
    }

    // ====== LOAD HAND MODAL ======
    function openLoadHandModal(){
      if(!state.indexRows.length){
        showFeedback('Index ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. CSV ê²Œì‹œì™€ URLì„ í™•ì¸í•˜ì„¸ìš”.', true);
        return;
      }
      
      // í•¸ë“œ ë²ˆí˜¸ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ìµœì‹  í•¸ë“œê°€ ìœ„ë¡œ)
      const items = state.indexRows.slice().sort((a,b)=> {
        const numA = parseInt(a.handNumber, 10) || 0;
        const numB = parseInt(b.handNumber, 10) || 0;
        return numB - numA; // ë‚´ë¦¼ì°¨ìˆœ
      });
      
      const htmlItems = items.map(it=>{
        return `<button class="btn bg-gray-700 p-2 rounded-md w-full text-left load-hand-item-btn mb-2" data-no="${it.handNumber}" data-date="${it.handUpdatedAt}">
          <div class="flex justify-between items-center">
            <span class="font-bold text-white">#${it.handNumber}</span>
            <span class="text-xs text-amber-400 truncate">${it.table||''}</span>
            <span class="text-xs text-gray-300">${it.handUpdatedAt||''}</span>
          </div>
        </button>`;
      }).join('');
      
      const html = `<div class="bg-gray-800 rounded-lg p-4 w-full max-w-md flex flex-col h-2/3">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold text-amber-400">í•¸ë“œ ë¶ˆëŸ¬ì˜¤ê¸°</h2>
          <button id="close-load-hand-modal" class="text-2xl">&times;</button>
        </div>
        <div class="overflow-y-auto space-y-2 flex-grow pr-2">${htmlItems}</div>
      </div>`;
      openModal(el.loadHandModal, html);
      
      // ëª¨ë‹¬ ë°– í´ë¦­ ì‹œ ë‹«ê¸° (ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì™€ ì¶©ëŒ ë°©ì§€)
      // onclick ëŒ€ì‹  ë³„ë„ì˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì‚¬ìš©
    }
    async function ensureHandCsv(){
      if(state.handCsvCache) return state.handCsvCache;
      logMessage('Hand CSV ë‹¤ìš´ë¡œë“œ ì¤‘...');
      const rows = await fetchCsv(CSV_HAND_URL + `&cb=${Date.now()}`);
      state.handCsvCache = rows;
      logMessage(`Hand CSV ë¡œë“œ ì™„ë£Œ (rows=${rows.length})`);
      return rows;
    }

    async function loadHandData(handNumber, preferDate){
      try{
        const rows = await ensureHandCsv();
        const data = parseHandBlock(rows, handNumber, preferDate);
        if(!data){ showFeedback(`Hand #${handNumber} ë¸”ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, true); return; }

        state.playersInHand=[];
        state.board = data.board||[];
        state.actionState = {
          ...state.actionState,
          handNumber: String(handNumber),
          smallBlind: data.smallBlind || '',
          bigBlind: data.bigBlind || '',
          hasBBAnte: data.ante>0,
          preflop: data.actions?.preflop||[],
          flop: data.actions?.flop||[],
          turn: data.actions?.turn||[],
          river: data.actions?.river||[],
        };
        state.selectedTable = data.table || '';
        el.tableSelector.value = state.selectedTable;

        state.playersInHand = (data.players||[]).map(p=>({
          name:p.name, hand:p.hand||[], chips:p.finalChips, initialChips:p.initialChips, role:p.role||null
        }));

        el.handNumberDisplay.textContent = `#${handNumber}`;
        el.smallBlindInput.value = formatNumber(state.actionState.smallBlind);
        el.bigBlindInput.value = formatNumber(state.actionState.bigBlind);
        el.bbAnteCheckbox.checked = state.actionState.hasBBAnte;

        // currentStreet ê²°ì •: ë§ˆì§€ë§‰ìœ¼ë¡œ ì•¡ì…˜ì´ ìˆëŠ” ìŠ¤íŠ¸ë¦¬íŠ¸ ì°¾ê¸°
        if(state.actionState.river.length > 0) {
          state.currentStreet = 'river';
        } else if(state.actionState.turn.length > 0) {
          state.currentStreet = 'turn';
        } else if(state.actionState.flop.length > 0) {
          state.currentStreet = 'flop';
        } else {
          state.currentStreet = 'preflop';
        }

        renderAll(); saveActionState();
        
        // í•´ë‹¹ í•¸ë“œì˜ ë…¸íŠ¸ë§Œ ë¡œë“œ
        if(CSV_NOTE_URL.includes('http')){
          try{
            const noteRows = await fetchCsv(CSV_NOTE_URL + `&cb=${Date.now()}`);
            renderNotes(noteRows, handNumber);
          }catch(err){
            console.error('ë…¸íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', err);
            // ë…¸íŠ¸ ë¡œë“œ ì‹¤íŒ¨ì‹œ ì„¹ì…˜ ìˆ¨ê¹€
            document.getElementById('notes-section').style.display = 'none';
          }
        }
        
        closeModal(el.loadHandModal);
        showFeedback(`#${handNumber} í•¸ë“œë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
      }catch(err){
        console.error(err); showFeedback(`ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${err.message}`, true);
      }
    }

    // ====== GENERATE & SEND ======
    function formatISODateInTZ(date, tz){
      // yyyy-MM-dd
      const y = new Intl.DateTimeFormat('en-CA', { timeZone: tz, year:'numeric' }).format(date);
      const m = new Intl.DateTimeFormat('en-CA', { timeZone: tz, month:'2-digit' }).format(date);
      const d = new Intl.DateTimeFormat('en-CA', { timeZone: tz, day:'2-digit' }).format(date);
      return `${y}-${m}-${d}`;
    }

    function generateRows_v46(){
      const out=[]; let no=1;
      const push=(arr)=>{ const a=[no, ...arr]; while(a.length<18) a.push(''); out.push(a); no++; };

      const epochSec = Math.floor(Date.now()/1000);
      const sb = unformatNumber(state.actionState.smallBlind)||'0';
      const bb = unformatNumber(state.actionState.bigBlind)||'0';
      const ante = state.actionState.hasBBAnte ? bb : '0';
      const table = state.selectedTable || '';
      const currentDate = new Date().toISOString().split('T')[0]; // YYYY-MM-DD í˜•ì‹

      // GAME / PAYOUTS - Eì—´(ì¸ë±ìŠ¤ 4)ì— ë‚ ì§œ ì¶”ê°€
      const gameRow = ['GAME','GGProd Hand Logger','Virtual Table', currentDate];
      push(gameRow);
      push(['PAYOUTS']);

      // HAND: C no, D code, G ante, I SB, J BB, R table
      const handDate = formatISODateInTZ(new Date(), state.selectedTimezone); // yyyy-MM-dd
      
      // HAND: C no, D code, G ante, I SB, J BB, R table
      push(['HAND',
        String(state.actionState.handNumber),
        epochSec,
        'HOLDEM',
        state.actionState.hasBBAnte ? 'BB_ANTE':'NO_ANTE',
        ante,
        handDate, // â˜… ì—¬ê¸°(H) ì¹¸ì— ë‚ ì§œë¥¼ ë„£ë„ë¡ ì•½ì† (Apps Scriptë„ ì´ ì¹¸ì€ ë‚ ì§œë¡œ ì“°ê²Œ)
        sb,       // I
        bb,       // J
        0,1,2,3,0,0,1,
        table     // R
      ]);

      // PLAYERS
      const players = state.playersInHand.map((p,i)=>({...p, seat:i+1}));
      players.forEach(p=>{
        let initialChips = parseInt(unformatNumber(p.initialChips)||0,10);
        let finalChips = parseInt(unformatNumber(p.chips)||0,10);
        // PLAYER: B name, C seat, D 0, E 0, F ì‹œì‘ì¹©, G ì¢…ë£Œì¹©, H í•¸ë“œ
        push(['PLAYER', p.name, p.seat, 0, 0, initialChips, finalChips, p.hand?.length? p.hand.join(' ') : '']);
      });

      // EVENTS
      const addEv=(log)=>{
        const p=players.find(x=>x.name===log.player);
        const seat=p?p.seat:'';
        const amt=log.amount? unformatNumber(log.amount):'';
        let t=(log.action||'').toUpperCase().replace(/S$/,'');
        if(t==='BET/RAISES') t='RAISE TO';
        push(['EVENT', t, seat, amt, '' ]);
      };
      state.actionState.preflop.forEach(addEv);
      if(state.board.length>=3){ push(['EVENT','BOARD',1,state.board[0],'' ]); push(['EVENT','BOARD',1,state.board[1],'' ]); push(['EVENT','BOARD',1,state.board[2],'' ]); }
      state.actionState.flop.forEach(addEv);
      if(state.board.length>=4){ push(['EVENT','BOARD',1,state.board[3],'' ]); }
      state.actionState.turn.forEach(addEv);
      if(state.board.length>=5){ push(['EVENT','BOARD',1,state.board[4],'' ]); }
      state.actionState.river.forEach(addEv);

      // ë§ˆì§€ë§‰ ë²ˆí˜¸í–‰(ì„ íƒ)
      out.push([no]); 
      return { rows: out, epochSec, currentDate };
    }
    
let isSending = false;

async function sendDataToGoogleSheet(){
  if (isSending) return;     // ì¤‘ë³µ ì „ì†¡ ê°€ë“œ
  isSending = true;

  if (state.playersInHand.filter(p=>p.role==='winner').length===0){
    showFeedback('ìŠ¹ìë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.', true);
    isSending = false;
    return;
  }

  openLogModal(); logMessage('ì‹œíŠ¸ ì „ì†¡ ì‹œì‘...');
  el.sendToSheetBtn.textContent='ì „ì†¡ ì¤‘...';
  el.sendToSheetBtn.disabled=true;

  try{
    const { rows, epochSec } = generateRows_v46();
    const indexMeta   = buildIndexMeta();
    const typeUpdates = buildTypeUpdates();
    // ë…¸íŠ¸ ê¸°ëŠ¥ ì œê±°
    const payload = { rows, indexMeta, typeUpdates };

    // x-www-form-urlencodedë¡œ ì „ì†¡ â†’ í”„ë¦¬í”Œë¼ì´íŠ¸ ì—†ìŒ (CORS ìš°íšŒ)
    const form = new URLSearchParams();
    form.append('payload', JSON.stringify(payload));

    const res = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
      body: form.toString(),
      // mode: 'cors'  // ìƒëµ ê°€ëŠ¥ (ê¸°ë³¸)
    });

    if(!res.ok){
      const text = await res.text().catch(()=> '');
      throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${res.status} ${text || ''}`);
    }

    const json = await res.json().catch(()=> ({}));

    if(json.status !== 'success'){
      logMessage('âš ï¸ Apps Scriptê°€ successë¥¼ ë°˜í™˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê¸°ë¡ì€ ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    } else {
      logMessage(`âœ… ì €ì¥ ì™„ë£Œ: #${json.handNumber || indexMeta.handNumber} (rows=${json.rowsAdded})`);
    }

    // Index CSV ë¦¬í”„ë ˆì‹œ
    try{
      await sleep(600);
      if(CSV_INDEX_URL.includes('http')){
        const idxRows = await fetchCsv(CSV_INDEX_URL + `&cb=${Date.now()}`);
        buildIndexFromCsv(idxRows);
        el.dataStamp.textContent = `IDX rows: ${state.indexRows.length}`;
      }
    }catch(_){ /* noop */ }

    showFeedback('âœ… ì‹œíŠ¸ ê¸°ë¡ ì™„ë£Œ');
    state.noteDraft = '';
    resetApp();

  }catch(err){
    console.error(err);
    showFeedback(`âŒ ì „ì†¡ ì‹¤íŒ¨: ${err.message}`, true);
  }finally{
    isSending = false;
    el.sendToSheetBtn.textContent='ì‹œíŠ¸ ì „ì†¡';
    el.sendToSheetBtn.disabled=false;
    setTimeout(()=>closeLogModal(), 1000);
  }
}


    function nowIso() {
      // ì„œë²„ì—ì„œ timezone ë³€í™˜í•˜ë¯€ë¡œ UTC ISOë¡œ ë³´ëƒ„
      return new Date().toISOString();
    }
    function buildIndexMeta(){
      const handNumber = String(state.actionState.handNumber);
      const handUpdatedAt = new Date().toISOString().split('T')[0]; // YYYY-MM-DD í˜•ì‹
      const table = state.selectedTable || '';
      
      // Index ì‹œíŠ¸ì˜ ì „ì²´ ì—´ êµ¬ì¡°ì— ë§ê²Œ ë°ì´í„° ì¤€ë¹„
      return {
        handNumber,                                           // Aì—´
        // startRow, endRowëŠ” ì„œë²„ì—ì„œ ê³„ì‚°                    // B,Cì—´
        handUpdatedAt,                                        // Dì—´ (YYYY-MM-DD)
        // handEditëŠ” ë¹„ì›Œë‘                                   // Eì—´
        // handEditTimeì€ ì„œë²„ì—ì„œ ì²˜ë¦¬                        // Fì—´
        label: 'HOLDEM',                                      // Gì—´
        table,                                                 // Hì—´
        tableUpdatedAt: handUpdatedAt,                        // Iì—´ (YYYY-MM-DD)
        cam: `${state.camPreset.cam1 || ''}+${state.camPreset.cam2 || ''}`, // Jì—´
        camFile01name: state.camPreset.cam1 || '',            // Kì—´
        camFile01number: state.camNumbers.cam1no || '',       // Lì—´
        camFile02name: state.camPreset.cam2 || '',            // Mì—´
        camFile02number: state.camNumbers.cam2no || ''        // Nì—´
      };
    }

    function buildTypeUpdates(){
      // ì´ë²ˆ í•¸ë“œ ë™ì•ˆ ì¹©ì´ ìˆ˜ì •ëœ í”Œë ˆì´ì–´ë§Œ ì¶”ë ¤ì„œ Typeì— updatedAt ê¸°ë¡
      const table = state.selectedTable || '';
      return state.playersInHand
        .filter(p => p.chipsUpdatedAt) // ìˆ˜ì •ëœ ì¼€ì´ìŠ¤ë§Œ
        .map(p => ({
          player: p.name,
          table,
          chips: String(p.chips || ''),
          updatedAt: p.chipsUpdatedAt // ISO. ì•± ìŠ¤í¬ë¦½íŠ¸ì—ì„œ Dateë¡œ set
        }));
    }
    function buildNotePayload(epochSec){
      const text = (state.noteDraft || '').trim();
      if(!text) return null;
      // Note ì‹œíŠ¸ ìŠ¤í‚¤ë§ˆ: Aì—´(Code/íƒ€ì„ì½”ë“œ), Bì—´(handNumber), Cì—´(Note)
      // Apps ScriptëŠ” code í•„ë“œë¥¼ Aì—´ì— ê¸°ë¡
      return {
        text,  // Cì—´: Note í…ìŠ¤íŠ¸
        handNumber: String(state.actionState.handNumber),  // Bì—´: handNumber
        code: String(epochSec || Math.floor(Date.now()/1000))  // Aì—´: HAND í–‰ Dì—´ì˜ íƒ€ì„ì½”ë“œ
      };
    }



    // ====== CAM PREFILL ======
    function computeCamPrefill(which){
      // 1) ìì‹ ì˜ ê°’ ìˆìœ¼ë©´ ê·¸ê±¸ í‘œì‹œ
      if (which==='cam1' && state.camNumbers.cam1no) return pad4(state.camNumbers.cam1no);
      if (which==='cam2' && state.camNumbers.cam2no) return pad4(state.camNumbers.cam2no);

      // 2) ì§ì˜ ê°’ ê¸°ë°˜ ìë™ ì¦ê°€
      if (which==='cam2' && state.camNumbers.cam1no){
        return pad4((parseInt(state.camNumbers.cam1no,10)||0)+1);
      }
      if (which==='cam1' && state.camNumbers.cam2no){
        const v = (parseInt(state.camNumbers.cam2no,10)||0)-1;
        return pad4(v<0?0:v);
      }

      // 3) ë§ˆì§€ë§‰ ì…ë ¥(ì„¸ì…˜ ê¸°ì¤€) +1
      if (state.lastCamNo!=null){
        return pad4((parseInt(state.lastCamNo,10)||0)+1);
      }

      // 4) ê¸°ë³¸ê°’
      return '0001';
    }

    // ====== NOTES ======
    async function loadNotes(){
      if(!CSV_NOTE_URL.includes('http')) return;
      try{
        const rows = await fetchCsv(CSV_NOTE_URL + `&cb=${Date.now()}`);
        renderNotes(rows);
      }catch(err){
        console.error(err);
      }
    }

    function renderNotes(rows, filterHandNumber = null){
      // Note ì‹œíŠ¸ êµ¬ì¡°: Code(íƒ€ì„ì½”ë“œ) | handNumber | Note (3ì»¬ëŸ¼)
      const listEl = document.getElementById('notes-list');
      const cntEl = document.getElementById('notes-count');
      
      // ë…¸íŠ¸ ì„¹ì…˜ ìˆ¨ê¹€/í‘œì‹œ ì²˜ë¦¬
      const notesSection = document.getElementById('notes-section');
      
      if(!rows || rows.length<2){ 
        if(filterHandNumber) {
          // íŠ¹ì • í•¸ë“œë¥¼ ë¡œë“œí–ˆëŠ”ë° ë…¸íŠ¸ê°€ ì—†ìœ¼ë©´ ì„¹ì…˜ ìˆ¨ê¹€
          notesSection.style.display = 'none';
        } else {
          listEl.innerHTML = '<p class="text-xs text-gray-500">ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; 
          cntEl.textContent='0';
        }
        return; 
      }

      // ë°ì´í„° íŒŒì‹± - Note ì‹œíŠ¸ ìŠ¤í‚¤ë§ˆì— ë§ê²Œ
      // Aì—´: íƒ€ì„ì½”ë“œ(epochSec), Bì—´: handNumber, Cì—´: Note
      const header = rows[0];
      let data = rows.slice(1)
        .filter(r => r && r.length >= 3 && r[2]) // ë…¸íŠ¸ í…ìŠ¤íŠ¸ê°€ ìˆëŠ” í–‰ë§Œ
        .map(r=>({
          timestamp: r[0]||'',  // Aì—´: íƒ€ì„ì½”ë“œ
          hand: r[1]||'',       // Bì—´: handNumber  
          text: r[2]||''        // Cì—´: Note
        }));

      // íŠ¹ì • í•¸ë“œ ë²ˆí˜¸ë¡œ í•„í„°ë§
      if(filterHandNumber) {
        data = data.filter(n => n.hand === String(filterHandNumber));
        if(data.length === 0) {
          notesSection.style.display = 'none';
          return;
        }
        notesSection.style.display = 'block';
      } else {
        // í•¸ë“œ ë¡œë“œê°€ ì•„ë‹Œ ê²½ìš° ë…¸íŠ¸ ì„¹ì…˜ ìˆ¨ê¹€
        notesSection.style.display = 'none';
        return;
      }

      // ìµœì‹ ìˆœ ì •ë ¬ (ì—­ìˆœ - ë‚˜ì¤‘ì— ì¶”ê°€ëœ ê²ƒì´ ë¨¼ì €)
      data.reverse();

      // í‘œì‹œí•  ë…¸íŠ¸ë“¤
      const toShow = data;
      
      listEl.innerHTML = toShow.map(n=>{
        // íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ë‚ ì§œë¡œ ë³€í™˜ (Unix timestampì¸ ê²½ìš°)
        const timeStr = n.timestamp ? new Date(parseInt(n.timestamp) * 1000).toLocaleString('ko-KR') : '';
        return `<div class="p-2 bg-gray-900/50 rounded mb-2">
          <div class="text-xs text-gray-400 mb-1">í•¸ë“œ #${n.hand} Â· ${timeStr}</div>
          <div class="text-sm text-white">${(n.text||'').replace(/</g,'&lt;').replace(/\n/g,'<br>')}</div>
        </div>`;
      }).join('');
      cntEl.textContent = String(toShow.length);
    }

    // ====== RESET & FEEDBACK ======
    function resetApp(){
      const lastNo = state.indexRows.length
        ? Math.max(...state.indexRows.map(r=>parseInt(r.handNumber,10)||0))
        : 0;
      state.playersInHand = [];
      state.board = [];
      state.currentStreet = 'preflop'; // ìŠ¤íŠ¸ë¦¬íŠ¸ ì´ˆê¸°í™”
      state.actionState = {
        handNumber: String(lastNo + 1),
        smallBlind: state.actionState.smallBlind,
        bigBlind: state.actionState.bigBlind,
        hasBBAnte: state.actionState.hasBBAnte,
        preflop: [], flop: [], turn: [], river: [],
      };
      renderAll(); saveActionState();
      el.handNumberDisplay.textContent = `#${state.actionState.handNumber}`;
      // ìƒˆ í•¸ë“œ ì‹œì‘ ì‹œ ë…¸íŠ¸ ì„¹ì…˜ ìˆ¨ê¹€
      document.getElementById('notes-section').style.display = 'none';
    }
    function showFeedback(msg,isErr=false){
      el.feedbackMessage.textContent = msg;
      el.feedbackMessage.className = `text-center h-4 text-xs font-semibold ${isErr?'text-red-400':'text-green-400'}`;
    }

    // ====== EVENT LISTENERS ======
    function setupEventListeners(){
      el.loadHandBtn.onclick = openLoadHandModal;
      el.refreshDataBtn.onclick = loadInitial;
      el.resetBtn.onclick = resetApp;
      
      // Cam ë²„íŠ¼ í´ë¦­
      el.cam1.addEventListener('click', ()=>{
        const prefill = computeCamPrefill('cam1');
        openKeypad(null, { purpose:'cam', cam:'cam1', prefill });
      });

      el.cam2.addEventListener('click', ()=>{
        const prefill = computeCamPrefill('cam2');
        openKeypad(null, { purpose:'cam', cam:'cam2', prefill });
      });
      // "ì‹œíŠ¸ ì „ì†¡" ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ â†’ ë°”ë¡œ ì „ì†¡ (ë…¸íŠ¸ ê¸°ëŠ¥ ì œê±°)
      el.sendToSheetBtn.onclick = () => { sendDataToGoogleSheet(); };
      
      // ë…¸íŠ¸ ëª¨ë‹¬ ê´€ë ¨ ì´ë²¤íŠ¸ ì œê±° (ë…¸íŠ¸ ê¸°ëŠ¥ ì‚­ì œ)
      
      el.showLogBtn.onclick = openLogModal;
      el.closeLogModalBtn.onclick = closeLogModal;
      
      // ë¡œê·¸ ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
      el.logModal.addEventListener('click', (e)=>{
        if(e.target === el.logModal) {
          closeLogModal();
        }
      });

      el.tableSelector.onchange = (e)=>{ state.selectedTable=e.target.value; state.playersInHand=[]; renderAll(); };
      el.timezoneSelector.onchange = (e)=>{ state.selectedTimezone=e.target.value; updateTimeDisplay(); renderAll(); };

      // í”Œë ˆì´ì–´ ì„ íƒ/í•´ì œ
      el.playerSelectionButtons.addEventListener('click', (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        const name = btn.dataset.playerName; if(!name) return;
        togglePlayerInHand(name);
      });

      // í”Œë ˆì´ì–´ ì¹´ë“œ/ì¹© ì…ë ¥
      el.playerDetailsSection.addEventListener('click', (e)=>{
        const cardPlaceholder = e.target.closest('.card-placeholder');
        const keypadBtn = e.target.closest('.keypad-icon-btn');
        const playerCard = e.target.closest('.player-card');
        if(!playerCard) return;
        if(cardPlaceholder){
          state.modalState.cardTarget = { target:'playerHand', player:cardPlaceholder.dataset.playerName, count:parseInt(cardPlaceholder.dataset.count) };
          openCardSelector();
        }else if(keypadBtn){
          const input = playerCard.querySelector('.player-chip-input');
          openKeypad(input, { purpose:'input' });
        }
      });

      // ìŠ¹ì í† ê¸€
      el.winnerButtons.addEventListener('click', (e)=>{
        const btn=e.target.closest('.set-winner-btn'); if(!btn) return;
        setPlayerRole(btn.dataset.playerName);
      });

      // ì¹© ì…ë ¥ í¬ë§·íŒ…
      el.playerDetailsSection.addEventListener('input', (e)=>{
        if(!e.target.classList.contains('player-chip-input')) return;
        const parent = e.target.closest('.player-card');
        const player = state.playersInHand.find(p=>p.name===parent.dataset.playerName);
        const raw = unformatNumber(e.target.value);
        if(player) player.chips = raw;
        e.target.value = formatNumber(raw);
        const nowIso = new Date().toISOString();
        if (player){
          player.chips = raw;
          player.chipsUpdatedAt = nowIso;     // â˜… ë§ˆì§€ë§‰ ìˆ˜ì • ì‹œê° ê¸°ë¡
        }
      });

      // ë³´ë“œ ì¹´ë“œ ì„ íƒ
      el.boardCardPlaceholders.addEventListener('click', (e)=>{
        const ph = e.target.closest('.card-placeholder'); if(!ph) return;
        state.modalState.cardTarget = { target:'board', index:parseInt(ph.dataset.index), count:parseInt(ph.dataset.count) };
        openCardSelector();
      });

      // ì¹´ë“œ ì„ íƒ ëª¨ë‹¬ ì´ë²¤íŠ¸
      el.cardSelectorModal.addEventListener('click', (e)=>{
        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        if(e.target === el.cardSelectorModal) {
          closeModal(el.cardSelectorModal);
          return;
        }
        // ë‹«ê¸° ë²„íŠ¼ í´ë¦­
        if(e.target.id==='close-card-modal') closeModal(el.cardSelectorModal);
      });

      // ìŠ¤íŠ¸ë¦¬íŠ¸ ë²„íŠ¼(ì¶”ê°€/ë˜ëŒë¦¬ê¸°/Pot êµì •/ìŠ¤íŠ¸ë¦¬íŠ¸ ì„ íƒ)
      el.streetLogsContainer.addEventListener('click', (e)=>{
        const streetBtn = e.target.closest('.street-select-btn');
        const addBtn = e.target.closest('.add-action-btn');
        const undoBtn = e.target.closest('.undo-action-btn');
        const potBtn = e.target.closest('.pot-keypad-btn');
        
        if(streetBtn) {
          state.currentStreet = streetBtn.dataset.street;
          renderActionStreets(); // í•˜ì´ë¼ì´íŠ¸ ì—…ë°ì´íŠ¸
        }
        if(addBtn) openActionPad(addBtn.dataset.street);
        if(undoBtn) undoLastAction(undoBtn.dataset.street);
        if(potBtn){
          state.modalState.actionPadStreet = potBtn.dataset.street;
          openKeypad(null, { purpose:'pot', currentPot: potBtn.dataset.currentPot });
        }
      });

      // ì•¡ì…˜ íŒ¨ë“œ ë‚´ë¶€ ë²„íŠ¼
      el.actionPadModal.addEventListener('click', (e)=>{
        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        if(e.target === el.actionPadModal) {
          closeModal(el.actionPadModal);
          return;
        }
        
        const btn = e.target.closest('button'); if(!btn) return;
        if(btn.id==='close-action-pad'){ closeModal(el.actionPadModal); return; }
        const modal = el.actionPadModal;
        if(btn.parentElement.id==='action-pad-players'){
          state.modalState.actionPadPlayer = btn.dataset.playerName;
          modal.querySelector('#action-pad-players').classList.add('hidden');
          modal.querySelector('#action-pad-actions').classList.remove('hidden');
        }else if(btn.parentElement.id==='action-pad-actions'){
          const action = btn.dataset.action;
          if(action==='Bet/Raises'){
            const st = state.modalState.actionPadStreet;
            const hasBet = state.actionState[st].some(a=>/BET|RAISE/i.test(a.action||''));
            state.modalState.actionPadCurrentAction = hasBet ? 'Raises' : 'Bets';
            closeModal(el.actionPadModal); openKeypad(null, { purpose:'bet' });
          }else if(action==='All In'){
            const p = state.playersInHand.find(pp=>pp.name===state.modalState.actionPadPlayer);
            if(p) addActionToLog('All In', p.chips);
          }else if(action==='Calls'){
            const st = state.modalState.actionPadStreet;
            const p = state.playersInHand.find(pp=>pp.name===state.modalState.actionPadPlayer);
            
            // ë§ˆì§€ë§‰ ë² íŒ…/ë ˆì´ì¦ˆ ì°¾ê¸°
            const lastBet = [...state.actionState[st]].reverse().find(a=>/BET|RAISE/i.test(a.action||''));
            const requiredAmt = lastBet ? lastBet.amount : unformatNumber(state.actionState.bigBlind);
            
            // í”Œë ˆì´ì–´ í˜„ì¬ ì¹©
            const playerChips = p ? parseInt(unformatNumber(p.chips), 10) : 0;
            
            // ì˜¬ì¸ ì½œ ì²´í¬: í•„ìš” ê¸ˆì•¡ì´ í”Œë ˆì´ì–´ ì¹©ë³´ë‹¤ í¬ë©´ ì˜¬ì¸
            if(playerChips > 0 && playerChips <= parseInt(unformatNumber(requiredAmt), 10)){
              // ì˜¬ì¸ ì½œ (í”Œë ˆì´ì–´ì˜ ëª¨ë“  ì¹©)
              addActionToLog('All In', p.chips);
            } else {
              // ì¼ë°˜ ì½œ
              addActionToLog('Calls', requiredAmt);
            }
          }else{
            addActionToLog(action);
          }
        }
      });

      // ë°”ê¹¥ìª½ í‚¤íŒ¨ë“œ ë²„íŠ¼(SB/BB ë“±)
      document.body.addEventListener('click', (e)=>{
        const kb = e.target.closest('.keypad-icon-btn');
        if(kb && !kb.closest('.player-card')) openKeypad(kb.previousElementSibling, { purpose:'input' });
      });

      // í‚¤íŒ¨ë“œ ì…ë ¥
      el.keypadModal.addEventListener('click', (e)=>{
        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        if(e.target === el.keypadModal) {
          closeModal(el.keypadModal);
          return;
        }
        
        const btn = e.target.closest('button'); if(!btn) return;
        const display = el.keypadModal.querySelector('#keypad-display');
        const key = btn.textContent;
        if(btn.id==='keypad-confirm'){
          const finalAmt = unformatNumber(display.textContent);
          const { purpose, currentPot } = state.modalState.keypadOptions;
          if(purpose==='cam'){
            const which = state.modalState.keypadOptions.cam; // 'cam1'|'cam2'
            const padded = pad4(finalAmt);
            if (which==='cam1'){
              state.camNumbers.cam1no = padded;
              state.lastCamNo = padded;
              showFeedback(`${state.camPreset.cam1 || 'Cam1'}: ${padded} ì…ë ¥ë¨`);
            }else if (which==='cam2'){
              state.camNumbers.cam2no = padded;
              state.lastCamNo = padded;
              showFeedback(`${state.camPreset.cam2 || 'Cam2'}: ${padded} ì…ë ¥ë¨`);
            }
          }else if(purpose==='bet'){
            if(finalAmt) addActionToLog(state.modalState.actionPadCurrentAction, finalAmt);
          }else if(purpose==='pot'){
            // Pot correction: ì…ë ¥í•œ ê°’ ê·¸ëŒ€ë¡œ ì €ì¥ (ì´ì „ íŒŸ í¬ê¸°ë¥¼ ë¹¼ì§€ ì•ŠìŒ)
            const potSize = finalAmt; // í¬ë§·ëœ ê°’ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            if(potSize){
              const st = state.modalState.actionPadStreet;
              // Pot Correctionì€ player ì—†ì´ ì €ì¥ (ì‹œìŠ¤í…œ ì•¡ì…˜)
              state.actionState[st].push({ 
                action:'Pot Correction', 
                amount:potSize,  // í¬ë§·ëœ ê°’ ê·¸ëŒ€ë¡œ ì €ì¥
                timestamp:new Date().toISOString() 
              });
              saveActionState(); renderAll();
            }
          }else if(purpose==='input'){
            if(state.modalState.keypadTarget){
              state.modalState.keypadTarget.value = display.textContent;
              state.modalState.keypadTarget.dispatchEvent(new Event('input',{bubbles:true}));
            }
          }
          closeModal(el.keypadModal);
        }else if(btn.id==='keypad-cancel'){ closeModal(el.keypadModal);
        }else if(key==='C'){ display.textContent='';
        }else if(key==='â†'){ display.textContent = formatNumber(unformatNumber(display.textContent).slice(0,-1));
        }else{
          display.textContent = formatNumber(unformatNumber(display.textContent) + key);
        }
      });

      // SB/BB/Ante ì²´í¬
      document.querySelectorAll('.number-input').forEach(inp=>{
        inp.addEventListener('input', (e)=>{
          const raw = unformatNumber(e.target.value);
          const fmt = formatNumber(raw);
          if(e.target.value!==fmt) e.target.value=fmt;
          const k = toCamelCase(e.target.id.replace('-input','')); // small-blind-input -> smallBlind
          if(k in state.actionState) state.actionState[k]=raw;
          saveActionState();
        });
      });
      el.bbAnteCheckbox.onchange = (e)=>{ state.actionState.hasBBAnte = e.target.checked; saveActionState(); renderAll(); };

      // Load Hand ëª¨ë‹¬ ë‚´ë¶€ í´ë¦­
      el.loadHandModal.addEventListener('click', (e)=>{
        // í•¸ë“œ í•­ëª© í´ë¦­ ìš°ì„  ì²˜ë¦¬
        const itemBtn = e.target.closest('.load-hand-item-btn');
        if(itemBtn){
          const no = itemBtn.dataset.no;
          const dt = itemBtn.dataset.date || null;
          loadHandData(no, dt);
          return;
        }
        
        // ë‹«ê¸° ë²„íŠ¼ í´ë¦­
        const closeBtn = e.target.closest('#close-load-hand-modal');
        if(closeBtn) {
          closeModal(el.loadHandModal);
          return;
        }
        
        // ëª¨ë‹¬ ì»¨í…ì¸  ì˜ì—­ í´ë¦­ì€ ë¬´ì‹œ
        const content = e.target.closest('.bg-gray-800');
        if(content) return;
        
        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        if (e.target === el.loadHandModal) {
          closeModal(el.loadHandModal);
        }
      });
    }

    // ====== INIT ======
    async function initializeApp(){
      el.logDisplay.innerHTML=''; openLogModal(); logMessage('ì•± ì´ˆê¸°í™” ì‹œì‘...');
      populateTimezones(); loadActionState();
      try{
        await loadInitial();
        // ì´ˆê¸°í™” ì‹œì—ëŠ” ë…¸íŠ¸ ì„¹ì…˜ ìˆ¨ê¹€ (í•¸ë“œ ë¡œë“œ ì‹œì—ë§Œ í‘œì‹œ)
        document.getElementById('notes-section').style.display = 'none';
        renderTableSelection();
        if(timeUpdater) clearInterval(timeUpdater);
        timeUpdater = setInterval(updateTimeDisplay, 1000);
        updateTimeDisplay();
        logMessage('ì¤€ë¹„ ì™„ë£Œ!');
      }catch(err){
        console.error(err); logMessage(`ì´ˆê¸°í™” ì‹¤íŒ¨: ${err.message}`, true);
      }finally{
        setTimeout(closeLogModal, 800);
      }
    }

    setupEventListeners();
    initializeApp();
  });
  </script>
</body>
</html>
