<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <title>Phase 1 í…ŒìŠ¤íŠ¸ - ActionHistory & ìŠ¤ë‚µë°”</title>
  <script src="https://cdn-tailwindcss.vercel.app/"></script>
  <script src="action-history.js"></script>
  <style>
    .snackbar {
      position: fixed;
      bottom: -60px;
      left: 10px;
      right: 10px;
      background: #333;
      color: white;
      padding: 12px;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: bottom 0.2s ease-out;
      z-index: 10000;
      font-size: 14px;
      max-width: 500px;
      margin: 0 auto;
    }
    .snackbar.show { bottom: 10px; }
    .snackbar-undo-btn {
      background: transparent;
      border: 1px solid white;
      color: white;
      padding: 4px 12px;
      border-radius: 3px;
      font-size: 12px;
      margin-left: 10px;
      cursor: pointer;
      min-width: 44px;
      min-height: 30px;
    }
    .snackbar-info { background: #2563eb; }
    .snackbar-error { background: #dc2626; }
    .snackbar-success { background: #16a34a; }
  </style>
</head>
<body class="bg-gray-900 text-white p-4">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold mb-6">Phase 1 í…ŒìŠ¤íŠ¸</h1>

    <div class="space-y-4">
      <!-- í…ŒìŠ¤íŠ¸ í”Œë ˆì´ì–´ ëª©ë¡ -->
      <div class="bg-gray-800 p-4 rounded-lg">
        <h2 class="text-lg font-bold mb-3">í”Œë ˆì´ì–´ ê´€ë¦¬</h2>
        <div id="player-list" class="space-y-2"></div>
      </div>

      <!-- í…ŒìŠ¤íŠ¸ ë²„íŠ¼ë“¤ -->
      <div class="bg-gray-800 p-4 rounded-lg">
        <h2 class="text-lg font-bold mb-3">í…ŒìŠ¤íŠ¸ ì•¡ì…˜</h2>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="addTestPlayer()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">
            í”Œë ˆì´ì–´ ì¶”ê°€
          </button>
          <button onclick="deleteTestPlayer()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded">
            í”Œë ˆì´ì–´ ì‚­ì œ
          </button>
          <button onclick="updateTestPlayer()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
            í”Œë ˆì´ì–´ ìˆ˜ì •
          </button>
          <button onclick="batchTest()" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded">
            ì¼ê´„ ì‘ì—…
          </button>
          <button onclick="testUndo()" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded">
            ì‹¤í–‰ ì·¨ì†Œ
          </button>
          <button onclick="clearHistory()" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">
            íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”
          </button>
        </div>
      </div>

      <!-- í…ŒìŠ¤íŠ¸ ê²°ê³¼ -->
      <div class="bg-gray-800 p-4 rounded-lg">
        <h2 class="text-lg font-bold mb-3">í…ŒìŠ¤íŠ¸ ê²°ê³¼</h2>
        <div id="test-results" class="space-y-2 text-sm font-mono">
          <div>âœ… ActionHistory ì‹œìŠ¤í…œ ë¡œë“œë¨</div>
        </div>
      </div>

      <!-- íˆìŠ¤í† ë¦¬ í˜„í™© -->
      <div class="bg-gray-800 p-4 rounded-lg">
        <h2 class="text-lg font-bold mb-3">íˆìŠ¤í† ë¦¬ í˜„í™©</h2>
        <div id="history-status" class="text-sm">
          íˆìŠ¤í† ë¦¬ ê°œìˆ˜: <span id="history-count">0</span> / 20
        </div>
        <div id="history-list" class="mt-2 space-y-1 text-xs"></div>
      </div>
    </div>
  </div>

  <!-- ìŠ¤ë‚µë°” -->
  <div id="snackbar" class="snackbar"></div>

  <script>
    // í…ŒìŠ¤íŠ¸ ë°ì´í„°
    let testPlayers = [
      { id: 1, name: 'Player1', seat: 1, chips: 1000 },
      { id: 2, name: 'Player2', seat: 2, chips: 2000 },
      { id: 3, name: 'Player3', seat: 3, chips: 1500 }
    ];

    // Mock tableManager
    window.tableManager = {
      deletePlayer: async (name) => {
        testPlayers = testPlayers.filter(p => p.name !== name);
        renderPlayers();
        return true;
      },
      addPlayer: async (player) => {
        testPlayers.push(player);
        renderPlayers();
        return true;
      },
      updatePlayer: async (player) => {
        const index = testPlayers.findIndex(p => p.id === player.id);
        if (index >= 0) {
          testPlayers[index] = player;
          renderPlayers();
        }
        return true;
      }
    };

    // í”Œë ˆì´ì–´ ëª©ë¡ ë Œë”ë§
    function renderPlayers() {
      const list = document.getElementById('player-list');
      list.innerHTML = testPlayers.map(p => `
        <div class="flex justify-between items-center bg-gray-700 p-2 rounded">
          <span>${p.name} (Seat ${p.seat})</span>
          <span class="text-amber-400">${p.chips} chips</span>
        </div>
      `).join('');
      updateHistoryStatus();
    }

    // íˆìŠ¤í† ë¦¬ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateHistoryStatus() {
      const count = window.actionHistory.history.length;
      document.getElementById('history-count').textContent = count;

      const list = document.getElementById('history-list');
      list.innerHTML = window.actionHistory.history.map((action, i) => `
        <div class="text-gray-400">${i + 1}. ${action.getDescription()}</div>
      `).join('');
    }

    // í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤
    async function addTestPlayer() {
      const num = testPlayers.length + 1;
      const newPlayer = {
        id: num,
        name: `Player${num}`,
        seat: num,
        chips: Math.floor(Math.random() * 5000) + 1000
      };

      const action = new AddPlayerAction(newPlayer);
      await window.actionHistory.execute(action);

      addResult('âœ… í”Œë ˆì´ì–´ ì¶”ê°€ í…ŒìŠ¤íŠ¸ ì™„ë£Œ');
    }

    async function deleteTestPlayer() {
      if (testPlayers.length === 0) {
        window.actionHistory.showSnackbar('ì‚­ì œí•  í”Œë ˆì´ì–´ê°€ ì—†ìŠµë‹ˆë‹¤', null, 'error');
        return;
      }

      const player = testPlayers[0];
      const action = new DeletePlayerAction(player);
      await window.actionHistory.execute(action);

      addResult('âœ… í”Œë ˆì´ì–´ ì‚­ì œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ');
    }

    async function updateTestPlayer() {
      if (testPlayers.length === 0) {
        window.actionHistory.showSnackbar('ìˆ˜ì •í•  í”Œë ˆì´ì–´ê°€ ì—†ìŠµë‹ˆë‹¤', null, 'error');
        return;
      }

      const oldPlayer = testPlayers[0];
      const newPlayer = { ...oldPlayer, chips: oldPlayer.chips + 500 };

      const action = new UpdatePlayerAction(oldPlayer, newPlayer);
      await window.actionHistory.execute(action);

      addResult('âœ… í”Œë ˆì´ì–´ ìˆ˜ì • í…ŒìŠ¤íŠ¸ ì™„ë£Œ');
    }

    async function batchTest() {
      const actions = [
        new AddPlayerAction({ id: 99, name: 'BatchTest1', seat: 99, chips: 9999 }),
        new AddPlayerAction({ id: 100, name: 'BatchTest2', seat: 100, chips: 10000 })
      ];

      const batch = new BatchAction(actions, '2ëª… ì¼ê´„ ì¶”ê°€');
      await window.actionHistory.execute(batch);

      addResult('âœ… ì¼ê´„ ì‘ì—… í…ŒìŠ¤íŠ¸ ì™„ë£Œ');
    }

    async function testUndo() {
      await window.actionHistory.undo();
      addResult('âœ… ì‹¤í–‰ ì·¨ì†Œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ');
    }

    function clearHistory() {
      window.actionHistory.clear();
      addResult('âœ… íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™” ì™„ë£Œ');
    }

    function addResult(message) {
      const results = document.getElementById('test-results');
      const div = document.createElement('div');
      div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      results.appendChild(div);

      // 10ê°œ ì´ìƒì´ë©´ ì˜¤ë˜ëœ ê²ƒ ì œê±°
      if (results.children.length > 10) {
        results.removeChild(results.firstChild);
      }
    }

    // ì´ˆê¸° ë Œë”ë§
    renderPlayers();

    // ìë™ í…ŒìŠ¤íŠ¸ ì‹œí€€ìŠ¤
    async function runAutoTest() {
      addResult('ğŸš€ ìë™ í…ŒìŠ¤íŠ¸ ì‹œì‘...');

      await new Promise(r => setTimeout(r, 1000));
      await addTestPlayer();

      await new Promise(r => setTimeout(r, 1500));
      await deleteTestPlayer();

      await new Promise(r => setTimeout(r, 1500));
      await testUndo();

      addResult('âœ… ìë™ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!');
    }

    // 5ì´ˆ í›„ ìë™ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    setTimeout(runAutoTest, 5000);
  </script>
</body>
</html>