<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>모듈 테스트 - 콘솔 버전</title>
</head>
<body>
    <h1>모듈 테스트 실행 중... (콘솔을 확인하세요)</h1>
    <p>F12를 눌러 개발자 도구를 열고 Console 탭을 확인하세요.</p>

    <!-- 모듈 로드 -->
    <script src="src/modules/filename-manager.js"></script>
    <script src="src/modules/ai-analyzer.js"></script>
    <script src="src/modules/filename-adapter.js"></script>

    <script>
        console.log('========================================');
        console.log('🧪 Virtual Table DB 모듈 테스트 시작');
        console.log('========================================');

        // 테스트 1: 모듈 로드 확인
        console.group('📦 TEST 1: 모듈 로드 확인');

        if (window.FilenameManager) {
            console.log('✅ FilenameManager 로드 성공');
            console.log('   - generateFilename 함수:', typeof window.FilenameManager.generateFilename);
            console.log('   - extractHandNumber 함수:', typeof window.FilenameManager.extractHandNumber);
            console.log('   - Map 크기:', window.FilenameManager.handToFilename.size);
        } else {
            console.error('❌ FilenameManager 로드 실패');
        }

        if (window.AIAnalyzer) {
            console.log('✅ AIAnalyzer 로드 성공');
            console.log('   - analyzeHand 함수:', typeof window.AIAnalyzer.analyzeHand);
            console.log('   - generateFileSummary 함수:', typeof window.AIAnalyzer.generateFileSummary);
            console.log('   - 캐시 크기:', window.AIAnalyzer.analysisCache.size);
        } else {
            console.error('❌ AIAnalyzer 로드 실패');
        }

        if (window.generateCustomFilename && window.extractHandNumberFromFilename) {
            console.log('✅ 호환성 어댑터 로드 성공');
            console.log('   - generateCustomFilename:', typeof window.generateCustomFilename);
            console.log('   - extractHandNumberFromFilename:', typeof window.extractHandNumberFromFilename);
        } else {
            console.error('❌ 호환성 어댑터 로드 실패');
        }
        console.groupEnd();

        // 테스트 2: 파일명 생성 테스트
        console.group('📝 TEST 2: 파일명 생성 테스트');

        async function testFilenameGeneration() {
            const testCases = [142, 999, 1, 50000];

            for (const handNumber of testCases) {
                const startTime = performance.now();
                const filename = await window.FilenameManager.generateFilename(handNumber);
                const endTime = performance.now();

                console.log(`✅ 핸드 #${handNumber}:`);
                console.log(`   생성된 파일명: "${filename}"`);
                console.log(`   소요 시간: ${(endTime - startTime).toFixed(3)}ms`);

                // 매핑 저장 확인
                const mapped = window.FilenameManager.handToFilename.get(handNumber);
                if (mapped) {
                    console.log(`   ✅ Map 저장 확인: ${mapped}`);
                } else {
                    console.warn(`   ⚠️ Map 저장 실패`);
                }
            }
        }

        // 테스트 3: 핸드번호 추출 테스트
        console.groupEnd();
        console.group('🔍 TEST 3: 핸드번호 추출 테스트');

        function testHandExtraction() {
            const testCases = [
                { filename: 'VT142_BTN_3bet_win', expected: 142 },
                { filename: 'H999_allin_fold', expected: 999 },
                { filename: '888_simple_hand', expected: 888 },
                { filename: 'T777_test', expected: 777 },
                { filename: 'invalid_name', expected: null }
            ];

            for (const test of testCases) {
                const startTime = performance.now();
                const result = window.FilenameManager.extractHandNumber(test.filename);
                const endTime = performance.now();

                if (result === test.expected) {
                    console.log(`✅ "${test.filename}"`);
                    console.log(`   추출된 핸드번호: ${result}`);
                    console.log(`   소요 시간: ${(endTime - startTime).toFixed(3)}ms`);
                } else {
                    console.error(`❌ "${test.filename}"`);
                    console.error(`   예상: ${test.expected}, 실제: ${result}`);
                }
            }
        }

        // 테스트 4: Map 기반 O(1) 성능 테스트
        console.groupEnd();
        console.group('⚡ TEST 4: Map 성능 벤치마크');

        async function testMapPerformance() {
            // 1000개 파일명 생성 (캐시 채우기)
            console.log('📊 1000개 핸드 파일명 생성 중...');
            const genStart = performance.now();
            for (let i = 1; i <= 1000; i++) {
                await window.FilenameManager.generateFilename(i);
            }
            const genEnd = performance.now();
            console.log(`✅ 생성 완료: ${(genEnd - genStart).toFixed(2)}ms`);
            console.log(`   Map 크기: ${window.FilenameManager.handToFilename.size}`);

            // Map 조회 성능 테스트 (10000회)
            console.log('\n📊 Map 조회 성능 테스트 (10000회)...');
            const lookupStart = performance.now();
            for (let i = 0; i < 10000; i++) {
                const handNum = Math.floor(Math.random() * 1000) + 1;
                window.FilenameManager.handToFilename.get(handNum);
            }
            const lookupEnd = performance.now();
            const avgLookup = (lookupEnd - lookupStart) / 10000;

            console.log(`✅ 조회 완료: ${(lookupEnd - lookupStart).toFixed(2)}ms`);
            console.log(`   평균 조회 시간: ${avgLookup.toFixed(4)}ms`);

            if (avgLookup < 0.01) {
                console.log('   🎯 O(1) 성능 확인! (< 0.01ms)');
            } else {
                console.warn('   ⚠️ 성능 최적화 필요');
            }
        }

        // 테스트 5: 호환성 테스트
        console.groupEnd();
        console.group('🔄 TEST 5: 레거시 함수 호환성');

        async function testCompatibility() {
            // 레거시 함수 테스트
            console.log('📊 레거시 함수 호출 테스트...');

            try {
                // generateCustomFilename 테스트
                const filename = await window.generateCustomFilename(555);
                console.log(`✅ generateCustomFilename(555): "${filename}"`);

                // extractHandNumberFromFilename 테스트
                const handNum = window.extractHandNumberFromFilename('VT666_test');
                console.log(`✅ extractHandNumberFromFilename('VT666_test'): ${handNum}`);

                // analyzeHandWithAI 테스트
                if (window.analyzeHandWithAI) {
                    console.log('✅ analyzeHandWithAI 함수 존재');
                }

                // generateAIFileSummary 테스트
                if (window.generateAIFileSummary) {
                    console.log('✅ generateAIFileSummary 함수 존재');
                }

                console.log('🎉 모든 레거시 함수 호환성 확인!');
            } catch (error) {
                console.error('❌ 호환성 오류:', error);
            }
        }

        // 모든 테스트 실행
        async function runAllTests() {
            console.log('\n🚀 모든 테스트 실행 중...\n');

            await testFilenameGeneration();
            console.groupEnd();

            console.group('🔍 TEST 3: 핸드번호 추출 테스트');
            testHandExtraction();
            console.groupEnd();

            console.group('⚡ TEST 4: Map 성능 벤치마크');
            await testMapPerformance();
            console.groupEnd();

            console.group('🔄 TEST 5: 레거시 함수 호환성');
            await testCompatibility();
            console.groupEnd();

            // 최종 요약
            console.log('\n========================================');
            console.log('📊 테스트 완료 요약');
            console.log('========================================');
            console.log(`✅ FilenameManager Map 크기: ${window.FilenameManager.handToFilename.size}`);
            console.log(`✅ 양방향 매핑 크기: ${window.FilenameManager.filenameToHand.size}`);
            console.log(`✅ AI 캐시 크기: ${window.AIAnalyzer.analysisCache.size}`);
            console.log('✅ 모든 테스트 완료!');
            console.log('========================================');
        }

        // 페이지 로드 후 자동 실행
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 1000);
        });
    </script>
</body>
</html>