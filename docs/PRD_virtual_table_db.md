# PRD: Virtual Table DB v13.5.11

**Product Requirements Document**
**프로젝트**: Virtual Table DB Claude
**현재 버전**: v13.5.11
**문서 버전**: 1.0.0
**작성일**: 2025-10-05
**상태**: ✅ 운영 중

---

## 📋 목차

1. [제품 개요](#제품-개요)
2. [비즈니스 요구사항](#비즈니스-요구사항)
3. [기능 요구사항](#기능-요구사항)
4. [비기능 요구사항](#비기능-요구사항)
5. [사용자 스토리](#사용자-스토리)
6. [우선순위 및 로드맵](#우선순위-및-로드맵)

---

## 🎯 제품 개요

### 1.1 제품 비전
포커 핸드 데이터를 실시간으로 모니터링하고 AI 기반 분석을 제공하는 통합 관리 시스템

### 1.2 핵심 가치 제안
- **실시간 감지**: SSE를 통한 새 핸드 자동 감지 및 알림
- **AI 분석**: Gemini API를 활용한 핸드 자동 분석
- **데이터 동기화**: Google Sheets와 실시간 양방향 연동
- **자동화**: 파일명 및 자막 자동 생성

### 1.3 타겟 사용자
- 포커 영상 제작자
- 포커 게임 운영자
- 데이터 분석가

### 1.4 성공 지표
- 핸드 처리 속도: < 2초
- 시스템 가동률: > 99%
- AI 분석 정확도: > 90%
- 사용자 만족도: > 4.5/5

---

## 💼 비즈니스 요구사항

### 2.1 핵심 비즈니스 목표
1. **효율성 향상**: 수동 작업 시간 80% 단축
2. **정확성 보장**: 데이터 입력 오류 95% 감소
3. **확장성 확보**: 일일 처리량 1000+ 핸드 지원

### 2.2 제약사항
- **기술 스택**: 순수 HTML/CSS/JavaScript (프레임워크 없음)
- **인프라**: GitHub Pages + Google Apps Script
- **비용**: 무료 티어 범위 내 운영
- **브라우저**: Chrome/Edge 최신 버전 지원

### 2.3 이해관계자
- **운영팀**: 실시간 모니터링 및 데이터 관리
- **영상팀**: 파일명 및 자막 정보 활용
- **개발팀**: 시스템 유지보수 및 개선

---

## ⚙️ 기능 요구사항

### 3.1 핵심 기능 (P0 - 필수)

#### F1. 실시간 핸드 감지
- **요구사항**: 새로운 핸드 추가 시 자동 감지 및 브라우저 알림
- **입력**: Google Sheets 데이터 변경 이벤트
- **출력**: 토스트 알림 + 테이블 자동 업데이트
- **성능**: 감지 지연 < 3초

#### F2. Google Sheets 양방향 동기화
- **요구사항**: Virtual/Hand 시트 데이터 읽기/쓰기
- **지원 열** (실제 구현):
  - A열: 테이블명
  - B열: 시간 (HH:MM:SS, ±3분 매칭 허용)
  - D열: 핸드 번호
  - E열: 상태 (미완료/복사완료)
  - F열: 파일명 (자동 생성)
  - G열: 드롭다운 값 (체크박스 대체)
  - H열: AI 분석 결과
  - I열: 업데이트 시간 (자동)
  - J열: 자막 정보
- **성능**: API 응답 < 2초
- **캐싱**: SheetDataCache (TTL 5분, 최대 2000행)

#### F3. AI 핸드 분석
- **요구사항**: Gemini API를 통한 핸드 자동 분석
- **입력**: 핸드 정보 (플레이어, 액션, 결과)
- **출력**: 전략적 분석 텍스트 (최대 100자)
- **저장**: H열에 자동 저장
- **캐싱 전략** (실제 구현):
  - Map 기반 메모리 캐시
  - TTL: 24시간
  - 핸드 번호 기반 중복 방지
- **Fallback**: 여러 Gemini 모델 순차 시도

#### F4. 자동 파일명 생성
- **요구사항**: 플레이어 정보 기반 파일명 자동 생성
- **형식** (실제 구현): `{prefix}{handNumber}_{player1}_{cards1}_{player2}_{cards2}...{suffix}`
- **예시**: `H12345_Alice_AK_Bob_QQ`
- **특징**:
  - **모든 플레이어** 정보 포함 (hero/villain만이 아님)
  - 플레이어명 + 카드 조합
  - 연속 밑줄(_) 자동 정규화
- **저장**: F열 + handToFilenameMapping (Map)
- **특수문자 처리**: 정규화 및 제거
- **코드 위치**: index.html 라인 933

#### F5. 자막 생성 (키 플레이어)
- **요구사항**: 키 플레이어 자동 감지 및 자막 생성
- **조건**: Hand 시트 J열 = "True"
- **형식**:
  ```
  "
  국가
  이름(대문자)
  CURRENT STACK - 스택 (BB)
  "
  ```
- **트리거**: 편집 버튼 클릭
- **저장**: J열에 자동 저장

### 3.2 부가 기능 (P1 - 중요)

#### F6. 상태 관리
- **미완료/복사완료** 상태 전환
- **편집 버튼**: 미완료 상태로 설정
- **완료 버튼**: 복사완료 상태로 설정
- **UI**: 버튼 활성화/비활성화 자동 처리

#### F7. 중복 제거
- **요구사항**: G열 드롭다운 기반 중복 플레이어 제거 (체크박스에서 변경됨)
- **로직**: 동일 테이블에서 선택된 값에 따라 필터링
- **UI**: 실시간 테이블 업데이트
- **구현**: g-column-checkbox-handler.js

### 3.3 미래 기능 (P2 - 선택)

#### F8. 통계 대시보드
- 일별/주별 핸드 처리량
- AI 분석 품질 메트릭
- 에러율 모니터링

#### F9. 다중 언어 지원
- 한국어/영어 UI
- 자막 다국어 생성

#### F10. 오프라인 모드
- 서비스 워커 기반 캐싱
- 네트워크 재연결 시 동기화

---

## 🔧 비기능 요구사항

### 4.1 성능 (Performance)
| 메트릭 | 목표 | 현재 |
|--------|------|------|
| 초기 로딩 시간 | < 2초 | ~3초 |
| API 응답 시간 | < 2초 | ~2초 |
| 메모리 사용량 | < 100MB | ~85MB |
| 번들 크기 | < 200KB | 357KB ⚠️ |

### 4.2 보안 (Security) - 실제 현황

**현재 취약점** (코드 리뷰 결과):
- ❌ **Critical**: API 키 평문 노출 (localStorage, index.html 라인 5320)
- ❌ **High**: XSS 취약점 19곳 (innerHTML 사용)
- ⚠️ **Medium**: CORS 헤더 미흡 (appScripts.gs 라인 13)
- ❌ **Low**: CSRF 토큰 미구현
- ⚠️ **Low**: 입력 검증 부족

**개선 계획**:
- CryptoJS 기반 API 키 암호화
- DOMPurify 라이브러리 도입
- CORS Access-Control-Allow-Origin 화이트리스트
- 총 12개 보안 이슈 해결 필요

### 4.3 안정성 (Reliability)
- **가동률**: 99.9% 목표
- **에러율**: < 0.1%
- **데이터 일관성**: 100%
- **백업**: Google Sheets 자동 버전 관리

### 4.4 확장성 (Scalability)
- **동시 사용자**: 10명 (현재)
- **핸드 처리량**: 1000개/일 (목표)
- **데이터 크기**: 최대 5MB (localStorage 한계)

### 4.5 사용성 (Usability)
- **학습 곡선**: 신규 사용자 < 10분
- **접근성**: WCAG 2.1 Level A 준수 (목표)
- **반응형**: 데스크톱 최적화 (모바일 지원 예정)

### 4.6 유지보수성 (Maintainability) - 실제 현황

**현재 상태**:
- **테스트 커버리지**: 0% (테스트 코드 없음)
- **코드 품질**: ESLint 미도입
- **문서화**: 부분적 (JSDoc 없음)
- **모듈화**: 단일 파일 (357KB index.html)

**코드 복잡도** (추정):
- refreshCache(): 15+ 분기
- findClosestRow(): 12+ 분기
- handleSheetUpdate(): 10+ 분기

**전역 변수**: 10개 이상 (window 네임스페이스 오염)

**개선 계획**:
- Jest 단위 테스트 (목표: 80% 커버리지)
- ESLint + Prettier 도입
- 모듈 분리 (7개 모듈로 리팩토링)
- **테스트 커버리지**: 80% 목표 (현재 0%)
- **문서화**: JSDoc 주석 (부분적)
- **버전 관리**: Semantic Versioning 준수

---

## 👤 사용자 스토리

### Epic 1: 핸드 모니터링
```gherkin
Feature: 실시간 핸드 감지
  As a 포커 운영자
  I want to 새 핸드를 자동으로 감지하고
  So that 수동 새로고침 없이 최신 데이터를 볼 수 있다

  Scenario: 새 핸드 추가 알림
    Given Google Sheets에 새 핸드가 추가되었을 때
    When SSE 이벤트가 발생하면
    Then 브라우저 알림이 표시되고
    And 테이블이 자동으로 업데이트된다
```

### Epic 2: AI 분석
```gherkin
Feature: AI 핸드 분석
  As a 데이터 분석가
  I want to 핸드를 AI로 분석하고
  So that 전략적 인사이트를 얻을 수 있다

  Scenario: 핸드 분석 요청
    Given 핸드 번호 "12345"가 선택되었을 때
    When AI 분석 버튼을 클릭하면
    Then Gemini API로 분석을 요청하고
    And H열에 결과가 저장된다
    And 캐시에 저장되어 재분석을 방지한다
```

### Epic 3: 파일명 생성
```gherkin
Feature: 자동 파일명 생성
  As a 영상 제작자
  I want to 플레이어 정보로 파일명을 자동 생성하고
  So that 일관된 파일명 규칙을 유지할 수 있다

  Scenario: 파일명 생성 및 저장
    Given 테이블 "T1", 핸드 "12345", 플레이어 ["Alice", "Bob"]
    When 편집 버튼을 클릭하면
    Then "T1_12345_Alice_Bob.mp4" 파일명이 생성되고
    And F열에 자동 저장된다
```

### Epic 4: 자막 생성
```gherkin
Feature: 키 플레이어 자막 생성
  As a 영상 제작자
  I want to 키 플레이어의 자막을 자동 생성하고
  So that 영상 편집 시간을 단축할 수 있다

  Scenario: 자막 생성
    Given Hand 시트 J열이 "True"인 플레이어가 있을 때
    When 편집 버튼을 클릭하면
    Then 다음 형식의 자막이 생성된다:
      """

      KOR
      ALICE
      CURRENT STACK - 50,000 (100)

      """
    And J열에 저장된다
```

---

## 🗓️ 우선순위 및 로드맵

### Phase 1: 보안 강화 (v13.6.0) - 1주일
**목표**: Critical 보안 이슈 해결

- [ ] API 키 암호화 구현
- [ ] XSS 방어 (DOMPurify)
- [ ] CORS 헤더 강화
- [ ] 입력 검증 추가

### Phase 2: 성능 최적화 (v13.7.0) - 1주일
**목표**: 번들 크기 50% 감소

- [ ] 코드 스플리팅
- [ ] 레이지 로딩
- [ ] 캐싱 전략 개선
- [ ] Virtual Scrolling

### Phase 3: 코드 품질 (v14.0.0) - 2주일
**목표**: 테스트 커버리지 80%

- [ ] 모듈화 리팩토링
- [ ] Jest 단위 테스트
- [ ] Playwright E2E 테스트
- [ ] ESLint/Prettier 설정

### Phase 4: 기능 확장 (v14.1.0) - 2주일
**목표**: P2 기능 구현

- [ ] 통계 대시보드
- [ ] 다중 언어 지원
- [ ] 오프라인 모드

---

## 📊 성공 메트릭

### KPI (Key Performance Indicators)
1. **처리 효율**: 핸드당 평균 처리 시간 < 5초
2. **정확도**: AI 분석 만족도 > 4.0/5
3. **안정성**: 월간 다운타임 < 1시간
4. **사용성**: 신규 사용자 온보딩 < 10분

### OKR (Objectives and Key Results)
**O1**: 운영 효율 2배 향상
- KR1: 수동 작업 80% → 20% 감소
- KR2: 핸드 처리량 500 → 1000개/일

**O2**: 코드 품질 90점 달성
- KR1: 테스트 커버리지 0% → 80%
- KR2: 보안 취약점 12개 → 0개
- KR3: Lighthouse 점수 60 → 90+

---

## 📎 부록

### A. 용어 정의
- **핸드 (Hand)**: 포커 게임의 한 판
- **테이블 (Table)**: 게임이 진행되는 가상 테이블
- **키 플레이어**: 자막 생성 대상 플레이어 (J열=True)
- **BB**: 빅 블라인드 (Big Blind)

### B. 참고 문서
- [LLD_virtual_table_db.md](./LLD_virtual_table_db.md) - 기술 설계 문서
- [PLAN_virtual_table_db.md](./PLAN_virtual_table_db.md) - 실행 계획
- [README.md](./README.md) - 프로젝트 소개

### C. 변경 이력
| 버전 | 날짜 | 변경사항 |
|------|------|----------|
| 1.0.0 | 2025-10-05 | 초기 PRD 작성 (v13.5.11 기준) |

---

**승인**: Development Team
**검토**: Project Manager
**다음 리뷰**: 2025-10-19
