<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day 3 증분 업데이트 테스트</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .test-pass { color: #10b981; }
        .test-fail { color: #ef4444; }
        .test-running { color: #f59e0b; }
        .console-log {
            background: #1f2937;
            color: #f9fafb;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 8px;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="bg-gray-900 text-white p-6">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">📊 Day 3 증분 업데이트 테스트</h1>

        <!-- 테스트 진행 상황 -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">테스트 진행 상황</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-gray-700 rounded p-4">
                    <div class="text-sm text-gray-400">총 테스트</div>
                    <div id="total-tests" class="text-2xl font-bold">0</div>
                </div>
                <div class="bg-green-900 rounded p-4">
                    <div class="text-sm text-gray-400">통과</div>
                    <div id="passed-tests" class="text-2xl font-bold text-green-400">0</div>
                </div>
                <div class="bg-red-900 rounded p-4">
                    <div class="text-sm text-gray-400">실패</div>
                    <div id="failed-tests" class="text-2xl font-bold text-red-400">0</div>
                </div>
            </div>
            <div class="mt-4">
                <div class="w-full bg-gray-700 rounded-full h-2">
                    <div id="progress-bar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- 테스트 제어 -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">테스트 제어</h2>
            <div class="flex gap-4">
                <button id="run-all-tests" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                    모든 테스트 실행
                </button>
                <button id="run-unit-tests" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">
                    단위 테스트만
                </button>
                <button id="run-integration-tests" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded">
                    통합 테스트만
                </button>
                <button id="clear-results" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">
                    결과 초기화
                </button>
            </div>
        </div>

        <!-- 테스트 결과 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- 단위 테스트 -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">🧪 단위 테스트</h3>
                <div id="unit-test-results" class="space-y-2"></div>
            </div>

            <!-- 통합 테스트 -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">🔗 통합 테스트</h3>
                <div id="integration-test-results" class="space-y-2"></div>
            </div>
        </div>

        <!-- 성능 메트릭 -->
        <div class="bg-gray-800 rounded-lg p-6 mt-6">
            <h3 class="text-lg font-semibold mb-4">📈 성능 메트릭</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-gray-700 rounded p-4">
                    <div class="text-sm text-gray-400">델타 계산 시간</div>
                    <div id="delta-time" class="text-xl font-bold">-</div>
                </div>
                <div class="bg-gray-700 rounded p-4">
                    <div class="text-sm text-gray-400">충돌 해결 시간</div>
                    <div id="conflict-time" class="text-xl font-bold">-</div>
                </div>
                <div class="bg-gray-700 rounded p-4">
                    <div class="text-sm text-gray-400">데이터 압축률</div>
                    <div id="compression-ratio" class="text-xl font-bold">-</div>
                </div>
                <div class="bg-gray-700 rounded p-4">
                    <div class="text-sm text-gray-400">메모리 사용량</div>
                    <div id="memory-usage" class="text-xl font-bold">-</div>
                </div>
            </div>
        </div>

        <!-- 콘솔 로그 -->
        <div class="bg-gray-800 rounded-lg p-6 mt-6">
            <h3 class="text-lg font-semibold mb-4">📋 테스트 로그</h3>
            <div id="console-output" class="console-log">테스트 로그가 여기에 표시됩니다...\n</div>
        </div>
    </div>

    <!-- 증분 업데이트 매니저 로드 -->
    <script src="incremental_manager.js"></script>

    <script>
        // 테스트 상태 관리
        let testStats = {
            total: 0,
            passed: 0,
            failed: 0
        };

        // 콘솔 로그 함수
        function log(message, type = 'info') {
            const output = document.getElementById('console-output');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : '📝';
            output.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }

        // 테스트 결과 업데이트
        function updateTestStats() {
            document.getElementById('total-tests').textContent = testStats.total;
            document.getElementById('passed-tests').textContent = testStats.passed;
            document.getElementById('failed-tests').textContent = testStats.failed;

            const progress = testStats.total > 0 ? ((testStats.passed + testStats.failed) / testStats.total) * 100 : 0;
            document.getElementById('progress-bar').style.width = progress + '%';
        }

        // 테스트 결과 표시
        function displayTestResult(category, testName, passed, details = '') {
            const container = category === 'unit' ?
                document.getElementById('unit-test-results') :
                document.getElementById('integration-test-results');

            const resultDiv = document.createElement('div');
            resultDiv.className = `p-3 rounded ${passed ? 'bg-green-900 border border-green-600' : 'bg-red-900 border border-red-600'}`;

            resultDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="${passed ? 'test-pass' : 'test-fail'}">${passed ? '✅' : '❌'} ${testName}</span>
                    <span class="text-xs text-gray-400">${passed ? 'PASS' : 'FAIL'}</span>
                </div>
                ${details ? `<div class="text-sm text-gray-300 mt-1">${details}</div>` : ''}
            `;

            container.appendChild(resultDiv);

            if (passed) {
                testStats.passed++;
                log(`✅ ${testName} 테스트 통과`, 'success');
            } else {
                testStats.failed++;
                log(`❌ ${testName} 테스트 실패: ${details}`, 'error');
            }

            updateTestStats();
        }

        // ========================================
        // 단위 테스트
        // ========================================

        async function runUnitTests() {
            log('🧪 단위 테스트 시작');

            // TC1: 델타 계산 정확성
            await testDeltaCalculation();

            // TC2: 클라이언트 ID 생성
            await testClientIdGeneration();

            // TC3: 버전 해시 일관성
            await testVersionHashing();

            // TC4: 충돌 감지
            await testConflictDetection();

            // TC5: 충돌 해결 전략
            await testConflictResolution();

            log('🧪 단위 테스트 완료');
        }

        async function testDeltaCalculation() {
            testStats.total++;

            try {
                const oldData = [
                    ['A1', 'B1', 'C1'],
                    ['A2', 'B2', 'C2'],
                    ['A3', 'B3', 'C3']
                ];

                const newData = [
                    ['A1', 'B1_modified', 'C1'],  // 수정
                    ['A2', 'B2', 'C2'],            // 변경 없음
                    ['A3', 'B3', 'C3'],            // 변경 없음
                    ['A4', 'B4', 'C4']             // 추가
                ];

                // 앱스 스크립트의 calculateDelta 함수 시뮬레이션
                const delta = simulateCalculateDelta(oldData, newData);

                const expectedModified = 1;
                const expectedAdded = 1;
                const expectedDeleted = 0;

                const passed =
                    delta.modified.length === expectedModified &&
                    delta.added.length === expectedAdded &&
                    delta.deleted.length === expectedDeleted;

                displayTestResult('unit', '델타 계산 정확성', passed,
                    `수정: ${delta.modified.length}/${expectedModified}, 추가: ${delta.added.length}/${expectedAdded}, 삭제: ${delta.deleted.length}/${expectedDeleted}`);

            } catch (error) {
                displayTestResult('unit', '델타 계산 정확성', false, error.message);
            }
        }

        async function testClientIdGeneration() {
            testStats.total++;

            try {
                const manager = new IncrementalUpdateManager('test-url');
                const clientId1 = manager.clientId;

                const manager2 = new IncrementalUpdateManager('test-url');
                const clientId2 = manager2.clientId;

                const passed =
                    clientId1 !== clientId2 &&
                    clientId1.startsWith('client_') &&
                    clientId2.startsWith('client_');

                displayTestResult('unit', '클라이언트 ID 생성', passed,
                    `ID1: ${clientId1.substring(0, 20)}..., ID2: ${clientId2.substring(0, 20)}...`);

            } catch (error) {
                displayTestResult('unit', '클라이언트 ID 생성', false, error.message);
            }
        }

        async function testVersionHashing() {
            testStats.total++;

            try {
                const data1 = [['A', 'B'], ['C', 'D']];
                const data2 = [['A', 'B'], ['C', 'D']];
                const data3 = [['A', 'B'], ['C', 'E']];

                const hash1 = simulateGenerateVersion(data1);
                const hash2 = simulateGenerateVersion(data2);
                const hash3 = simulateGenerateVersion(data3);

                const passed = hash1 === hash2 && hash1 !== hash3;

                displayTestResult('unit', '버전 해시 일관성', passed,
                    `동일 데이터 해시 일치: ${hash1 === hash2}, 다른 데이터 해시 상이: ${hash1 !== hash3}`);

            } catch (error) {
                displayTestResult('unit', '버전 해시 일관성', false, error.message);
            }
        }

        async function testConflictDetection() {
            testStats.total++;

            try {
                const manager = new IncrementalUpdateManager('test-url');

                const localChanges = [{
                    row: 0,
                    col: 1,
                    newValue: 'Client_Value'
                }];

                const serverDelta = {
                    modified: [{
                        row: 0,
                        cells: [{
                            col: 1,
                            newValue: 'Server_Value'
                        }]
                    }]
                };

                const conflicts = manager.detectConflicts(localChanges, serverDelta);

                const passed = conflicts.length === 1 &&
                    conflicts[0].row === 0 &&
                    conflicts[0].col === 1;

                displayTestResult('unit', '충돌 감지', passed,
                    `감지된 충돌: ${conflicts.length}개`);

            } catch (error) {
                displayTestResult('unit', '충돌 감지', false, error.message);
            }
        }

        async function testConflictResolution() {
            testStats.total++;

            try {
                const manager = new IncrementalUpdateManager('test-url');

                const conflicts = [{
                    row: 0,
                    col: 1,
                    localValue: 'Client',
                    serverValue: 'Server'
                }];

                // Server-wins 전략 테스트
                manager.setConflictStrategy('server-wins');
                const resolutions = manager.applyConflictStrategy(conflicts);

                const passed = resolutions.length === 1 &&
                    resolutions[0].value === 'Server' &&
                    resolutions[0].strategy === 'server-wins';

                displayTestResult('unit', '충돌 해결 전략', passed,
                    `해결 전략: ${resolutions[0]?.strategy}, 결과: ${resolutions[0]?.value}`);

            } catch (error) {
                displayTestResult('unit', '충돌 해결 전략', false, error.message);
            }
        }

        // ========================================
        // 통합 테스트
        // ========================================

        async function runIntegrationTests() {
            log('🔗 통합 테스트 시작');

            // TC6: 전체 워크플로우
            await testFullWorkflow();

            // TC7: 성능 벤치마크
            await testPerformanceBenchmark();

            // TC8: 메모리 관리
            await testMemoryManagement();

            // TC9: 이벤트 시스템
            await testEventSystem();

            log('🔗 통합 테스트 완료');
        }

        async function testFullWorkflow() {
            testStats.total++;

            try {
                const manager = new IncrementalUpdateManager('test-url');
                let eventsFired = 0;

                // 이벤트 리스너 등록
                manager.on('deltaReceived', () => eventsFired++);
                manager.on('deltaApplied', () => eventsFired++);

                // 시뮬레이션 업데이트 적용
                const mockUpdate = {
                    type: 'incremental',
                    version: 'test-version',
                    delta: {
                        added: [{ row: 0, data: ['New', 'Row'] }],
                        modified: [],
                        deleted: []
                    },
                    stats: { added: 1, modified: 0, deleted: 0 }
                };

                await manager.applyUpdate(mockUpdate);

                const passed =
                    manager.currentVersion === 'test-version' &&
                    manager.dataStore.length === 1 &&
                    eventsFired === 2;

                displayTestResult('integration', '전체 워크플로우', passed,
                    `버전 업데이트: ${manager.currentVersion === 'test-version'}, 데이터 적용: ${manager.dataStore.length}행, 이벤트: ${eventsFired}개`);

            } catch (error) {
                displayTestResult('integration', '전체 워크플로우', false, error.message);
            }
        }

        async function testPerformanceBenchmark() {
            testStats.total++;

            try {
                const startTime = performance.now();

                // 대용량 데이터 시뮬레이션
                const largeOldData = Array(100).fill(null).map((_, i) =>
                    Array(10).fill(null).map((_, j) => `R${i}C${j}`)
                );

                const largeNewData = largeOldData.map(row =>
                    row.map(cell => Math.random() < 0.1 ? cell + '_modified' : cell)
                );

                const delta = simulateCalculateDelta(largeOldData, largeNewData);
                const elapsed = performance.now() - startTime;

                // 성능 메트릭 업데이트
                document.getElementById('delta-time').textContent = elapsed.toFixed(1) + 'ms';

                const passed = elapsed < 100; // 100ms 이내

                displayTestResult('integration', '성능 벤치마크', passed,
                    `100x10 데이터 처리 시간: ${elapsed.toFixed(1)}ms (기준: <100ms)`);

            } catch (error) {
                displayTestResult('integration', '성능 벤치마크', false, error.message);
            }
        }

        async function testMemoryManagement() {
            testStats.total++;

            try {
                const initialMemory = performance.memory ? performance.memory.usedJSHeapSize : 0;
                const manager = new IncrementalUpdateManager('test-url');

                // 여러 업데이트 시뮬레이션
                for (let i = 0; i < 50; i++) {
                    const mockUpdate = {
                        type: 'incremental',
                        version: `version-${i}`,
                        delta: {
                            added: [{ row: i, data: [`Data${i}`, `Value${i}`] }],
                            modified: [],
                            deleted: []
                        },
                        stats: { added: 1, modified: 0, deleted: 0 }
                    };
                    await manager.applyUpdate(mockUpdate);
                }

                const finalMemory = performance.memory ? performance.memory.usedJSHeapSize : 0;
                const memoryIncrease = finalMemory - initialMemory;

                // 메모리 사용량 업데이트
                document.getElementById('memory-usage').textContent =
                    (memoryIncrease / 1024 / 1024).toFixed(2) + 'MB';

                const passed = memoryIncrease < 10 * 1024 * 1024; // 10MB 이내

                displayTestResult('integration', '메모리 관리', passed,
                    `50회 업데이트 후 메모리 증가: ${(memoryIncrease / 1024 / 1024).toFixed(2)}MB`);

            } catch (error) {
                displayTestResult('integration', '메모리 관리', false, error.message);
            }
        }

        async function testEventSystem() {
            testStats.total++;

            try {
                const manager = new IncrementalUpdateManager('test-url');
                const events = [];

                // 이벤트 리스너 등록
                manager.on('deltaReceived', (data) => events.push('deltaReceived'));
                manager.on('deltaApplied', (data) => events.push('deltaApplied'));
                manager.on('conflictDetected', (data) => events.push('conflictDetected'));

                // 이벤트 발생 시뮬레이션
                manager.emit('deltaReceived', { test: true });
                manager.emit('deltaApplied', { test: true });
                manager.emit('conflictDetected', { test: true });

                const passed = events.length === 3 &&
                    events.includes('deltaReceived') &&
                    events.includes('deltaApplied') &&
                    events.includes('conflictDetected');

                displayTestResult('integration', '이벤트 시스템', passed,
                    `발생한 이벤트: ${events.join(', ')}`);

            } catch (error) {
                displayTestResult('integration', '이벤트 시스템', false, error.message);
            }
        }

        // ========================================
        // 헬퍼 함수들
        // ========================================

        function simulateCalculateDelta(oldData, newData) {
            const delta = {
                added: [],
                modified: [],
                deleted: []
            };

            // 추가 및 수정 확인
            for (let i = 0; i < newData.length; i++) {
                if (i >= oldData.length) {
                    // 새로운 행
                    delta.added.push({
                        row: i,
                        data: newData[i]
                    });
                } else {
                    // 기존 행 변경 확인
                    const changes = [];
                    for (let j = 0; j < Math.max(oldData[i].length, newData[i].length); j++) {
                        if (oldData[i][j] !== newData[i][j]) {
                            changes.push({
                                col: j,
                                oldValue: oldData[i][j] || '',
                                newValue: newData[i][j] || ''
                            });
                        }
                    }

                    if (changes.length > 0) {
                        delta.modified.push({
                            row: i,
                            cells: changes
                        });
                    }
                }
            }

            // 삭제 확인
            for (let i = newData.length; i < oldData.length; i++) {
                delta.deleted.push({ row: i });
            }

            return delta;
        }

        function simulateGenerateVersion(data) {
            const dataString = JSON.stringify(data);
            // 간단한 해시 함수 (실제로는 MD5 사용)
            let hash = 0;
            for (let i = 0; i < dataString.length; i++) {
                const char = dataString.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString(36);
        }

        // ========================================
        // 이벤트 리스너
        // ========================================

        document.getElementById('run-all-tests').addEventListener('click', async () => {
            log('🚀 모든 테스트 시작');
            clearResults();
            await runUnitTests();
            await runIntegrationTests();

            const successRate = testStats.total > 0 ? (testStats.passed / testStats.total * 100).toFixed(1) : 0;
            log(`📊 테스트 완료: ${testStats.passed}/${testStats.total} 통과 (${successRate}%)`,
                testStats.failed === 0 ? 'success' : 'error');
        });

        document.getElementById('run-unit-tests').addEventListener('click', async () => {
            log('🧪 단위 테스트만 실행');
            clearResults();
            await runUnitTests();
        });

        document.getElementById('run-integration-tests').addEventListener('click', async () => {
            log('🔗 통합 테스트만 실행');
            clearResults();
            await runIntegrationTests();
        });

        document.getElementById('clear-results').addEventListener('click', clearResults);

        function clearResults() {
            testStats = { total: 0, passed: 0, failed: 0 };
            updateTestStats();

            document.getElementById('unit-test-results').innerHTML = '';
            document.getElementById('integration-test-results').innerHTML = '';
            document.getElementById('console-output').textContent = '테스트 로그가 여기에 표시됩니다...\n';

            // 성능 메트릭 초기화
            document.getElementById('delta-time').textContent = '-';
            document.getElementById('conflict-time').textContent = '-';
            document.getElementById('compression-ratio').textContent = '-';
            document.getElementById('memory-usage').textContent = '-';
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', () => {
            log('📋 Day 3 테스트 도구 초기화 완료');
            log('🎯 테스트 목표: 증분 업데이트 기능 검증');
            updateTestStats();
        });
    </script>
</body>
</html>