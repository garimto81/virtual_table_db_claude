<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>포커 핸드 모니터링 v10.2.0 - Checksum Enhanced</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="performance_monitor.js"></script>
  <script src="checksum_manager.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }
    .metric-card {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 16px;
    }
  </style>
</head>
<body>
  <!-- 헤더 -->
  <div class="bg-slate-900/95 border-b border-slate-700 p-4 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-4">
        <h1 class="text-xl font-bold">포커 핸드 모니터링</h1>
        <span class="text-xs text-gray-500">v10.2.0 Checksum</span>
      </div>
      <div class="flex items-center gap-3">
        <button onclick="toggleChecksumMode()" id="checksum-toggle" class="px-3 py-1 bg-green-600 text-white rounded text-sm">
          ✅ Checksum ON
        </button>
        <button onclick="showStats()" class="px-3 py-1 bg-blue-600 text-white rounded text-sm">
          📊 통계
        </button>
        <button onclick="forceRefresh()" class="px-3 py-1 bg-yellow-600 text-white rounded text-sm">
          🔄 새로고침
        </button>
      </div>
    </div>
  </div>

  <!-- 메인 컨테이너 -->
  <div class="max-w-7xl mx-auto p-6">
    <!-- 상태 대시보드 -->
    <div class="grid grid-cols-4 gap-4 mb-6">
      <div class="metric-card">
        <div class="text-xs text-gray-400 mb-1">API 호출 감소율</div>
        <div id="api-reduction" class="text-2xl font-bold text-green-400">0%</div>
      </div>
      <div class="metric-card">
        <div class="text-xs text-gray-400 mb-1">캐시 히트율</div>
        <div id="cache-hit-rate" class="text-2xl font-bold text-blue-400">0%</div>
      </div>
      <div class="metric-card">
        <div class="text-xs text-gray-400 mb-1">Checksum 호출</div>
        <div id="checksum-calls" class="text-2xl font-bold">0</div>
      </div>
      <div class="metric-card">
        <div class="text-xs text-gray-400 mb-1">데이터 호출</div>
        <div id="data-calls" class="text-2xl font-bold">0</div>
      </div>
    </div>

    <!-- 데이터 테이블 -->
    <div class="metric-card">
      <h2 class="text-lg font-bold mb-4">시트 데이터</h2>
      <div id="data-container" class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-gray-700">
              <th class="text-left p-2">행</th>
              <th class="text-left p-2">A열</th>
              <th class="text-left p-2">B열</th>
              <th class="text-left p-2">C열</th>
              <th class="text-left p-2">D열</th>
              <th class="text-left p-2">E열 (상태)</th>
              <th class="text-left p-2">Checksum</th>
            </tr>
          </thead>
          <tbody id="data-tbody">
            <tr>
              <td colspan="7" class="text-center p-4 text-gray-500">데이터 로딩 중...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- 로그 -->
    <div class="metric-card mt-6">
      <h2 class="text-lg font-bold mb-4">실시간 로그</h2>
      <div id="log-container" class="h-48 overflow-y-auto bg-black/30 rounded p-3 font-mono text-xs">
        <div class="text-green-400">[시스템] Checksum 모드 준비 완료</div>
      </div>
    </div>
  </div>

  <!-- 통계 모달 -->
  <div id="stats-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-slate-800 rounded-lg p-6 max-w-md w-full">
      <h3 class="text-xl font-bold mb-4">📊 성능 통계</h3>
      <div id="stats-content" class="space-y-2 text-sm">
        <!-- 동적 생성 -->
      </div>
      <button onclick="closeStats()" class="mt-4 px-4 py-2 bg-gray-600 text-white rounded w-full">
        닫기
      </button>
    </div>
  </div>

  <script>
    // Google Apps Script URL (실제 URL로 교체 필요)
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';

    // Checksum Manager 인스턴스
    let checksumManager = null;
    let checksumEnabled = true;
    let legacyInterval = null;

    // 로그 추가
    function addLog(message, type = 'info') {
      const logContainer = document.getElementById('log-container');
      const timestamp = new Date().toLocaleTimeString('ko-KR');

      let prefix = '[정보]';
      let colorClass = 'text-gray-300';

      if (type === 'success') {
        prefix = '[성공]';
        colorClass = 'text-green-400';
      } else if (type === 'error') {
        prefix = '[오류]';
        colorClass = 'text-red-400';
      } else if (type === 'warning') {
        prefix = '[경고]';
        colorClass = 'text-yellow-400';
      }

      const entry = document.createElement('div');
      entry.className = colorClass;
      entry.textContent = `${timestamp} ${prefix} ${message}`;
      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    // UI 업데이트
    function updateUI(data) {
      const tbody = document.getElementById('data-tbody');

      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-gray-500">데이터 없음</td></tr>';
        return;
      }

      // 최대 10개 행만 표시
      const displayData = data.slice(0, 10);

      tbody.innerHTML = displayData.map((row, index) => `
        <tr class="border-b border-gray-700/50 hover:bg-gray-800/30">
          <td class="p-2">${index + 1}</td>
          <td class="p-2">${row[0] || '-'}</td>
          <td class="p-2">${row[1] || '-'}</td>
          <td class="p-2">${row[2] || '-'}</td>
          <td class="p-2">${row[3] || '-'}</td>
          <td class="p-2">
            <span class="px-2 py-1 rounded text-xs ${
              row[4] === '완료' ? 'bg-green-600' : 'bg-gray-600'
            }">
              ${row[4] || '대기'}
            </span>
          </td>
          <td class="p-2 text-xs text-gray-500">${
            checksumManager ? checksumManager.getChecksum()?.substring(0, 8) + '...' : '-'
          }</td>
        </tr>
      `).join('');

      addLog(`UI 업데이트: ${displayData.length}개 행 표시`, 'success');
    }

    // 통계 업데이트
    function updateStats() {
      if (!checksumManager) return;

      const stats = checksumManager.getStats();

      document.getElementById('api-reduction').textContent = stats.apiReduction || '0%';
      document.getElementById('cache-hit-rate').textContent = stats.cacheHitRate || '0%';
      document.getElementById('checksum-calls').textContent = stats.checksumCalls || '0';
      document.getElementById('data-calls').textContent = stats.dataCalls || '0';
    }

    // Checksum 모드 초기화
    async function initializeChecksumMode() {
      addLog('Checksum Manager 초기화 시작', 'warning');

      try {
        // ChecksumManager 생성
        checksumManager = new ChecksumManager(APPS_SCRIPT_URL);

        // 이벤트 리스너 설정
        checksumManager.on('dataChanged', (event) => {
          addLog(`데이터 변경 감지: ${event.timestamp}`, 'success');
          updateUI(event.data);
          updateStats();
        });

        checksumManager.on('checksumChecked', (event) => {
          addLog(`Checksum 확인: ${event.responseTime.toFixed(0)}ms`, 'info');
          updateStats();
        });

        checksumManager.on('error', (error) => {
          addLog(`오류: ${error.message}`, 'error');
        });

        // 폴링 시작 (10초 간격)
        checksumManager.startPolling(10000);

        addLog('Checksum 모드 활성화 완료', 'success');

        // 전역 등록
        window.checksumManager = checksumManager;
        window.updateUI = updateUI;

      } catch (error) {
        addLog(`초기화 실패: ${error.message}`, 'error');
        console.error(error);
      }
    }

    // 레거시 모드 (기존 10초 폴링)
    function initializeLegacyMode() {
      addLog('레거시 모드 시작 (10초 폴링)', 'warning');

      const fetchData = async () => {
        try {
          const response = await fetch(APPS_SCRIPT_URL);
          const data = await response.json();

          if (data && data.data) {
            updateUI(data.data);
            addLog('레거시 데이터 로드 완료', 'success');
          }
        } catch (error) {
          addLog(`레거시 로드 실패: ${error.message}`, 'error');
        }
      };

      // 즉시 실행
      fetchData();

      // 10초마다 반복
      legacyInterval = setInterval(fetchData, 10000);
    }

    // Checksum 모드 토글
    function toggleChecksumMode() {
      checksumEnabled = !checksumEnabled;
      const button = document.getElementById('checksum-toggle');

      if (checksumEnabled) {
        // Checksum 모드 활성화
        button.textContent = '✅ Checksum ON';
        button.className = 'px-3 py-1 bg-green-600 text-white rounded text-sm';

        if (legacyInterval) {
          clearInterval(legacyInterval);
          legacyInterval = null;
        }

        if (checksumManager) {
          checksumManager.startPolling();
        } else {
          initializeChecksumMode();
        }

        addLog('Checksum 모드 활성화', 'success');

      } else {
        // 레거시 모드
        button.textContent = '❌ Checksum OFF';
        button.className = 'px-3 py-1 bg-gray-600 text-white rounded text-sm';

        if (checksumManager) {
          checksumManager.stopPolling();
        }

        initializeLegacyMode();
        addLog('레거시 모드 전환', 'warning');
      }
    }

    // 강제 새로고침
    async function forceRefresh() {
      addLog('강제 새로고침 시작', 'warning');

      if (checksumManager) {
        const result = await checksumManager.forceRefresh();
        if (result.updated) {
          addLog('새 데이터 로드 완료', 'success');
        } else {
          addLog('데이터 변경 없음', 'info');
        }
      } else {
        addLog('Checksum Manager가 초기화되지 않음', 'error');
      }
    }

    // 통계 표시
    function showStats() {
      if (!checksumManager) {
        alert('Checksum Manager가 초기화되지 않았습니다');
        return;
      }

      const stats = checksumManager.getStats();
      const status = checksumManager.getStatus();

      const content = `
        <div class="space-y-3">
          <div class="flex justify-between">
            <span>총 API 호출:</span>
            <span class="font-bold">${stats.totalCalls}</span>
          </div>
          <div class="flex justify-between">
            <span>Checksum 호출:</span>
            <span class="font-bold text-green-400">${stats.checksumCalls}</span>
          </div>
          <div class="flex justify-between">
            <span>데이터 호출:</span>
            <span class="font-bold text-blue-400">${stats.dataCalls}</span>
          </div>
          <div class="flex justify-between">
            <span>캐시 히트:</span>
            <span class="font-bold text-yellow-400">${stats.cacheHits}</span>
          </div>
          <div class="flex justify-between">
            <span>캐시 히트율:</span>
            <span class="font-bold">${stats.cacheHitRate}</span>
          </div>
          <div class="flex justify-between">
            <span>API 감소율:</span>
            <span class="font-bold text-green-400">${stats.apiReduction}</span>
          </div>
          <div class="flex justify-between">
            <span>실행 시간:</span>
            <span class="font-bold">${stats.runningTime}</span>
          </div>
          <div class="flex justify-between">
            <span>분당 호출:</span>
            <span class="font-bold">${stats.callsPerMinute}</span>
          </div>
          <hr class="border-gray-600">
          <div class="flex justify-between">
            <span>폴링 상태:</span>
            <span class="font-bold ${status.isPolling ? 'text-green-400' : 'text-red-400'}">
              ${status.isPolling ? '활성' : '비활성'}
            </span>
          </div>
          <div class="flex justify-between">
            <span>폴링 간격:</span>
            <span class="font-bold">${status.pollInterval}ms</span>
          </div>
        </div>
      `;

      document.getElementById('stats-content').innerHTML = content;
      document.getElementById('stats-modal').classList.remove('hidden');
    }

    // 통계 모달 닫기
    function closeStats() {
      document.getElementById('stats-modal').classList.add('hidden');
    }

    // 페이지 로드 시 초기화
    window.onload = () => {
      addLog('페이지 로드 완료', 'success');

      // 5초 후 자동 시작
      setTimeout(() => {
        if (checksumEnabled) {
          initializeChecksumMode();
        } else {
          initializeLegacyMode();
        }
      }, 2000);

      // 30초마다 통계 업데이트
      setInterval(updateStats, 30000);
    };
  </script>
</body>
</html>