<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>모듈화된 로직 테스트 - Virtual Table DB</title>
    <style>
        body {
            font-family: 'Consolas', monospace;
            margin: 20px;
            background: #1a1a1a;
            color: #ffffff;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-section {
            background: #2d2d2d;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        .test-section.error { border-left-color: #f44336; }
        .test-section.warning { border-left-color: #ff9800; }
        h1 { color: #4CAF50; text-align: center; }
        h2 { color: #81C784; border-bottom: 2px solid #81C784; padding-bottom: 5px; }
        h3 { color: #A5D6A7; }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .success { background: #1B5E20; color: #C8E6C9; }
        .error { background: #B71C1C; color: #FFCDD2; }
        .warning { background: #E65100; color: #FFE0B2; }
        .info { background: #0D47A1; color: #BBDEFB; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #666; cursor: not-allowed; }
        .code-block {
            background: #000;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            border: 1px solid #444;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .stat-card {
            background: #333;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }
        .stat-value { font-size: 24px; font-weight: bold; color: #4CAF50; }
        .stat-label { font-size: 12px; color: #ccc; }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4CAF50, #81C784);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 모듈화된 로직 테스트</h1>
        <div class="test-section">
            <p>이 테스트는 기존 index.html에서 분리된 모듈화된 로직만을 독립적으로 테스트합니다.</p>
            <p><strong>테스트 범위:</strong></p>
            <ul>
                <li>FilenameManager.generateCustomFilename() - 복잡한 파일명 생성</li>
                <li>FilenameManager 매핑 시스템 - O(1) 조회</li>
                <li>AIAnalyzer.generateFileSummary() - AI 요약 생성</li>
                <li>filename-adapter.js 호환성 레이어</li>
            </ul>
        </div>

        <!-- 모듈 로드 상태 -->
        <div class="test-section" id="module-status">
            <h2>📦 모듈 로드 상태</h2>
            <div class="stats">
                <div class="stat-card" id="filename-manager-status">
                    <div class="stat-value" id="fm-status">❌</div>
                    <div class="stat-label">FilenameManager</div>
                </div>
                <div class="stat-card" id="ai-analyzer-status">
                    <div class="stat-value" id="ai-status">❌</div>
                    <div class="stat-label">AIAnalyzer</div>
                </div>
                <div class="stat-card" id="adapter-status">
                    <div class="stat-value" id="adapter-status-val">❌</div>
                    <div class="stat-label">Adapter</div>
                </div>
            </div>
        </div>

        <!-- 컨트롤 패널 -->
        <div class="test-section">
            <h2>🎮 테스트 컨트롤</h2>
            <button onclick="runAllTests()" id="run-all-btn">전체 테스트 실행</button>
            <button onclick="testFilenameGeneration()">파일명 생성 테스트</button>
            <button onclick="testMappingSystem()">매핑 시스템 테스트</button>
            <button onclick="testAIIntegration()">AI 통합 테스트</button>
            <button onclick="testCompatibility()">호환성 테스트</button>
            <button onclick="performanceBenchmark()">성능 벤치마크</button>
            <button onclick="clearResults()">결과 초기화</button>
        </div>

        <!-- 테스트 진행도 -->
        <div class="test-section">
            <h2>📊 테스트 진행도</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="tests-passed">0</div>
                    <div class="stat-label">통과</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="tests-failed">0</div>
                    <div class="stat-label">실패</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="tests-total">0</div>
                    <div class="stat-label">총 테스트</div>
                </div>
            </div>
        </div>

        <!-- 테스트 결과 -->
        <div class="test-section">
            <h2>📝 테스트 결과</h2>
            <div id="test-results"></div>
        </div>

        <!-- 성능 결과 -->
        <div class="test-section">
            <h2>⚡ 성능 결과</h2>
            <div id="performance-results"></div>
        </div>
    </div>

    <!-- 모듈 로드 -->
    <script>
        // 디버그 모드 활성화 (테스트용)
        window.DEBUG_MODE = true;

        // 테스트 통계
        let testStats = {
            passed: 0,
            failed: 0,
            total: 0
        };

        // 가짜 CONFIG 객체 (테스트용)
        window.CONFIG = {
            GEMINI_API_KEY: 'test-key-12345' // 테스트용 가짜 키
        };

        // 가짜 localStorage (테스트용)
        const testStorage = {
            'filenamePrefix': 'VT',
            'filenameSuffix': '_test',
            'useAIForFilename': 'true',
            'filenameTemplate': '{prefix}{handNumber}_{position}_{action}'
        };

        // localStorage 오버라이드
        const originalGetItem = localStorage.getItem;
        localStorage.getItem = function(key) {
            if (testStorage[key] !== undefined) {
                return testStorage[key];
            }
            return originalGetItem.call(this, key);
        };
    </script>

    <!-- 실제 모듈들 로드 -->
    <script src="../src/modules/filename-manager.js"></script>
    <script src="../src/modules/ai-analyzer.js"></script>
    <script src="../src/modules/filename-adapter.js"></script>

    <script>
        // 모듈 로드 확인
        function checkModuleStatus() {
            const fmStatus = document.getElementById('fm-status');
            const aiStatus = document.getElementById('ai-status');
            const adapterStatus = document.getElementById('adapter-status-val');

            if (window.FilenameManager) {
                fmStatus.textContent = '✅';
                fmStatus.style.color = '#4CAF50';
            }

            if (window.AIAnalyzer) {
                aiStatus.textContent = '✅';
                aiStatus.style.color = '#4CAF50';
            }

            if (window.generateCustomFilename) {
                adapterStatus.textContent = '✅';
                adapterStatus.style.color = '#4CAF50';
            }
        }

        // 가짜 분석 데이터 생성 (테스트용)
        function createMockAnalysis(handNumber) {
            return {
                handData: { handNumber },
                hero: { name: 'TestHero', cards: 'AK' },
                villain: { name: 'TestVillain', cards: 'QQ' },
                keywords: ['3bet', 'bluff', 'fold'],
                summary: 'bluff_3bet_fold'
            };
        }

        // 가짜 getUnifiedHandAnalysis 함수 (테스트용)
        window.getUnifiedHandAnalysis = async function(handNumber) {
            // 테스트용 지연
            await new Promise(resolve => setTimeout(resolve, 10));
            return createMockAnalysis(handNumber);
        };

        // 테스트 결과 출력
        function addTestResult(testName, passed, message, details = '') {
            const resultsDiv = document.getElementById('test-results');
            const resultClass = passed ? 'success' : 'error';
            const icon = passed ? '✅' : '❌';

            testStats.total++;
            if (passed) testStats.passed++;
            else testStats.failed++;

            const resultHtml = `
                <div class="test-result ${resultClass}">
                    <strong>${icon} ${testName}</strong>
                    <br>${message}
                    ${details ? `<br><small>${details}</small>` : ''}
                </div>
            `;

            resultsDiv.innerHTML += resultHtml;
            updateStats();
        }

        // 통계 업데이트
        function updateStats() {
            document.getElementById('tests-passed').textContent = testStats.passed;
            document.getElementById('tests-failed').textContent = testStats.failed;
            document.getElementById('tests-total').textContent = testStats.total;

            const progress = testStats.total > 0 ? (testStats.passed / testStats.total) * 100 : 0;
            document.getElementById('progress-fill').style.width = progress + '%';
        }

        // 1. 파일명 생성 테스트
        async function testFilenameGeneration() {
            // 테스트 그룹 시작 - 성공으로 초기화하고 실패 시에만 false 설정
            let groupSuccess = true;

            try {
                // 기본 파일명 생성
                const filename1 = await window.FilenameManager.generateCustomFilename(142);
                const expected1 = 'VT142_TestHero_AK_TestVillain_QQ_bluff_3bet_fold_test';
                const passed1 = filename1.includes('VT142') && filename1.includes('TestHero');
                if (!passed1) groupSuccess = false;
                addTestResult('기본 파일명 생성', passed1,
                    `생성된 파일명: ${filename1}`,
                    `예상 패턴 포함 여부 확인`);

                // 캐시 테스트 (두 번째 호출)
                const start = performance.now();
                const filename2 = await window.FilenameManager.generateCustomFilename(142);
                const cacheTime = performance.now() - start;
                const passed2 = filename1 === filename2 && cacheTime < 1;
                if (!passed2) groupSuccess = false;
                addTestResult('캐시 시스템', passed2,
                    `캐시된 파일명: ${filename2}`,
                    `조회 시간: ${cacheTime.toFixed(2)}ms (1ms 이하 기대)`);

                // 다른 핸드번호 테스트
                const filename3 = await window.FilenameManager.generateCustomFilename(999);
                const passed3 = filename3.includes('VT999') && filename3 !== filename1;
                if (!passed3) groupSuccess = false;
                addTestResult('다른 핸드번호', passed3,
                    `새 핸드 파일명: ${filename3}`,
                    `기존과 다른 파일명 생성 확인`);

                // 테스트 그룹 결과 업데이트
                addTestResult('파일명 생성 테스트', groupSuccess, groupSuccess ? '모든 테스트 통과' : '일부 테스트 실패');

            } catch (error) {
                addTestResult('파일명 생성 테스트', false, `오류 발생: ${error.message}`);
            }
        }

        // 2. 매핑 시스템 테스트
        async function testMappingSystem() {
            try {
                // 매핑 저장 테스트
                window.FilenameManager.saveMapping(777, 'test_777_mapping');
                const extracted = window.FilenameManager.extractHandNumber('test_777_mapping');
                const passed1 = extracted === 777;
                addTestResult('매핑 저장/추출', passed1,
                    `저장: 777 → test_777_mapping, 추출: ${extracted}`);

                // 일괄 매핑 테스트
                const batchData = [];
                for (let i = 500; i < 510; i++) {
                    batchData.push({ handNumber: i, filename: `batch_${i}_test` });
                }
                window.FilenameManager.batchSaveMappings(batchData);

                let batchSuccess = true;
                for (let i = 500; i < 510; i++) {
                    const extracted = window.FilenameManager.extractHandNumber(`batch_${i}_test`);
                    if (extracted !== i) {
                        batchSuccess = false;
                        break;
                    }
                }
                addTestResult('일괄 매핑', batchSuccess,
                    `10개 매핑 일괄 처리 ${batchSuccess ? '성공' : '실패'}`);

                // 통계 확인
                const stats = window.FilenameManager.getStats();
                const passed3 = stats.totalMappings > 10;
                addTestResult('매핑 통계', passed3,
                    `총 매핑 수: ${stats.totalMappings}, 메모리: ${stats.memorySize}`);

            } catch (error) {
                addTestResult('매핑 시스템 테스트', false, `오류 발생: ${error.message}`);
            }
        }

        // 3. AI 통합 테스트
        async function testAIIntegration() {
            try {
                // AI 요약 생성 테스트
                const mockAnalysis = createMockAnalysis(888);
                const summary = await window.AIAnalyzer.generateFileSummary(mockAnalysis);
                const passed1 = summary && summary.length > 0 && summary.includes('_');
                addTestResult('AI 요약 생성', passed1,
                    `생성된 요약: ${summary}`,
                    `3단어 형식 확인`);

                // AI 캐시 테스트
                const start = performance.now();
                const summary2 = await window.AIAnalyzer.generateFileSummary(mockAnalysis);
                const cacheTime = performance.now() - start;
                const passed2 = summary === summary2 && cacheTime < 1;
                addTestResult('AI 캐시', passed2,
                    `캐시된 요약: ${summary2}`,
                    `조회 시간: ${cacheTime.toFixed(2)}ms`);

                // AI 통계
                const aiStats = window.AIAnalyzer.getStats();
                const passed3 = aiStats.cacheSize >= 0;
                addTestResult('AI 통계', passed3,
                    `캐시 크기: ${aiStats.cacheSize}, API 키: ${aiStats.apiKey}`);

            } catch (error) {
                addTestResult('AI 통합 테스트', false, `오류 발생: ${error.message}`);
            }
        }

        // 4. 호환성 테스트
        async function testCompatibility() {
            try {
                // 기존 함수 호출 테스트 (deprecated이지만 작동해야 함)
                if (typeof window.generateCustomFilename === 'function') {
                    const filename = await window.generateCustomFilename(123);
                    const passed1 = filename && filename.includes('123');
                    addTestResult('기존 함수 호환성', passed1,
                        `deprecated 함수 결과: ${filename}`);
                }

                // 전역 매핑 변수 테스트
                const passed2 = window.handToFilenameMapping instanceof Map;
                addTestResult('전역 매핑 변수', passed2,
                    `handToFilenameMapping 타입: ${typeof window.handToFilenameMapping}`);

                // 어댑터 래퍼 함수들 테스트
                if (typeof window.extractHandNumberFromFilename === 'function') {
                    // 이 함수는 이제 null을 반환하도록 deprecated 처리됨
                    const result = window.extractHandNumberFromFilename('test_123_file');
                    const passed3 = true; // deprecated 함수는 경고만 출력
                    addTestResult('어댑터 래퍼', passed3,
                        `deprecated 함수 호출 완료 (경고 출력됨)`);
                }

            } catch (error) {
                addTestResult('호환성 테스트', false, `오류 발생: ${error.message}`);
            }
        }

        // 5. 성능 벤치마크
        async function performanceBenchmark() {
            const performanceResults = document.getElementById('performance-results');

            try {
                // O(1) 조회 성능 테스트
                const iterations = 1000;

                // 데이터 준비
                for (let i = 1; i <= iterations; i++) {
                    await window.FilenameManager.generateCustomFilename(i);
                }

                // 조회 성능 테스트
                const start = performance.now();
                for (let i = 1; i <= iterations; i++) {
                    await window.FilenameManager.generateCustomFilename(i); // 캐시에서 조회
                }
                const end = performance.now();

                const totalTime = end - start;
                const avgTime = totalTime / iterations;

                const performanceHtml = `
                    <div class="test-result success">
                        <strong>⚡ 성능 벤치마크 결과</strong>
                        <br>총 ${iterations}개 파일명 조회
                        <br>총 시간: ${totalTime.toFixed(2)}ms
                        <br>평균 시간: ${avgTime.toFixed(4)}ms (O(1) 목표: <0.01ms)
                        <br>초당 처리량: ${Math.round(1000 / avgTime).toLocaleString()}개/초
                    </div>
                `;

                performanceResults.innerHTML += performanceHtml;

                const passed = avgTime < 0.1; // 0.1ms 이하면 양호
                addTestResult('성능 벤치마크', passed,
                    `평균 조회 시간: ${avgTime.toFixed(4)}ms`,
                    `목표: <0.01ms (캐시 조회)`);

            } catch (error) {
                addTestResult('성능 벤치마크', false, `오류 발생: ${error.message}`);
            }
        }

        // 전체 테스트 실행
        async function runAllTests() {
            clearResults();
            document.getElementById('run-all-btn').disabled = true;

            await testFilenameGeneration();
            await testMappingSystem();
            await testAIIntegration();
            await testCompatibility();
            await performanceBenchmark();

            document.getElementById('run-all-btn').disabled = false;

            // 최종 결과 요약
            const resultsDiv = document.getElementById('test-results');
            const summaryHtml = `
                <div class="test-result info">
                    <strong>🏁 테스트 완료</strong>
                    <br>통과: ${testStats.passed}/${testStats.total}
                    <br>성공률: ${((testStats.passed / testStats.total) * 100).toFixed(1)}%
                </div>
            `;
            resultsDiv.innerHTML += summaryHtml;
        }

        // 결과 초기화
        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('performance-results').innerHTML = '';
            testStats = { passed: 0, failed: 0, total: 0 };
            updateStats();
        }

        // 페이지 로드 시 모듈 상태 확인
        window.addEventListener('load', () => {
            setTimeout(checkModuleStatus, 100);
        });
    </script>
</body>
</html>